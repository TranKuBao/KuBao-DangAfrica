<!-- Additional CSS for Enhanced Styling -->
<style>
    .CodeMirror {
        font-size: 13px !important;
        min-height: 400px;
        height: 80%;
        width: 100%;
        background: #282a36;
        border-radius: 6px;
        box-sizing: border-box;
    }

    .modal-body {
        max-height: none;
        overflow-y: visible;
        overflow-x: hidden;
        /* Ch·∫∑n cu·ªôn ngang */
        padding: 1rem 1.5rem;
    }

    .modal-content {
        transition: all 0.3s ease;
    }

    .modal-content:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
    }

    .modal-header {
        border-bottom: 2px solid #e9ecef;
    }

    .modal-footer {
        border-top: 2px solid #e9ecef;
    }

    .modal-header,
    .modal-footer {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
        padding-left: 1rem !important;
        padding-right: 1rem !important;
        min-height: 28px;
        align-items: center !important;
    }

    .modal-header .modal-title {
        font-size: 1.1rem;
        padding: 0;
        margin: 0;
    }

    h5.text-primary {
        font-weight: 600;
    }

    .shadow-sm {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .btn-hacker {
        font-family: 'Courier New', monospace;
        border: 1px solid #f97316;
        background-color: #FFFFFF;
        color: #f97316;
        padding: 10px 20px;
        border-radius: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 0 5px #f97316;
    }

    .btn-hacker:hover {
        background-color: #f97316;
        color: #FFFFFF;
        box-shadow: 0 0 12px #f97316;
    }

    .btn-hacker-danger {
        border: 1px solid #ff0033;
        color: #ff0033;
        box-shadow: 0 0 5px #ff0033;
    }

    .btn-hacker-danger:hover {
        background-color: #ff0033;
        color: #000;
        box-shadow: 0 0 12px #ff0033;
    }

    .btn-hacker-warning {
        border: 1px solid #f97316;
        color: #f97316;
        box-shadow: 0 0 5px #f97316;
    }

    .btn-hacker-warning:hover {
        background-color: #f97316;
        color: #000;
        box-shadow: 0 0 12px #f97316;
    }

    .btn-hacker-success {
        border: 1px solid #28a745;
        color: #28a745;
        box-shadow: 0 0 5px #28a745;
    }

    .btn-hacker-success:hover {
        background-color: #28a745;
        color: #FFFFFF;
        box-shadow: 0 0 12px #28a745;
    }

    /* POC List Styling */
    .poc-list-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #fff;
    }

    .poc-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .poc-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .poc-item.selected {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }

    .poc-item:last-child {
        border-bottom: none;
    }

    .poc-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .poc-description {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
    }

    .poc-cve {
        font-size: 11px;
        color: #f97316;
        font-weight: 500;
    }

    .poc-status {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .status-verified {
        background-color: #d4edda;
        color: #155724;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-failed {
        background-color: #f8d7da;
        color: #721c24;
    }

    /* Search and Filter Section */
    .search-filter-section {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-buttons {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 6px 12px;
        border: 1px solid #dee2e6;
        background: white;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-btn.active {
        background: #f97316;
        color: white;
        border-color: #f97316;
    }

    .filter-btn:hover {
        background: #f97316;
        color: white;
        border-color: #f97316;
    }

    /* Loading Animation */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #f97316;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Target Selection */
    .target-selection {
        background: #e3f2fd;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 16px;
        border-left: 4px solid #2196f3;
    }

    .target-count {
        font-weight: 600;
        color: #1976d2;
    }
</style>

<div class="modal fade" id="reconTargetsModal" tabindex="-1" aria-labelledby="reconTargetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content shadow-lg" style="background-color: #f8f9fa; border-radius: 12px;">
            <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center"
                style="background-color: #e9ecef !important;">
                <h5 class="modal-title font-weight-bold" id="reconTargetModalLabel">üîç Recon Targets with Tools</h5>
                <div class="d-flex gap-2" style="margin-top: 10px !important;">
                    <button type="button" class="btn btn-hacker-success px-4" onclick="Run_Scan()">
                        <i class="fas fa-play"></i> Run <!--m√†u xanh-->
                    </button>
                    <button type="button" class="btn btn-hacker-success px-4" onclick="Stop_Scan()">
                        <i class="fas fa-play"></i> Stop <!--m√†u vang-->
                    </button>
                    <button type="button" class="btn btn-hacker px-4" onclick="Save_Scan()">
                        <i class="fas fa-save"></i> Save <!--m√†u cam-->
                    </button>
                    <button type="button" class="btn btn-hacker-danger px-4" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close <!--m√†u cam-->
                    </button>
                </div>
            </div>

            <div class="modal-body p-4">
                <!-- Target Selection Info -->
                <div class="target-selection">
                    <i class="fas fa-bullseye me-2"></i>
                    <span class="target-count" id="reconSelectedTargetCount"></span> targets selected for verification
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Check console for detailed target information
                        </small>
                    </div>
                </div>

                <!-- Error Notification -->
                <div class="alert alert-danger mt-3" id="reconErrorAlert" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="reconErrorMessage"></span>
                </div>

                <!-- Success Notification -->
                <div class="alert alert-success mt-3" id="reconSuccessAlert" style="display: none;">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="reconSuccessMessage"></span>
                </div>

                <!--th√¥ng b√°o v·ªÅ k·∫øt qu·∫£ verify-->
                <div id="reconVerifyResult" class="mt-3"></div>

                <!-- Tool & Mode Selection Section -->
                <div class="my-4 p-3 bg-white rounded shadow-sm">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <label class="fw-bold mb-2">Ch·ªçn c√¥ng c·ª•:</label>
                            <div class="d-flex gap-3 flex-wrap" id="reconToolSelectGroup">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="toolSelect" id="toolDirsearch" value="dirsearch" checked onchange="onToolChange()">
                                    <label class="form-check-label" for="toolDirsearch">Dirsearch</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="toolSelect" id="toolWpscan" value="wpscan" onchange="onToolChange()">
                                    <label class="form-check-label" for="toolWpscan">WP-Scan</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="toolSelect" id="toolNmap" value="nmap" onchange="onToolChange()">
                                    <label class="form-check-label" for="toolNmap">Nmap</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="toolSelect" id="toolWappalyzer" value="wappalyzer" onchange="onToolChange()">
                                    <label class="form-check-label" for="toolWappalyzer">Wappalyzer</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold mb-2">Ch·ªçn mode:</label>
                            <div id="reconModeSelectGroup">
                                <!-- Mode select s·∫Ω thay ƒë·ªïi theo c√¥ng c·ª• -->
                                <select class="form-select" id="reconModeDirsearch">
                                    <option value="1"selected>Fast</option>
                                    <option value="2" >Normal</option>
                                    <option value="3">Deep</option>
                                </select>
                                <select class="form-select d-none" id="reconModeWpscan">
                                    <option value="standard" selected>Standard</option>
                                </select>
                                <select class="form-select d-none" id="reconModeNmap">\
                                    <option value="1" selected>Host Discovery</option>
                                    <option value="2">Fast Scan</option>
                                    <option value="3">Service Detection</option>
                                    <option value="4">Vulnerability Scan</option>
                                    <option value="5">Aggressive Scan</option>
                                </select>
                                <select class="form-select d-none" id="reconModeWappalyzer">
                                    <option value="standard" selected>Standard</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result & Loading Section -->
                <div class="my-4">
                    <div id="reconScanLoading" class="loading-spinner" style="display: none;">
                        <div class="spinner"></div>
                        <p class="mt-2">ƒêang qu√©t, vui l√≤ng ch·ªù...</p>
                    </div>
                    <div id="reconScanResult" class="bg-light p-3 rounded shadow-sm" style="min-height: 120px; font-family: monospace; white-space: pre-wrap;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--V-->
<script>
    
    //b·ªè d·ªØ li·ªáu qu√©t m·ªõi nh·∫•t v√¥ ƒë·∫•y n·∫øu ai ƒë√≥ mu·ªën l∆∞u
    window.latestReconResult = {
       tool: null,    // t√™n c√¥ng c·ª•: 'wpscan', 'nmap', ...
       data: []     // d·ªØ li·ªáu k·∫øt qu·∫£ m·ªõi nh·∫•t
    };

    // Load POCs when modal opens
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('reconTargetsModal');
        modal.addEventListener('show.bs.modal', function () {
            reconUpdateTargetCount();
            reconDisplaySelectedTargetsInfo();
        });
    });

    // c·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng
    async function reconUpdateTargetCount() {
        const checkedTargets = getCheckedTargetIds();
        const count = checkedTargets.length;
        // L·∫•y th√¥ng tin chi ti·∫øt (n·∫øu c·∫ßn)
        let hostname = '';
        if (count > 0) {
            const details = await reconFetchTargetDetails(checkedTargets);
            if (details.length > 0) {
                hostname = details[0].hostname ;
            }
        }
        const url = hostname.startsWith('http') ? hostname : `http://${hostname}`;
        document.getElementById('reconSelectedTargetCount').innerHTML = `<a class="target-count" href="${url}" target="_blank" >${hostname}</a>  |  ${count}`;
        
        // Hi·ªÉn th·ªã th√™m th√¥ng tin chi ti·∫øt n·∫øu c·∫ßn
        //console.log(`Modal: ƒê√£ ch·ªçn ${count} targets:`, checkedTargets);

        // C√≥ th·ªÉ th√™m hi·ªÉn th·ªã danh s√°ch target ƒë√£ ch·ªçn
        if (count > 0) {
            // V√≠ d·ª•: hi·ªÉn th·ªã danh s√°ch target IDs
            const targetList = checkedTargets.join(', ');
            //console.log(`Target IDs: ${targetList}`);
        }
    }

    // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªÅ c√°c target ƒë√£ ch·ªçn
    function reconDisplaySelectedTargetsInfo() {
        const targetIds = getCheckedTargetIds();
        const count = targetIds.length;

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        reconUpdateTargetCount();

        // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt trong console
        console.log('=== TH√îNG TIN TARGETS ƒê√É CH·ªåN RECON ===');
        console.log(`T·ªïng s·ªë: ${count} targets`);
        //console.log('Target IDs:', targetIds);

        // N·∫øu c√≥ target ƒë∆∞·ª£c ch·ªçn, hi·ªÉn th·ªã th√™m th√¥ng tin
        if (count > 0) {
            console.log('Danh s√°ch Target RECON IDs:', targetIds.join(', '));

            // C√≥ th·ªÉ th√™m logic ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt c·ªßa t·ª´ng target
            // V√≠ d·ª•: g·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin hostname, IP c·ªßa c√°c target
            reconFetchTargetDetails(targetIds);
        } else {
        console.log('Ch∆∞a c√≥ target n√†o ƒë∆∞·ª£c ch·ªçn');
        }
    }

    // L·∫•y th√¥ng tin chi ti·∫øt c·ªßa c√°c target (t√πy ch·ªçn)
    function reconFetchTargetDetails(targetIds) {
        return fetch('/api/getalltarget')
            .then(response => response.json())
            .then(data => {
                if (data.targets) {
                    return data.targets.filter(target =>
                        targetIds.includes(target.server_id.toString())
                    ).map(target => ({
                        id: target.server_id,
                        hostname: target.hostname,
                        ip: target.ip_address
                    }));
                }
                return [];
            });
    }

    // Tool & Mode logic
    function onToolChange() {
        const tool = document.querySelector('input[name="toolSelect"]:checked').value;
        document.getElementById('reconModeDirsearch').classList.add('d-none');
        document.getElementById('reconModeWpscan').classList.add('d-none');
        document.getElementById('reconModeNmap').classList.add('d-none');
        document.getElementById('reconModeWappalyzer').classList.add('d-none');
        if (tool === 'dirsearch') document.getElementById('reconModeDirsearch').classList.remove('d-none');
        if (tool === 'wpscan') document.getElementById('reconModeWpscan').classList.remove('d-none');
        if (tool === 'nmap') document.getElementById('reconModeNmap').classList.remove('d-none');
        if (tool === 'wappalyzer') document.getElementById('reconModeWappalyzer').classList.remove('d-none');
    }

    // Kh·ªüi t·∫°o ƒë√∫ng mode khi load l·∫°i modal
    onToolChange();

    // Scan state
    let scanInProgress = false;

    function startScan() {
        if (scanInProgress) return;
        scanInProgress = true;
        document.getElementById('reconScanLoading').style.display = 'block';
        document.getElementById('reconScanResult').textContent = '';

        const tool = document.querySelector('input[name="toolSelect"]:checked').value;        
        let mode = '';
        // L·∫•y danh s√°ch target ƒë√£ ch·ªçn
        const targetIds = getCheckedTargetIds();
        // fetchTargetDetails l√† async, n√™n ph·∫£i d√πng .then
        reconFetchTargetDetails(targetIds).then(urls => {
            if (tool === 'dirsearch') {
                mode = document.getElementById('reconModeDirsearch').value;
                hander_Dirsearch(urls[0].hostname,mode,'start');
            }
            if (tool === 'wpscan') {
                mode = document.getElementById('reconModeWpscan').value;
                hander_Wp_scan(urls[0].hostname,mode,'start');
            }
            if (tool === 'nmap'){
                mode = document.getElementById('reconModeNmap').value;
                hander_Nmap(urls[0].hostname,mode,'start');
            }
            if (tool === 'wappalyzer') {
                mode = document.getElementById('reconModeWappalyzer').value;
                hander_Wappalyzer(urls[0].hostname,mode,'start');
            }
        });
    }

    function stopScan() {
        scanInProgress = false;
        const tool = document.querySelector('input[name="toolSelect"]:checked').value;
        let mode = '';
        // L·∫•y danh s√°ch target ƒë√£ ch·ªçn
        const targetIds = getCheckedTargetIds();
        // fetchTargetDetails l√† async, n√™n ph·∫£i d√πng .then
        reconFetchTargetDetails(targetIds).then(urls => {
            if (tool === 'dirsearch') {
                mode = document.getElementById('reconModeDirsearch').value;
                hander_Dirsearch(urls[0].hostname,mode,'stop');
            }
            if (tool === 'wpscan') {
                mode = document.getElementById('reconModeWpscan').value;
                hander_Wp_scan(urls[0].hostname,mode,'stop');
            }
            if (tool === 'nmap'){
                mode = document.getElementById('reconModeNmap').value;
                hander_Nmap(urls[0].hostname,mode,'stop');
            }
            if (tool === 'wappalyzer') {
                mode = document.getElementById('reconModeWappalyzer').value;
                hander_Wappalyzer(urls[0].hostname,mode,'stop');
            }
        });

        document.getElementById('reconScanLoading').style.display = 'none';
        document.getElementById('reconScanResult').textContent += '\n[ƒê√£ d·ª´ng qu√©t]';
        //g·ª≠i request v·ªÅ
    }

    //==============l∆∞u d·ªØ li·ªáu ----------------------
    function saveScan() {
        // L∆∞u k·∫øt qu·∫£ (t√πy √Ω)
        console.log("===================D·ªØ li·ªáu l∆∞u ƒë√¢y====================")
        
        if (!window.latestReconResult.tool || window.latestReconResult.data.length === 0) {
            alert('No verification results to save. Please run verification first.');
            return;
        }
        // L·∫•y danh s√°ch target ƒë√£ ch·ªçn
        const targetIds = getCheckedTargetIds();
        // fetchTargetDetails l√† async, n√™n ph·∫£i d√πng .then
        reconFetchTargetDetails(targetIds).then(urls => {
            //console.log(`${urls[0].hostname} and ${urls[0].id}`);
            if(!confirm('Do you want to save new data?'))
                return;

            let text_data = '';            
            if(window.latestReconResult.tool == 'wappalyzer'){
                text_data = wappalyzerArrayToText(window.latestReconResult.data);
            } else if(window.latestReconResult.tool == 'nmap'){
                text_data = nmapArrayToText(window.latestReconResult.data);
            } else if(window.latestReconResult.tool == 'dirsearch'){
                text_data = dirsearchArrayToText(window.latestReconResult.data);
            } else if(window.latestReconResult.tool == 'wpscan'){
                //console.log('WPScan raw data:', window.latestReconResult);
                text_data = wpscanArrayToText(window.latestReconResult.data);
            }
            
            const data = {
                server_id: urls[0].id, 
                tool: window.latestReconResult.tool, 
                data_scan: text_data
            };
            
            console.log(`Data to save: ${text_data}`);
            request_save(data);
        });
        //alert(`ƒê√£ l∆∞u k·∫øt qu·∫£ (demo) ${window.latestReconResult.data.length}`);
    }

    // request api save data
    function request_save(data){
        fetch('/api/save_report', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Log Saving: ${data.msg}`);
            alert(`${data.msg}`);
            return data.msg;
        })
        .catch(error => {
                alert('Request to Save is Fail');
                console.error(error);
            });
    }

    
    //=============================== Wpscan =======================================
    function hander_Wp_scan(hostname, mode, action){
        console.log('Handle`s Wpscan is processing....')
        if (action === 'start') {
            const data = { hostname: hostname };
            document.getElementById('reconScanLoading').style.display = 'block';
            document.getElementById('reconScanResult').textContent = '';

            fetch('/recon/wpscan/scan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.msg);
                pollWPScanResult();
            })
            .catch(error => {
                document.getElementById('reconScanLoading').style.display = 'none';
                alert('WP-Scan request failed');
                console.error(error);
            });
        } else if (action === 'stop') {
            alert('Stop WP-Scan isn`t support!');
        }
    }

    function pollWPScanResult() {
        if(scanInProgress){
            fetch('/recon/wpscan/result')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 0) {
                        document.getElementById('reconScanLoading').style.display = 'none';
                        showResultReconWPScan(data.data);
                        scanInProgress = false;
                    } else {
                        setTimeout(pollWPScanResult, 2000);
                    }
                });
        }
    }

    function removeAnsi(str) {
        return str.replace(/\x1B\[[0-?]*[ -/]*[@-~]/g, '');
    }   

    function showResultReconWPScan(data) {
        window.latestReconResult.tool = 'wpscan';
        // Lo·∫°i b·ªè m√£ m√†u khi l∆∞u v√†o latestReconResult.data
        window.latestReconResult.data = data.map(line => removeAnsi(line));
        const container = document.getElementById('reconScanResult');
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<span class="text-danger">Kh√¥ng c√≥ k·∫øt qu·∫£.</span>';
            return;
        }
        let text = '';
        data.forEach(line => {
            text += removeAnsi(line) + '\n';
        });
        container.innerHTML = `<pre style="font-size:14px;line-height:1.5;">${text}</pre>`;
    }

    function wpscanArrayToText(arr) {
        if (!Array.isArray(arr)) return '';
        return arr.map(line => removeAnsi(line)).join('\n');
    }

        
    //=============================== Nmap =======================================
    function hander_Nmap(hostname, mode, action){
        console.log('Handle`s Nmap is processing....')
        const data ={hostname: hostname, mode:mode};
        if(action == 'start')
        {
            $.ajax({
                url: '/recon/nmap/scan',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Nmap is scaning .....");
                    pollNmapResult();
                }
                else{
                    alert('Error');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
        else{
            $.ajax({
                url: '/recon/nmap/stop',
                type: 'POST'
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Successful stop");
                    console.log(resp['msg'])
                }
                else{
                    alert('Error stop');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
    }

    function pollNmapResult() {
        if(scanInProgress){
        fetch('/recon/nmap/result')
            .then(res => res.json())
            .then(data => {
                if (data.status === 0) {
                    // ·∫®n loading khi c√≥ k·∫øt qu·∫£
                    document.getElementById('reconScanLoading').style.display = 'none';
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£, d·ª´ng polling
                    showResultReconNmap(data.data);
                    scanInProgress = false;
                } else {
                    // Ch∆∞a xong, ti·∫øp t·ª•c polling sau 2s
                    setTimeout(pollNmapResult, 2000);
                }
                //hander_Nmap(1,1,'stop');
            });
        }
    }

    function showResultReconNmap(data) {
        // L∆∞u l·∫°i k·∫øt qu·∫£ m·ªõi nh·∫•t cho nmap
        window.latestReconResult.tool = 'nmap';
        window.latestReconResult.data=data;

        if (!data || data.length === 0) {
            document.getElementById('reconScanResult').innerHTML = '<span class="text-danger">Kh√¥ng c√≥ k·∫øt qu·∫£.</span>';
            return;
        }

        let text = '';
        data.forEach((host, idx) => {
            text += `Host: ${host.host} (${host.state})\n`;
            if (host.os && host.os.length > 0) {
                text += `  OS Guess: ${host.os.map(os => `${os.name} (${os.accuracy}%)`).join(', ')}\n`;
            }
            Object.keys(host.protocols).forEach(proto => {
                text += `  Protocol: ${proto}\n`;
                host.protocols[proto].forEach(portInfo => {
                    text += `    Port ${portInfo.port}/${
                        proto
                    }  ${portInfo.state}  ${portInfo.service || ''}  ${portInfo.product || ''}  ${portInfo.version || ''}\n`;
                });
            });
            text += '\n';
        });

        document.getElementById('reconScanResult').innerHTML = `<pre style="font-size:14px;line-height:1.5;">${text}</pre>`;
    }

    function nmapArrayToText(arr) {
        if (!Array.isArray(arr)) return '';
        let text = '';
        arr.forEach((host, idx) => {
            text += `Host: ${host.host} (${host.state})\n`;
            if (host.os && host.os.length > 0) {
                text += `  OS Guess: ${host.os.map(os => `${os.name} (${os.accuracy}%)`).join(', ')}\n`;
            }
            Object.keys(host.protocols).forEach(proto => {
                text += `  Protocol: ${proto}\n`;
                host.protocols[proto].forEach(portInfo => {
                    text += `    Port ${portInfo.port}/${proto}  ${portInfo.state}  ${portInfo.service || ''}  ${portInfo.product || ''}  ${portInfo.version || ''}\n`;
                });
            });
            text += '\n';
        });
        return text;
    }


    
    //=============================== Wappalyzer =======================================
    function hander_Wappalyzer(hostname, mode, action){
        console.log('Handle`s Wappalyzer is processing....')
        const data ={hostname: hostname, mode:mode};
        if(action == 'start')
        {
            $.ajax({
                url: '/recon/wappalyzer/scan',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Wappalyzer is scaning .....");
                    pollWappalyzerResult();
                }
                else{
                    alert('Error');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
        else{
            $.ajax({
                url: '/recon/wappalyzer/stop',
                type: 'POST'
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Successful stop");
                    console.log(resp['msg'])
                }
                else{
                    alert('Error stop');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
    }

    function pollWappalyzerResult() {
        if(scanInProgress){
        fetch('/recon/wappalyzer/result')
            .then(res => res.json())
            .then(data => {
                if (data.status === 0) {
                    // ·∫®n loading khi c√≥ k·∫øt qu·∫£
                    document.getElementById('reconScanLoading').style.display = 'none';
                    // Hi·ªÉn th·ªã k·∫øt qu·∫£, d·ª´ng polling
                    showResultReconWappalyzer(data.data);
                    console.log(data.data);
                    scanInProgress = false;
                } else {
                    // Ch∆∞a xong, ti·∫øp t·ª•c polling sau 2s
                    setTimeout(pollWappalyzerResult, 2000);
                }
                //hander_Nmap(1,1,'stop');
            });
        }
    }

    function showResultReconWappalyzer(data) {
        // L∆∞u l·∫°i k·∫øt qu·∫£ m·ªõi nh·∫•t cho wappalyzer
        window.latestReconResult.tool = 'wappalyzer'
        window.latestReconResult.data = data;  // G√°n tr·ª±c ti·∫øp, kh√¥ng push
        
        let container = document.getElementById('reconScanResult');
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<span class="text-danger">Kh√¥ng c√≥ k·∫øt qu·∫£.</span>';
            return;
        }
        let text = '';
        data.forEach(item => {
            if (item.version && item.version !== 'Unknown' && item.version.trim() !== '') {
                text += `${item.technology} (v${item.version})\n`;
            } else {
                text += `${item.technology}\n`;
            }
        });
        container.innerHTML = `<pre style="font-size:14px;line-height:1.5;">${text}</pre>`;
    }

    //ƒê·∫®Y L√Ä H√ÄM CHUY·ªÇN ƒê·ªîI ƒê·ªÇ L∆ØU V√ÄO CSDL V·ªöI WAPPALYZER
    function wappalyzerArrayToText(arr) {
        if (!Array.isArray(arr)) return '';
        return arr.map(item => {
            // N·∫øu version l√† Unknown ho·∫∑c r·ªóng th√¨ ch·ªâ ghi (Unknown)
            let version = (item.version && item.version.trim() !== '' && item.version !== 'Unknown')
                ? `(v${item.version})`
                : '(Unknown)';
            // N·∫øu version l√† Unknown th√¨ kh√¥ng th√™m 'v'
            if (item.version === 'Unknown' || !item.version || item.version.trim() === '') {
                version = '(Unknown)';
            }
            return `${item.technology} ${version}`;
        }).join('\n');
    }

    //=============================== Dirsearch =======================================
    let lastDirsearchResultCount = 0;
    function hander_Dirsearch(hostname, mode, action){
        console.log('Handle`s Dirsearch is processing....')
        const data ={hostname: hostname, mode:mode};
        if(action == 'start')
        {
            $.ajax({
                url: '/recon/Dirsearch/scan',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Dirsearch is scaning .....");
                    pollDirsearchResult();
                }
                else{
                    alert('Error');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
        else{
            $.ajax({
                url: '/recon/Dirsearch/stop',
                type: 'POST'
            })
            .done((resp) => {
                if(resp['status'] === 0){
                    alert("Successful stop");
                    console.log(resp['msg'])
                }
                else{
                    alert('Error stop');
                    console.log(resp['msg'])
                }
            })
            .fail((error) => {
                alert(resp['msg']);
                console.log(`Error ${resp['msg']}`);
            });
        }
        // ... stop
    }
    
    function pollDirsearchResult(){
        if(scanInProgress){
            fetch('/recon/Dirsearch/result')
                .then(res => res.json())
                .then(data => {
                    if (data.status === 0) {
                        showResultReconDirsearch(data.data);
                        if (data.done) {
                            // ƒê√£ xong, d·ª´ng polling
                            scanInProgress = false;
                            document.getElementById('reconScanLoading').style.display = 'none';
                            alert('Dirsearch scan completed!');
                        } else {
                            setTimeout(pollDirsearchResult, 1500);
                        }
                    } /// n√ÄO R·∫¢NH TH√å TEST L·∫†I C√ÅI N√ÄY
                });
        }
    }

    function showResultReconDirsearch(data) {
        // L∆∞u l·∫°i k·∫øt qu·∫£ m·ªõi nh·∫•t cho WPScan
        window.latestReconResult.tool = 'dirsearch'
        //window.latestReconResult.data = [];  // reset m·∫£ng
        window.latestReconResult.data=data;

        const container = document.getElementById('reconScanResult');
        if (!Array.isArray(data) || data.length === 0) {
            container.innerHTML = '<span class="text-danger">Kh√¥ng c√≥ k·∫øt qu·∫£.</span>';
            return;
        }
        // L·ªçc ch·ªâ c√°c k·∫øt qu·∫£ t√¨m th·∫•y (found = true)
        const found = data.filter(item => item.found);
        if (found.length === 0) {
            container.innerHTML = '<span class="text-warning">Kh√¥ng ph√°t hi·ªán th∆∞ m·ª•c/file n√†o t·ªìn t·∫°i!</span>';
            return;
        }
        let text = '';
        found.forEach(item => {
            text += `${item.url} (Status: ${item.status_code}, Time: ${item.response_time}s)\n`;
        });
        container.innerHTML = `<pre style="font-size:14px;line-height:1.5;">${text}</pre>`;
    }

    function dirsearchArrayToText(arr) {
        if (!Array.isArray(arr)) return '';
        const found = arr.filter(item => item.found);
        if (found.length === 0) return 'Kh√¥ng ph√°t hi·ªán th∆∞ m·ª•c/file n√†o t·ªìn t·∫°i!';
        
        return found.map(item => 
            `${item.url} (Status: ${item.status_code}, Time: ${item.response_time}s)`
        ).join('\n');
    }

    




















    // G√°n n√∫t
    window.Run_Scan = startScan;
    window.Stop_Scan = stopScan;
    window.Save_Scan = saveScan;
</script>