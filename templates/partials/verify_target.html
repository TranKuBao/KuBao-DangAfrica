<!-- Additional CSS for Enhanced Styling -->
<style>
  .CodeMirror {
    font-size: 13px !important;
    min-height: 400px;
    height: 80%;
    width: 100%;
    background: #282a36;
    border-radius: 6px;
    box-sizing: border-box;
  }

  .modal-body {
    max-height: none;
    overflow-y: visible;
    overflow-x: hidden;
    /* Ch·∫∑n cu·ªôn ngang */
    padding: 1rem 1.5rem;
  }

  .modal-content {
    transition: all 0.3s ease;
  }

  .modal-content:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .modal-header {
    border-bottom: 2px solid #e9ecef;
  }

  .modal-footer {
    border-top: 2px solid #e9ecef;
  }

  .modal-header,
  .modal-footer {
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    min-height: 28px;
    align-items: center !important;
  }

  .modal-header .modal-title {
    font-size: 1.1rem;
    padding: 0;
    margin: 0;
  }

  h5.text-primary {
    font-weight: 600;
  }

  .shadow-sm {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  }

  .btn-hacker {
    font-family: 'Courier New', monospace;
    border: 1px solid #f97316;
    background-color: #FFFFFF;
    color: #f97316;
    padding: 10px 20px;
    border-radius: 4px;
    transition: all 0.3s ease;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker:hover {
    background-color: #f97316;
    color: #FFFFFF;
    box-shadow: 0 0 12px #f97316;
  }

  .btn-hacker-danger {
    border: 1px solid #ff0033;
    color: #ff0033;
    box-shadow: 0 0 5px #ff0033;
  }

  .btn-hacker-danger:hover {
    background-color: #ff0033;
    color: #000;
    box-shadow: 0 0 12px #ff0033;
  }

  .btn-hacker-warning {
    border: 1px solid #f97316;
    color: #f97316;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker-warning:hover {
    background-color: #f97316;
    color: #000;
    box-shadow: 0 0 12px #f97316;
  }

  .btn-hacker-success {
    border: 1px solid #28a745;
    color: #28a745;
    box-shadow: 0 0 5px #28a745;
  }

  .btn-hacker-success:hover {
    background-color: #28a745;
    color: #FFFFFF;
    box-shadow: 0 0 12px #28a745;
  }

  /* POC List Styling */
  .poc-list-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #fff;
  }

  .poc-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .poc-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
  }

  .poc-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
  }

  .poc-item:last-child {
    border-bottom: none;
  }

  .poc-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .poc-description {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }

  .poc-cve {
    font-size: 11px;
    color: #f97316;
    font-weight: 500;
  }

  .poc-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
  }

  .status-verified {
    background-color: #d4edda;
    color: #155724;
  }

  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-failed {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* Search and Filter Section */
  .search-filter-section {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .filter-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .filter-btn {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-btn.active {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  .filter-btn:hover {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  /* Loading Animation */
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #f97316;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  /* Target Selection */
  .target-selection {
    background: #e3f2fd;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    border-left: 4px solid #2196f3;
  }

  .target-count {
    font-weight: 600;
    color: #1976d2;
  }
</style>

<div class="modal fade" id="verifyPocWithTargetsModal" tabindex="-1" aria-labelledby="verifyPocModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow-lg" style="background-color: #f8f9fa; border-radius: 12px;">
      <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center"
        style="background-color: #e9ecef !important;">
        <h5 class="modal-title font-weight-bold" id="verifyPocModalLabel">üîç Verify Targets with POC</h5>
        <div class="d-flex gap-2" style="margin-top: 10px !important;">
          <button type="button" class="btn btn-hacker-success px-4" onclick="verifySelectedPoc()">
            <i class="fas fa-play"></i> Verify
          </button>
          <button type="button" class="btn btn-hacker px-4" onclick="saveVerificationResults()">
            <i class="fas fa-save"></i> Save
          </button>
          <button type="button" class="btn btn-hacker-danger px-4" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>

      <div class="modal-body p-4">
        <!-- Target Selection Info -->
        <div class="target-selection">
          <i class="fas fa-bullseye me-2"></i>
          <span class="target-count" id="selectedTargetCount"></span> targets selected for verification
          <div class="mt-2">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Check console for detailed target information
            </small>
          </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
          <h6 class="mb-3 text-primary">
            <i class="fas fa-search me-2"></i>Search & Select POC
          </h6>

          <div class="row">
            <div class="col-md-8">
              <div class="input-group">
                <span class="input-group-text text-body">
                  <i class="fas fa-search" aria-hidden="true"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search POC by name, CVE, or description..."
                  id="pocSearchInput" onchange="filterPocs()" />
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="pocVulTypeFilter" onchange="filterPocs()">
              </select>
            </div>
          </div>


        </div>

        <!-- POC List -->
        <div class="row">
          <div class="col-md-6">
            <h6 class="mb-3 text-primary">
              <i class="fas fa-list me-2"></i>Available POCs
            </h6>
            <div class="poc-list-container" id="pocListContainer">
              <!-- POC items will be loaded here -->
              <div class="loading-spinner" id="pocLoadingSpinner" style="display: none;">
                <div class="spinner"></div>
                <p class="mt-2">Loading POCs...</p>
              </div>
            </div>
          </div>

          <!-- Selected POC Details -->
          <div class="col-md-6">
            <h6 class="mb-3 text-primary">
              <i class="fas fa-code me-2"></i>POC Details
            </h6>
            <div id="pocDetailsContainer">
              <div class="text-center text-muted py-5">
                <i class="fas fa-arrow-left fa-2x mb-3"></i>
                <p>Select a POC from the list to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Notification -->
        <div class="alert alert-danger mt-3" id="notiErrorPoc" style="display: none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="errorMessage"></span>
        </div>

        <!-- Success Notification -->
        <div class="alert alert-success mt-3" id="notiSuccessPoc" style="display: none;">
          <i class="fas fa-check-circle me-2"></i>
          <span id="successMessage"></span>
        </div>

        <!--th√¥ng b√°o v·ªÅ k·∫øt qu·∫£ verify-->
        <div id="verifyResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for POC functionality -->
<script>
  let selectedPocId = null;
  let selectedPocPath = null;
  let currentFilter = 'all';
  let allPocs = [];
  let resp_verify = [];
  // Th√™m bi·∫øn l∆∞u k·∫øt qu·∫£ verify cho t·ª´ng target
  let verifiedReports = [];
  // Th√™m bi·∫øn to√†n c·ª•c l∆∞u danh s√°ch target t·ª´ server
  let allTargets = [];
  // Th√™m bi·∫øn l∆∞u danh s√°ch POC ƒë∆∞·ª£c ch·ªçn
  let selectedPocList = [];
  // H√†m l·∫•y danh s√°ch target t·ª´ server
  function fetchAllTargets() {
    fetch('/api/getalltarget')
      .then(res => res.json())
      .then(data => {
        allTargets = data.targets || [];
      });
  }
  // Load POCs when modal opens
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('verifyPocWithTargetsModal');
    modal.addEventListener('show.bs.modal', function () {
      fetchAllTargets();
      loadPocCategories();
      loadPocs();
      verifyUpdateTargetCount();
      verifyDisplaySelectedTargetsInfo();
    });
  });

  // Load POCs from server
  function loadPocs(search = '', page = 1) {
    const spinner = document.getElementById('pocLoadingSpinner');
    const container = document.getElementById('pocListContainer');
    if (spinner) {
      spinner.style.display = 'block';
    }
    container.innerHTML = '';
    container.appendChild(spinner);

    fetch(`/api/fetch-pocs?search=${encodeURIComponent(search)}&page=${page}&limit=100`)
      .then(response => response.json())
      .then(data => {
        allPocs = data.pocs || [];
        spinner.style.display = 'none';
        displayPocs(allPocs);
      })
      .catch(error => {
        console.error('Error loading POCs:', error);
        container.innerHTML = '<div class="text-center text-danger py-3">Error loading POCs</div>';
        spinner.style.display = 'none';
      });
  }

  // Display POCs in the list
  function displayPocs(pocs) {
    const container = document.getElementById('pocListContainer');
    container.innerHTML = '';

    if (pocs.length === 0) {
      container.innerHTML = '<div class="text-center text-muted py-3">No POCs found</div>';
      return;
    }

    pocs.forEach(poc => {
      const pocItem = document.createElement('div');
      pocItem.className = 'poc-item';
      // Checkbox cho ph√©p ch·ªçn nhi·ªÅu POC
      pocItem.innerHTML = `
      <div class="form-check" style="margin-right: 10px;">
        <input class="form-check-input poc-checkbox" type="checkbox" value="${poc.id}" data-pocid="${poc.id}" data-pocpath="${poc.path}" id="poc-checkbox-${poc.id}">
      </div>
      <div class="flex-grow-1" onclick="showPocDetails(${poc.id})">
        <div class="poc-title">${poc.name || 'Unnamed POC'}</div>
        <div class="poc-description">${poc.appversion || 'No description available'}</div>
        <div class="poc-cve">Auth: ${poc.author || 'N/A'}</div>
      </div>
      <div class="poc-status status-${poc.status || 'pending'}">
        ${poc.status || 'pending'}
      </div>
    `;

      container.appendChild(pocItem);
    });

    // S·ª± ki·ªán khi tick ch·ªçn POC
    document.querySelectorAll('.poc-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const pocId = this.getAttribute('data-pocid');
        const pocPath = this.getAttribute('data-pocpath');
        if (this.checked) {
          selectedPocList.push({id: pocId, path: pocPath});
        } else {
          selectedPocList = selectedPocList.filter(p => p.id !== pocId);
        }
      });
    });
  }

  // S·ª≠a showPocDetails ƒë·ªÉ nh·∫≠n id, t√¨m poc t·ª´ allPocs
  function showPocDetails(pocId) {
    const poc = allPocs.find(p => p.id == pocId);
    if (!poc) return;
    const container = document.getElementById('pocDetailsContainer');
    container.innerHTML = `
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">${poc.name || 'Unnamed POC'}</h6>
        <p class="card-text">${poc.references || ''}</p>
        <div class="row mb-3">
          <div class="col-6"><strong>Type:</strong> ${poc.vulType || 'N/A'}</div>
          <div class="col-6"><strong>Author:</strong> ${poc.author || 'N/A'}</div>
        </div>
        <div class="mb-3">
          <strong>Path:</strong> ${poc.path || ''}
        </div>
      </div>
    </div>
  `;
  }

  // Filter POCs
  function filterPocs() {
    const searchTerm = document.getElementById('pocSearchInput').value.toLowerCase();
    const vultypeFilter = document.getElementById('pocVulTypeFilter').value;
    console.log(vultypeFilter);
    console.log(searchTerm);
    let filteredPocs = allPocs.filter(poc => {
      const matchesSearch = !searchTerm ||
        poc.name?.toLowerCase().includes(searchTerm) ||
        poc.appname?.toLowerCase().includes(searchTerm) ||
        poc.appversion?.toLowerCase().includes(searchTerm);

      //const matchesCategory = !categoryFilter || poc.category === categoryFilter;
      const matchesVulType = !vultypeFilter || poc.vultype === vultypeFilter; // Th√™m ƒëi·ªÅu ki·ªán vultype
      const matchesStatus = currentFilter === 'all' || poc.status === currentFilter;

      return matchesSearch && matchesVulType && matchesStatus;
    });

    displayPocs(filteredPocs);
  }


  // c·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng
  async function verifyUpdateTargetCount() {
    const checkedTargets = await getCheckedTargetIds();
    const count = checkedTargets.length;
    document.getElementById('selectedTargetCount').textContent = count;

    // Hi·ªÉn th·ªã th√™m th√¥ng tin chi ti·∫øt n·∫øu c·∫ßn
    //console.log(`Modal: ƒê√£ ch·ªçn ${count} targets:`, checkedTargets);

    // C√≥ th·ªÉ th√™m hi·ªÉn th·ªã danh s√°ch target ƒë√£ ch·ªçn
    if (count > 0) {
      // V√≠ d·ª•: hi·ªÉn th·ªã danh s√°ch target IDs
      const targetList = checkedTargets.join(', ');
      //console.log(`Target IDs: ${targetList}`);
    }
  }

  // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªÅ c√°c target ƒë√£ ch·ªçn
  function verifyDisplaySelectedTargetsInfo() {
    const targetIds = getCheckedTargetIds();
    const count = targetIds.length;

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    verifyUpdateTargetCount();

    // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt trong console
    console.log('=== TH√îNG TIN TARGETS VERIFY ƒê√É CH·ªåN ===');
    console.log(`T·ªïng s·ªë: ${count} targets`);
    //console.log('Target IDs:', targetIds);

    // N·∫øu c√≥ target ƒë∆∞·ª£c ch·ªçn, hi·ªÉn th·ªã th√™m th√¥ng tin
    if (count > 0) {
      console.log('Danh s√°ch Target VERIFY IDs:', targetIds.join(', '));

      // C√≥ th·ªÉ th√™m logic ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt c·ªßa t·ª´ng target
      // V√≠ d·ª•: g·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin hostname, IP c·ªßa c√°c target
      verifyFetchTargetDetails(targetIds);
    } else {
      console.log('Ch∆∞a c√≥ target n√†o ƒë∆∞·ª£c ch·ªçn');
    }
  }

  // L·∫•y th√¥ng tin chi ti·∫øt c·ªßa c√°c target (t√πy ch·ªçn)
  function verifyFetchTargetDetails(targetIds) {
    return fetch('/api/getalltarget')
      .then(response => response.json())
      .then(data => {
        if (data.targets) {
          return data.targets.filter(target =>
            targetIds.includes(target.server_id.toString())
          ).map(target => ({
            id: target.server_id,
            hostname: target.hostname,
            ip: target.ip_address
          }));
        }
        return [];
      });
  }


  // Verify selected nhi·ªÅu POC v·ªõi nhi·ªÅu target
  async function verifySelectedPoc() {
  if (!selectedPocList || selectedPocList.length === 0) {
    showError('Please select at least one POC');
    return;
  }
  const targetIds = getCheckedTargetIds();
  if (targetIds.length === 0) {
    showError('Please select at least one target');
    return;
  }
  showSuccess('Loading POCs.........');
  let allResults = [];

  for (const poc of selectedPocList) {
    // 1. Load POC l√™n server (ch·ªù xong)
    await new Promise((resolve, reject) => {
      $.ajax({
        url: '/get-poc-info',
        type: 'POST',
        data: { poc_path: poc.path.slice(5) }
      })
      .done((resp) => {
        if (resp['status'] === 0) {
          resolve();
        } else {
          resolve(); // v·∫´n resolve ƒë·ªÉ kh√¥ng b·ªã k·∫πt
        }
      })
      .fail(() => resolve());
    });

    // 2. Verify v·ªõi t·ª´ng target (ch·ªù t·ª´ng c√°i xong)
    const targets = await verifyFetchTargetDetails(targetIds);
    for (const target of targets) {
      await new Promise((resolve, reject) => {
        $.ajax({
          url: '/api/verify-mode',
          type: 'POST',
          data: { 'target-value': target.hostname }
        })
        .done((resp) => {
          allResults.push({
            poc: poc,
            target: target.hostname,
            result: resp['data']
          });
          resolve();
        })
        .fail(() => resolve());
      });
    }
  }

  showVerifyResults(allResults);
}

  // Save verification results
  function saveVerificationResults() {
    console.log('Save clicked', verifiedReports);
    if (!verifiedReports || verifiedReports.length === 0) {
      showError('No verification results to save. Please run verification first.');
      return;
    }

    // T·∫°o modal ƒë·ªÉ ch·ªçn c√°ch xu·∫•t d·ªØ li·ªáu
    showExportOptions();
  }

  // Hi·ªÉn th·ªã c√°c t√πy ch·ªçn xu·∫•t d·ªØ li·ªáu
  function showExportOptions() {
    console.log('Hi·ªÉn th·ªã modal save c·ªßa verify');
    const exportModal = `
      <div class="modal fade" id="exportOptionsModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">üíæ Export Verification Results</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="fas fa-file-csv fa-3x text-success mb-3"></i>
                      <h6>Export to CSV</h6>
                      <p class="text-muted">Download as CSV file</p>
                      <button class="btn btn-success" onclick="exportToCSV()">
                        <i class="fas fa-download"></i> Export CSV
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="fas fa-file-json fa-3x text-warning mb-3"></i>
                      <h6>Export to JSON</h6>
                      <p class="text-muted">Download as JSON file</p>
                      <button class="btn btn-warning" onclick="exportToJSON()">
                        <i class="fas fa-download"></i> Export JSON
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                      <h6>Export to PDF</h6>
                      <p class="text-muted">Generate PDF report</p>
                      <button class="btn btn-danger" onclick="exportToPDF()">
                        <i class="fas fa-download"></i> Export PDF
                      </button>
                    </div>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <div class="card h-100">
                    <div class="card-body text-center">
                      <i class="fas fa-database fa-3x text-info mb-3"></i>
                      <h6>Save to Database</h6>
                      <p class="text-muted">Store results in database</p>
                      <button class="btn btn-info" onclick="saveToDatabase()">
                        <i class="fas fa-save"></i> Save to DB
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    // X√≥a modal c≈© n·∫øu c√≥
    const existingModal = document.getElementById('exportOptionsModal');
    if (existingModal) {
      existingModal.remove();
    }

    // Th√™m modal m·ªõi v√†o body
    document.body.insertAdjacentHTML('beforeend', exportModal);

    // Hi·ªÉn th·ªã modal
    const modal = new bootstrap.Modal(document.getElementById('exportOptionsModal'));
    modal.show();
  }

  // Xu·∫•t d·ªØ li·ªáu ra CSV
  function exportToCSV() {
    const results = verifiedReports;
    if (!results || results.length === 0) {
      showError('No data to export');
      return;
    }
    let csvContent = "POC,Target,Result,Status,Details\n";
    results.forEach(item => {
      const poc = item.poc.name || item.poc.id || 'N/A';
      const target = item.target || 'N/A';
      const result = item.result || {};
      const status = result.status || 'Unknown';
      const details = JSON.stringify(result).replace(/"/g, '""');
      csvContent += `"${poc}","${target}","${status}","${details}"\n`;
    });
    downloadFile(csvContent, 'verification_results.csv', 'text/csv');
    showSuccess('CSV file downloaded successfully!');
    closeExportModal();
  }

  // Xu·∫•t d·ªØ li·ªáu ra JSON
  function exportToJSON() {
    const results = verifiedReports;
    if (!results || results.length === 0) {
      showError('No data to export');
      return;
    }
    const jsonData = {
      verification_date: new Date().toISOString(),
      results: results
    };
    const jsonContent = JSON.stringify(jsonData, null, 2);
    downloadFile(jsonContent, 'verification_results.json', 'application/json');
    showSuccess('JSON file downloaded successfully!');
    closeExportModal();
  }

  // Xu·∫•t d·ªØ li·ªáu ra PDF (s·ª≠ d·ª•ng jsPDF)
  function exportToPDF() {
    const results = verifiedReports;
    if (!results || results.length === 0) {
      showError('No data to export');
      return;
    }
    // Ki·ªÉm tra xem jsPDF ƒë√£ ƒë∆∞·ª£c load ch∆∞a
    if (typeof jsPDF === 'undefined') {
      // Load jsPDF t·ª´ CDN
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
      script.onload = () => generatePDF(results);
      document.head.appendChild(script);
    } else {
      generatePDF(results);
    }
  }

  // T·∫°o PDF
  function generatePDF(results) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Ti√™u ƒë·ªÅ
    doc.setFontSize(20);
    doc.text('Verification Results Report', 20, 20);
    
    doc.setFontSize(12);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
    doc.text(`POC: ${selectedPocPath || 'N/A'}`, 20, 40);
    doc.text(`Total Targets: ${results.length}`, 20, 50);
    
    let yPosition = 70;
    
    results.forEach((item, index) => {
      if (yPosition > 250) {
        doc.addPage();
        yPosition = 20;
      }
      
      doc.setFontSize(14);
      doc.text(`Target ${index + 1}: ${item.target}`, 20, yPosition);
      yPosition += 10;
      
      doc.setFontSize(10);
      const result = item.result || {};
      Object.keys(result).forEach(key => {
        const value = typeof result[key] === 'object' ? JSON.stringify(result[key]) : result[key];
        doc.text(`${key}: ${value}`, 25, yPosition);
        yPosition += 5;
      });
      
      yPosition += 10;
    });
    
    doc.save('verification_results.pdf');
    showSuccess('PDF file generated successfully!');
    closeExportModal();
  }

  // L∆∞u v√†o database
  async function saveToDatabase() {
    if (!verifiedReports || verifiedReports.length === 0) {
      showError('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
      return;
    }

    // Gom k·∫øt qu·∫£ theo t·ª´ng target
    let resultsByTarget = {};
    verifiedReports.forEach(report => {
      // T√¨m ƒë√∫ng server_id t·ª´ hostname ho·∫∑c IP
      let matchedTarget = allTargets.find(t =>
        t.hostname === report.target || t.ip_address === report.target
      );
      let server_id = matchedTarget ? matchedTarget.server_id : null;
      if (!server_id) return;

      if (!resultsByTarget[server_id]) {
        resultsByTarget[server_id] = [];
      }
      resultsByTarget[server_id].push({
        poc: report.poc,
        result: report.result
      });
    });

    let serverIds = Object.keys(resultsByTarget);
    let successCount = 0;
    let failCount = 0;

    for (const server_id of serverIds) {
      let dataToSave = JSON.stringify(resultsByTarget[server_id]);
      try {
        const res = await fetch('/api/save_report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            server_id: server_id,
            tool: 'pocs',
            data_scan: dataToSave
          })
        });
        const data = await res.json();
        if (data.status === 0) {
          successCount++;
        } else {
          failCount++;
          console.error('L·ªói l∆∞u DB:', data);
        }
      } catch (err) {
        failCount++;
        console.error('L·ªói fetch:', err);
      }
    }
    showSuccess(`L∆∞u DB ho√†n t·∫•t: Th√†nh c√¥ng ${successCount}, l·ªói ${failCount}`);
    alert(`L∆∞u DB ho√†n t·∫•t: Th√†nh c√¥ng ${successCount}, l·ªói ${failCount}`);
  }

  // H√†m helper ƒë·ªÉ download file
  function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }

  // ƒê√≥ng modal export
  function closeExportModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('exportOptionsModal'));
    if (modal) {
      modal.hide();
    }
  }

  // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ ra giao di·ªán
  function showVerifyResults(results) {
    let html = '<h6>K·∫øt qu·∫£ verify:</h6><table class="table table-bordered"><thead><tr><th>POC</th><th>Target</th><th>K·∫øt qu·∫£</th></tr></thead><tbody>';
    results.forEach(item => {
      html += `<tr>
      <td>${item.poc.name || item.poc.id}</td>
      <td>${item.target}</td>
      <td><pre>${JSON.stringify(item.result, null, 1)}</pre></td>
    </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('verifyResult').innerHTML = html;
    saveVerifiedReports(results);
  }

  // H√†m l∆∞u l·∫°i k·∫øt qu·∫£ verify cho t·ª´ng target v·ªõi th√¥ng tin POC
  function saveVerifiedReports(results) {
    verifiedReports = [];
    results.forEach(item => {
      verifiedReports.push({
        poc: item.poc,
        target: item.target,
        result: item.result
      });
    });
    console.log('ƒê√£ l∆∞u verifiedReports:', verifiedReports);
  }

  // H√†m l∆∞u to√†n b·ªô verifiedReports v√†o DB
  

  // Show error message
  function showError(message) {
    const errorDiv = document.getElementById('notiErrorPoc');
    const errorMessage = document.getElementById('errorMessage');
    const successDiv = document.getElementById('notiSuccessPoc');

    errorMessage.textContent = message;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';

    // Auto hide after 5 seconds
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  // Show success message
  function showSuccess(message) {
    const successDiv = document.getElementById('notiSuccessPoc');
    const successMessage = document.getElementById('successMessage');
    const errorDiv = document.getElementById('notiErrorPoc');

    successMessage.textContent = message;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';

    // Auto hide after 3 seconds
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }

  // Load POC categories for filter
  function loadPocCategories() {
    fetch('/api/poc-categories')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('pocVulTypeFilter');
        // X√≥a c√°c option c≈© (tr·ª´ All)
        select.innerHTML = '<option value="">All Vul Type</option>';
        data.categories.forEach(cat => {
          select.innerHTML += `<option value="${cat.name}">${cat.value}</option>`;
        });
      });
  }

  // C·∫≠p nh·∫≠t th√¥ng tin target khi c√≥ thay ƒë·ªïi (c√≥ th·ªÉ g·ªçi t·ª´ trang ch√≠nh)
  function refreshTargetInfo() {
    verifyDisplaySelectedTargetsInfo();
  }
</script>

<!--V-->