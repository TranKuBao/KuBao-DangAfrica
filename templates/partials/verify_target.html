<!-- Additional CSS for Enhanced Styling -->
<style>
  .CodeMirror {
    font-size: 13px !important;
    min-height: 400px;
    height: 80%;
    width: 100%;
    background: #282a36;
    border-radius: 6px;
    box-sizing: border-box;
  }

  .modal-body {
    max-height: none;
    overflow-y: visible;
    overflow-x: hidden;
    /* Ch·∫∑n cu·ªôn ngang */
    padding: 1rem 1.5rem;
  }

  .modal-content {
    transition: all 0.3s ease;
  }

  .modal-content:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .modal-header {
    border-bottom: 2px solid #e9ecef;
  }

  .modal-footer {
    border-top: 2px solid #e9ecef;
  }

  .modal-header,
  .modal-footer {
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    min-height: 28px;
    align-items: center !important;
  }

  .modal-header .modal-title {
    font-size: 1.1rem;
    padding: 0;
    margin: 0;
  }

  h5.text-primary {
    font-weight: 600;
  }

  .shadow-sm {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  }

  .btn-hacker {
    font-family: 'Courier New', monospace;
    border: 1px solid #f97316;
    background-color: #FFFFFF;
    color: #f97316;
    padding: 10px 20px;
    border-radius: 4px;
    transition: all 0.3s ease;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker:hover {
    background-color: #f97316;
    color: #FFFFFF;
    box-shadow: 0 0 12px #f97316;
  }

  .btn-hacker-danger {
    border: 1px solid #ff0033;
    color: #ff0033;
    box-shadow: 0 0 5px #ff0033;
  }

  .btn-hacker-danger:hover {
    background-color: #ff0033;
    color: #000;
    box-shadow: 0 0 12px #ff0033;
  }

  .btn-hacker-warning {
    border: 1px solid #f97316;
    color: #f97316;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker-warning:hover {
    background-color: #f97316;
    color: #000;
    box-shadow: 0 0 12px #f97316;
  }

  .btn-hacker-success {
    border: 1px solid #28a745;
    color: #28a745;
    box-shadow: 0 0 5px #28a745;
  }

  .btn-hacker-success:hover {
    background-color: #28a745;
    color: #FFFFFF;
    box-shadow: 0 0 12px #28a745;
  }

  /* POC List Styling */
  .poc-list-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #fff;
  }

  .poc-item {
    padding: 12px 16px;
    border-bottom: 1px solid #f1f3f4;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .poc-item:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
  }

  .poc-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
  }

  .poc-item:last-child {
    border-bottom: none;
  }

  .poc-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }

  .poc-description {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }

  .poc-cve {
    font-size: 11px;
    color: #f97316;
    font-weight: 500;
  }

  .poc-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
  }

  .status-verified {
    background-color: #d4edda;
    color: #155724;
  }

  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-failed {
    background-color: #f8d7da;
    color: #721c24;
  }

  /* Search and Filter Section */
  .search-filter-section {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
  }

  .filter-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
  }

  .filter-btn {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .filter-btn.active {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  .filter-btn:hover {
    background: #f97316;
    color: white;
    border-color: #f97316;
  }

  /* Loading Animation */
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #f97316;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  /* Target Selection */
  .target-selection {
    background: #e3f2fd;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    border-left: 4px solid #2196f3;
  }

  .target-count {
    font-weight: 600;
    color: #1976d2;
  }
</style>

<div class="modal fade" id="verifyPocWithTargetsModal" tabindex="-1" aria-labelledby="verifyPocModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow-lg" style="background-color: #f8f9fa; border-radius: 12px;">
      <div class="modal-header bg-primary text-white d-flex justify-content-between align-items-center"
        style="background-color: #e9ecef !important;">
        <h5 class="modal-title font-weight-bold" id="verifyPocModalLabel">üîç Verify Targets with POC</h5>
        <div class="d-flex gap-2" style="margin-top: 10px !important;">
          <button type="button" class="btn btn-hacker-success px-4" onclick="verifySelectedPoc()">
            <i class="fas fa-play"></i> Verify
          </button>
          <button type="button" class="btn btn-hacker px-4" onclick="saveVerificationResults()">
            <i class="fas fa-save"></i> Save
          </button>
          <button type="button" class="btn btn-hacker-danger px-4" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>

      <div class="modal-body p-4">
        <!-- Target Selection Info -->
        <div class="target-selection">
          <i class="fas fa-bullseye me-2"></i>
          <span class="target-count" id="selectedTargetCount"></span> targets selected for verification
          <div class="mt-2">
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Check console for detailed target information
            </small>
          </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
          <h6 class="mb-3 text-primary">
            <i class="fas fa-search me-2"></i>Search & Select POC
          </h6>

          <div class="row">
            <div class="col-md-8">
              <div class="input-group">
                <span class="input-group-text text-body">
                  <i class="fas fa-search" aria-hidden="true"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search POC by name, CVE, or description..."
                  id="pocSearchInput" onchange="filterPocs()" />
              </div>
            </div>
            <div class="col-md-4">
              <select class="form-select" id="pocVulTypeFilter" onchange="filterPocs()">
              </select>
            </div>
          </div>


        </div>

        <!-- POC List -->
        <div class="row">
          <div class="col-md-6">
            <h6 class="mb-3 text-primary">
              <i class="fas fa-list me-2"></i>Available POCs
            </h6>
            <div class="poc-list-container" id="pocListContainer">
              <!-- POC items will be loaded here -->
              <div class="loading-spinner" id="pocLoadingSpinner" style="display: none;">
                <div class="spinner"></div>
                <p class="mt-2">Loading POCs...</p>
              </div>
            </div>
          </div>

          <!-- Selected POC Details -->
          <div class="col-md-6">
            <h6 class="mb-3 text-primary">
              <i class="fas fa-code me-2"></i>POC Details
            </h6>
            <div id="pocDetailsContainer">
              <div class="text-center text-muted py-5">
                <i class="fas fa-arrow-left fa-2x mb-3"></i>
                <p>Select a POC from the list to view details</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Notification -->
        <div class="alert alert-danger mt-3" id="notiErrorPoc" style="display: none;">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span id="errorMessage"></span>
        </div>

        <!-- Success Notification -->
        <div class="alert alert-success mt-3" id="notiSuccessPoc" style="display: none;">
          <i class="fas fa-check-circle me-2"></i>
          <span id="successMessage"></span>
        </div>

        <!--th√¥ng b√°o v·ªÅ k·∫øt qu·∫£ verify-->
        <div id="verifyResult" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for POC functionality -->
<script>
  let selectedPocId = null;
  let selectedPocPath = null;
  let currentFilter = 'all';
  let allPocs = [];
  let resp_verify = [];
  // Load POCs when modal opens
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('verifyPocWithTargetsModal');
    modal.addEventListener('show.bs.modal', function () {
      loadPocCategories();
      loadPocs();
      updateTargetCount();
      displaySelectedTargetsInfo();
    });
  });

  // Load POCs from server
  function loadPocs(search = '', page = 1) {
    const spinner = document.getElementById('pocLoadingSpinner');
    const container = document.getElementById('pocListContainer');
    if (spinner) {
      spinner.style.display = 'block';
    }
    container.innerHTML = '';
    container.appendChild(spinner);

    fetch(`/api/fetch-pocs?search=${encodeURIComponent(search)}&page=${page}&limit=100`)
      .then(response => response.json())
      .then(data => {
        allPocs = data.pocs || [];
        spinner.style.display = 'none';
        displayPocs(allPocs);
      })
      .catch(error => {
        console.error('Error loading POCs:', error);
        container.innerHTML = '<div class="text-center text-danger py-3">Error loading POCs</div>';
        spinner.style.display = 'none';
      });
  }

  // Display POCs in the list
  function displayPocs(pocs) {
    const container = document.getElementById('pocListContainer');
    container.innerHTML = '';

    if (pocs.length === 0) {
      container.innerHTML = '<div class="text-center text-muted py-3">No POCs found</div>';
      return;
    }

    pocs.forEach(poc => {
      const pocItem = document.createElement('div');
      pocItem.className = 'poc-item';
      pocItem.onclick = () => selectPoc(poc); // them c√°i s·ª± ki·ªán n√†y v√¥ ƒë·ªÉ khi ch·ªçn poc th√¨ n√≥ nh·∫£y qua b√™n ph·∫£i ƒë·∫ª verify

      pocItem.innerHTML = `
      <div class="flex-grow-1">
        <div class="poc-title">${poc.name || 'Unnamed POC'}</div>
        <div class="poc-description">${poc.appversion || 'No description available'}</div>
        <div class="poc-cve">Auth: ${poc.author || 'N/A'}</div>
      </div>
      <div class="poc-status status-${poc.status || 'pending'}">
        ${poc.status || 'pending'}
      </div>
    `;

      container.appendChild(pocItem);
    });
  }

  // Select a POC
  function selectPoc(poc) {
    selectedPocId = poc.id;
    selectedPocPath = poc.path;
    document.querySelectorAll('.poc-item').forEach(item => item.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    showPocDetails(poc);
  }

  // Show POC details
  function showPocDetails(poc) {
    const container = document.getElementById('pocDetailsContainer');
    container.innerHTML = `
    <div class="card">
      <div class="card-body">
        <h6 class="card-title">${poc.name || 'Unnamed POC'}</h6>
        <p class="card-text">${poc.references || ''}</p>
        <div class="row mb-3">
          <div class="col-6"><strong>Type:</strong> ${poc.vulType || 'N/A'}</div>
          <div class="col-6"><strong>Author:</strong> ${poc.author || 'N/A'}</div>
        </div>
        <div class="mb-3">
          <strong>Path:</strong> ${poc.path || ''}
        </div>
        <div class="d-grid">
          <button class="btn btn-hacker-success" onclick="verifySelectedPoc()">
            <i class="fas fa-play me-2"></i>Verify with Selected Targets
          </button>
        </div>
      </div>
    </div>
  `;
  }

  // Filter POCs
  function filterPocs() {
    const searchTerm = document.getElementById('pocSearchInput').value.toLowerCase();
    const vultypeFilter = document.getElementById('pocVulTypeFilter').value;
    console.log(vultypeFilter);
    console.log(searchTerm);
    let filteredPocs = allPocs.filter(poc => {
      const matchesSearch = !searchTerm ||
        poc.name?.toLowerCase().includes(searchTerm) ||
        poc.appname?.toLowerCase().includes(searchTerm) ||
        poc.appversion?.toLowerCase().includes(searchTerm);

      //const matchesCategory = !categoryFilter || poc.category === categoryFilter;
      const matchesVulType = !vultypeFilter || poc.vultype === vultypeFilter; // Th√™m ƒëi·ªÅu ki·ªán vultype
      const matchesStatus = currentFilter === 'all' || poc.status === currentFilter;

      return matchesSearch && matchesVulType && matchesStatus;
    });

    displayPocs(filteredPocs);
  }



  // Get risk color
  function getRiskColor(risk) {
    switch (risk?.toLowerCase()) {
      case 'critical': return 'danger';
      case 'high': return 'warning';
      case 'medium': return 'info';
      case 'low': return 'success';
      default: return 'secondary';
    }
  }

  // Get status color
  function getStatusColor(status) {
    switch (status?.toLowerCase()) {
      case 'verified': return 'success';
      case 'pending': return 'warning';
      case 'failed': return 'danger';
      default: return 'secondary';
    }
  }

  // c·∫≠p nh·∫≠t t·ªïng s·ªë l∆∞·ª£ng
  function updateTargetCount() {
    const checkedTargets = getCheckedTargetIds();
    const count = checkedTargets.length;
    document.getElementById('selectedTargetCount').textContent = count;

    // Hi·ªÉn th·ªã th√™m th√¥ng tin chi ti·∫øt n·∫øu c·∫ßn
    console.log(`Modal: ƒê√£ ch·ªçn ${count} targets:`, checkedTargets);

    // C√≥ th·ªÉ th√™m hi·ªÉn th·ªã danh s√°ch target ƒë√£ ch·ªçn
    if (count > 0) {
      // V√≠ d·ª•: hi·ªÉn th·ªã danh s√°ch target IDs
      const targetList = checkedTargets.join(', ');
      //console.log(`Target IDs: ${targetList}`);
    }
  }

  // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt v·ªÅ c√°c target ƒë√£ ch·ªçn
  function displaySelectedTargetsInfo() {
    const targetIds = getCheckedTargetIds();
    const count = targetIds.length;

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    updateTargetCount();

    // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt trong console
    console.log('=== TH√îNG TIN TARGETS ƒê√É CH·ªåN ===');
    console.log(`T·ªïng s·ªë: ${count} targets`);
    console.log('Target IDs:', targetIds);

    // N·∫øu c√≥ target ƒë∆∞·ª£c ch·ªçn, hi·ªÉn th·ªã th√™m th√¥ng tin
    if (count > 0) {
      console.log('Danh s√°ch Target IDs:', targetIds.join(', '));

      // C√≥ th·ªÉ th√™m logic ƒë·ªÉ l·∫•y th√¥ng tin chi ti·∫øt c·ªßa t·ª´ng target
      // V√≠ d·ª•: g·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin hostname, IP c·ªßa c√°c target
      fetchTargetDetails(targetIds);
    } else {
      console.log('Ch∆∞a c√≥ target n√†o ƒë∆∞·ª£c ch·ªçn');
    }
  }

  // L·∫•y th√¥ng tin chi ti·∫øt c·ªßa c√°c target (t√πy ch·ªçn)
  function fetchTargetDetails(targetIds) {
    return fetch('/api/getalltarget')
      .then(response => response.json())
      .then(data => {
        if (data.targets) {
          return data.targets.filter(target =>
            targetIds.includes(target.server_id.toString())
          ).map(target => ({
            id: target.server_id,
            hostname: target.hostname,
            ip: target.ip_address
          }));
        }
        return [];
      });
  }


  // Verify selected POC
  function verifySelectedPoc() {
    if (!selectedPocId || !selectedPocPath) {
      showError('Please select a POC first');
      return;
    }
    const targetIds = getCheckedTargetIds();
    if (targetIds.length === 0) {
      showError('Please select at least one target');
      return;
    }
    showSuccess('Loading POC.........');
    $.ajax({
      url: '/get-poc-info',
      type: 'POST',
      data: { poc_path: selectedPocPath.slice(5) }
    })
      .done((resp) => {

        if (resp['status'] === 0) {
          showSuccess('POC loaded, verifying...');
          //reset l·∫°i to√†n b·ªô
          window.resp_verify = [];

          // Ch·ªâ verify khi load POC th√†nh c√¥ng
          //const checkedTargets = getCheckedTargetIds();
          fetchTargetDetails(targetIds).then(list_target_verify => {
            let total = list_target_verify.length;
            window.resp_verify = [];
            for (let i = 0; i < total; i++) {
              let data = {};
              data['target-value'] = list_target_verify[i].hostname;
              // closure ƒë·ªÉ gi·ªØ ƒë√∫ng index
              ((targetName) => {
                $.ajax({
                  url: '/api/verify-mode',
                  type: 'POST',
                  data: data
                })
                  .done((resp) => {
                    if (resp['status'] === 0) {
                      showSuccess(`[+] Verification completed successfully in target ${targetName}`);
                      window.resp_verify.push({
                        target: targetName,
                        result: resp['data']
                      });
                      // Ch·ªâ show khi ƒë√£ ƒë·ªß k·∫øt qu·∫£
                      if (window.resp_verify.length === total) {
                        showVerifyResults(window.resp_verify);
                      }
                    }
                    else {
                      showError(data.message || 'Verification failed');
                    }
                  })
                  .fail((error) => {
                    console.error('Verification error:', error);
                    showError('Error during verification process');
                  });
              })(list_target_verify[i].hostname);
            }
          });
          //k·∫øt th√∫c verify v√† showw to√†n b·ªç ra cho m·ªçi ng∆∞·ªùi xem

        } else {
          showError('Error loading POC');
        }
      })
      .fail((error) => {
        showError('Error loading POC');
        console.log("Ph√°t hi·ªán l·ªói: ", error);
      });
  }

  // Save verification results
  function saveVerificationResults() {
    showSuccess('Verification results saved successfully!');
    // Close modal after a short delay
    setTimeout(() => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('verifyPocWithTargetsModal'));
      modal.hide();
    }, 1500);
  }

  // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£ ra giao di·ªán
  function showVerifyResults(results) {
    let html = '<h6>K·∫øt qu·∫£ verify:</h6><table class="table table-bordered"><thead><tr><th>Target</th><th>K·∫øt qu·∫£</th></tr></thead><tbody>';
    results.forEach(item => {
      html += `<tr><td>${item.target}</td><td><pre>${JSON.stringify(item.result, null, 2)}</pre></td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('verifyResult').innerHTML = html;
    //document.getElementById('successMessage').innerHTML = html;
  }

  // Show error message
  function showError(message) {
    const errorDiv = document.getElementById('notiErrorPoc');
    const errorMessage = document.getElementById('errorMessage');
    const successDiv = document.getElementById('notiSuccessPoc');

    errorMessage.textContent = message;
    errorDiv.style.display = 'block';
    successDiv.style.display = 'none';

    // Auto hide after 5 seconds
    setTimeout(() => {
      errorDiv.style.display = 'none';
    }, 5000);
  }

  // Show success message
  function showSuccess(message) {
    const successDiv = document.getElementById('notiSuccessPoc');
    const successMessage = document.getElementById('successMessage');
    const errorDiv = document.getElementById('notiErrorPoc');

    successMessage.textContent = message;
    successDiv.style.display = 'block';
    errorDiv.style.display = 'none';

    // Auto hide after 3 seconds
    setTimeout(() => {
      successDiv.style.display = 'none';
    }, 3000);
  }

  // Load POC categories for filter
  function loadPocCategories() {
    fetch('/api/poc-categories')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('pocVulTypeFilter');
        // X√≥a c√°c option c≈© (tr·ª´ All)
        select.innerHTML = '<option value="">All Vul Type</option>';
        data.categories.forEach(cat => {
          select.innerHTML += `<option value="${cat.name}">${cat.value}</option>`;
        });
      });
  }

  // C·∫≠p nh·∫≠t th√¥ng tin target khi c√≥ thay ƒë·ªïi (c√≥ th·ªÉ g·ªçi t·ª´ trang ch√≠nh)
  function refreshTargetInfo() {
    updateTargetCount();
    displaySelectedTargetsInfo();
  }
</script>

<!--V-->