<div class="modal fade" id="pocModal" tabindex="-1" aria-labelledby="pocModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow-lg" style="background-color: #f8f9fa; border-radius: 12px;">
      <div class="modal-header bg-primary text-white" style="background-color: #e9ecef !important;">
        <h5 class="modal-title font-weight-bold" id="pocModalLabel">Proof of Concept (POC)</h5>
        <button type="button" class="btn btn-hacker-danger px-4 ms-auto" data-bs-dismiss="modal"
          style="margin-top: 10px !important;">✖ Close</button>
      </div>
      <div class="modal-body p-4">
        <div class="row">
          <!-- Target Options -->
          <div class="col-md-6 p-3 bg-white rounded shadow-sm mb-3">
            <h5 class="mb-3 text-primary">Target Options</h5>
            <div class="form-group" style="position: relative;">
              <label for="target-value" class="col-form-label font-weight-semibold">Target URL</label>
              <div class="input-group align-items-center">
                <input type="text" class="form-control" id="target-value" placeholder="Enter target URL" autocomplete="off" />
                <button class="btn btn-outline-secondary" type="button" id="btn-select-target" style="margin-top: 15px !important;">
                  <i class="fa fa-list"></i> Chọn Target
                </button>
              </div>
              <div id="dropdown-targets" class="dropdown-menu" style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 9999;"></div>
            </div>
            <div class="form-group" style="display: none;">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="chkBoxFileTarget" />
                <label class="form-check-label" for="chkBoxFileTarget">Target from File</label>
              </div>
              <!--<input type="file" id="multiFiles" name="files[]" multiple="multiple" />-->
            </div>
            <div class="form-group">
              <label for="rport-value" class="col-form-label font-weight-semibold">Remote Port (RPORT)</label>
              <input type="text" class="form-control" id="rport-value" placeholder="Enter remote port" />
            </div>
          </div>

          <!-- Module Options -->
          <div class="col-md-6 p-3 bg-white rounded shadow-sm mb-3">
            <h5 class="mb-3 text-primary">Module Options</h5>
            <div id="dynamic-options">
            <!---->
            </div>
          </div>

          <!-- Listening Address -->
        <div class="col-md-6 p-3 bg-white rounded shadow-sm mb-3">
            <h5 class="mb-3 text-primary">Listening Address</h5>
            <div class="form-group">
              <label for="lhost-value" class="col-form-label font-weight-semibold">Local Host (LHOST)</label>
              <input type="text" class="form-control" id="lhost-value" placeholder="Enter local host" />
            </div>
            <div class="form-group">
              <label for="lport-value" class="col-form-label font-weight-semibold">Local Port (LPORT)</label>
              <input type="text" class="form-control" id="lport-value" placeholder="Enter local port" />
            </div>
         </div>
        
      </div>

        <!-- Result Section -->
        <div class="row p-3">
          <div class="col-12 bg-light rounded p-3" id="result">
            <h6 class="text-muted" id="h6-output-result">Results will appear here...</h6>
            <p class="text-muted" id="output-result"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background-color: #FFFFFF;">
        <div class="d-flex justify-content-center flex-wrap w-100 gap-2">
          <button type="button" class="btn btn-hacker mx-2 px-4" id="btn-verify" onclick="verify_click()">
            ▷ Verify
          </button>
          <button type="button" class="btn btn-hacker-warning mx-2 px-4" id="btn-attack" onclick="attack_click()">
            ⚠ Attack
          </button>
          <button type="button" class="btn btn-hacker mx-2 px-4" id="btn-shell" onclick="shell_click()">
            ⛓ Shell
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Additional CSS for Enhanced Styling -->
<style>
  #target-value,
  #btn-select-target {
    height: 40px !important;
    box-sizing: border-box;
  }

  #target-value {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }

  #btn-select-target {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
    padding-top: 0;
    padding-bottom: 0;
    font-weight: 500;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .input-group:focus-within {
    box-shadow: none !important;
    border-color: #ced4da !important;
  }



  .input-group {
    width: 100%;
  }
  .modal-content {
    transition: all 0.3s ease;
  }

  .modal-content:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-2px);
  }

  .modal-header {
    border-bottom: 2px solid #e9ecef;
  }

  .modal-footer {
    border-top: 2px solid #e9ecef;
  }

  .modal-header {
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    min-height: 28px;
    align-items: center !important;
  }

  h5.text-primary {
    font-weight: 600;
  }

  .shadow-sm {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  }

  .btn-hacker {
    font-family: 'Courier New', monospace;
    border: 1px solid #fff;
    background-color: #f97316;
    color: #fff;
    padding: 10px 20px;
    border-radius: 4px;
    transition: all 0.3s ease;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker:hover {
    background-color: #f97316;
    color: #000;
    box-shadow: 0 0 12px #f97316;
  }

  .btn-hacker-danger {
    border: 1px solid #ff0033;
    color: #ff0033;
    box-shadow: 0 0 5px #ff0033;
  }

  .btn-hacker-danger:hover {
    background-color: #ff0033;
    color: #000;
    box-shadow: 0 0 12px #ff0033;
  }

  .btn-hacker-warning {
    border: 1px solid #f97316;
    color: #f97316;
    box-shadow: 0 0 5px #f97316;
  }

  .btn-hacker-warning:hover {
    background-color: #f97316;
    color: #000;
    box-shadow: 0 0 12px #f97316;
  }
</style>

<script>
  // Lấy data để request
  function getAllInputData() {
    const data = {};
    // Lấy các trường động
    document.querySelectorAll('#dynamic-options input').forEach(input => {
      const key = input.id.replace('opt-', '');
      data[key + '-value'] = input.value;
    });
    // Lấy các trường đặc biệt nếu cần
    data['target-value'] = document.getElementById('target-value').value;
    data['rport-value'] = document.getElementById('rport-value').value;

    //data['lhost-value'] = document.getElementById('lhost-value').value || 0.0.0.0;
    //data['lport-value'] = document.getElementById('lport-value').value || 1337;

    // ... các trường khác nếu có
    console.log("data's option",data);
    return data;
  }

  

  //gọi API verify
  function verify_click() {
    data_input = getAllInputData();

    showAlertSuccess('Is verifing the target...  ');

    $.ajax({
      url: '/api/verify-mode',
      type: 'POST',
      data: data_input,
      beforeSend: function() {
            // Show loading state
            document.getElementById('h6-output-result').innerHTML = "IS Checking the target...  ";
            document.getElementById('h6-output-result').style.backgroundColor = "#00ff2aff";
            document.getElementById('output-result').innerHTML = "";
        }
    })
    .done((resp)=>{
      console.log("STATUS:",resp['status']);
      console.log('Dữ liệu',resp['data'] );
      alert(resp['data']['Message']);
      document.getElementById('h6-output-result').style.backgroundColor = "#e3e3e7";
      document.getElementById('h6-output-result').innerHTML = "------------------------Result for POC------------------------";

      // Xử lý kết quả trả về
      let html = '';
      if (resp['data']) {
        // Nếu là object, hiển thị từng key-value
        for (const key in resp['data']) {
          if (typeof resp['data'][key] === 'object') {
            html += `<b>${key}:</b><br>`;
            for (const subkey in resp['data'][key]) {
              html += `&nbsp;&nbsp;${subkey}: ${resp['data'][key][subkey]}<br>`;
            }
          } else {
            html += `<b>${key}:</b> ${resp['data'][key]}<br>`;
          }
        }
      } else {
        html = 'No result';
      }
      document.getElementById('output-result').innerHTML = html;

    })
    .fail((error) =>{
      showAlertError(error);
      console.log("Phát hiện lỗi: ",error)
    });

  }

  //gọi API verify
  function attack_click() {
    data_input = getAllInputData();

    showAlertSuccess('Is attacking the target...  ');

    $.ajax({
      url: '/api/attack-mode',
      type: 'POST',
      data: data_input,
      beforeSend: function() {
            // Show loading state
            document.getElementById('h6-output-result').innerHTML = "IS starting attack the target...  ";
            document.getElementById('h6-output-result').style.backgroundColor = "#00ff2aff";
            document.getElementById('output-result').innerHTML = "";
        }
    })
    .done((resp)=>{
      console.log("STATUS:",resp['status']);
      console.log('Dữ liệu',resp['data'] );
      alert(resp['data']['Message']);
      document.getElementById('h6-output-result').style.backgroundColor = "#e3e3e7";
      document.getElementById('h6-output-result').innerHTML = "------------------------Result for POC------------------------";

      // Xử lý kết quả trả về
      let html = '';
      if (resp['data']) {
        // Nếu là object, hiển thị từng key-value
        for (const key in resp['data']) {
          if (typeof resp['data'][key] === 'object') {
            html += `<b>${key}:</b><br>`;
            for (const subkey in resp['data'][key]) {
              html += `&nbsp;&nbsp;${subkey}: ${resp['data'][key][subkey]}<br>`;
            }
          } else {
            html += `<b>${key}:</b> ${resp['data'][key]}<br>`;
          }
        }
      } else {
        html = 'No result';
        showAlertSuccess('No result found for this POC');
      }
      document.getElementById('output-result').innerHTML = html;

    })
    .fail((error) =>{
      console.log("Phát hiện lỗi: ",error);
      showAlertError(error);
    });
  }

  // Hàm tự động khởi động shell trong background
  function startShellInBackground(shellId) {
    console.log('Starting shell in background:', shellId);
    
    $.ajax({
      url: `/api/shells/${shellId}/start`,
      type: 'POST',
      success: function(resp) {
        console.log('Shell started successfully:', resp);
        showAlertSuccess('Shell listener started successfully!');
      },
      error: function(xhr, status, error) {
        console.error('Failed to start shell:', error);
        showAlertError('Failed to start shell listener. You can start it manually from the shell management page.');
      }
    });
  }

  // Hàm copy shell connection info
  function copyShellInfo(shellId, lhost, lport) {
    const info = `Shell ID: ${shellId}\nLocal IP: ${lhost}\nLocal Port: ${lport}\nConnection URL: ${window.location.origin}/shells/${shellId}`;
    
    if (navigator.clipboard) {
      navigator.clipboard.writeText(info).then(() => {
        showAlertSuccess('Shell connection info copied to clipboard!');
      }).catch(() => {
        // Fallback nếu clipboard API không hoạt động
        fallbackCopyTextToClipboard(info);
      });
    } else {
      fallbackCopyTextToClipboard(info);
    }
  }

  // Fallback copy function
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      document.execCommand('copy');
      showAlertSuccess('Shell connection info copied to clipboard!');
    } catch (err) {
      showAlertError('Failed to copy to clipboard');
    }
    
    document.body.removeChild(textArea);
  }

  // Hàm lấy LHOST/LPORT từ shell đã có
  function getExistingShellInfo() {
    return new Promise((resolve, reject) => {
      $.ajax({
        url: '/api/shells',
        type: 'GET',
        success: function(resp) {
          if (resp.shells && resp.shells.length > 0) {
            // Tìm shell đang listening
            const listeningShell = resp.shells.find(s => s.status === 'listening');
            if (listeningShell) {
              resolve({
                lhost: listeningShell.local_ip,
                lport: listeningShell.local_port
              });
            } else {
              resolve(null);
            }
          } else {
            resolve(null);
          }
        },
        error: function() {
          resolve(null);
        }
      });
    });
  }

  // Hàm tự động điền LHOST/LPORT
  async function autoFillShellInfo() {
    const shellInfo = await getExistingShellInfo();
    if (shellInfo) {
      document.getElementById('lhost-value').value = shellInfo.lhost;
      document.getElementById('lport-value').value = shellInfo.lport;
      console.log(`Auto-filled shell info: ${shellInfo.lhost}:${shellInfo.lport}`);
    }
  }

  // Tự động điền khi modal mở
  $('#pocModal').on('show.bs.modal', function() {
    autoFillShellInfo();
  });

  //gọi API verify
  function shell_click() {
    const data = getAllInputData();
    let lhost = document.getElementById('lhost-value').value;
    let lport = document.getElementById('lport-value').value;

    // Nếu không có LHOST/LPORT, thử lấy từ shell đã có
    if (!lhost || !lport) {
      console.log('LHOST/LPORT not provided, checking for existing shells...');
      getExistingShellInfo().then(shellInfo => {
        if (shellInfo) {
          lhost = shellInfo.lhost;
          lport = shellInfo.lport;
          document.getElementById('lhost-value').value = lhost;
          document.getElementById('lport-value').value = lport;
          console.log(`Using existing shell: ${lhost}:${lport}`);
        }
      });
    }
    
    // Validate LHOST/LPORT
    if (!lhost || !lport) {
      showAlertError('Please provide LHOST and LPORT values');
      return;
    }
    
    if (lport < 1 || lport > 65535) {
      showAlertError('LPORT must be between 1 and 65535');
      return;
    }
    
    // Append lhost và lport vào data object
    data['lhost-value'] = lhost;
    data['lport-value'] = lport;

    showAlertSuccess('Starting shell mode...');

    $.ajax({
      url: '/api/shell-mode',
      type: 'POST',
      data: data,
      beforeSend: function() {
            // Show loading state
            document.getElementById('h6-output-result').innerHTML = "Starting shell in the target...  ";
            document.getElementById('h6-output-result').style.backgroundColor = "#00ff2aff";
            document.getElementById('output-result').innerHTML = "";
        }
    })
    .done((resp)=>{
      console.log("STATUS:",resp['status']);
      console.log('Dữ liệu',resp['data'] );
      
      if (resp['status'] === 0) {
        showAlertSuccess(resp['data']['Message']);
        
        // Cập nhật LHOST/LPORT nếu server trả về giá trị khác
        if (resp['data']['lhost'] && resp['data']['lport']) {
          document.getElementById('lhost-value').value = resp['data']['lhost'];
          document.getElementById('lport-value').value = resp['data']['lport'];
        }
        
        // Tự động khởi động shell nếu có shell_id
        if (resp['data']['shell_id']) {
          console.log('Auto-starting shell:', resp['data']['shell_id']);
          startShellInBackground(resp['data']['shell_id']);
        }
      } else {
        showAlertError(resp['msg'] || 'Shell mode failed');
      }
      
      document.getElementById('h6-output-result').innerHTML = "------------------------Shell Connection Information------------------------"; 
      document.getElementById('h6-output-result').style.backgroundColor = "#e3e3e7";

      // Xử lý kết quả trả về với thông tin chi tiết
      let html = '';
      if (resp['data']) {
        // Hiển thị thông tin shell connection
        if (resp['data']['connection_info']) {
          const conn = resp['data']['connection_info'];
          html += `<div class="alert alert-success mb-3">
            <h6><i class="fas fa-terminal me-2"></i>Shell Connection Established</h6>
            <div class="row">
              <div class="col-md-6">
                <strong>Shell ID:</strong> ${conn.shell_id}<br>
                <strong>Name:</strong> ${conn.name}<br>
                <strong>Type:</strong> ${conn.type}<br>
                <strong>Status:</strong> <span class="badge bg-success">${conn.status}</span>
              </div>
              <div class="col-md-6">
                <strong>Local IP:</strong> ${conn.local_ip}<br>
                <strong>Local Port:</strong> ${conn.local_port}<br>
                <strong>Created:</strong> ${conn.created_at ? new Date(conn.created_at).toLocaleString() : 'N/A'}
              </div>
            </div>
            <div class="mt-3">
              <a href="${resp['data']['shell_url']}" class="btn btn-primary btn-sm" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i>Open Shell Terminal
              </a>
              <button class="btn btn-info btn-sm ms-2" onclick="copyShellInfo('${conn.shell_id}', '${conn.local_ip}', '${conn.local_port}')">
                <i class="fas fa-copy me-1"></i>Copy Connection Info
              </button>
            </div>
          </div>`;
        }
        
        // Hiển thị các thông tin khác
        for (const key in resp['data']) {
          if (key !== 'connection_info' && typeof resp['data'][key] === 'object') {
            html += `<div class="mb-2"><b>${key}:</b><br>`;
            for (const subkey in resp['data'][key]) {
              html += `&nbsp;&nbsp;${subkey}: ${resp['data'][key][subkey]}<br>`;
            }
            html += `</div>`;
          } else if (key !== 'connection_info' && key !== 'shell_url') {
            html += `<div class="mb-2"><b>${key}:</b> ${resp['data'][key]}</div>`;
          }
        }
      } else {
        html = '<div class="alert alert-warning">No result</div>';
      }
      document.getElementById('output-result').innerHTML = html;
    })
    .fail((error) =>{
      console.log("Phát hiện lỗi: ",error);
      showAlertError('Failed to start shell mode. Please check your network connection and try again.');
    });  
    
  }

  // Khi bấm nút Chọn, hiện dropdown các target từ API mới
  $('#btn-select-target').on('click', function() {
    // Hiển thị loading state
    $('#dropdown-targets').html('<div class="dropdown-item text-center"><i class="fa fa-spinner fa-spin"></i> Loading targets...</div>').show();
    
    $.ajax({
      url: '/api/getalltarget',
      type: 'GET',
      beforeSend: function() {
        console.log('Đang gọi API getalltarget...');
      },
      success: function(resp) {
        console.log('API Response:', resp);
        let html = '';
        
        if (resp.targets && resp.targets.length > 0) {
          resp.targets.forEach(t => {
            // Escape special characters để tránh lỗi JavaScript
            const safeHostname = t.hostname.replace(/'/g, "\\'").replace(/"/g, '\\"');
            const displayText = `${t.hostname} (${t.ip_address})`;
            html += `<a class='dropdown-item' href='#' onclick="selectTarget('${safeHostname}')">${displayText}</a>`;
          });
          console.log(`Loaded ${resp.targets.length} targets`);
        } else {
          html = '<div class="dropdown-item text-muted">No targets found</div>';
          console.log('No targets found in response');
        }
        
        $('#dropdown-targets').html(html);
      },
      error: function(xhr, status, error) {
        console.error('Error fetching targets:', error);
        console.error('Status:', status);
        console.error('Response:', xhr.responseText);
        
        let errorMessage = 'Error loading targets';
        try {
          const errorData = JSON.parse(xhr.responseText);
          if (errorData.error) {
            errorMessage = errorData.error;
          }
        } catch (e) {
          // Ignore JSON parse error
        }
        
        $('#dropdown-targets').html(`<div class="dropdown-item text-danger">${errorMessage}</div>`);
      }
    });
  });

  // Hàm chọn target
  function selectTarget(val) {
    console.log('Selected target:', val);
    $('#target-value').val(val);
    $('#dropdown-targets').hide();
    
    // Thêm visual feedback
    $('#target-value').addClass('border-success');
    setTimeout(() => {
      $('#target-value').removeClass('border-success');
    }, 1000);
  }

  // Ẩn dropdown khi click ngoài
  $(document).on('click', function(e) {
    if (!$(e.target).closest('#btn-select-target, #dropdown-targets').length) {
      $('#dropdown-targets').hide();
    }
  });

  // Thêm keyboard navigation cho dropdown
  $(document).on('keydown', function(e) {
    if (e.key === 'Escape') {
      $('#dropdown-targets').hide();
    }
  });

  // Thêm loading state cho button
  $('#btn-select-target').on('click', function() {
    const $btn = $(this);
    const originalText = $btn.html();
    $btn.html('<i class="fa fa-spinner fa-spin"></i> Loading...').prop('disabled', true);
    
    // Re-enable button after a delay
    setTimeout(() => {
      $btn.html(originalText).prop('disabled', false);
    }, 3000);
  });
</script>