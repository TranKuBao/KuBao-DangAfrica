{% extends "layouts/base.html" %} {% block content %}
<head>
  <style>
    .pagination-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }

    .page-item {
      width: 40px;
      height: 40px;
      margin: 0 5px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #495057;
      border: none;
    }

    .page-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px #FFFFFF;
      background: linear-gradient(135deg, #f97316 0%,rgb(255, 255, 255) 100%);
      color: white !important;
    }

    .page-item.active {
      background: linear-gradient(135deg, #f97316 0%,rgb(255, 255, 255) 100%);
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .page-item.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .content-area {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin: 20px 0;
      min-height: 300px;
    }

    .page-info {
      text-align: center;
      margin: 20px 0;
      color: #6c757d;
      font-size: 14px;
    }

    .nav-button {
      background: linear-gradient(135deg, #f97316 0%, #f97000 100%);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 0 5px;
    }

    .nav-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .demo-content {
      display: none;
    }

    .demo-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .settings-panel {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .setting-row {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .setting-row label {
      min-width: 120px;
      font-weight: 500;
    }

    .setting-row input,
    .setting-row select {
      padding: 5px 10px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }




    .btn-orange {
      margin-top: 10px;
      background: linear-gradient(135deg, #f97316 0%, #f97000 100%);
      color: #fff !important;
      border: none;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(249, 115, 22, 0.15);
      transition: all 0.2s;
    }
    .btn-orange:hover, .btn-orange:focus {
      background: linear-gradient(135deg, #f97000 0%, #f97316 100%);
      color: #fff !important;
      box-shadow: 0 4px 16px rgba(249, 115, 22, 0.25);
}
  </style>
</head>
<div class="container-fluid py-4">
  <!--các tag tổng thống kê-->  
  {% include "partials/header-statictical.html"%}
  
  

  <!--table hiển thị list Mục tiêu ở đây-->
  <div class="row my-3">
    <div class="col-12">
      
      <div class="card mb-4">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-6 d-flex align-items-center">
              <div class="row">
                <h6 class="mb-0">List_POCs</h6>
                <div class="col-6 d-flex align-items-center" style="width:100% !important; margin-top:10px !important;">
                  <div class="input-group" >
                    <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
                    <input
                      type="text"
                      class="form-control"
                      placeholder="Tìm kiếm ..."
                      id="id_search_poc"/>
                  </div>
                </div>
                <div class="col-6 text-end"><!--có thể thêm cái nút vô đây--></div>
              </div>
            </div>
            <div class="col-6 text-end">
              <a class="col-lg-3 btn bg-gradient-dark mb-0" id="btn-addpocs"><i class="fas fa-plus"></i>&nbsp;&nbsp;Add POC</a>
              <!-- Thêm POC ở chỗ add file này-->
              <div class="card p-3 text-end" id="card-addpoc" hidden style="box-shadow: 0 0 0 2px #ececec !important; margin-top:10px;">
                      <label class="form-control-label" for="input-last-name"
                        >File POC</label
                      >
                      <input
                        type="file"
                        id="id-file-poc"
                        class="form-control d-inline-block"
                        accept=".py" 
                        style="width:70%; border: 2px solid rgba(0, 0, 0, 0.541);"
                      />
                      <button type="button" class="btn btn-orange bg-gradient" onclick="upload_new_poc()" style="background-color: #f97316 !important;">
                        <i class="fas fa-plus"></i>&nbsp;&nbsp;Upload_POC
                      </button>
              </div>                    
            </div>
          </div>
        </div>
        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              
              <thead>
                <tr>
                  <th
                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"              >
                    Name POC
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2"  style="width: 400px; min-width: 120px;"  >
                    Vulnerable version
                  </th>
                  <th
                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"                  >
                    Platform
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder text-center opacity-7 ps-2"
                  >
                    Author-Refer
                  </th>
                  <th class="text-secondary opacity-7"></th>
                </tr>
              </thead>
              
              <tbody id="POCTableBody" >
                <!--Hiển thị list POC ở đây-->
                {% include "pocs/partial-list-pocs.html"%}
              </tbody>
              
            </table>
          </div>
        </div>
        <!--bắt đầu row phân trang-->
        <!-- Phân trang -->
        <div class="card-header pb-0 p-3" style="margin-bottom: 20px !important">
            <div class="row">
                <div class="col-12 d-flex align-items-center" style="display: flex !important; justify-content: center !important;">
                    
                    <!-- Nút Previous -->
                    <button class="nav-button" id="prevBtn" onclick="goToPage(currentPage - 1)" >
                        ‹ Trước
                    </button>

                    <!-- Container các trang -->
                    <div id="paginationContainer" style="display: flex; align-items: center;">
                        <!-- Các số trang sẽ được tạo bằng JavaScript -->
                    </div>

                    <!-- Nút Next -->
                    <button class="nav-button" id="nextBtn" onclick="goToPage(currentPage + 1)" > 
                        Sau ›
                    </button>

                </div>            
            </div>
        </div>

        <!-- Thông tin trang -->
        <div class="page-info">
            Trang <span id="currentPageInfo">1</span> / <span id="totalPagesInfo">5</span>
        </div>
        <!--Kết thúc row phân trang-->
      </div>
    </div>
  </div>
</div>

{% include "poc/use-poc.html"%}


<!--Phân trang-->
<script>
  let currentPage = 1;
  let totalPages = {{ total_pages|default(1) }};
  let visiblePages = 5;

  function initPagination() {
    updatePaginationDisplay();
    updateNavigationButtons();
    updatePageInfo();
    showContent(currentPage, document.getElementById("id_search_poc").value);
  }

  function showContent(page, searchInput = "") {
    let url = `/api/fetch-pocs?page=${page}`;
    if (searchInput.trim()) {
      url += `&search=${encodeURIComponent(searchInput.trim())}`;
    }

    document.querySelector("#POCTableBody").innerHTML = '<tr><td colspan="6">Đang tải...</td></tr>';

    fetch(url)
      .then((response) => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
      })
      .then((data) => {
        if (data.total_pages !== undefined) {
          totalPages = data.total_pages;
        }
        document.querySelector("#POCTableBody").innerHTML = data.html;
        updatePaginationDisplay();
        updateNavigationButtons();
        updatePageInfo();
      })
      .catch((error) => {
        console.error("Lỗi khi tải danh sách pocs:", error);
        document.querySelector("#POCTableBody").innerHTML = '<tr><td colspan="6">Lỗi tải dữ liệu</td></tr>';
      });
  }

  function goToPage(page) {
    if (!page || isNaN(page) || page < 1 || page > totalPages || page === currentPage) return;

    const searchValue = document.getElementById("id_search_poc").value;
    currentPage = page;
    showContent(page, searchValue);
  }

  function addPageButton(pageNum) {
    const container = document.getElementById("paginationContainer");
    const button = document.createElement("div");
    button.className = `page-item ${pageNum === currentPage ? "active" : ""}`;
    button.innerHTML = `<span>${pageNum}</span>`;
    button.onclick = () => goToPage(pageNum);
    container.appendChild(button);
  }

  function addEllipsis() {
    const container = document.getElementById("paginationContainer");
    const ellipsis = document.createElement("div");
    ellipsis.className = "page-item disabled";
    ellipsis.innerHTML = "<span>...</span>";
    container.appendChild(ellipsis);
  }

  function updatePaginationDisplay() {
    const container = document.getElementById("paginationContainer");
    container.innerHTML = "";

    let startPage, endPage;
    const halfVisible = Math.floor(visiblePages / 2);

    if (totalPages <= visiblePages) {
      startPage = 1;
      endPage = totalPages;
    } else if (currentPage <= halfVisible) {
      startPage = 1;
      endPage = visiblePages;
    } else if (currentPage >= totalPages - halfVisible) {
      startPage = totalPages - visiblePages + 1;
      endPage = totalPages;
    } else {
      startPage = currentPage - halfVisible;
      endPage = currentPage + halfVisible;
    }

    if (startPage > 1) {
      addPageButton(1);
      if (startPage > 2) addEllipsis();
    }

    for (let i = startPage; i <= endPage; i++) {
      addPageButton(i);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) addEllipsis();
      addPageButton(totalPages);
    }
  }

  function updateNavigationButtons() {
    document.getElementById("prevBtn").disabled = currentPage === 1;
    document.getElementById("nextBtn").disabled = currentPage === totalPages;
  }

  function updatePageInfo() {
    document.getElementById("currentPageInfo").textContent = currentPage;
    document.getElementById("totalPagesInfo").textContent = totalPages;
  }

  // Tìm kiếm realtime có debounce
  function debounce(func, delay) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  document.addEventListener("DOMContentLoaded", function () {
    initPagination();

    const searchInput = document.getElementById("id_search_poc");
    searchInput.addEventListener("input", debounce(function () {
      currentPage = 1;
      showContent(currentPage, this.value);
    }, 400));

    searchInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") {
        currentPage = 1;
        showContent(currentPage, this.value);
      }
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "ArrowLeft") goToPage(currentPage - 1);
      else if (e.key === "ArrowRight") goToPage(currentPage + 1);
    });
  });

</script>

<!--Script button hiên thị tham POC-->
<script>
  function on_off_addic() {
    if (document.getElementById("card-addpoc").hidden == true) {
      document.getElementById("card-addpoc").hidden = false;
      document.getElementById("btn-addpocs").innerHTML =
        '<i class="fas fa-minus"></i>&nbsp;&nbsp;Hide Form';
    } else {
      document.getElementById("card-addpoc").hidden = true;
      document.getElementById("btn-addpocs").innerHTML =
        '<i class="fas fa-plus"></i>&nbsp;&nbsp;Add POC';
    }
  }
  document
    .getElementById("btn-addpocs")
    .addEventListener("click", function (event) {
      event.preventDefault();
      console.log("Nút thêm POCs đã được nhấn");
      on_off_addic();
    });
</script>

<!-- upload new POC-->
<script>
  //debug file thôi
  const file_poc = document.getElementById('id-file-poc');

  file_poc.addEventListener('change', function () {
    const file = this.files[0]; // Lấy file đầu tiên (nếu có)
    if (file) {
      console.log("Tên file:", file.name);
      console.log("Dung lượng:", file.size, "bytes");
      console.log("Kiểu:", file.type);
    } else {
      console.log("Chưa chọn file.");
    }
  });

  function upload_new_poc(){
    //lấy file
    const file_poc = document.getElementById('id-file-poc');

    const file = file_poc.files[0]; // Lấy file đầu tiên (nếu có)
    if (!file) {
      alert("Chưa chọn file.");
      return;
    } 

    const filename = file.name;
    const extendsion = filename.split('.').pop().toLowerCase();

    if(extendsion !== 'py'){
      alert("Chỉ cho phép file python !!!!");
      return;
    }

    const formdata = new FormData();
    formdata.append('poc_file',file);

    $.ajax({
      url:'/api/upload-poc',
      type: "POST",
      data: formdata,
      contentType: false,
      processData:false,
    })
    .done((resp)=>{
      if(resp['status'] === 0){
        alert(resp['msg']);
      }
      else{
        alert(resp['msg']);
      }
    })
    .fail((error)=>{
      console.log('Lỗi: ',error);
      alert(error);
    });
    return;

  }
</script>

{% endblock content %} {% block extra_js %}







<script src="{{ url_for('static', filename='assets/js/plugins/chartjs.min.js') }}"></script>

{% endblock extra_js %}
