{% for target in targets %}
                <tr>                  
                  <td class="align-middle text-center">
                    <input type="checkbox" class="row-checkbox m-0"
                           style="
                             width: 18px;
                             height: 18px;
                             cursor: pointer;
                             border: 2px solid #c9c2c2;
                             border-radius: 4px;
                             accent-color: #f97316;
                             color: #fff;
                             transition: all 0.2s ease;
                           "
                           data-target-id="{{target.server_id}}"
                           onchange="onTargetCheckboxChange(this)">
                  </td>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <!-- ảnh hệ điều hành -->
                        <img                          
                          src="{{ url_for('static', filename='assets/img/targetsecurity.png') }}" 
                          class="avatar avatar-sm me-3"
                        />
                      
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">
                          <a href="{{ 'http://' + target.hostname if not target.hostname.startswith('http') else target.hostname }}" target="_blank">
                          {{ target.hostname }}
                          </a>
                        </h6> 
                        <p class="text-xs text-secondary mb-0">
                          IP: {{ target.ip_address }}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">{{ target.server_type }}</p>
                    <p class="text-xs text-secondary mb-0">
                      OS: {{ target.os }}
                    </p>
                  </td>
                  <td class="align-middle text-center text-sm">
                    <span 
                      data-status-span="{{ target.server_id }}" 
                      data-url-status="{{ target.hostname }}" 
                      class="badge badge-sm bg-gradient-warning"
                    >
                      Checking...
                    </span>
                    <p class="text-xs text-secondary mb-0" data-status-code="{{ target.server_id }}"></p>
                  </td>
                  <td>
                    {% set poc_info = target.exploitation_level.split('/') if target.exploitation_level else ['0', '0'] %}
                    {% set poc_verified = poc_info[0]|int if poc_info|length > 0 else 0 %}
                    {% set poc_total = poc_info[1]|int if poc_info|length > 1 else 0 %}
                    
                    {% if poc_verified > 0 %}
                      <span 
                        data-status-span="{{ target.server_id }}" 
                        data-url-status="{{ target.hostname }}" 
                        class="badge badge-sm bg-gradient-success"
                      >
                        <i class="fas fa-check-circle me-1"></i>Checked
                      </span>
                    {% else %}
                      <span 
                        data-status-span="{{ target.server_id }}" 
                        data-url-status="{{ target.hostname }}" 
                        class="badge badge-sm bg-gradient-warning"
                      >
                        <i class="fas fa-clock me-1"></i>Not-Tested
                      </span>
                    {% endif %}
                    
                    <p class="text-xs text-secondary mb-0">
                      <i class="fas fa-shield-alt me-1"></i>POC: {{ target.exploitation_level or '0/0' }}
                    </p>
                    
                    {% if poc_verified > 0 %}
                      <p class="text-xs text-success mb-0">
                        <i class="fas fa-chart-line me-1"></i>{{ "%.1f"|format((poc_verified / poc_total * 100) if poc_total > 0 else 0) }}% Complete
                      </p>
                    {% endif %}
                  </td>
                    <td class="align-middle text-center">
                      <div class="d-flex align-items-center justify-content-center">
                        {% set poc_info = target.exploitation_level.split('/') if target.exploitation_level else ['0', '0'] %}
                        {% set poc_verified = poc_info[0]|int if poc_info|length > 0 else 0 %}
                        {% set poc_total = poc_info[1]|int if poc_info|length > 1 else 0 %}
                        {% set completion_percent = (poc_verified / poc_total * 100) if poc_total > 0 else 0 %}
                        
                        <span class="me-2 text-xs font-weight-bold">{{ "%.1f"|format(completion_percent) }}%</span>
                        <div>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-success" role="progressbar" 
                                 aria-valuenow="{{ completion_percent }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100" 
                                 style="width: {{ completion_percent }}%"></div>
                          </div>
                        </div>
                      </div>
                    </td>
                  <td class="align-middle">
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-info" 
                      title="Xem Target"
                      data-target-id="{{target.server_id}}"
                      onclick="handleViewTarget('{{target.server_id}}')"
                        <i class="fa fa-eye"></i> Xem
                      </button>
                      <button class="btn btn-sm btn-outline-warning" title="Xóa target"
                        onclick="deleteSingleTarget('{{target.server_id}}')">
                        <i class="fa fa-trash"></i> Xóa
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
                
                <script>
                  //<!-- Xem thông tin target-->
                  function handleViewTarget(idtarget){
                    // mở trong tab mới
                    console.log('idtarget:', idtarget);
                    window.open(`/view-target?idtarget=${idtarget}`, '_blank');
                  }

                  //<!-- Xóa target-->
                  function deleteSingleTarget(idtarget){
                    if (confirm(`Are you sure you want to delete the selected targets?`)) {
                      const data = [];
                      data.push(idtarget);
                      // xóa target
                      $.ajax({
                        url:'/api/delete_target',
                        type: 'POST',
                        data: JSON.stringify({target_ids: data}),
                        contentType: 'application/json',
                      })
                      .done((resp) =>{
                        if(resp['status'] === 0){
                          showContent(currentPage, document.getElementById("id_search_target").value, currentSortType);
                          showAlertSuccess('Xóa target thành công');
                        }
                        else{
                          showAlertError('Lỗi khi xóa target: ' + resp['msg']);
                        }
                      })
                      .fail((error) =>{
                        showAlertError('Lỗi khi xóa target: ' + error);
                      });
                    }
                    
                  }
                </script>



<!--check status code in website-->
<!--check status code in website-->
<script>
  //check live in website
  function initStatusCheckSequential() {
    const spans = Array.from(document.querySelectorAll('[data-status-span]'));
    function checkNext(i) {
      if (i >= spans.length) return;
      const span = spans[i];
      const url = span.getAttribute('data-url-status');
      const serverId = span.getAttribute('data-status-span');
      checkWebsite(url, serverId).then(() => {
        checkNext(i + 1);
      });
    }
    checkNext(0);
  }

  // Sửa lại checkWebsite trả về Promise
  function checkWebsite(URL, serverId){
    const span = document.querySelector(`[data-status-span='${serverId}']`);
    const p_status = document.querySelector(`[data-status-code='${serverId}']`);
    span.classList.remove('bg-gradient-success', 'bg-gradient-warning', 'bg-gradient-danger');

    return $.ajax({
      url: '/api/checkstatussite',
      type: 'POST',
      data: JSON.stringify({ url: URL }),
      contentType: 'application/json',
    })
    .done((resp) =>{
      if(resp['http_status']){
        p_status.innerHTML="Status-code: " + resp['http_status'];
        if(resp['status'] === 'online'){
          span.innerHTML='Online';
          span.classList.add('bg-gradient-success');
        }
        else{
          span.innerHTML='Offline';
          span.classList.add('bg-gradient-warning');
        }
      }
      else{
        span.innerHTML='Offline';
        span.classList.add('bg-gradient-danger');
      }
    })
    .fail((error) =>{
      span.innerHTML = 'Offline';
      span.classList.remove('bg-gradient-success', 'bg-gradient-warning');
      span.classList.add('bg-gradient-danger');
    });
  }

  // Gọi sau khi render bảng
  document.addEventListener('DOMContentLoaded', function() {
    initStatusCheckSequential();
  });
  
</script>


