{% extends "layouts/base.html" %} {% block content %}
<!--Style cho biểu đồ tròn-->
<style>
  :root {
    --primary-color: #5e72e4;
    --secondary-color: #f7fafc;
    --success-color: #2dce89;
    --info-color: #11cdef;
    --warning-color: #fb6340;
    --danger-color: #f5365c;
    --dark-color: #172b4d;
    --light-color: #f8f9fe;
  }

  body {
    font-family: "Poppins", sans-serif;
    background-color: #f8f9fe;
    color: #525f7f;
  }

  .dashboard-header {
    background: linear-gradient(to right, #5e72e4, #825ee4);
    color: white;
    padding: 2rem 0;
    border-radius: 0 0 15px 15px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .card {
    border-radius: 15px;
    border: none;
    box-shadow: 0 0 2rem 0 rgba(136, 152, 170, 0.15);
    margin-bottom: 2rem;
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
  }

  .card-header {
    background-color: transparent;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
  }

  .card-title {
    margin-bottom: 0;
    color: #32325d;
    font-weight: 600;
  }

  .card-subtitle {
    color: #8898aa;
    font-weight: 400;
  }

  .chart-container {
    position: relative;
    height: 350px;
    padding: 20px;
  }

  .chart-legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    margin: 5px 15px;
  }

  .legend-color {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    margin-right: 10px;
  }

  .percentage-label {
    font-size: 0.85rem;
    font-weight: 600;
  }

  .btn-dashboard {
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    border-radius: 0.375rem;
    transition: all 0.15s ease;
    box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-primary:hover {
    background-color: #4761db;
    border-color: #4761db;
  }

  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  .time-filter {
    display: flex;
    gap: 10px;
  }

  .time-filter .btn {
    padding: 5px 15px;
    border-radius: 20px;
    background-color: rgba(94, 114, 228, 0.1);
    color: var(--primary-color);
    font-weight: 500;
    border: none;
  }

  .time-filter .btn.active {
    background-color: var(--primary-color);
    color: white;
  }

  .card-stats {
    padding: 1rem;
    display: flex;
    align-items: center;
  }

  .stats-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    background: linear-gradient(45deg, var(--primary-color), #825ee4);
    color: white;
    font-size: 1.5rem;
  }

  .stats-info h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
  }

  .stats-info p {
    margin: 0;
    color: #8898aa;
  }

  /* Custom colors for charts */
  .sales-colors {
    --color1: rgba(94, 114, 228, 0.9);
    --color2: rgba(130, 94, 228, 0.9);
    --color3: rgba(45, 206, 137, 0.9);
    --color4: rgba(251, 99, 64, 0.9);
  }

  .social-colors {
    --color1: rgba(17, 205, 239, 0.9);
    --color2: rgba(245, 54, 92, 0.9);
    --color3: rgba(45, 206, 137, 0.9);
    --color4: rgba(251, 99, 64, 0.9);
    --color5: rgba(94, 114, 228, 0.9);
  }

  .pages-colors {
    --color1: rgba(45, 206, 137, 0.9);
    --color2: rgba(251, 99, 64, 0.9);
    --color3: rgba(94, 114, 228, 0.9);
    --color4: rgba(17, 205, 239, 0.9);
    --color5: rgba(245, 54, 92, 0.9);
  }
  
  /* CSS cho phần thống kê file đẹp mắt */
  .file-stats-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    padding: 20px;
    color: white;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  
  .stats-header {
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 15px;
  }
  
  .stats-icon-wrapper {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
  }
  
  .total-files-badge {
    font-size: 2rem;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }
  
  .stats-size-section {
    text-align: center;
  }
  
  .size-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .size-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
    color: #ffd700;
  }
  
  .size-value {
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
  }
  
  .size-label {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .file-type-breakdown {
    margin-top: 20px;
  }
  
  .breakdown-title {
    color: #fff;
    font-weight: 600;
    text-align: center;
    font-size: 1.1rem;
  }
  
  .type-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .type-card {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
  }
  
  .type-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  
  .type-header {
    margin-bottom: 10px;
  }
  
  .type-icon {
    font-size: 1.5rem;
    margin-bottom: 8px;
    color: #ffd700;
  }
  
  .type-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .type-stats {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 10px;
  }
  
  .type-count {
    font-size: 1.2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 3px;
  }
  
  .type-size {
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.7);
  }
  
  /* Màu sắc đặc biệt cho từng loại file */
  .type-upload {
    background: linear-gradient(135deg, rgba(46, 213, 115, 0.2) 0%, rgba(46, 213, 115, 0.1) 100%);
    border-color: rgba(46, 213, 115, 0.3);
  }
  
  .type-download {
    background: linear-gradient(135deg, rgba(54, 123, 245, 0.2) 0%, rgba(54, 123, 245, 0.1) 100%);
    border-color: rgba(54, 123, 245, 0.3);
  }
  
  .type-image {
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.2) 0%, rgba(255, 71, 87, 0.1) 100%);
    border-color: rgba(255, 71, 87, 0.3);
  }
  
  .type-code {
    background: linear-gradient(135deg, rgba(255, 165, 2, 0.2) 0%, rgba(255, 165, 2, 0.1) 100%);
    border-color: rgba(255, 165, 2, 0.3);
  }
  
  .type-file {
    background: linear-gradient(135deg, rgba(108, 92, 231, 0.2) 0%, rgba(108, 92, 231, 0.1) 100%);
    border-color: rgba(108, 92, 231, 0.3);
  }
  /*css của thằng terminal hacker*/

  #terminal {
      box-sizing: border-box;
      padding: 10px;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }

    #output_terminal {
      flex-grow: 1;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.4em;
    }

    .input-line {
      display: flex;
      align-items: center;
      background: #111;
      border: 1px solid #00ff00;
      padding: 5px 10px;
      margin-top: 5px;
    }

    .prompt {
      margin-right: 8px;
      white-space: nowrap;
      color: #00ff00;
    }

    #input_terminal {
      flex-grow: 1;
      background: transparent;
      border: none;
      color: #00ff00;
      font-size: 16px;
      font-family: inherit;
      outline: none;
    }

    ::selection {
      background: #00ff00;
      color: #000;
    }

    ::-webkit-scrollbar {
      width: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: #00ff00;
    }

  .tools-btn-group {
    gap: 12px !important;
  }
  .tools-btn {
    min-width: 80px;
    height: 26px;
    padding: 0 12px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    transition: all 0.2s;
  }
  .tools-btn-orange {
    background: linear-gradient(135deg, #f97316 0%, #f97000 100%) !important;
    color: #fff !important;
    border: none !important;
  }
  .tools-btn-orange:hover, .tools-btn-orange:focus {
    background: linear-gradient(135deg, #f97000 0%, #f97316 100%) !important;
    color: #fff !important;
    box-shadow: 0 4px 16px rgba(249, 115, 22, 0.18);
  }
</style>
<!-- Scripts này là cho các biểu đồ tròn-->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Configure Sales Chart
    // Đã có IC được đánh nhãn trong PCB
    const salesCtx = document.getElementById("salesChart").getContext("2d");
    const salesChart = new Chart(salesCtx, {
      type: "doughnut",
      data: {
        labels: ["Exploitable", "Unexploitable","Other"],
        datasets: [
          {
            data: [{{ exploitable }}, {{ unexploitable }}, {{ other }}],
            backgroundColor: [
              "rgba(130, 94, 228, 0.9)",
              "rgba(251, 99, 64, 0.9)",
              "rgba(83, 251, 64, 0.9)",
            ],
            borderWidth: 0,
            hoverOffset: 10,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: "70%",
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: function (context) {
                return `${context.label}: ${context.raw}%`;
              },
            },
          },
        },
        animation: {
          animateScale: true,
          animateRotate: true,
        },
      },
    });

    // Time filter buttons
    const timeButtons = document.querySelectorAll(".time-filter .btn");
    timeButtons.forEach((button) => {
      button.addEventListener("click", function () {
        timeButtons.forEach((btn) => btn.classList.remove("active"));
        this.classList.add("active");

        // Here you would typically update the charts with new data
        // For demo purposes, we'll just simulate new data

        // Update Sales Chart
        const newSalesData = [
          [35, 30, 20, 15], // Today
          [25, 35, 15, 25], // Week
          [30, 20, 25, 25], // Month
          [20, 30, 30, 20], // Year
        ];

        // Update Social Chart
        const newSocialData = [
          [30, 15, 25, 20, 10], // Today
          [20, 20, 25, 25, 10], // Week
          [25, 10, 30, 25, 10], // Month
          [15, 15, 35, 20, 15], // Year
        ];

        // Update Pages Chart
        const newPagesData = [
          [35, 25, 15, 10, 15], // Today
          [30, 20, 20, 15, 15], // Week
          [25, 25, 20, 10, 20], // Month
          [20, 30, 15, 15, 20], // Year
        ];

        // Get button index
        const index = Array.from(timeButtons).indexOf(this);

        // Update charts with new data
        salesChart.data.datasets[0].data = newSalesData[index];
        salesChart.update();

        socialChart.data.datasets[0].data = newSocialData[index];
        socialChart.update();

        pagesChart.data.datasets[0].data = newPagesData[index];
        pagesChart.update();
      });
    });
  });
</script>
<div class="container-fluid py-4">
  <div class="row" style="margin: -25px !important">
    <!-- Hiển thị file collect-->
    <div class="col-lg-3">
      <div class="card h-100">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-6 d-flex align-items-center justify-content-center">
              <h6 class="mb-0">Files Collected</h6>
            </div>
            <div class="col-6 d-flex justify-content-center align-items-center" style="margin-top: -5px !important;">
              <button class="btn btn-sm mb-0 tools-btn tools-btn-orange" onclick="refreshFiles()">
                <i class="fas fa-sync-alt me-1"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-3 pb-0">
          <!-- Các file thu thập được sẽ được ghi ở đây-->
          {% if target_files and target_files|length > 0 %}
            <ul class="list-group">
              {% for file in target_files %}
              <li
                class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 bg-gray-100 border-radius-lg"
              >
                <div
                  class="d-flex flex-column"
                  style="margin-left: 10px !important"
                >
                  <h6 class="mb-1 text-dark font-weight-bold text-sm" title="{{ file.file_name }}">
                    {{ file.file_name[:25] }}{% if file.file_name|length > 25 %}...{% endif %}
                  </h6>
                  <span class="text-xs">
                    <i class="fas fa-file-{{ 'image' if file.file_type in ['jpg', 'jpeg', 'png', 'gif'] else 'code' if file.file_type in ['php', 'html', 'js', 'css'] else 'file' }} me-1"></i>
                    {{ file.file_type|upper }} • {{ (file.file_size / 1024)|round(1) }} KB
                  </span>
                  <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    {{ file.file_created_at.strftime('%d/%m/%Y %H:%M') if file.file_created_at else 'N/A' }}
                  </small>
                </div>
                <div
                  class="d-flex align-items-center text-sm justify-content-center"
                >
                  <div class="d-flex flex-column align-items-end">
                    <button class="btn btn-link text-dark text-sm mb-0 px-0 ms-4" 
                            onclick="downloadFile('{{ file.file_id }}', '{{ file.file_name }}')"
                            title="Download {{ file.file_name }}">
                      <i class="fas fa-download text-lg me-1"></i> Download
                    </button>
                    <small class="text-muted text-xs">{{ file.source_path[:20] }}{% if file.source_path|length > 20 %}...{% endif %}</small>
                  </div>
                </div>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="text-center py-4">
              <div class="icon icon-shape icon-lg bg-gradient-warning shadow text-center border-radius-xl mt-n4 mx-auto">
                <i class="fas fa-file-alt"></i>
              </div>
              <h6 class="mt-3">Chưa có file nào</h6>
              <p class="text-sm">Chưa có file nào được thu thập từ target này. Hãy sử dụng các công cụ recon và exploit để thu thập dữ liệu.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Hiện thị thông tin RCE-->
    <div class="col-lg-6">
      <div class="card mt-4">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-6 d-flex align-items-center justify-content-center">
              <h6 class="mb-0">Kết quả thống kê POC đã quét</h6>
            </div>
            <div class="col-6 d-flex align-items-center justify-content-end">
              <div class="d-flex gap-2">
                <a class="btn btn-success btn-sm mb-0"  id="btn-verify-viewtarget">Verify</a>
                <a class="btn btn-info btn-sm mb-0" id="btn-recon-viewtarget">Recon</a>
              </div>
            </div>
          </div>
        </div>
        
        
        <div class="card-body p-3">
          <div class="row justify-content-center align-items-center">
            <div class="col-lg-4 d-flex justify-content-center">
              <div class="chart-container sales-colors" style="width: 180px; height: 180px;">
                <canvas id="salesChart" style="width: 100%; height: 100%;"></canvas>
              </div>
            </div>
            <div class="col-lg-8 d-flex align-items-center">
              <div class="chart-legend w-100">
                <div class="legend-item d-flex flex-column w-100">
                  {% set total = exploitable + unexploitable + other %}
                  <span>Exploited  {{exploitable}} POC</span>
                  <span>Unexploited  {{unexploitable}} POC</span>
                  <span>Other  {{other}} POC</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4">
        <div class="card-header pb-0 p-3">
          <div class="row">
            <div class="col-12 d-flex align-items-center justify-content-center">
              <h6 class="mb-0">Shells liên quan đến Target này</h6>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          {% if shells and shells|length > 0 %}
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Shell Name</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Type</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Status</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Connection</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">User</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Connect Time</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder">Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for shell in shells %}
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">{{ shell.name }}</h6>
                          <p class="text-xs text-secondary mb-0">{{ shell.connection_id[:8] }}...</p>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-sm bg-gradient-secondary">{{ shell.shell_type.value if shell.shell_type else 'N/A' }}</span>
                    </td>
                    <td>
                      {% if shell.status.value == 'connected' %}
                        <span class="badge badge-sm bg-gradient-success">{{ shell.status.value }}</span>
                      {% elif shell.status.value == 'disconnected' %}
                        <span class="badge badge-sm bg-gradient-danger">{{ shell.status.value }}</span>
                      {% else %}
                        <span class="badge badge-sm bg-gradient-secondary">{{ shell.status.value }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0">{{ shell.local_ip }}:{{ shell.local_port }}</p>
                      <p class="text-xs text-secondary mb-0">→ {{ shell.remote_ip or 'N/A' }}:{{ shell.remote_port or 'N/A' }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0">{{ shell.user or 'N/A' }}</p>
                      <p class="text-xs text-secondary mb-0">{{ shell.os_info or 'N/A' }}</p>
                    </td>
                    <td>
                      <p class="text-xs font-weight-bold mb-0">
                        {% if shell.connect_time %}
                          {{ shell.connect_time.strftime('%d/%m/%Y') }}
                        {% else %}
                          N/A
                        {% endif %}
                      </p>
                      <p class="text-xs text-secondary mb-0">
                        {% if shell.connect_time %}
                          {{ shell.connect_time.strftime('%H:%M:%S') }}
                        {% else %}
                          N/A
                        {% endif %}
                      </p>
                    </td>
                    <td>
                      <a href="/shells/{{ shell.connection_id }}" class="btn btn-sm btn-outline-primary" target="_blank">
                        <i class="fa fa-terminal"></i> XEM SHELL
                      </a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-center py-4">
              <div class="icon icon-shape icon-lg bg-gradient-warning shadow text-center border-radius-xl mt-n4 mx-auto">
                <i class="fas fa-terminal"></i>
              </div>
              <h6 class="mt-3">Chưa có Shell nào</h6>
              <p class="text-sm">Chưa có shell nào được tạo cho target này. Hãy tạo shell mới từ trang quản lý shell.</p>
              <a href="/shells" class="btn btn-primary btn-sm mt-2">
                <i class="fa fa-plus"></i> Tạo Shell Mới
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Hiện thị thông tin report và edit của target -->
    <div class="col-md-3 mt-4" style="margin-top: -1px !important">
      <div class="card h-100 mb-4">
        <div class="card-header pb-0 px-3" style="margin-top: -10px !important">
          <div class="d-flex justify-content-between align-items-center w-100 flex-wrap">
            
            <div class="tools-btn-group d-flex align-items-center gap-2 flex-wrap justify-content-end">
              <a class="btn btn-sm mb-0 tools-btn tools-btn-orange" href="javascript:;" id="btn-report-viewtarget">Report Target</a>
              <a class="btn btn-primary btn-sm mb-0 tools-btn" href="javascript:void(0);" onclick="show_edittarget_Modal()">Edit Target</a>
            </div>
            <div>
              <h6 class="mb-1">Tool update information</h6>
              <p class="text-sm mb-0">
                <i class="fa fa-arrow-up text-success" aria-hidden="true"></i>
                <span class="font-weight-bold">Cập nhật gần nhất</span>
              </p>
            </div>
          </div>
        </div>
        <div class="card-body p-3">
          <div class="timeline timeline-one-side">
            <div class="timeline-block mb-3">
              <span class="timeline-step bg-gradient-info">
                <i class="fas fa-folder-open"></i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">Dirsearch</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ report.update_dirsearch or 'Chưa có dữ liệu' }}</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step bg-gradient-warning">
                <i class="fas fa-globe"></i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">Wappalyzer</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ report.update_wappalyzer or 'Chưa có dữ liệu' }}</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step bg-gradient-success">
                <i class="fas fa-network-wired"></i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">Nmap</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ report.update_nmap or 'Chưa có dữ liệu' }}</p>
              </div>
            </div>
            <div class="timeline-block mb-3">
              <span class="timeline-step bg-gradient-danger">
                <i class="fas fa-wordpress"></i>
              </span>
              <div class="timeline-content">
                <h6 class="text-dark text-sm font-weight-bold mb-0">Wpscan</h6>
                <p class="text-secondary font-weight-bold text-xs mt-1 mb-0">{{ report.update_wpscan or 'Chưa có dữ liệu' }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}

  {% include "partials/verify_target.html" %}

  {% include "partials/recon_target.html" %}

  {% include "partials/report_target.html" %}

</div>

{% include "partials/edit_target.html" %}

<!-- Script hiển thị modal edit target-->
<script>
  function show_edittarget_Modal() {
    // Set target ID
    const targetIDElement = document.getElementById('targetID');
    if (targetIDElement) {
      targetIDElement.value = '{{target.server_id}}';
    } else {
      console.error('Không tìm thấy element targetID');
    }
    
    // Load target data into form fields
    document.getElementById('edit-hostname').value = '{{target.hostname}}';
    document.getElementById('edit-ip-address').value = '{{target.ip_address}}';
    document.getElementById('edit-server-type').value = '{{target.server_type}}';
    document.getElementById('edit-os').value = '{{target.os}}';
    document.getElementById('edit-location').value = '{{target.location}}';
    document.getElementById('edit-status').value = '{{target.status}}';
    document.getElementById('edit-notes').value = '{{target.notes}}';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('edittargetModal'));
    modal.show();
  }

  // Hàm download file
  function downloadFile(fileId, fileName) {
    console.log(`Downloading file: ${fileName} (ID: ${fileId})`);
    
    // Tạo URL download
    const downloadUrl = `/api/download_file/${fileId}`;
    
    // Tạo link download ẩn
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = fileName;
    link.style.display = 'none';
    
    // Thêm vào DOM và click
    document.body.appendChild(link);
    link.click();
    
    // Dọn dẹp
    document.body.removeChild(link);
    
    // Hiển thị thông báo
    showNotification('success', `Đang tải xuống file: ${fileName}`);
  }

  // Hàm hiển thị thông báo
  function showNotification(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      <i class="${icon} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Tự động ẩn sau 3 giây
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 3000);
  }

  // Hàm refresh danh sách files
  function refreshFiles() {
    console.log('Refreshing files...');
    
    // Hiển thị loading
    const fileContainer = document.querySelector('.card-body');
    if (fileContainer) {
      fileContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Đang tải danh sách files...</p>
        </div>
      `;
    }
    
    // Gọi API để lấy dữ liệu mới
    const targetId = '{{ target.server_id }}';
    fetch(`/api/refresh-file-stats?target_id=${targetId}`)
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Cập nhật thống kê file
          updateFileStats(data.file_stats);
          
          // Cập nhật danh sách file
          updateFileList(data.target_files);
          
          showNotification('success', 'Đã cập nhật danh sách files thành công!');
        } else {
          throw new Error(data.error || 'Có lỗi xảy ra');
        }
      })
      .catch(error => {
        console.error('Error refreshing files:', error);
        showNotification('error', `Lỗi khi tải files: ${error.message}`);
        
        // Fallback: reload trang
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      });
  }
  
  // Hàm cập nhật thống kê file
  function updateFileStats(fileStats) {
    // Tìm container thống kê
    const statsContainer = document.querySelector('.card-body .row.mb-3');
    if (!statsContainer) return;
    
    // Cập nhật tổng số file và dung lượng
    const totalFilesBadge = statsContainer.querySelector('.badge');
    const totalSizeSpan = statsContainer.querySelector('.text-success');
    
    if (totalFilesBadge) {
      totalFilesBadge.textContent = `${fileStats.total_files} files`;
    }
    
    if (totalSizeSpan) {
      totalSizeSpan.textContent = `${fileStats.total_size_mb} MB`;
    }
    
    // Cập nhật phân loại theo loại
    const typeContainer = document.querySelector('.mb-3 .row');
    if (typeContainer && fileStats.by_type) {
      let typeHtml = '';
      for (const [fileType, stats] of Object.entries(fileStats.by_type)) {
        typeHtml += `
          <div class="col-6 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-xs text-muted">${fileType.toUpperCase()}:</span>
              <div class="text-end">
                <div class="text-xs font-weight-bold">${stats.count} files</div>
                <div class="text-xs text-muted">${stats.size_mb} MB</div>
              </div>
            </div>
          </div>
        `;
      }
      typeContainer.innerHTML = typeHtml;
    }
  }
  
  // Hàm cập nhật danh sách file
  function updateFileList(targetFiles) {
    const fileListContainer = document.querySelector('.card-body .list-group');
    if (!fileListContainer) return;
    
    if (targetFiles && targetFiles.length > 0) {
      let fileHtml = '';
      targetFiles.forEach(file => {
        const fileIcon = getFileIcon(file.file_type);
        const fileSize = (file.file_size / 1024).toFixed(1);
        const createdDate = file.file_created_at ? new Date(file.file_created_at).toLocaleDateString('vi-VN') : 'N/A';
        
        fileHtml += `
          <li class="list-group-item border-0 d-flex justify-content-between ps-0 mb-2 bg-gray-100 border-radius-lg">
            <div class="d-flex flex-column" style="margin-left: 10px !important">
              <h6 class="mb-1 text-dark font-weight-bold text-sm" title="${file.file_name}">
                ${file.file_name.length > 25 ? file.file_name.substring(0, 25) + '...' : file.file_name}
              </h6>
              <span class="text-xs">
                <i class="fas fa-file-${fileIcon} me-1"></i>
                ${file.file_type.toUpperCase()} • ${fileSize} KB
              </span>
              <small class="text-muted">
                <i class="fas fa-clock me-1"></i>
                ${createdDate}
              </small>
            </div>
            <div class="d-flex align-items-center text-sm justify-content-center">
              <div class="d-flex flex-column align-items-end">
                <button class="btn btn-link text-dark text-sm mb-0 px-0 ms-4" 
                        onclick="downloadFile('${file.file_id}', '${file.file_name}')"
                        title="Download ${file.file_name}">
                  <i class="fas fa-download text-lg me-1"></i> Download
                </button>
                <small class="text-muted text-xs">${file.source_path.length > 20 ? file.source_path.substring(0, 20) + '...' : file.source_path}</small>
              </div>
            </div>
          </li>
        `;
      });
      fileListContainer.innerHTML = fileHtml;
    } else {
      fileListContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="icon icon-shape icon-lg bg-gradient-warning shadow text-center border-radius-xl mt-n4 mx-auto">
            <i class="fas fa-file-alt"></i>
          </div>
          <h6 class="mt-3">Chưa có file nào</h6>
          <p class="text-sm">Chưa có file nào được thu thập từ target này. Hãy sử dụng các công cụ recon và exploit để thu thập dữ liệu.</p>
        </div>
      `;
    }
  }
  
  // Hàm lấy icon cho loại file
  function getFileIcon(fileType) {
    const imageTypes = ['jpg', 'jpeg', 'png', 'gif'];
    const codeTypes = ['php', 'html', 'js', 'css'];
    
    if (imageTypes.includes(fileType.toLowerCase())) {
      return 'image';
    } else if (codeTypes.includes(fileType.toLowerCase())) {
      return 'code';
    } else {
      return 'file';
    }
  }

  
</script>


<!--recon target and verify target-->
<script>
// Lấy target IDs đã check
function getCheckedTargetIds() {
  return ['{{ target.server_id }}'];
}


  //verify 1 POC với nhiểu target đã chọn
document.getElementById('btn-verify-viewtarget').addEventListener("click",function(){
  const data = getCheckedTargetIds();
    
    // ... cập nhật các field khác
    const modal = new bootstrap.Modal(document.getElementById('verifyPocWithTargetsModal'));
     // const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('verifyPocWithTargetsModal'));

    modal.show();
});

//Chức năng Recon
document.getElementById('btn-recon-viewtarget').addEventListener("click",function(){
  const data = getCheckedTargetIds();
    

    document.getElementById('reconScanLoading').style.display = 'none';
    document.getElementById('reconScanResult').textContent += '\n[Data will be display in here]';

    // ... cập nhật các field khác
    const modal = new bootstrap.Modal(document.getElementById('reconTargetsModal'));
    modal.show();
});

//Chức năng xem các report
document.getElementById('btn-report-viewtarget').addEventListener("click",function(){
  const data = getCheckedTargetIds();
    
    // ... cập nhật các field khác
    const modal = new bootstrap.Modal(document.getElementById('reportTargetModal'));
    modal.show();
});

</script>

{% endblock content %}
