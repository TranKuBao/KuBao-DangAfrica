{% extends "layouts/base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header thông tin shell -->
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex flex-wrap justify-content-between align-items-center">
          <div>
            <h5 class="mb-1">Shell Detail</h5>
            <div class="d-flex flex-wrap gap-3 align-items-center">
              <span class="badge bg-dark">Session: {{ shell.connection_id }}</span>
              <span class="badge bg-info">Type: {{ shell.shell_type.name }}</span>
              <span class="badge bg-secondary">Status: {{ shell.status.name }}</span>
              <span class="badge bg-success">User: {{ shell.user or 'N/A' }}</span>
              <span class="badge bg-warning text-dark">Privilege: {{ shell.privilege_level or 'N/A' }}</span>
            </div>
          </div>
          <div class="text-end">
            <div class="mb-1">
              <i class="fas fa-calendar-alt me-1"></i> Created: {{ shell.created_at|replace('T', ' ')|truncate(19, True, '') if shell.created_at }}
            </div>
            <div>
              <i class="fas fa-clock me-1"></i> Updated: {{ shell.updated_at|replace('T', ' ')|truncate(19, True, '') if shell.updated_at }}
            </div>
          </div>
        </div>
        <div class="card-body py-2">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <h6 class="mb-2"><i class="fas fa-network-wired me-1"></i> Listen (Local)</h6>
                <div><strong>IP:</strong> {{ shell.local_ip or 'N/A' }}</div>
                <div><strong>Port:</strong> {{ shell.local_port or 'N/A' }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <h6 class="mb-2"><i class="fas fa-globe me-1"></i> Remote</h6>
                <div><strong>IP:</strong> {{ shell.remote_ip or 'N/A' }}</div>
                <div><strong>Port:</strong> {{ shell.remote_port or 'N/A' }}</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <h6 class="mb-2"><i class="fas fa-bullseye me-1"></i> Linked Target</h6>
                <div id="linkedTargetInfo">
                  {% if shell.target_id and shell.target_id|int > 0 %}
                    <div><strong>Hostname:</strong> <span id="linkedTargetHostname">{{ shell.hostname or 'N/A' }}</span></div>
                    <div><strong>Target ID:</strong> <a href="/targets/{{ shell.target_id }}" target="_blank" id="linkedTargetId">{{ shell.target_id }}</a></div>
                  {% else %}
                    <div class="text-muted">No target linked</div>
                  {% endif %}
                </div>
                <!-- Khu vực cập nhật liên kết target -->
                <div class="mt-2">
                  <select id="targetSelect" class="form-select form-select-sm mb-1">
                    <option value="">-- Chọn target để liên kết --</option>
                    {% for t in targets %}
                      <option value="{{ t.server_id }}" {% if shell.target_id==t.server_id %}selected{% endif %}>{{ t.hostname }} ({{ t.ip_address }})</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-sm btn-outline-primary" id="updateTargetBtn">Cập nhật liên kết</button>
                  <span id="updateTargetStatus" class="ms-2 text-success" style="display:none;"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Ghi chú cho shell -->
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex align-items-center justify-content-between">
          <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Shell Notes</h6>
          <button class="btn btn-sm btn-outline-primary" id="saveNoteBtn"><i class="fas fa-save me-1"></i>Save Note</button>
        </div>
        <div class="card-body">
          <textarea id="shellNote" class="form-control" rows="3" >{{ shell.notes or '' }}</textarea>
          <div id="noteStatus" class="mt-2 text-success" style="display:none;"></div>
        </div>
      </div>
      <!-- Terminal tương tác trực tiếp -->
      <div class="card mb-4">
        <div class="card-header pb-0 d-flex align-items-center justify-content-between">
          <h6 class="mb-0"><i class="fas fa-terminal me-2"></i>Interactive Shell</h6>
          <span id="shellStatus" class="badge bg-secondary ms-2">Disconnected</span>
        </div>
        <div class="card-body p-0">
          <div class="shell-container">
            <div class="terminal-header">
              <div class="terminal-controls">
                <span class="control close"></span>
                <span class="control minimize"></span>
                <span class="control maximize"></span>
              </div>
              <div class="terminal-title">
                <i class="fas fa-server me-2"></i>
                <span id="targetInfo">Target: {{ shell.hostname or shell_name or shell_id }}</span>
              </div>
            </div>
            <div class="terminal-body" id="terminalOutput">
              <div class="terminal-line">
                <span class="prompt">root@target:~$</span>
                <span class="command" id="currentCommand"></span>
                <span class="cursor" id="cursor">|</span>
              </div>
            </div>
            <div class="command-input-container">
              <div class="input-group">
                <span class="input-group-text bg-dark text-white">
                  <i class="fas fa-chevron-right"></i>
                </span>
                <input type="text" class="form-control" id="commandInput" placeholder="Enter command..." autocomplete="off" disabled>
                <button class="btn btn-primary" type="button" id="sendCommand" disabled>
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>
            <div class="p-2 d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="clearTerminal">
                <i class="fas fa-trash me-1"></i>Clear
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="saveOutput">
                <i class="fas fa-save me-1"></i>Save
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="fullscreen">
                <i class="fas fa-expand me-1"></i>Fullscreen
              </button>
              <button type="button" class="btn btn-outline-info btn-sm" id="loadHistory">
                <i class="fas fa-history me-1"></i>History
              </button>
              <!-- Nút bật/tắt shell -->
              <button type="button" class="btn btn-outline-warning btn-sm" id="toggleShellBtn">
                <i class="fas fa-power-off me-1"></i><span id="toggleShellBtnText">Tắt Shell</span>
              </button>
              <button type="button" class="btn btn-danger btn-sm ms-auto" id="disconnectShell" disabled>
                <i class="fas fa-times me-1"></i>Disconnect
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.shell-container {
  background: #1e1e1e;
  border-radius: 8px;
  overflow: hidden;
  font-family: 'Courier New', monospace;
  height: 500px;
  display: flex;
  flex-direction: column;
}
.terminal-header {
  background: #2d2d2d;
  padding: 8px 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #404040;
}
.terminal-controls { display: flex; gap: 8px; }
.control { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; }
.control.close { background: #ff5f56; }
.control.minimize { background: #ffbd2e; }
.control.maximize { background: #27ca3f; }
.terminal-title { color: #ffffff; font-size: 14px; font-weight: 500; }
.terminal-body { flex: 1; padding: 15px; overflow-y: auto; background: #1e1e1e; color: #ffffff; font-size: 14px; line-height: 1.4; }
.terminal-line { margin-bottom: 5px; display: flex; align-items: center; }
.prompt { color: #4CAF50; font-weight: bold; margin-right: 10px; white-space: nowrap; }
.command { color: #ffffff; flex: 1; }
.cursor { color: #ffffff; animation: blink 1s infinite; margin-left: 2px; }
@keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
.output-line { color: #cccccc; margin-bottom: 5px; word-wrap: break-word; }
.error-line { color: #ff6b6b; }
.success-line { color: #4CAF50; }
.command-input-container { padding: 15px; background: #2d2d2d; border-top: 1px solid #404040; }
.command-input-container .input-group-text { border: none; background: #404040; }
.command-input-container .form-control { background: #1e1e1e; border: 1px solid #404040; color: #ffffff; font-family: 'Courier New', monospace; }
.command-input-container .form-control:focus { background: #1e1e1e; border-color: #4CAF50; color: #ffffff; box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25); }
.command-input-container .btn { border: 1px solid #404040; }
.terminal-body::-webkit-scrollbar { width: 8px; }
.terminal-body::-webkit-scrollbar-track { background: #2d2d2d; }
.terminal-body::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
.terminal-body::-webkit-scrollbar-thumb:hover { background: #555555; }
.terminal-line { animation: slideIn 0.3s ease; }
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
#shellStatus { animation: pulse 2s infinite; }
@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
.shell-container.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; border-radius: 0; }
</style>

<script>
  function render_target_info(){
    $.ajax({
      url: `/api/getalltarget`,
      type: 'GET',
      success: function(resp){
        // xóa hết mấy cái đang có
        $('#targetSelect').find('option:not(:first)').remove();

        $.each(resp.targets, function(index, item) {
        $('#targetSelect').append(
          $('<option>', {
            value: item.server_id,
            text: item.hostname
          })
        );
        });
      },
      error: function(error){
        console.log(error);
      }

    });
  }


  render_target_info();
</script>


<script>
// AJAX lưu ghi chú shell
$(document).ready(function() {
  
  $('#saveNoteBtn').click(function() {
    const note = $('#shellNote').val();
    const shellId = '{{ shell.connection_id }}';
    $('#saveNoteBtn').prop('disabled', true);
    $.ajax({
      url: `/api/shells/${shellId}/notes`,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ notes: note }),
      success: function(resp) {
        if (resp.status === 'success') {
          $('#noteStatus').text('Note saved!').removeClass('text-danger').addClass('text-success').show();
        } else {
          $('#noteStatus').text('Failed to save note: ' + resp.msg).removeClass('text-success').addClass('text-danger').show();
        }
      },
      error: function(xhr) {
        $('#noteStatus').text('Error saving note!').removeClass('text-success').addClass('text-danger').show();
      },
      complete: function() {
        $('#saveNoteBtn').prop('disabled', false);
        setTimeout(function() { $('#noteStatus').fadeOut(); }, 2000);
      }
    });
  });

  // Cập nhật liên kết target
  $('#updateTargetBtn').click(function() {
    const shellId = '{{ shell.connection_id }}';
    const targetId = $('#targetSelect').val();
    if (!targetId) {
      $('#updateTargetStatus').text('Vui lòng chọn target!').removeClass('text-success').addClass('text-danger').show();
      return;
    }
    $('#updateTargetBtn').prop('disabled', true);
    $.ajax({
      url: `/api/shells/${shellId}/link_target`,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ target_id: targetId }),
      success: function(resp) {
        if (resp.status === 'success') {
          $('#updateTargetStatus').text('Đã cập nhật liên kết!').removeClass('text-danger').addClass('text-success').show();
          // Cập nhật lại thông tin hiển thị
          const selected = $('#targetSelect option:selected');
          $('#linkedTargetHostname').text(selected.text());
          $('#linkedTargetId').text(targetId).attr('href', '/targets/' + targetId);
        } else {
          $('#updateTargetStatus').text('Lỗi: ' + resp.msg).removeClass('text-success').addClass('text-danger').show();
        }
      },
      error: function(xhr) {
        $('#updateTargetStatus').text('Lỗi cập nhật!').removeClass('text-success').addClass('text-danger').show();
      },
      complete: function() {
        $('#updateTargetBtn').prop('disabled', false);
        setTimeout(function() { $('#updateTargetStatus').fadeOut(); }, 2000);
      }
    });
  });

  // Terminal tương tác trực tiếp
  let commandHistory = [];
  let historyIndex = -1;
  let isConnected = false;
  let currentShellId = '{{ shell.connection_id }}';
  let currentShellData = null;

  function initTerminal() {
    $('#terminalOutput').empty();
    addOutputLine('Welcome to Interactive Shell', 'success');
    addOutputLine('Type your command below.', 'output');
    addOutputLine('', 'output');
  }

  function addOutputLine(text, type = 'output') {
    const line = $('<div>').addClass('terminal-line');
    const output = $('<span>').addClass(`${type}-line`).text(text);
    line.append(output);
    $('#terminalOutput').append(line);
    const terminalBody = document.getElementById('terminalOutput');
    terminalBody.scrollTop = terminalBody.scrollHeight;
  }

  function addCommandLine(command) {
    const line = $('<div>').addClass('terminal-line');
    const prompt = $('<span>').addClass('prompt').text('root@target:~$');
    const cmd = $('<span>').addClass('command').text(command);
    const cursor = $('<span>').addClass('cursor').text('|');
    line.append(prompt, cmd, cursor);
    $('#terminalOutput').append(line);
    const terminalBody = document.getElementById('terminalOutput');
    terminalBody.scrollTop = terminalBody.scrollHeight;
  }

  function connectToShell(shellId) {
    if (!shellId) return;
    $.ajax({
      url: `/api/shells/${shellId}/start`,
      type: 'POST',
      success: function(response) {
        if (response.status === 'success') {
          isConnected = true;
          $('#shellStatus').removeClass('bg-secondary bg-danger').addClass('bg-success').text('Connected');
          $('#commandInput').prop('disabled', false);
          $('#sendCommand').prop('disabled', false);
          $('#disconnectShell').prop('disabled', false);
          // Get shell info
          $.ajax({
            url: `/api/shells/${shellId}`,
            type: 'GET',
            success: function(shellResponse) {
              if (shellResponse.status === 'success') {
                currentShellData = shellResponse.data;
                $('#targetInfo').text(`Target: ${currentShellData.hostname || currentShellData.name}`);
                addOutputLine(`Connected to shell: ${currentShellData.name}`, 'success');
                addOutputLine(`Type: ${currentShellData.shell_type}`, 'output');
                addOutputLine(`Status: ${currentShellData.status}`, 'output');
                addOutputLine('', 'output');
              }
            }
          });
          loadCommandHistory(shellId);
        } else {
          addOutputLine(`Failed to connect: ${response.msg}`, 'error');
        }
      },
      error: function(xhr) {
        addOutputLine(`Connection error: ${xhr.responseJSON?.msg || 'Unknown error'}`, 'error');
      }
    });
  }

  function loadCommandHistory(shellId) {
    $.ajax({
      url: `/api/shells/${shellId}/history`,
      type: 'GET',
      data: { limit: 50 },
      success: function(response) {
        if (response.status === 'success') {
          commandHistory = response.data.map(cmd => cmd.command);
          historyIndex = commandHistory.length;
        }
      }
    });
  }

  function sendCommandToShell(command) {
    if (!currentShellId || !isConnected) return;
    addCommandLine(command);
    $.ajax({
      url: `/api/shells/${currentShellId}/command`,
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ command: command }),
      success: function(response) {
        if (response.status === 'success') {
          const output = response.data.output;
          if (output) {
            addOutputLine(output, 'output');
          }
          addOutputLine('', 'output');
        } else {
          addOutputLine(`Command failed: ${response.msg}`, 'error');
        }
      },
      error: function(xhr) {
        addOutputLine(`Error executing command: ${xhr.responseJSON?.msg || 'Unknown error'}`, 'error');
      }
    });
  }

  function disconnectShell() {
    if (currentShellId) {
      $.ajax({
        url: `/api/shells/${currentShellId}/close`,
        type: 'POST',
        success: function(response) {
          // ...
        }
      });
    }
    isConnected = false;
    $('#shellStatus').removeClass('bg-success bg-danger').addClass('bg-secondary').text('Disconnected');
    $('#commandInput').prop('disabled', true);
    $('#sendCommand').prop('disabled', true);
    $('#disconnectShell').prop('disabled', true);
    $('#targetInfo').text('Target: {{ shell.hostname or shell_name or shell_id }}');
    addOutputLine('Shell disconnected', 'error');
  }

  $('#sendCommand').click(function() {
    const command = $('#commandInput').val().trim();
    if (command && isConnected) {
      sendCommandToShell(command);
      $('#commandInput').val('');
    }
  });
  $('#commandInput').keypress(function(e) {
    if (e.which === 13 && isConnected) {
      const command = $(this).val().trim();
      if (command) {
        sendCommandToShell(command);
        $(this).val('');
      }
    }
  });
  $('#commandInput').keydown(function(e) {
    if (e.which === 38) {
      e.preventDefault();
      if (historyIndex > 0) {
        historyIndex--;
        $(this).val(commandHistory[historyIndex]);
      }
    } else if (e.which === 40) {
      e.preventDefault();
      if (historyIndex < commandHistory.length - 1) {
        historyIndex++;
        $(this).val(commandHistory[historyIndex]);
      } else if (historyIndex === commandHistory.length - 1) {
        historyIndex++;
        $(this).val('');
      }
    }
  });
  $('#clearTerminal').click(function() {
    initTerminal();
  });
  $('#saveOutput').click(function() {
    const output = $('#terminalOutput').text();
    const blob = new Blob([output], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `shell_output_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });
  $('#loadHistory').click(function() {
    if (currentShellId) {
      loadCommandHistory(currentShellId);
      addOutputLine('Command history loaded', 'success');
    }
  });
  $('#fullscreen').click(function() {
    const container = $('.shell-container');
    const icon = $(this).find('i');
    if (container.hasClass('fullscreen')) {
      container.removeClass('fullscreen');
      icon.removeClass('fa-compress').addClass('fa-expand');
    } else {
      container.addClass('fullscreen');
      icon.removeClass('fa-expand').addClass('fa-compress');
    }
  });
  $('#disconnectShell').click(function() {
    disconnectShell();
  });

  // Tự động kết nối shell khi vào trang
  initTerminal();
  //connectToShell(currentShellId); // PHẢI tắt tự động kết nối shell khi vào trang

  // Nút bật/tắt shell
  function updateToggleShellBtn(status) {
    if (status === 'CLOSED' || status === 'closed') {
      $('#toggleShellBtnText').text('Bật Shell');
      $('#toggleShellBtn').removeClass('btn-outline-danger').addClass('btn-outline-success');
    } else {
      $('#toggleShellBtnText').text('Tắt Shell');
      $('#toggleShellBtn').removeClass('btn-outline-success').addClass('btn-outline-danger');
    }
  }

  // Gọi khi trạng thái shell thay đổi hoặc khi load trang
  function refreshShellStatus() {
    $.ajax({
      url: `/api/shells/${currentShellId}`, // lấy thông tin shell 
      type: 'GET',
      success: function(resp) {
        if (resp.status === 'success') {
          const status = resp.data.status;
          updateToggleShellBtn(status);
          // Cập nhật badge
          if (status === 'CLOSED' || status === 'closed') {
            $('#shellStatus').removeClass('bg-success').addClass('bg-secondary').text('Closed');
            $('#commandInput').prop('disabled', true);
            $('#sendCommand').prop('disabled', true);
            $('#disconnectShell').prop('disabled', true);
          } else if (status === 'CONNECTED' || status === 'LISTENING' || status === 'connected' || status === 'listening') {
            $('#shellStatus').removeClass('bg-secondary').addClass('bg-success').text('Connected');
            $('#commandInput').prop('disabled', false);
            $('#sendCommand').prop('disabled', false);
            $('#disconnectShell').prop('disabled', false);
          }
        }
      }
    });
  }

  // Sự kiện click nút bật/tắt shell
  $('#toggleShellBtn').click(function() {
    $.ajax({
      url: `/api/shells/${currentShellId}`,
      type: 'GET',
      success: function(resp) {
        if (resp.status === 'success') {
          const status = resp.data.status;
          if (status === 'CLOSED' || status === 'closed') {
            // Bật shell
            $.ajax({
              url: `/api/shells/${currentShellId}/start`,
              type: 'POST',
              success: function(startResp) {
                if (startResp.status === 'success') {
                  alert('Shell đã được bật!');
                  refreshShellStatus();
                  connectToShell(currentShellId);
                } else {
                  alert('Không thể bật shell: ' + startResp.msg);
                }
              },
              error: function() { alert('Lỗi bật shell!'); }
            });
          } else {
            // Tắt shell
            if (confirm('Bạn có chắc muốn tắt shell này?')) {
              $.ajax({
                url: `/api/shells/${currentShellId}/close`,
                type: 'POST',
                success: function(closeResp) {
                  if (closeResp.status === 'success') {
                    alert('Shell đã được tắt!');
                    refreshShellStatus();
                  } else {
                    alert('Không thể tắt shell: ' + closeResp.msg);
                  }
                },
                error: function() { alert('Lỗi tắt shell!'); }
              });
            }
          }
        }
      }
    });
  });

  // Khi load trang, cập nhật trạng thái nút bật/tắt shell
  refreshShellStatus();
});
</script>
{% endblock content %}
