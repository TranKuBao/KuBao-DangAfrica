{% extends "layouts/base.html" %}

{% block content %}

<div class="container-fluid py-4">
  <!-- Header Statistics Cards -->
  <div class="row mb-4">
    <div class="col-8">
      <h4 class="mb-3">üìä Dashboard system statistics
    </h4>
    </div>
    <div class="col-4 text-end">
      <button class="btn btn-sm btn-primary" onclick="forceDashboardReload()">
        <i class="fas fa-sync-alt me-1"></i> Force Reload
      </button>
    </div>
  </div>

  <!-- Quick Stats Cards - Similar to index.html -->
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6 col-12 mb-3">
      <div class="card">
        <span class="mask bg-primary opacity-10 border-radius-lg"></span>
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                <i class="ni ni-bug text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
              </div>
              <h5 class="text-white font-weight-bolder mb-0 mt-3" id="total-pocs">0</h5>
              <span class="text-white text-sm">T·ªïng POC</span>
            </div>
            <div class="col-4">
              <div class="dropdown text-end mb-6">
                <a href="javascript:;" class="cursor-pointer" id="dropdownPocs" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-h text-white"></i>
                </a>
                <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownPocs">
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Xem chi ti·∫øt</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">C·∫≠p nh·∫≠t</a></li>
                </ul>
              </div>
              <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0" id="poc-trend">+0%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 col-12 mb-3">
      <div class="card">
        <span class="mask bg-dark opacity-10 border-radius-lg"></span>
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                <i class="ni ni-world text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
              </div>
              <h5 class="text-white font-weight-bolder mb-0 mt-3" id="total-targets">0</h5>
              <span class="text-white text-sm">Targets</span>
            </div>
            <div class="col-4">
              <div class="dropstart text-end mb-6">
                <a href="javascript:;" class="cursor-pointer" id="dropdownTargets" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-h text-white"></i>
                </a>
                <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownTargets">
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Xem chi ti·∫øt</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">C·∫≠p nh·∫≠t</a></li>
                </ul>
              </div>
              <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0" id="target-trend">+0%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 col-12 mb-3">
      <div class="card">
        <span class="mask bg-primary opacity-10 border-radius-lg"></span>
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                <i class="ni ni-laptop text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
              </div>
              <h5 class="text-white font-weight-bolder mb-0 mt-3" id="total-shells">0</h5>
              <span class="text-white text-sm">Shell Connections</span>
            </div>
            <div class="col-4">
              <div class="dropdown text-end mb-6">
                <a href="javascript:;" class="cursor-pointer" id="dropdownShells" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-h text-white"></i>
                </a>
                <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownShells">
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Xem chi ti·∫øt</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">C·∫≠p nh·∫≠t</a></li>
                </ul>
              </div>
              <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0" id="shell-trend">+0%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6 col-12 mb-3">
      <div class="card">
        <span class="mask bg-dark opacity-10 border-radius-lg"></span>
        <div class="card-body p-3 position-relative">
          <div class="row">
            <div class="col-8 text-start">
              <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                <i class="ni ni-folder-17 text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
              </div>
              <h5 class="text-white font-weight-bolder mb-0 mt-3" id="total-files">0</h5>
              <span class="text-white text-sm">Data Files</span>
            </div>
            <div class="col-4">
              <div class="dropstart text-end mb-6">
                <a href="javascript:;" class="cursor-pointer" id="dropdownFiles" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa fa-ellipsis-h text-white"></i>
                </a>
                <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownFiles">
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">Xem chi ti·∫øt</a></li>
                  <li><a class="dropdown-item border-radius-md" href="javascript:;">C·∫≠p nh·∫≠t</a></li>
                </ul>
              </div>
              <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0" id="file-trend">+0%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Charts Section - ƒê∆∞a l√™n ƒë·∫ßu -->
  <div class="row mb-4">
    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üîç POC Categories</h6>
          <p class="text-sm text-muted mb-0">Ph√¢n lo·∫°i POC theo c√¥ng ngh·ªá</p>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="poc-pie-chart" class="chart-canvas" height="250"></canvas>
          </div>
          <div class="row mt-3">
            <div class="col-6 text-center">
              <h4 class="text-primary" id="total-cves">0</h4>
              <p class="text-sm text-muted mb-0">T·ªïng s·ªë CVE</p>
            </div>
            <div class="col-6">
              <h6 class="text-sm font-weight-bold mb-2">POC M·ªõi Nh·∫•t</h6>
              <div id="recent-pocs" class="text-sm">
                <!-- Recent POCs will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üñ•Ô∏è Shell Status & Types</h6>
          <p class="text-sm text-muted mb-0">Tr·∫°ng th√°i v√† lo·∫°i shell</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6">
              <div class="chart">
                <canvas id="shell-status-pie-chart" class="chart-canvas" height="200"></canvas>
              </div>
            </div>
            <div class="col-6">
              <div class="chart">
                <canvas id="shell-type-bar-chart" class="chart-canvas" height="200"></canvas>
              </div>
              <div class="mt-3 text-center">
                <h6 class="text-sm font-weight-bold mb-2">Shell 7 ng√†y qua</h6>
                <h4 class="text-primary" id="shell-recent">0</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üéØ Server Types</h6>
          <p class="text-sm text-muted mb-0">Ph√¢n lo·∫°i server theo c√¥ng ngh·ªá</p>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="server-type-pie-chart" class="chart-canvas" height="250"></canvas>
          </div>
          <div class="mt-3 text-center">
            <h6 class="text-sm font-weight-bold mb-2">Targets m·ªõi (7 ng√†y)</h6>
            <h4 class="text-success" id="targets-recent">0</h4>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6>üíæ TH·ªêNG K√ä FILE CHI TI·∫æT</h6>
              <p class="text-sm text-muted mb-0">T·ªïng quan d·ªØ li·ªáu ƒë√£ thu th·∫≠p</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="loadFileStatistics()">
                <i class="fas fa-sync-alt me-1"></i> Refresh
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- File Statistics Container -->
          <div id="file-statistics-container">
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">ƒêang t·∫£i th·ªëng k√™ file...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üìä File Sizes</h6>
          <p class="text-sm text-muted mb-0">Dung l∆∞·ª£ng file theo lo·∫°i</p>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="file-size-bar-chart" class="chart-canvas" height="250"></canvas>
          </div>
          <div class="mt-3 text-center">
            <h6 class="text-sm font-weight-bold mb-2">Files m·ªõi (7 ng√†y)</h6>
            <h4 class="text-info" id="files-recent">0</h4>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üñ•Ô∏è OS Distribution</h6>
          <p class="text-sm text-muted mb-0">Ph√¢n b·ªë h·ªá ƒëi·ªÅu h√†nh</p>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="os-distribution-bar-chart" class="chart-canvas" height="250"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Charts Row -->
  <div class="row">
    <div class="col-lg-8 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>üìà Ho·∫°t ƒê·ªông Theo Th·ªùi Gian (7 ng√†y qua)</h6>
          <p class="text-sm text-muted mb-0">S·ªë l∆∞·ª£ng targets, shells v√† files theo ng√†y</p>
        </div>
        <div class="card-body">
          <div class="chart">
            <canvas id="time-chart" class="chart-canvas" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>‚ö†Ô∏è Log ƒê·∫∑c Bi·ªát</h6>
          <p class="text-sm text-muted mb-0">C√°c s·ª± ki·ªán quan tr·ªçng</p>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush" id="special-logs">
            <!-- Special logs will be populated here -->
          </div>
        </div>
      </div>
    </div>
  </div>



  <!-- Top Targets Table -->
  <div class="row">
    <div class="col-12 mb-4">
      <div class="card">
        <div class="card-header pb-0">
          <h6>ÔøΩÔøΩ Top Targets C√≥ Nhi·ªÅu Shell Connections</h6>
          <p class="text-sm text-muted mb-0">C√°c targets c√≥ nhi·ªÅu k·∫øt n·ªëi shell nh·∫•t</p>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Target</th>
                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Shell Count</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                  <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Last Activity</th>
                </tr>
              </thead>
              <tbody id="top-targets-table">
                <!-- Top targets will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>

{% endblock content %}

{% block extra_css %}
<style>
/* CSS cho ph·∫ßn th·ªëng k√™ file ƒë·∫πp m·∫Øt */
.file-stats-container {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 20px;
  padding: 25px;
  color: white;
  box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.file-stats-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
  opacity: 0.3;
  pointer-events: none;
}

.stats-header {
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
  padding-bottom: 20px;
  margin-bottom: 25px;
  position: relative;
  z-index: 1;
}

.stats-icon-wrapper {
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}

.total-files-badge {
  font-size: 2.5rem;
  font-weight: 800;
  color: #fff;
  text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
  background: linear-gradient(45deg, #ffd700, #ffed4e);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.stats-size-section {
  margin-bottom: 25px;
  position: relative;
  z-index: 1;
}

.size-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 16px;
  padding: 25px 20px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.size-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
}

.size-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

.size-icon {
  font-size: 3rem;
  margin-bottom: 15px;
  background: linear-gradient(45deg, #4facfe, #00f2fe);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

.size-value {
  font-size: 2.2rem;
  font-weight: 800;
  color: #fff;
  margin-bottom: 8px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.size-label {
  font-size: 0.9rem;
  color: rgba(255, 255, 255, 0.9);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 600;
}

.file-type-breakdown {
  margin-top: 20px;
}

.breakdown-title {
  color: #fff;
  font-weight: 600;
  text-align: center;
  font-size: 1.1rem;
  margin-bottom: 15px;
}

.type-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.type-card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.08) 100%);
  border-radius: 16px;
  padding: 20px 15px;
  text-align: center;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.type-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  transform: translateX(-100%);
  transition: transform 0.6s ease;
}

.type-card:hover::before {
  transform: translateX(100%);
}

.type-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
  border-color: rgba(255, 255, 255, 0.4);
}

.type-header {
  margin-bottom: 15px;
}

.type-icon {
  font-size: 2rem;
  margin-bottom: 10px;
  background: linear-gradient(45deg, #4facfe, #00f2fe);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
}

.type-name {
  font-size: 0.85rem;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.95);
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.type-stats {
  border-top: 1px solid rgba(255, 255, 255, 0.25);
  padding-top: 15px;
  margin-top: 10px;
}

.type-count {
  font-size: 1.4rem;
  font-weight: 800;
  color: #fff;
  margin-bottom: 5px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.type-size {
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.8);
  font-weight: 500;
  letter-spacing: 0.5px;
}

/* M√†u s·∫Øc ƒë·∫∑c bi·ªát cho t·ª´ng lo·∫°i file */
.type-upload {
  background: linear-gradient(135deg, rgba(46, 213, 115, 0.2) 0%, rgba(46, 213, 115, 0.1) 100%);
  border-color: rgba(46, 213, 115, 0.3);
}

.type-download {
  background: linear-gradient(135deg, rgba(54, 123, 245, 0.2) 0%, rgba(54, 123, 245, 0.1) 100%);
  border-color: rgba(54, 123, 245, 0.3);
}

.type-image {
  background: linear-gradient(135deg, rgba(255, 71, 87, 0.2) 0%, rgba(255, 71, 87, 0.1) 100%);
  border-color: rgba(255, 71, 87, 0.3);
}

.type-code {
  background: linear-gradient(135deg, rgba(255, 165, 2, 0.2) 0%, rgba(255, 165, 2, 0.1) 100%);
  border-color: rgba(255, 165, 2, 0.3);
}

.type-file {
  background: linear-gradient(135deg, rgba(108, 92, 231, 0.2) 0%, rgba(108, 92, 231, 0.1) 100%);
  border-color: rgba(108, 92, 231, 0.3);
}

.recent-files-section {
  margin-top: 20px;
}

.recent-files-title {
  color: #fff;
  font-weight: 700;
  text-align: center;
  font-size: 1.2rem;
  margin-bottom: 20px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.recent-file-item {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 12px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.recent-file-item::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  background: linear-gradient(180deg, #4facfe, #00f2fe);
}

.recent-file-item:hover {
  transform: translateX(8px);
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  border-color: rgba(255, 255, 255, 0.4);
}

.recent-file-name {
  color: #fff;
  font-weight: 700;
  font-size: 0.95rem;
  margin-bottom: 6px;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
}

.recent-file-name::before {
  content: 'üìÑ';
  margin-right: 8px;
  font-size: 1rem;
}

.recent-file-info {
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.8rem;
  font-weight: 500;
  letter-spacing: 0.3px;
}

/* Animation cho recent files */
@keyframes slideInFromLeft {
  from {
    opacity: 0;
    transform: translateX(-30px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.recent-file-item {
  animation: slideInFromLeft 0.6s ease-out forwards;
  opacity: 0;
}

/* Floating animation */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-2px); }
}

.stats-icon-wrapper {
  animation: float 3s ease-in-out infinite;
}

/* Pulse animation cho total files badge */
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.total-files-badge {
  animation: pulse 2s ease-in-out infinite;
}

/* Button fixes for header */
.card-header .d-flex.gap-2 {
  align-items: center;
}

.card-header .btn {
  font-size: 0.8rem;
}

/* Collapse button styles */
.collapse-btn {
  min-width: auto;
  padding: 0.25rem 0.5rem;
  transition: all 0.3s ease;
}

.collapse-btn:hover {
  transform: scale(1.1);
}

.card-header {
  position: relative;
}

.card-header .d-flex.gap-2[style*="position: absolute"] {
  z-index: 10;
}


</style>
{% endblock extra_css %}

{% block extra_js %}

<script src="{{ url_for('static', filename='assets/js/plugins/chartjs.min.js') }}"></script>
<script>
// Global variables
let dashboardData = {};
let timeChart = null;
let pocPieChart = null;
let shellStatusPieChart = null;
let shellTypeBarChart = null;
let serverTypePieChart = null;
let osDistributionBarChart = null;
let fileTypePieChart = null;
let fileSizeBarChart = null;

// Initialize dashboard
document.addEventListener("DOMContentLoaded", function () {
    console.log('Dashboard initializing...');
    loadDashboardData();
    loadFileStatistics(); // Load file statistics
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
    setInterval(loadFileStatistics, 60000); // Refresh file stats every 60 seconds
    
    // Add collapse functionality to all statistics cards
    initializeCollapseButtons();
});

// Initialize collapse buttons for all statistics cards
function initializeCollapseButtons() {
    // Get all cards that have statistics/charts (exclude the top stats cards)
    const chartCards = document.querySelectorAll('.card');
    
    chartCards.forEach((card, index) => {
        const header = card.querySelector('.card-header');
        // Skip the top summary cards (they don't have card-header)
        if (header && !header.querySelector('.collapse-btn')) {
            addCollapseButtonToCard(card);
        }
    });
}

function addCollapseButtonToCard(card) {
    const header = card.querySelector('.card-header');
    if (!header) return;
    
    // Create collapse button
    const collapseBtn = document.createElement('button');
    collapseBtn.className = 'btn btn-sm btn-outline-secondary collapse-btn';
    collapseBtn.innerHTML = '<i class="fas fa-chevron-up"></i>';
    collapseBtn.title = 'Thu g·ªçn/M·ªü r·ªông';
    
    // Add click event
    collapseBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const cardBody = card.querySelector('.card-body');
        const icon = this.querySelector('i');
        
        if (cardBody.style.display === 'none') {
            cardBody.style.display = 'block';
            icon.className = 'fas fa-chevron-up';
            this.classList.remove('btn-outline-danger');
            this.classList.add('btn-outline-secondary');
        } else {
            cardBody.style.display = 'none';
            icon.className = 'fas fa-chevron-down';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-outline-danger');
        }
    });
    
    // Find existing button container or create new one
    let buttonContainer = header.querySelector('.d-flex.gap-2');
    
    if (buttonContainer) {
        // Add to existing container (like refresh button container)
        buttonContainer.appendChild(collapseBtn);
    } else {
        // Create new container for collapse button
        buttonContainer = document.createElement('div');
        buttonContainer.className = 'd-flex gap-2 align-items-center';
        buttonContainer.appendChild(collapseBtn);
        
        // Add to header with proper positioning
        header.style.position = 'relative';
        buttonContainer.style.position = 'absolute';
        buttonContainer.style.right = '1rem';
        buttonContainer.style.top = '50%';
        buttonContainer.style.transform = 'translateY(-50%)';
        
        header.appendChild(buttonContainer);
    }
}

// Load dashboard data
function loadDashboardData() {
    console.log('üîÑ Loading dashboard data from API...');
    fetch('/dashboard_stats')
        .then(response => {
            console.log('üì° Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Real dashboard data received:', data);
            
            // Verify we have the correct data structure
            if (data.poc_statistics && data.poc_statistics.total_pocs) {
                console.log('‚úÖ Using REAL data - Total POCs:', data.poc_statistics.total_pocs);
                dashboardData = data;
                updateDashboardUI();
                updateCharts();
            } else {
                console.error('‚ùå Invalid data structure received:', data);
                alert('Invalid data received from server!');
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading dashboard data:', error);
            alert('Failed to load dashboard data: ' + error.message);
        });
}

// Force dashboard reload
function forceDashboardReload() {
    console.log('üîÑ Force reloading dashboard...');
    dashboardData = {}; // Clear existing data
    loadDashboardData();
    loadFileStatistics();
}

// Update dashboard UI
function updateDashboardUI() {
    console.log('üîÑ Updating dashboard UI with data:', dashboardData);
    
    // Update quick stats
    const totalPocs = dashboardData.poc_statistics?.total_pocs || 0;
    const totalTargets = dashboardData.target_statistics?.total_targets || 0;
    const totalShells = dashboardData.shell_statistics?.total_connections || 0;
    const totalFiles = dashboardData.data_statistics?.total_files || 0;
    
    console.log('üìä Updating stats - POCs:', totalPocs, 'Targets:', totalTargets, 'Shells:', totalShells, 'Files:', totalFiles);
    
    // Safely update elements
    const totalPocsElement = document.getElementById('total-pocs');
    if (totalPocsElement) totalPocsElement.textContent = totalPocs;
    
    const totalTargetsElement = document.getElementById('total-targets');
    if (totalTargetsElement) totalTargetsElement.textContent = totalTargets;
    
    const totalShellsElement = document.getElementById('total-shells');
    if (totalShellsElement) totalShellsElement.textContent = totalShells;
    
    const totalFilesElement = document.getElementById('total-files');
    if (totalFilesElement) totalFilesElement.textContent = totalFiles;

    // Update POC categories
    updatePOCCategories();
    
    // Update shell statistics
    updateShellStatistics();
    
    // Update target statistics
    updateTargetStatistics();
    
    // Update data statistics
    updateDataStatistics();
    
    // Update special logs
    updateSpecialLogs();
    
    // Update top targets table
    updateTopTargetsTable();
}

// Update POC categories
function updatePOCCategories() {
    const categories = dashboardData.poc_statistics?.categories || {};
    
    // Update total CVEs
    const totalCvesElement = document.getElementById('total-cves');
    if (totalCvesElement) {
        totalCvesElement.textContent = dashboardData.poc_statistics?.cve_count || 0;
    }
    
    // Update recent POCs
    const recentPOCs = dashboardData.poc_statistics?.recent_pocs || [];
    const recentPOCsDiv = document.getElementById('recent-pocs');
    if (recentPOCsDiv) {
        recentPOCsDiv.innerHTML = recentPOCs.slice(0, 3).map(poc => 
            `<div class="text-sm text-muted mb-1">‚Ä¢ ${poc.name.substring(0, 30)}...</div>`
        ).join('');
    }
}

// Update shell statistics
function updateShellStatistics() {
    const shellStats = dashboardData.shell_statistics || {};
    const shellRecentElement = document.getElementById('shell-recent');
    if (shellRecentElement) {
        shellRecentElement.textContent = shellStats.recent_shells_7days || 0;
    }
}

// Update target statistics
function updateTargetStatistics() {
    const targetStats = dashboardData.target_statistics || {};
    const targetsRecentElement = document.getElementById('targets-recent');
    if (targetsRecentElement) {
        targetsRecentElement.textContent = targetStats.recent_targets_7days || 0;
    }
}

// Update data statistics
function updateDataStatistics() {
    const dataStats = dashboardData.data_statistics || {};
    
    // Safely update total-size if element exists
    const totalSizeElement = document.getElementById('total-size');
    if (totalSizeElement) {
        totalSizeElement.textContent = `${dataStats.total_size_mb || 0} MB`;
    }
    
    // Safely update files-recent if element exists
    const filesRecentElement = document.getElementById('files-recent');
    if (filesRecentElement) {
        filesRecentElement.textContent = dataStats.recent_files_7days || 0;
    }
}

// Update special logs
function updateSpecialLogs() {
    const specialLogs = dashboardData.special_logs || [];
    const logsDiv = document.getElementById('special-logs');
    
    if (!logsDiv) {
        console.warn('Element special-logs not found');
        return;
    }
    
    logsDiv.innerHTML = specialLogs.map(log => {
        const logClass = log.type === 'error' ? 'text-danger' : 
                        log.type === 'warning' ? 'text-warning' : 'text-info';
        const icon = log.type === 'error' ? '‚ö†Ô∏è' : 
                    log.type === 'warning' ? '‚ö°' : '‚ÑπÔ∏è';
        
        return `<div class="list-group-item border-0 d-flex align-items-center px-3 py-2">
            <div class="me-3">
                <span class="text-lg">${icon}</span>
            </div>
            <div class="flex-grow-1">
                <h6 class="text-sm font-weight-bold mb-0 ${logClass}">${log.message}</h6>
                <p class="text-xs text-muted mb-0">${log.details}</p>
                <small class="text-xs text-muted">${log.timestamp ? new Date(log.timestamp).toLocaleString() : 'N/A'}</small>
            </div>
        </div>`;
    }).join('');
}

// Update top targets table
function updateTopTargetsTable() {
    const topTargets = dashboardData.shell_statistics?.top_targets || [];
    const tableBody = document.getElementById('top-targets-table');
    
    if (!tableBody) {
        console.warn('Element top-targets-table not found');
        return;
    }
    
    tableBody.innerHTML = topTargets.map(target => 
        `<tr>
            <td>
                <div class="d-flex px-2 py-1">
                    <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">${target.hostname || 'Unknown'}</h6>
                    </div>
                </div>
            </td>
            <td>
                <span class="text-xs font-weight-bold">${target.count}</span>
            </td>
            <td class="align-middle text-center text-sm">
                <span class="badge badge-sm bg-gradient-success">Active</span>
            </td>
            <td class="align-middle text-center">
                <span class="text-xs text-muted">Recent</span>
            </td>
        </tr>`
    ).join('');
}

// Update charts
function updateCharts() {
    updateTimeChart();
    updatePOCPieChart();
    updateShellStatusPieChart();
    updateShellTypeBarChart();
    updateServerTypePieChart();
    updateOSDistributionBarChart();
    updateFileTypePieChart();
    updateFileSizeBarChart();
}

// Update POC Pie Chart
function updatePOCPieChart() {
    console.log('üîÑ Updating POC Pie Chart...');
    const categories = dashboardData.poc_statistics?.categories || {};
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    
    console.log('üìä POC chart data - Categories:', categories, 'Labels:', labels, 'Data:', data);
    
    if (labels.length === 0) {
        console.error('‚ùå No POC categories data available');
        return;
    }
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    if (pocPieChart) {
        pocPieChart.destroy();
    }
    
    const canvas = document.getElementById('poc-pie-chart');
    if (!canvas) {
        console.error('‚ùå POC pie chart canvas not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    console.log('üé® Creating POC pie chart...');
    pocPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Update Shell Status Pie Chart
function updateShellStatusPieChart() {
    const statusDist = dashboardData.shell_statistics?.status_distribution || {};
    const labels = Object.keys(statusDist);
    const data = Object.values(statusDist);
    
    const colors = ['#4BC0C0', '#36A2EB', '#FFCE56', '#FF6384', '#9966FF'];
    
    if (shellStatusPieChart) {
        shellStatusPieChart.destroy();
    }
    
    const ctx = document.getElementById('shell-status-pie-chart').getContext('2d');
    shellStatusPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// Update Shell Type Bar Chart
function updateShellTypeBarChart() {
    const typeDist = dashboardData.shell_statistics?.type_distribution || {};
    const labels = Object.keys(typeDist);
    const data = Object.values(typeDist);
    
    if (shellTypeBarChart) {
        shellTypeBarChart.destroy();
    }
    
    const ctx = document.getElementById('shell-type-bar-chart').getContext('2d');
    shellTypeBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Shell Count',
                data: data,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update Server Type Pie Chart
function updateServerTypePieChart() {
    const serverTypes = dashboardData.target_statistics?.server_type_distribution || {};
    const labels = Object.keys(serverTypes);
    const data = Object.values(serverTypes);
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    if (serverTypePieChart) {
        serverTypePieChart.destroy();
    }
    
    const ctx = document.getElementById('server-type-pie-chart').getContext('2d');
    serverTypePieChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// Update OS Distribution Bar Chart
function updateOSDistributionBarChart() {
    const osDist = dashboardData.target_statistics?.os_distribution || {};
    const labels = Object.keys(osDist);
    const data = Object.values(osDist);
    
    if (osDistributionBarChart) {
        osDistributionBarChart.destroy();
    }
    
    const ctx = document.getElementById('os-distribution-bar-chart').getContext('2d');
    osDistributionBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'OS Count',
                data: data,
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update File Type Pie Chart
function updateFileTypePieChart() {
    const fileTypes = dashboardData.data_statistics?.file_type_distribution || {};
    const labels = Object.keys(fileTypes);
    const data = Object.values(fileTypes);
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    if (fileTypePieChart) {
        fileTypePieChart.destroy();
    }
    
    const ctx = document.getElementById('file-type-pie-chart').getContext('2d');
    fileTypePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// Update File Size Bar Chart
function updateFileSizeBarChart() {
    const sizeByType = dashboardData.data_statistics?.size_by_type || {};
    const labels = Object.keys(sizeByType);
    const data = Object.values(sizeByType).map(size => Math.round(size / (1024 * 1024))); // Convert to MB
    
    if (fileSizeBarChart) {
        fileSizeBarChart.destroy();
    }
    
    const ctx = document.getElementById('file-size-bar-chart').getContext('2d');
    fileSizeBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Size (MB)',
                data: data,
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        display: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update time-based chart
function updateTimeChart() {
    const timeStats = dashboardData.time_statistics || {};
    const targetsData = timeStats.targets_by_day || [];
    const shellsData = timeStats.shells_by_day || [];
    const filesData = timeStats.files_by_day || [];
    
    // Prepare labels (last 7 days)
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('vi-VN', { month: 'short', day: 'numeric' }));
    }
    
    // Prepare datasets
    const targetsDataset = labels.map(label => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - labels.indexOf(label)));
        const dateStr = date.toISOString().split('T')[0];
        const match = targetsData.find(item => item.date === dateStr);
        return match ? match.count : 0;
    });
    
    const shellsDataset = labels.map(label => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - labels.indexOf(label)));
        const dateStr = date.toISOString().split('T')[0];
        const match = shellsData.find(item => item.date === dateStr);
        return match ? match.count : 0;
    });
    
    const filesDataset = labels.map(label => {
        const date = new Date();
        date.setDate(date.getDate() - (6 - labels.indexOf(label)));
        const dateStr = date.toISOString().split('T')[0];
        const match = filesData.find(item => item.date === dateStr);
        return match ? match.count : 0;
    });
    
    // Destroy existing chart if it exists
    if (timeChart) {
        timeChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('time-chart').getContext('2d');
    timeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Targets',
                data: targetsDataset,
                borderColor: '#cb0c9f',
                backgroundColor: 'rgba(203, 12, 159, 0.2)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Shell Connections',
                data: shellsDataset,
                borderColor: '#3A416F',
                backgroundColor: 'rgba(58, 65, 111, 0.2)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Data Files',
                data: filesDataset,
                borderColor: '#fb6340',
                backgroundColor: 'rgba(251, 99, 64, 0.2)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false,
                        display: true,
                        drawOnChartArea: true,
                        drawTicks: false,
                        borderDash: [5, 5]
                    }
                },
                x: {
                    grid: {
                        drawBorder: false,
                        display: false,
                        drawOnChartArea: false,
                        drawTicks: false
                    }
                }
            }
        }
    });
}

// Load file statistics
function loadFileStatistics() {
    fetch('/file_statistics')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayFileStatistics(data.file_statistics);
            } else {
                console.error('Error loading file statistics:', data.message);
                displayFileStatisticsError(data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching file statistics:', error);
            displayFileStatisticsError('Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ file');
        });
}

// Display file statistics
function displayFileStatistics(fileStats) {
    const container = document.getElementById('file-statistics-container');
    
    let html = `
        <div class="row">
            <!-- Bi·ªÉu ƒë·ªì File Types -->
            <div class="col-lg-6 col-12 mb-4">
                <div class="chart">
                    <canvas id="file-type-pie-chart" class="chart-canvas" height="250"></canvas>
                </div>
                <div class="mt-3 text-center">
                    <h6 class="text-sm font-weight-bold mb-2">T·ªïng dung l∆∞·ª£ng</h6>
                    <h3 class="text-warning">${fileStats.total_size_mb} MB</h3>
                    <p class="text-sm text-muted">T·ªïng c·ªông ${fileStats.total_files} files</p>
                </div>
            </div>
            
            <!-- Th·ªëng k√™ chi ti·∫øt -->
            <div class="col-lg-6 col-12 mb-4">
                <div class="file-stats-container">
                    <!-- Header th·ªëng k√™ ch√≠nh -->
                    <div class="stats-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="stats-icon-wrapper me-3">
                                    <i class="fas fa-chart-pie text-white"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 text-white font-weight-bold">üìä TH·ªêNG K√ä</h6>
                                    <small class="text-white-50">Download vs Upload</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="total-files-badge">${fileStats.total_files}</div>
                                <small class="text-white-50">T·ªïng s·ªë file</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Th·ªëng k√™ dung l∆∞·ª£ng -->
                    <div class="stats-size-section">
                        <div class="row">
                            <div class="col-6">
                                <div class="size-card">
                                    <div class="size-icon">
                                        <i class="fas fa-download text-success"></i>
                                    </div>
                                    <div class="size-info">
                                        <div class="size-value">${fileStats.download_files.size_mb}</div>
                                        <div class="size-label">MB Download</div>
                                        <small class="text-white-50">${fileStats.download_files.count} files</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="size-card">
                                    <div class="size-icon">
                                        <i class="fas fa-upload text-warning"></i>
                                    </div>
                                    <div class="size-info">
                                        <div class="size-value">${fileStats.upload_files.size_mb}</div>
                                        <div class="size-label">MB Upload</div>
                                        <small class="text-white-50">${fileStats.upload_files.count} files</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    `;
    
    // Ph√¢n lo·∫°i file theo lo·∫°i
    if (fileStats.by_type && Object.keys(fileStats.by_type).length > 0) {
        html += `
            <div class="file-type-breakdown">
                <h6 class="breakdown-title">
                    <i class="fas fa-layer-group me-2"></i>
                    PH√ÇN LO·∫†I THEO LO·∫†I
                </h6>
                <div class="type-grid">
        `;
        
        for (const [fileType, stats] of Object.entries(fileStats.by_type)) {
            const fileIcon = getFileIcon(fileType);
            html += `
                <div class="type-card type-${fileType.toLowerCase()}">
                    <div class="type-header">
                        <div class="type-icon">
                            <i class="fas fa-${fileIcon}"></i>
                        </div>
                        <div class="type-name">${fileType.toUpperCase()}</div>
                    </div>
                    <div class="type-stats">
                        <div class="type-count">${stats.count}</div>
                        <div class="type-size">${stats.size_mb} MB</div>
                    </div>
                </div>
            `;
        }
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Files m·ªõi nh·∫•t
    if (fileStats.recent_files && fileStats.recent_files.length > 0) {
        html += `
            <div class="recent-files-section">
                <h6 class="recent-files-title">
                    <i class="fas fa-clock me-2"></i>
                    FILES M·ªöI NH·∫§T
                </h6>
        `;
        
        fileStats.recent_files.slice(0, 5).forEach((file, index) => {
            const createdDate = file.created_at ? new Date(file.created_at).toLocaleDateString('vi-VN') : 'N/A';
            const fileIcon = getFileTypeIcon(file.file_type);
            const typeColor = getFileTypeColor(file.file_type);
            html += `
                <div class="recent-file-item" style="animation-delay: ${index * 0.1}s">
                    <div class="recent-file-name">
                        <span style="margin-right: 10px; font-size: 1.1rem;">${fileIcon}</span>
                        ${file.file_name}
                    </div>
                    <div class="recent-file-info">
                        <span style="color: ${typeColor}; font-weight: 600;">${file.file_type.toUpperCase()}</span> 
                        ‚Ä¢ <strong>${file.file_size_mb} MB</strong> 
                        ‚Ä¢ ${createdDate}
                    </div>
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // T·∫°o bi·ªÉu ƒë·ªì pie chart sau khi HTML ƒë∆∞·ª£c render
    updateFileTypePieChartFromStats(fileStats);
}

// Display file statistics error
function displayFileStatisticsError(message) {
    const container = document.getElementById('file-statistics-container');
    container.innerHTML = `
        <div class="text-center py-4">
            <div class="icon icon-shape icon-lg bg-gradient-danger shadow text-center border-radius-xl mt-n4 mx-auto">
                <i class="fas fa-exclamation-triangle text-white"></i>
            </div>
            <h6 class="mt-3 text-danger">L·ªói t·∫£i th·ªëng k√™</h6>
            <p class="text-sm text-muted">${message}</p>
            <button class="btn btn-primary btn-sm mt-2" onclick="loadFileStatistics()">
                <i class="fas fa-redo me-1"></i> Th·ª≠ l·∫°i
            </button>
        </div>
    `;
}

// Update File Type Pie Chart from file statistics
function updateFileTypePieChartFromStats(fileStats) {
    const fileTypes = fileStats.by_type || {};
    const labels = Object.keys(fileTypes);
    const data = Object.values(fileTypes).map(stats => stats.count);
    
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    
    if (fileTypePieChart) {
        fileTypePieChart.destroy();
    }
    
    const ctx = document.getElementById('file-type-pie-chart').getContext('2d');
    fileTypePieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            const fileType = fileTypes[label];
                            const sizeMB = fileType ? fileType.size_mb : 0;
                            return `${label}: ${value} files (${percentage}%) - ${sizeMB} MB`;
                        }
                    }
                }
            }
        }
    });
}

// Get file icon based on type
function getFileIcon(fileType) {
    const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg'];
    const codeTypes = ['php', 'html', 'js', 'css', 'py', 'java', 'cpp', 'c'];
    const docTypes = ['pdf', 'doc', 'docx', 'txt', 'rtf'];
    
    if (imageTypes.includes(fileType.toLowerCase())) {
        return 'image';
    } else if (codeTypes.includes(fileType.toLowerCase())) {
        return 'code';
    } else if (docTypes.includes(fileType.toLowerCase())) {
        return 'file-alt';
    } else if (fileType.toLowerCase() === 'upload') {
        return 'upload';
    } else if (fileType.toLowerCase() === 'download') {
        return 'download';
    } else {
        return 'file';
    }
}

// Get file type emoji icon
function getFileTypeIcon(fileType) {
    const type = fileType.toLowerCase();
    
    switch(type) {
        case 'download': return '‚¨áÔ∏è';
        case 'upload': return '‚¨ÜÔ∏è';
        case 'php': return 'üêò';
        case 'html': return 'üåê';
        case 'js': case 'javascript': return '‚ö°';
        case 'css': return 'üé®';
        case 'py': case 'python': return 'üêç';
        case 'java': return '‚òï';
        case 'txt': return 'üìù';
        case 'pdf': return 'üìÑ';
        case 'doc': case 'docx': return 'üìÉ';
        case 'jpg': case 'jpeg': case 'png': case 'gif': return 'üñºÔ∏è';
        case 'mp4': case 'avi': case 'mov': return 'üé¨';
        case 'mp3': case 'wav': return 'üéµ';
        case 'zip': case 'rar': case 'tar': return 'üì¶';
        case 'exe': return '‚öôÔ∏è';
        case 'sh': return 'üíª';
        default: return 'üìÅ';
    }
}

// Get file type color
function getFileTypeColor(fileType) {
    const type = fileType.toLowerCase();
    
    switch(type) {
        case 'download': return '#4facfe';
        case 'upload': return '#43e97b';
        case 'php': return '#8993be';
        case 'html': return '#e34c26';
        case 'js': case 'javascript': return '#f7df1e';
        case 'css': return '#1572b6';
        case 'py': case 'python': return '#3776ab';
        case 'java': return '#ed8b00';
        case 'txt': return '#ffffff';
        case 'pdf': return '#ff0000';
        case 'doc': case 'docx': return '#2b579a';
        case 'jpg': case 'jpeg': case 'png': case 'gif': return '#ff6b6b';
        case 'zip': case 'rar': case 'tar': return '#feca57';
        default: return '#a4b0be';
    }
}
</script>

{% endblock extra_js %}
