<!-- Add/Edit Weevely Connection Form -->
<div class="row my-3" id="editshell-hidden" hidden>
  <div class="col-12">
    <div class="card mb-4">
      <div class="card-header pb-0 p-3">
        <div class="row">
          <div class="col-6 d-flex align-items-center">
            <h6 class="mb-0" style="margin-left: 20px !important;">Add Weevely Backdoor</h6>
          </div>
          <div class="col-6 text-end">
            <button class="btn btn-outline-secondary btn-sm" onclick="on_off_addshell()">
              <i class="fas fa-times"></i> Close
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <form id="add-weevely-form">
          <div class="row">
            <!-- Basic Information -->
            <div class="col-md-6">
              <div class="form-group">
                <label for="weevely-name" class="form-label">Connection Name *</label>
                <input type="text" class="form-control" id="weevely-name" name="name" 
                       placeholder="e.g., Production Server" required>
                <small class="form-text text-muted">Friendly name for this weevely connection</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="weevely-password" class="form-label">Password *</label>
                <div class="input-group">
                  <input type="password" class="form-control" id="weevely-password" name="password" 
                         placeholder="Enter backdoor password" required>
                  <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('weevely-password')">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <small class="form-text text-muted">Password for the weevely backdoor</small>
              </div>
            </div>
          </div>

          <div class="row">
            <!-- Target Information -->
            <div class="col-md-12">
              <div class="form-group">
                <label for="target-url" class="form-label">Target URL *</label>
                <input type="url" class="form-control" id="target-url" name="target_url" 
                       placeholder="https://example.com/path/to/backdoor.php" required>
                <small class="form-text text-muted">Full URL where the weevely backdoor will be/is deployed</small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="target-hostname" class="form-label">Hostname</label>
                <input type="text" class="form-control" id="target-hostname" name="target_hostname" 
                       placeholder="example.com">
                <small class="form-text text-muted">Target hostname (optional)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="target-ip" class="form-label">IP Address</label>
                <input type="text" class="form-control" id="target-ip" name="target_ip" 
                       placeholder="192.168.1.100">
                <small class="form-text text-muted">Target IP address (optional)</small>
              </div>
            </div>
          </div>

          <!-- Backdoor Configuration -->
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="backdoor-filename" class="form-label">Backdoor Filename</label>
                <input type="text" class="form-control" id="backdoor-filename" name="backdoor_filename" 
                       placeholder="shell.php">
                <small class="form-text text-muted">Name for the generated backdoor file (auto-generated if empty)</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="obfuscation-type" class="form-label">Obfuscation Type</label>
                <select class="form-control" id="obfuscation-type" name="obfuscation_type">
                  <option value="phar" selected>PHAR (Recommended)</option>
                  <option value="cleartext1_php">Clear Text PHP</option>
                  <option value="obfusc1_php">Obfuscated PHP</option>
                </select>
                <small class="form-text text-muted">Obfuscation method for the backdoor</small>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="agent-type" class="form-label">Agent Type</label>
                <select class="form-control" id="agent-type" name="agent_type">
                  <option value="obfpost_php" selected>ObfPost PHP (Default)</option>
                </select>
                <small class="form-text text-muted">Weevely agent communication type</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="notes" class="form-label">Notes</label>
                <textarea class="form-control" id="notes" name="notes" rows="3" 
                          placeholder="Additional notes about this connection..."></textarea>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex gap-2">
                <button type="submit" class="btn bg-gradient-success" id="submit-weevely-btn">
                  <i class="fas fa-plus"></i> Create Weevely Connection
                </button>
                <button type="button" class="btn bg-gradient-secondary" onclick="resetForm()">
                  <i class="fas fa-undo"></i> Reset Form
                </button>
                <button type="button" class="btn bg-gradient-info" onclick="generateRandomPassword()">
                  <i class="fas fa-key"></i> Generate Password
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Add Weevely Form -->
<script>
// Toggle password visibility
function togglePasswordVisibility(inputId) {
  const input = document.getElementById(inputId);
  const button = input.nextElementSibling.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    button.classList.remove('fa-eye');
    button.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    button.classList.remove('fa-eye-slash');
    button.classList.add('fa-eye');
  }
}

// Generate random password
function generateRandomPassword() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
  let password = '';
  for (let i = 0; i < 16; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  document.getElementById('weevely-password').value = password;
}

// Reset form
function resetForm() {
  document.getElementById('add-weevely-form').reset();
}

// Auto-fill hostname from URL
document.getElementById('target-url').addEventListener('input', function() {
  try {
    const url = new URL(this.value);
    const hostnameField = document.getElementById('target-hostname');
    if (!hostnameField.value) {
      hostnameField.value = url.hostname;
    }
  } catch (e) {
    // Invalid URL, ignore
  }
});

// Form submission
document.getElementById('add-weevely-form').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const submitBtn = document.getElementById('submit-weevely-btn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
  submitBtn.disabled = true;
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData.entries());
  
  console.log('Submitting weevely data:', data);
  
  fetch('/api/add_weevely', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(data => {
    console.log('Response:', data);
    
    if (data.status === '1') {
      // Success
      alert('Weevely connection created successfully!');
      this.reset();
      on_off_addshell(); // Hide form
      
      // Refresh the weevely list
      showContent(currentPage, document.getElementById("id_search_shell").value, currentSortType);
    } else {
      // Error
      alert('Error: ' + (data.message || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Network error: ' + error.message);
  })
  .finally(() => {
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  });
});
</script>

<style>
.form-group {
  margin-bottom: 1rem;
}

.form-label {
  font-weight: 600;
  color: #344767;
  margin-bottom: 0.5rem;
}

.form-control {
  border: 1px solid #d2d6da;
  border-radius: 0.5rem;
  padding: 0.625rem 0.75rem;
  font-size: 0.875rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
  border-color: #f97316;
  box-shadow: 0 0 0 0.2rem rgba(249, 115, 22, 0.25);
}

.input-group .btn {
  border: 1px solid #d2d6da;
  border-left: none;
}

.form-text {
  font-size: 0.75rem;
  color: #67748e;
}

.btn {
  font-weight: 600;
  letter-spacing: 0.025em;
}

.gap-2 {
  gap: 0.5rem !important;
}
</style>
