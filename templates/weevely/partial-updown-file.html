<!-- File Upload/Download Manager -->
<div class="row my-3">
  <div class="col-12">
    <div class="card mb-4 file-manager-card">
      <div class="card-header pb-0 p-3">
        <div class="row">
          <div class="col-6 d-flex align-items-center">
            <h6 class="mb-0" style="margin-left: 20px !important;">File Manager</h6>
          </div>
          <div class="col-6 text-end">
            <button class="btn bg-gradient-primary mb-0" id="btn-upload-file" style="margin-right: 10px !important;">
              <i class="fas fa-upload"></i>&nbsp;&nbsp;Upload File
            </button>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="card-header pb-0 p-3">
        <ul class="nav nav-tabs file-manager-tabs" id="fileManagerTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" 
                    type="button" role="tab" aria-controls="upload-panel" aria-selected="true">
              <i class="fas fa-upload me-2"></i>Uploaded Files
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="download-tab" data-bs-toggle="tab" data-bs-target="#download-panel" 
                    type="button" role="tab" aria-controls="download-panel" aria-selected="false">
              <i class="fas fa-download me-2"></i>Downloaded Files
            </button>
          </li>
        </ul>
      </div>

      <!-- Tab Content -->
      <div class="card-body">
        <div class="tab-content" id="fileManagerTabContent">
          
          <!-- Upload Panel -->
          <div class="tab-pane fade show active" id="upload-panel" role="tabpanel" aria-labelledby="upload-tab">
            
            <!-- Action Bar for Upload -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
              <!-- Search Box -->
              <div class="input-group" style="max-width: 280px; min-width: 200px;">
                <span class="input-group-text text-body">
                  <i class="fas fa-search" aria-hidden="true"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search files..." 
                       id="search-upload-files">
              </div>
              
              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" id="btn-view-upload-selected" 
                        title="View selected file">
                  <i class="fas fa-eye"></i> View
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="btn-delete-upload-selected" 
                        title="Delete selected files">
                  <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-outline-success btn-sm" id="btn-download-upload-selected" 
                        title="Download selected files to client">
                  <i class="fas fa-download"></i> Download
                </button>
              </div>
            </div>

            <!-- Upload Files Table -->
            <div class="table-responsive">
              <table class="table align-items-center mb-0" id="upload-files-table">
                <thead>
                  <tr>
                    <th class="text-secondary opacity-7" style="width: 50px;">
                      <input type="checkbox" id="select-all-upload" class="form-check-input" 
                             onchange="toggleAllUploadFiles(this)">
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      File Name
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      File Size
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      Upload Time
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      Status
                    </th>
                  </tr>
                </thead>
                <tbody id="upload-files-tbody">
                  <!-- Sample Upload Data -->
                  <tr class="file-row" data-file-id="upload-1" title="Double-click to view file">
                    <td>
                      <input type="checkbox" class="form-check-input upload-file-checkbox" 
                             data-file-id="upload-1" onchange="onUploadFileCheckboxChange(this)" 
                             onclick="event.stopPropagation()">
                    </td>
                    <td class="file-name-cell" onclick="viewFileContent('upload-1')">
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">
                            <i class="fas fa-file-code file-icon php me-2"></i>
                            backdoor.php
                          </h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">2.4 KB</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">2024-01-15 14:30:25</p>
                    </td>
                    <td>
                      <span class="badge badge-sm bg-gradient-success">Uploaded</span>
                    </td>
                  </tr>
                  
                  <tr class="file-row" data-file-id="upload-2" title="Double-click to view file">
                    <td>
                      <input type="checkbox" class="form-check-input upload-file-checkbox" 
                             data-file-id="upload-2" onchange="onUploadFileCheckboxChange(this)" 
                             onclick="event.stopPropagation()">
                    </td>
                    <td class="file-name-cell" onclick="viewFileContent('upload-2')">
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">
                            <i class="fas fa-file-image file-icon png me-2"></i>
                            screenshot.png
                          </h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">145.2 KB</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">2024-01-15 15:45:12</p>
                    </td>
                    <td>
                      <span class="badge badge-sm bg-gradient-success">Uploaded</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Download Panel -->
          <div class="tab-pane fade" id="download-panel" role="tabpanel" aria-labelledby="download-tab">
            
            <!-- Action Bar for Download -->
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-2">
              <!-- Search Box -->
              <div class="input-group" style="max-width: 280px; min-width: 200px;">
                <span class="input-group-text text-body">
                  <i class="fas fa-search" aria-hidden="true"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search files..." 
                       id="search-download-files">
              </div>
              
              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info btn-sm" id="btn-view-download-selected" 
                        title="View selected file">
                  <i class="fas fa-eye"></i> View
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="btn-delete-download-selected" 
                        title="Delete selected files">
                  <i class="fas fa-trash-alt"></i> Delete
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btn-save-download-selected" 
                        title="Save selected files to client">
                  <i class="fas fa-save"></i> Save
                </button>
              </div>
            </div>

            <!-- Download Files Table -->
            <div class="table-responsive">
              <table class="table align-items-center mb-0" id="download-files-table">
                <thead>
                  <tr>
                    <th class="text-secondary opacity-7" style="width: 50px;">
                      <input type="checkbox" id="select-all-download" class="form-check-input" 
                             onchange="toggleAllDownloadFiles(this)">
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      File Name
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      File Size
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      Download Time
                    </th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                      Source Path
                    </th>
                  </tr>
                </thead>
                <tbody id="download-files-tbody">
                  <!-- Sample Download Data -->
                  <tr class="file-row" data-file-id="download-1" title="Double-click to view file">
                    <td>
                      <input type="checkbox" class="form-check-input download-file-checkbox" 
                             data-file-id="download-1" onchange="onDownloadFileCheckboxChange(this)" 
                             onclick="event.stopPropagation()">
                    </td>
                    <td class="file-name-cell" onclick="viewFileContent('download-1')">
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">
                            <i class="fas fa-file-alt file-icon txt me-2"></i>
                            config.txt
                          </h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">892 B</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">2024-01-15 16:20:33</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">/var/www/html/config.txt</p>
                    </td>
                  </tr>
                  
                  <tr class="file-row" data-file-id="download-2" title="Double-click to view file">
                    <td>
                      <input type="checkbox" class="form-check-input download-file-checkbox" 
                             data-file-id="download-2" onchange="onDownloadFileCheckboxChange(this)" 
                             onclick="event.stopPropagation()">
                    </td>
                    <td class="file-name-cell" onclick="viewFileContent('download-2')">
                      <div class="d-flex px-2 py-1">
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0 text-sm">
                            <i class="fas fa-database file-icon sql me-2"></i>
                            database.sql
                          </h6>
                        </div>
                      </div>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">3.7 MB</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">2024-01-15 17:05:41</p>
                    </td>
                    <td>
                      <p class="text-xs text-secondary mb-0">/var/lib/mysql/backup.sql</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload File Modal -->
<div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadFileModalLabel">
          <i class="fas fa-upload me-2"></i>Upload File to Server
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="uploadFileForm" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-12">
              <div class="form-group mb-3">
                <label for="uploadFileInput" class="form-label">Select File(s)</label>
                <input type="file" class="form-control" id="uploadFileInput" name="files" multiple 
                       accept="*/*" onchange="displaySelectedFiles()">
                <small class="form-text text-muted">
                  You can select multiple files. Maximum size: 100MB per file.
                </small>
              </div>
            </div>
          </div>         
          

          <!-- Selected Files Display -->
          <div id="selectedFilesContainer" style="display: none;">
            <h6>Selected Files:</h6>
            <div id="selectedFilesList" class="list-group">
              <!-- Files will be displayed here -->
            </div>
          </div>

          <!-- Upload Progress -->
          <div id="uploadProgressContainer" style="display: none;">
            <h6>Upload Progress:</h6>
            <div class="progress mb-2">
              <div class="progress-bar" role="progressbar" style="width: 0%" id="uploadProgressBar">0%</div>
            </div>
            <div id="uploadStatus" class="text-muted"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="startUploadBtn" onclick="startFileUpload()">
          <i class="fas fa-upload me-2"></i>Start Upload
        </button>
      </div>
    </div>
  </div>
</div>

<!-- File Viewer Modal -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fileViewerModalLabel">
          <i class="fas fa-file-alt me-2"></i>File Content
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-4">
            <strong>File Name:</strong> <span id="viewerFileName" class="text-primary"></span>
          </div>
          <div class="col-md-3">
            <strong>File Size:</strong> <span id="viewerFileSize" class="text-info"></span>
          </div>
          <div class="col-md-3">
            <strong>File Type:</strong> <span id="viewerFileType" class="text-warning"></span>
          </div>
          <div class="col-md-2">
            <strong>Lines:</strong> <span id="viewerFileLines" class="text-success"></span>
          </div>
          <div class="col-md-2">
            <strong>Password:</strong> <span id="viewerFilePassword" class="text-danger"></span>
          </div>
        </div>
        
        <!-- File content with syntax highlighting -->
        <div class="file-viewer-container">
          <div class="file-viewer-header">
            <div class="d-flex justify-content-between align-items-center">
              <div class="file-viewer-info">
                <i class="fas fa-file-code me-2"></i>
                <span id="viewerFileNameHeader"></span>
              </div>
              <div class="file-viewer-actions">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copyFileContent()">
                  <i class="fas fa-copy me-1"></i>Copy
                </button>
              </div>
            </div>
          </div>
          <div class="file-viewer-content">
            <pre id="fileContentDisplay"><code id="fileContentCode"><!-- File content will be displayed here --></code></pre>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveFileBtn">
          <i class="fas fa-download me-2"></i>Save to Client
        </button>
      </div>
    </div>
  </div>
</div>

<!-- CSS Styles for File Manager -->
<style>
.file-manager-tabs .nav-link {
  border: none;
  border-bottom: 2px solid transparent;
  color: #6c757d;
  font-weight: 500;
  padding: 12px 20px;
  transition: all 0.3s ease;
}

.file-manager-tabs .nav-link:hover {
  border-bottom-color: #f97316;
  color: #f97316;
}

.file-manager-tabs .nav-link.active {
  background: none;
  border-bottom-color: #f97316;
  color: #f97316;
  font-weight: 600;
}

.table th {
  border-top: none;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.5px;
  padding: 8px 12px;
  background-color: #f8f9fa;
}

.table td {
  border-top: 1px solid #f0f2f5;
  vertical-align: middle;
  padding: 6px 12px;
  font-size: 0.875rem;
}

.badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
}

.btn-group .btn {
  margin: 0 2px;
}

/* Compact file display */
.table .d-flex.px-2.py-1 {
  padding: 0.25rem 0.5rem !important;
}

.table h6.mb-0.text-sm {
  margin-bottom: 0 !important;
  font-size: 0.875rem;
  line-height: 1.2;
}

.table .text-xs {
  font-size: 0.75rem !important;
  line-height: 1.1;
  margin-bottom: 0 !important;
}

/* Checkbox styling */
.form-check-input {
  width: 16px;
  height: 16px;
  margin: 0;
}

/* Action buttons styling */
.d-flex.gap-2 {
  gap: 0.5rem !important;
}

.d-flex.gap-2 .btn {
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
}

/* Table hover effects and compact styling */
.table tbody tr {
  transition: all 0.2s ease;
}

.table tbody tr:hover {
  background-color: #f8f9fa;
  transform: translateX(2px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.table tbody tr:hover .form-check-input {
  border-color: #f97316;
}

/* File manager specific table styling */
#upload-files-table, #download-files-table {
  font-size: 0.875rem;
}

#upload-files-table thead th, #download-files-table thead th {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  color: #6c757d;
  border-bottom: 2px solid #dee2e6;
}

/* File name cell clickable styling */
.file-name-cell {
  cursor: pointer;
  transition: all 0.2s ease;
}

.file-name-cell:hover {
  background-color: rgba(249, 115, 22, 0.1);
  border-radius: 4px;
}

.file-name-cell:hover h6 {
  color: #f97316 !important;
}

/* File viewer modal styling */
.file-viewer-container {
  border: 1px solid #e9ecef;
  border-radius: 8px;
  overflow: hidden;
  background: #fff;
}

.file-viewer-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 12px 16px;
  border-bottom: 1px solid #dee2e6;
}

.file-viewer-info {
  font-weight: 600;
  color: #495057;
}

.file-viewer-actions .btn {
  margin-left: 8px;
}

.file-viewer-content {
  max-height: 500px;
  overflow: auto;
  background: #282c34;
}

#fileContentDisplay {
  margin: 0;
  padding: 20px;
  background: #1e1e1e;
  color: #d4d4d4;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Courier New', monospace;
  font-size: 14px;
  line-height: 1.6;
  border: none;
  border-radius: 0;
  overflow-x: auto;
  white-space: pre;
}

#fileContentCode {
  color: #d4d4d4;
  background: transparent;
  padding: 0;
  margin: 0;
  font-family: inherit;
  white-space: pre;
  word-wrap: break-word;
}

/* Line numbers styling */
.file-viewer-content {
  position: relative;
}

/* Custom scrollbar for code */
#fileContentDisplay::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

#fileContentDisplay::-webkit-scrollbar-track {
  background: #2d2d2d;
}

#fileContentDisplay::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 4px;
}

#fileContentDisplay::-webkit-scrollbar-thumb:hover {
  background: #777;
}

/* Syntax highlighting colors - PHP */
.php-tag { color: #c678dd; font-weight: bold; }
.php-variable { color: #e06c75; }
.php-string { color: #98c379; }
.php-comment { color: #5c6370; font-style: italic; }
.php-keyword { color: #c678dd; font-weight: bold; }
.php-number { color: #d19a66; }

/* JavaScript */
.js-keyword { color: #c678dd; font-weight: bold; }
.js-string { color: #98c379; }
.js-number { color: #d19a66; }
.js-comment { color: #5c6370; font-style: italic; }
.js-literal { color: #56b6c2; font-weight: bold; }

/* HTML */
.html-tag { color: #e06c75; font-weight: bold; }
.html-attr { color: #d19a66; }

/* CSS */
.css-property { color: #61afef; font-weight: bold; }
.css-value { color: #98c379; }
.css-color { color: #e06c75; }
.css-comment { color: #5c6370; font-style: italic; }

/* Python */
.py-keyword { color: #c678dd; font-weight: bold; }
.py-string { color: #98c379; }
.py-number { color: #d19a66; }
.py-comment { color: #5c6370; font-style: italic; }

/* Java */
.java-keyword { color: #c678dd; font-weight: bold; }
.java-string { color: #98c379; }
.java-number { color: #d19a66; }
.java-comment { color: #5c6370; font-style: italic; }

/* SQL */
.sql-keyword { color: #61afef; font-weight: bold; }
.sql-string { color: #98c379; }
.sql-number { color: #d19a66; }
.sql-comment { color: #5c6370; font-style: italic; }

/* XML */
.xml-tag { color: #e06c75; font-weight: bold; }
.xml-attr { color: #d19a66; }
.xml-comment { color: #5c6370; font-style: italic; }

/* JSON */
.json-key { color: #61afef; font-weight: bold; }
.json-string { color: #98c379; }
.json-number { color: #d19a66; }
.json-literal { color: #56b6c2; font-weight: bold; }

/* Bash */
.bash-keyword { color: #c678dd; font-weight: bold; }
.bash-string { color: #98c379; }
.bash-comment { color: #5c6370; font-style: italic; }
.bash-variable { color: #e06c75; }

/* Markdown */
.md-heading { color: #61afef; font-weight: bold; }
.md-bold { color: #e06c75; font-weight: bold; }
.md-italic { color: #d19a66; font-style: italic; }
.md-code { color: #98c379; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; }
.md-link { color: #56b6c2; text-decoration: underline; }

/* Plain Text/Logs */
.log-level { color: #e06c75; font-weight: bold; }
.log-timestamp { color: #61afef; }
.log-version { color: #98c379; }

/* Generic */
.generic-string { color: #98c379; }
.generic-number { color: #d19a66; }

/* File row double-click hint */
.file-row {
  cursor: pointer;
  position: relative;
}

.file-row::after {
  content: "Click to view";
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.75rem;
  color: #6c757d;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none;
}

.file-row:hover::after {
  opacity: 1;
}

/* Responsive table adjustments */
@media (max-width: 768px) {
  .table th, .table td {
    padding: 4px 8px;
    font-size: 0.75rem;
  }
  
  .table h6.mb-0.text-sm {
    font-size: 0.75rem;
  }
  
  .d-flex.gap-2 .btn {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
  }
  
  .file-row::after {
    display: none;
  }
}

.selected-files-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 5px;
}

.selected-files-item .file-name {
  font-weight: 500;
  color: #495057;
}

.selected-files-item .file-size {
  font-size: 0.875rem;
  color: #6c757d;
}

.upload-progress-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 5px;
  padding: 10px;
  margin-bottom: 5px;
}

.dropdown-menu {
  border: none;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.dropdown-item {
  font-size: 0.875rem;
  padding: 8px 16px;
}

.dropdown-item:hover {
  background-color: #f8f9fa;
  color: #f97316;
}

/* File manager card styling */
.file-manager-card {
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  border-radius: 12px;
  overflow: hidden;
}

.file-manager-card .card-header {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 1px solid #dee2e6;
}

/* File icons based on file type */
.file-icon {
  width: 20px;
  text-align: center;
}

.file-icon.php { color: #777bb4; }
.file-icon.js { color: #f7df1e; }
.file-icon.html { color: #e34c26; }
.file-icon.css { color: #1572b6; }
.file-icon.py { color: #3776ab; }
.file-icon.java { color: #ed8b00; }
.file-icon.txt { color: #6c757d; }
.file-icon.md { color: #083fa1; }
.file-icon.json { color: #000000; }
.file-icon.xml { color: #e4761f; }
.file-icon.sql { color: #4479a1; }
.file-icon.db { color: #336791; }
.file-icon.png, .file-icon.jpg, .file-icon.jpeg, .file-icon.gif, .file-icon.svg { color: #17a2b8; }
.file-icon.pdf { color: #dc3545; }
.file-icon.doc, .file-icon.docx { color: #2b5797; }
.file-icon.xls, .file-icon.xlsx { color: #1d6f42; }
.file-icon.zip, .file-icon.rar, .file-icon.sevenz, .file-icon.tar, .file-icon.gz { color: #6c757d; }
.file-icon.default { color: #495057; }

/* Tab animation */
.tab-content .tab-pane {
  animation: fadeInUp 0.3s ease-in-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Toast notification animations */
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}
</style>

<!-- JavaScript for File Manager -->
<script>
// Global variables for file management
window.checkedUploadFiles = window.checkedUploadFiles || [];
window.checkedDownloadFiles = window.checkedDownloadFiles || [];

// Upload file checkbox management
function onUploadFileCheckboxChange(checkbox) {
  const fileId = checkbox.getAttribute('data-file-id');
  if (checkbox.checked) {
    if (!window.checkedUploadFiles.includes(fileId)) {
      window.checkedUploadFiles.push(fileId);
    }
  } else {
    window.checkedUploadFiles = window.checkedUploadFiles.filter(id => id !== fileId);
  }
  updateUploadSelectAllCheckbox();
}

// Download file checkbox management
function onDownloadFileCheckboxChange(checkbox) {
  const fileId = checkbox.getAttribute('data-file-id');
  if (checkbox.checked) {
    if (!window.checkedDownloadFiles.includes(fileId)) {
      window.checkedDownloadFiles.push(fileId);
    }
  } else {
    window.checkedDownloadFiles = window.checkedDownloadFiles.filter(id => id !== fileId);
  }
  updateDownloadSelectAllCheckbox();
}

// Toggle all upload files
function toggleAllUploadFiles(source) {
  const checkboxes = document.querySelectorAll('.upload-file-checkbox');
  if (source.checked) {
    checkboxes.forEach(cb => {
      cb.checked = true;
      onUploadFileCheckboxChange(cb);
    });
  } else {
    checkboxes.forEach(cb => {
      cb.checked = false;
      onUploadFileCheckboxChange(cb);
    });
  }
}

// Toggle all download files
function toggleAllDownloadFiles(source) {
  const checkboxes = document.querySelectorAll('.download-file-checkbox');
  if (source.checked) {
    checkboxes.forEach(cb => {
      cb.checked = true;
      onDownloadFileCheckboxChange(cb);
    });
  } else {
    checkboxes.forEach(cb => {
      cb.checked = false;
      onDownloadFileCheckboxChange(cb);
    });
  }
}

// Update upload select all checkbox
function updateUploadSelectAllCheckbox() {
  const checkboxes = document.querySelectorAll('.upload-file-checkbox');
  const selectAll = document.getElementById('select-all-upload');
  if (!selectAll) return;
  
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  if (checkedCount === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else if (checkedCount === checkboxes.length) {
    selectAll.checked = true;
    selectAll.indeterminate = false;
  } else {
    selectAll.checked = false;
    selectAll.indeterminate = true;
  }
}

// Update download select all checkbox
function updateDownloadSelectAllCheckbox() {
  const checkboxes = document.querySelectorAll('.download-file-checkbox');
  const selectAll = document.getElementById('select-all-download');
  if (!selectAll) return;
  
  const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  if (checkedCount === 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
  } else if (checkedCount === checkboxes.length) {
    selectAll.checked = true;
    selectAll.indeterminate = false;
  } else {
    selectAll.checked = false;
    selectAll.indeterminate = true;
  }
}

// Display selected files in upload modal
function displaySelectedFiles() {
  const fileInput = document.getElementById('uploadFileInput');
  const container = document.getElementById('selectedFilesContainer');
  const filesList = document.getElementById('selectedFilesList');
  
  if (fileInput.files.length > 0) {
    container.style.display = 'block';
    filesList.innerHTML = '';
    
    Array.from(fileInput.files).forEach((file, index) => {
      const fileItem = document.createElement('div');
      fileItem.className = 'selected-files-item';
      fileItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="file-name">
              <i class="${getFileIcon(file.name)} me-2"></i>${file.name}
            </div>
            <div class="file-size">${formatFileSize(file.size)}</div>
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSelectedFile(${index})">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      filesList.appendChild(fileItem);
    });
  } else {
    container.style.display = 'none';
  }
}

// Remove selected file
function removeSelectedFile(index) {
  const fileInput = document.getElementById('uploadFileInput');
  const dt = new DataTransfer();
  
  Array.from(fileInput.files).forEach((file, i) => {
    if (i !== index) {
      dt.items.add(file);
    }
  });
  
  fileInput.files = dt.files;
  displaySelectedFiles();
}

// Format file size
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Get file icon based on extension
function getFileIcon(fileName) {
  const extension = fileName.split('.').pop().toLowerCase();
  const iconMap = {
    // Code files
    'php': 'fas fa-file-code file-icon php',
    'js': 'fab fa-js-square file-icon js',
    'html': 'fab fa-html5 file-icon html',
    'css': 'fab fa-css3-alt file-icon css',
    'py': 'fab fa-python file-icon py',
    'java': 'fab fa-java file-icon java',
    // Text files
    'txt': 'fas fa-file-alt file-icon txt',
    'md': 'fab fa-markdown file-icon md',
    'json': 'fas fa-file-code file-icon json',
    'xml': 'fas fa-file-code file-icon xml',
    // Database
    'sql': 'fas fa-database file-icon sql',
    'db': 'fas fa-database file-icon db',
    // Images
    'png': 'fas fa-file-image file-icon png',
    'jpg': 'fas fa-file-image file-icon jpg',
    'jpeg': 'fas fa-file-image file-icon jpeg',
    'gif': 'fas fa-file-image file-icon gif',
    'svg': 'fas fa-file-image file-icon svg',
    // Documents
    'pdf': 'fas fa-file-pdf file-icon pdf',
    'doc': 'fas fa-file-word file-icon doc',
    'docx': 'fas fa-file-word file-icon docx',
    'xls': 'fas fa-file-excel file-icon xls',
    'xlsx': 'fas fa-file-excel file-icon xlsx',
    // Archives
    'zip': 'fas fa-file-archive file-icon zip',
    'rar': 'fas fa-file-archive file-icon rar',
    '7z': 'fas fa-file-archive file-icon sevenz',
    'tar': 'fas fa-file-archive file-icon tar',
    'gz': 'fas fa-file-archive file-icon gz',
    // Default
    'default': 'fas fa-file file-icon default'
  };
  
  return iconMap[extension] || iconMap['default'];
}

// Start file upload
function startFileUpload() {
  const fileInput = document.getElementById('uploadFileInput');
  const progressContainer = document.getElementById('uploadProgressContainer');
  const progressBar = document.getElementById('uploadProgressBar');
  const statusDiv = document.getElementById('uploadStatus');
  const startBtn = document.getElementById('startUploadBtn');
  
  if (fileInput.files.length === 0) {
    alert('Please select at least one file to upload.');
    return;
  }
  
  // Show progress container
  progressContainer.style.display = 'block';
  startBtn.disabled = true;
  startBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';
  
  const files = Array.from(fileInput.files);
  let uploadedCount = 0;
  let failedCount = 0;
  
  // Upload files one by one
  files.forEach((file, index) => {
    uploadSingleFile(file, index, files.length, (success) => {
      if (success) {
        uploadedCount++;
      } else {
        failedCount++;
      }
      
      // Update progress
      const totalProgress = ((index + 1) / files.length) * 100;
      progressBar.style.width = totalProgress + '%';
      progressBar.textContent = Math.round(totalProgress) + '%';
      statusDiv.textContent = `Uploading ${index + 1}/${files.length}: ${file.name}`;
      
      // Check if all files are processed
      if (index + 1 === files.length) {
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        if (failedCount === 0) {
          statusDiv.textContent = `All ${uploadedCount} files uploaded successfully!`;
          statusDiv.className = 'text-success';
        } else {
          statusDiv.textContent = `${uploadedCount} files uploaded, ${failedCount} failed.`;
          statusDiv.className = 'text-warning';
        }
        
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('uploadFileModal'));
          modal.hide();
          
          // Reset form
          document.getElementById('uploadFileForm').reset();
          document.getElementById('selectedFilesContainer').style.display = 'none';
          progressContainer.style.display = 'none';
          startBtn.disabled = false;
          startBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Start Upload';
          
          // Refresh upload files list
          refreshUploadFilesList();
          
          // Show result message
          if (failedCount === 0) {
            showToast(`Successfully uploaded ${uploadedCount} file(s)!`, 'success');
          } else {
            showToast(`${uploadedCount} files uploaded, ${failedCount} failed.`, 'warning');
          }
        }, 2000);
      }
    });
  });
}

// Upload single file using API
function uploadSingleFile(file, index, total, callback) {
  const formData = new FormData();
  formData.append('file', file);
  
  fetch('/api/dataserver/upload-file', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === '1') {
      console.log(`File ${file.name} uploaded successfully:`, data);
      callback(true);
    } else {
      console.error(`File ${file.name} upload failed:`, data);
      callback(false);
    }
  })
  .catch(error => {
    console.error(`Error uploading file ${file.name}:`, error);
    callback(false);
  });
}

// File operations
function downloadFile(fileId) {
  console.log('Downloading file:', fileId);
  // Implement download logic
  alert('Download functionality will be implemented!');
}

function deleteFile(fileId) {
  if (confirm('Are you sure you want to delete this file?')) {
    console.log('Deleting file:', fileId);
    // Implement delete logic
    alert('Delete functionality will be implemented!');
  }
}

function viewFileContent(fileId) {
  console.log('Viewing file content:', fileId);
  
  // Lấy thông tin file từ DOM
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (!fileRow) {
    alert('File information not found');
    return;
  }
  
  const fileInfo = JSON.parse(fileRow.getAttribute('data-file-info') || '{}');
  const fileIdNum = fileInfo.id;
  
  if (!fileIdNum) {
    alert('File ID not found');
    return;
  }
  
  // Gọi API để lấy nội dung file thực tế
  fetch(`/api/dataserver/view-upload-file?id=${fileIdNum}`)
    .then(response => response.json())
    .then(data => {
      if (data.status === '1') {
        // Cập nhật modal với thông tin thực tế
        document.getElementById('viewerFileName').textContent = data.filename;
        document.getElementById('viewerFileNameHeader').textContent = data.filename;
        document.getElementById('viewerFileSize').textContent = data.size_readable || formatFileSize(data.size || 0);
        document.getElementById('viewerFileType').textContent = data.type.toUpperCase();
        document.getElementById('viewerFileLines').textContent = data.lines;
        document.getElementById('viewerFilePassword').textContent = data.password;
        document.getElementById('saveFileBtn').setAttribute("onclick",`downloadFileContent("${data.file_id}")`) ;
        // Xử lý nội dung file với syntax highlighting
        const contentElement = document.getElementById('fileContentCode');
        const content = data.content;
        
        // Xác định loại file để áp dụng syntax highlighting phù hợp
        const fileExtension = data.filename.split('.').pop().toLowerCase();
        const highlightedContent = applySyntaxHighlighting(content, fileExtension);
        
        contentElement.innerHTML = highlightedContent;
        console.log(`[+] Content loaded for ${data.filename}`);
        
        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
        modal.show();
      } else {
        alert('Error loading file content: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(error => {
      console.error('Error fetching file content:', error);
      alert('Error loading file content. Please try again.');
    });
}
async function downloadFileContent(fileId) {
  const url = `/api/dataserver/download-upload-file?id=${encodeURIComponent(fileId)}`;

  try {
    const res = await fetch(url, { method: 'GET' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    // 1) Thử lấy filename từ Content-Disposition
    let filename = null;
    const dispo = res.headers.get('Content-Disposition');
    if (dispo) {
      const m = /filename\*?=(?:UTF-8'')?("?)([^";]+)\1/i.exec(dispo);
      if (m && m[2]) filename = decodeURIComponent(m[2]);
    }

    // 2) Fallback: lấy từ DOM data-file-info (nếu có)
    if (!filename) {
      const sel = `[data-file-id="${fileId}"]`;
      const row = document.querySelector(sel);
      if (row) {
        try {
          const info = JSON.parse(row.getAttribute('data-file-info') || '{}');
          filename = info.name || info.filename || null;
        } catch (_) { /* ignore */ }
      }
    }

    // 3) Fallback cuối
    if (!filename) filename = `file_${fileId}`;

    // Tải blob và trigger download
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = blobUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    URL.revokeObjectURL(blobUrl);

    if (typeof showToast === 'function') {
      showToast(`Downloaded ${filename}`, 'success');
    }
  } catch (err) {
    console.error('Download failed:', err);
    if (typeof showToast === 'function') {
      showToast(`Download failed for id=${fileId}: ${String(err)}`, 'error');
    } else {
      alert(`Download failed: ${String(err)}`);
    }
  }
}
// Hàm áp dụng syntax highlighting cho code
function applySyntaxHighlighting(content, fileExtension) {
  if (!content) return '';
  
  // Escape HTML entities để tránh XSS
  content = escapeHtml(content);
  
  // Áp dụng syntax highlighting dựa trên loại file
  switch (fileExtension) {
    case 'php':
      return highlightPHP(content);
    case 'js':
    case 'javascript':
      return highlightJavaScript(content);
    case 'html':
    case 'htm':
      return highlightHTML(content);
    case 'css':
      return highlightCSS(content);
    case 'py':
    case 'python':
      return highlightPython(content);
    case 'java':
      return highlightJava(content);
    case 'sql':
      return highlightSQL(content);
    case 'xml':
      return highlightXML(content);
    case 'json':
      return highlightJSON(content);
    case 'sh':
    case 'bash':
      return highlightBash(content);
    case 'md':
    case 'markdown':
    case 'yml':
      return highlightMarkdown(content);
    case 'txt':
    case 'log':
      return highlightPlainText(content);
    default:
      return highlightGeneric(content);
  }
}

// Highlight PHP
function highlightPHP(content) {
  return content
    .replace(/(&lt;?php|&lt;?=)/g, '<span class="php-tag">$1</span>')
    .replace(/(&lt;?php|&lt;?=)/g, '<span class="php-tag">$1</span>')
    .replace(/\b(function|class|public|private|protected|static|const|var|echo|print|return|if|else|elseif|foreach|for|while|do|switch|case|break|continue|new|extends|implements|interface|abstract|final|namespace|use|as|require|include|require_once|include_once)\b/g, '<span class="php-keyword">$1</span>')
    .replace(/\$([a-zA-Z_][a-zA-Z0-9_]*)/g, '<span class="php-variable">$$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="php-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="php-number">$1</span>')
    .replace(/(\/\*[\s\S]*?\*\/|\/\/.*)/g, '<span class="php-comment">$1</span>');
}

// Highlight JavaScript
function highlightJavaScript(content) {
  return content
    .replace(/\b(function|var|let|const|if|else|for|while|do|switch|case|break|continue|return|new|class|extends|import|export|default|async|await|try|catch|finally|throw)\b/g, '<span class="js-keyword">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*'|`[^`]*`)/g, '<span class="js-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="js-number">$1</span>')
    .replace(/(\/\*[\s\S]*?\*\/|\/\/.*)/g, '<span class="js-comment">$1</span>')
    .replace(/\b(true|false|null|undefined)\b/g, '<span class="js-literal">$1</span>');
}

// Highlight HTML
function highlightHTML(content) {
  return content
    .replace(/(&lt;[^&]*&gt;)/g, '<span class="html-tag">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;)/g, '<span class="html-attr">$1</span>')
    .replace(/(&lt;\/[^&]*&gt;)/g, '<span class="html-tag">$1</span>');
}

// Highlight CSS
function highlightCSS(content) {
  return content
    .replace(/([a-zA-Z-]+)(?=\s*:)/g, '<span class="css-property">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;)/g, '<span class="css-value">$1</span>')
    .replace(/(#[0-9a-fA-F]{3,6}|rgb\([^)]+\)|rgba\([^)]+\))/g, '<span class="css-color">$1</span>')
    .replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="css-comment">$1</span>');
}

// Highlight Python
function highlightPython(content) {
  return content
    .replace(/\b(def|class|if|elif|else|for|while|try|except|finally|with|import|from|as|return|yield|raise|assert|pass|break|continue|global|nonlocal|lambda|True|False|None)\b/g, '<span class="py-keyword">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="py-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="py-number">$1</span>')
    .replace(/(#.*)/g, '<span class="py-comment">$1</span>');
}

// Highlight Java
function highlightJava(content) {
  return content
    .replace(/\b(public|private|protected|static|final|abstract|class|interface|extends|implements|new|if|else|for|while|do|switch|case|break|continue|return|try|catch|finally|throw|throws|import|package|synchronized|volatile|transient|native|strictfp)\b/g, '<span class="java-keyword">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="java-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?[fdl]?)\b/g, '<span class="java-number">$1</span>')
    .replace(/(\/\*[\s\S]*?\*\/|\/\/.*)/g, '<span class="java-comment">$1</span>');
}

// Highlight SQL
function highlightSQL(content) {
  return content
    .replace(/\b(SELECT|FROM|WHERE|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER|TABLE|INDEX|PRIMARY|FOREIGN|KEY|REFERENCES|JOIN|LEFT|RIGHT|INNER|OUTER|ON|GROUP|BY|ORDER|HAVING|UNION|ALL|DISTINCT|AS|IN|NOT|AND|OR|IS|NULL|LIKE|BETWEEN|EXISTS|CASE|WHEN|THEN|ELSE|END)\b/gi, '<span class="sql-keyword">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="sql-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="sql-number">$1</span>')
    .replace(/(--.*)/g, '<span class="sql-comment">$1</span>');
}

// Highlight XML
function highlightXML(content) {
  return content
    .replace(/(&lt;[^&]*&gt;)/g, '<span class="xml-tag">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;)/g, '<span class="xml-attr">$1</span>')
    .replace(/(&lt;\/[^&]*&gt;)/g, '<span class="xml-tag">$1</span>')
    .replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="xml-comment">$1</span>');
}

// Highlight JSON
function highlightJSON(content) {
  return content
    .replace(/(&quot;[^&quot;]*&quot;)(?=\s*:)/g, '<span class="json-key">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;)/g, '<span class="json-string">$1</span>')
    .replace(/\b(true|false|null)\b/g, '<span class="json-literal">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="json-number">$1</span>');
}

// Highlight Bash
function highlightBash(content) {
  return content
    .replace(/\b(if|then|else|elif|fi|for|while|do|done|case|esac|function|local|export|source|echo|printf|read|exit|return|break|continue)\b/g, '<span class="bash-keyword">$1</span>')
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="bash-string">$1</span>')
    .replace(/(#.*)/g, '<span class="bash-comment">$1</span>')
    .replace(/\$([a-zA-Z_][a-zA-Z0-9_]*)/g, '<span class="bash-variable">$$1</span>');
}

// Highlight Markdown
function highlightMarkdown(content) {
  return content
    .replace(/^(#{1,6})\s+(.+)$/gm, '<span class="md-heading">$1 $2</span>')
    .replace(/\*\*(.+?)\*\*/g, '<span class="md-bold">**$1**</span>')
    .replace(/\*(.+?)\*/g, '<span class="md-italic">*$1*</span>')
    .replace(/`([^`]+)`/g, '<span class="md-code">`$1`</span>')
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<span class="md-link">[$1]($2)</span>');
}

// Highlight Plain Text
function highlightPlainText(content) {
  return content
    .replace(/^(ERROR|WARN|INFO|DEBUG):/gm, '<span class="log-level">$1:</span>')
    .replace(/\b(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})\b/g, '<span class="log-timestamp">$1</span>')
    .replace(/\b(\d+\.\d+\.\d+)\b/g, '<span class="log-version">$1</span>');
}

// Highlight Generic (cho các file không xác định)
function highlightGeneric(content) {
  return content
    .replace(/(&quot;[^&quot;]*&quot;|'[^']*')/g, '<span class="generic-string">$1</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g, '<span class="generic-number">$1</span>');
}

// Escape HTML để tránh XSS
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}



// Copy file content to clipboard
function copyFileContent() {
  const content = document.getElementById('fileContentCode').textContent;
  navigator.clipboard.writeText(content).then(() => {
    // Show toast notification
    showToast('File content copied to clipboard!', 'success');
  }).catch(err => {
    console.error('Failed to copy content: ', err);
    showToast('Failed to copy content', 'error');
  });
}


// Simple toast notification
function showToast(message, type = 'info') {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} toast-notification`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    padding: 12px 20px;
    border-radius: 8px;
    animation: slideIn 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  // Auto remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => document.body.removeChild(toast), 300);
  }, 3000);
}

// Refresh upload files list from API
function refreshUploadFilesList() {
  // Hiển thị loading state
  const searchInput = document.getElementById('search-upload-files').value;
  const tbody = document.getElementById('upload-files-tbody');
  if (tbody) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
          <br>Loading files...
        </td>
      </tr>
    `;
  }
  
  fetch(`/api/dataserver/list-file?folder=upload&search=${searchInput}`)
    .then(response => response.json())
    .then(data => {
      if (data.status === '1' && data.files && Array.isArray(data.files)) {
        updateUploadFilesTable(data.files);
        console.log('Upload files refreshed:', data.files);
        
        // Hiển thị thông báo nếu không có file nào
        if (data.files.length === 0) {
          showToast('No files found. Upload some files to get started!', 'info');
        }
      } else {
        console.error('Invalid response format:', data);
        // Fallback to empty table
        updateUploadFilesTable([]);
        showToast('Error loading files. Please try again.', 'error');
      }
    })
    .catch(error => {
      console.error('Error refreshing upload files:', error);
      // Fallback to empty table
      updateUploadFilesTable([]);
      showToast('Network error. Please check your connection.', 'error');
    });
}

// Refresh download files list from API
function refreshDownloadFilesList() {
  fetch('/api/dataserver/list-file-download')
    .then(response => response.json())
    .then(data => {
      if (data.files && Array.isArray(data.files)) {
        updateDownloadFilesTable(data.files);
      }
    })
    .catch(error => {
      console.error('Error refreshing download files:', error);
    });
}

// Update upload files table with real data
function updateUploadFilesTable(files) {
  const tbody = document.getElementById('upload-files-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (files.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          <i class="fas fa-folder-open fa-2x mb-2"></i>
          <br>No files uploaded yet
        </td>
      </tr>
    `;
    return;
  }
  
  files.forEach((fileInfo, index) => {
    const fileId = `upload-${fileInfo.id || index + 1}`;
    const filename = fileInfo.name;
    const fileIcon = getFileIcon(filename);
    const fileSize = fileInfo.size_readable || formatFileSize(fileInfo.size || 0);
    const uploadedTime = fileInfo.uploaded_at || 'Unknown';
    
    const row = document.createElement('tr');
    row.className = 'file-row';
    row.setAttribute('data-file-id', fileId);
    row.setAttribute('title', 'Double-click to view file');
    row.setAttribute('data-file-info', JSON.stringify(fileInfo));
    
    row.innerHTML = `
      <td>
        <input type="checkbox" class="form-check-input upload-file-checkbox" 
               data-file-id="${fileId}" onchange="onUploadFileCheckboxChange(this)" 
               onclick="event.stopPropagation()">
      </td>
      <td class="file-name-cell" onclick="viewFileContent('${fileId}')">
        <div class="d-flex px-2 py-1">
          <div class="d-flex flex-column justify-content-center">
            <h6 class="mb-0 text-sm">
              <i class="${fileIcon} me-2"></i>
              ${filename}
            </h6>
          </div>
        </div>
      </td>
      <td>
        <p class="text-xs text-secondary mb-0">${fileSize}</p>
      </td>
      <td>
        <p class="text-xs text-secondary mb-0">${uploadedTime}</p>
      </td>
      <td>
        <span class="badge badge-sm bg-gradient-success">Uploaded</span>
      </td>
    `;
    
    tbody.appendChild(row);
  });
  
  // Reset checkboxes
  window.checkedUploadFiles = [];
  updateUploadSelectAllCheckbox();
}

// Update download files table with real data
function updateDownloadFilesTable(files) {
  const tbody = document.getElementById('download-files-tbody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (files.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          <i class="fas fa-folder-open fa-2x mb-2"></i>
          <br>No files downloaded yet
        </td>
      </tr>
    `;
    return;
  }
  
  files.forEach((fileInfo, index) => {
    const fileId = `download-${index + 1}`;
    const filename = fileInfo.name;
    const fileIcon = getFileIcon(filename);
    const fileSize = fileInfo.size_readable || formatFileSize(fileInfo.size || 0);
    const modifiedTime = fileInfo.modified;
    
    const row = document.createElement('tr');
    row.className = 'file-row';
    row.setAttribute('data-file-id', fileId);
    row.setAttribute('title', 'Double-click to view file');
    
    row.innerHTML = `
      <td>
        <input type="checkbox" class="form-check-input download-file-checkbox" 
               data-file-id="${fileId}" onchange="onDownloadFileCheckboxChange(this)" 
               onclick="event.stopPropagation()">
      </td>
      <td class="file-name-cell" onclick="viewFileContent('${fileId}')">
        <div class="d-flex px-2 py-1">
          <div class="d-flex flex-column justify-content-center">
            <h6 class="mb-0 text-sm">
              <i class="${fileIcon} me-2"></i>
              ${filename}
            </h6>
          </div>
        </div>
      </td>
      <td>
        <p class="text-xs text-secondary mb-0">${fileSize}</p>
      </td>
      <td>
        <p class="text-xs text-secondary mb-0">${modifiedTime}</p>
      </td>
      <td>
        <p class="text-xs text-secondary mb-0">${fileInfo.path || '--'}</p>
      </td>
    `;
    
    tbody.appendChild(row);
  });
  
  // Reset checkboxes
  window.checkedDownloadFiles = [];
  updateDownloadSelectAllCheckbox();
}


// Action buttons for multiple selections
document.addEventListener('DOMContentLoaded', function() {
  // Load initial file lists
  refreshUploadFilesList();
  refreshDownloadFilesList();
  
  // Upload file button
  document.getElementById('btn-upload-file').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('uploadFileModal'));
    modal.show();
  });
  
  // View selected upload file
  document.getElementById('btn-view-upload-selected').addEventListener('click', function() {
    if (window.checkedUploadFiles.length === 0) {
      alert('Please select a file to view.');
      return;
    }
    
    if (window.checkedUploadFiles.length > 1) {
      alert('Please select only one file to view.');
      return;
    }
    
    viewFileContent(window.checkedUploadFiles[0]);
  });
  
  // Delete selected upload files
  document.getElementById('btn-delete-upload-selected').addEventListener('click', function() {
    if (window.checkedUploadFiles.length === 0) {
      alert('Please select files to delete.');
      return;
    }
    
    if (confirm(`Are you sure you want to delete ${window.checkedUploadFiles.length} selected file(s)?`)) {
      console.log('Deleting upload files:', window.checkedUploadFiles);
      
      // Xóa từng file một
      let deletedCount = 0;
      let failedCount = 0;
      
      window.checkedUploadFiles.forEach((fileId, index) => {
        const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
        if (fileRow) {
          const fileInfo = JSON.parse(fileRow.getAttribute('data-file-info') || '{}');
          const fileIdNum = fileInfo.id;
          
          if (fileIdNum) {
            fetch(`/api/dataserver/delete-upload-file?id=${fileIdNum}`, {
              method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
              if (data.status === '1') {
                deletedCount++;
                // Xóa row khỏi table
                fileRow.remove();
              } else {
                failedCount++;
                console.error('Failed to delete file:', data.error);
              }
              
              // Kiểm tra xem đã xóa xong tất cả chưa
              if (deletedCount + failedCount === window.checkedUploadFiles.length) {
                // Reset checkboxes
                window.checkedUploadFiles = [];
                updateUploadSelectAllCheckbox();
                
                // Hiển thị kết quả
                if (failedCount === 0) {
                  showToast(`Successfully deleted ${deletedCount} file(s)!`, 'success');
                } else {
                  showToast(`${deletedCount} files deleted, ${failedCount} failed.`, 'warning');
                }
              }
            })
            .catch(error => {
              failedCount++;
              console.error('Error deleting file:', error);
              
              if (deletedCount + failedCount === window.checkedUploadFiles.length) {
                window.checkedUploadFiles = [];
                updateUploadSelectAllCheckbox();
                showToast(`${deletedCount} files deleted, ${failedCount} failed.`, 'warning');
              }
            });
          } else {
            failedCount++;
            if (deletedCount + failedCount === window.checkedUploadFiles.length) {
              window.checkedUploadFiles = [];
              updateUploadSelectAllCheckbox();
              showToast(`${deletedCount} files deleted, ${failedCount} failed.`, 'warning');
            }
          }
        } else {
          failedCount++;
          if (deletedCount + failedCount === window.checkedUploadFiles.length) {
            window.checkedUploadFiles = [];
            updateUploadSelectAllCheckbox();
            showToast(`${deletedCount} files deleted, ${failedCount} failed.`, 'warning');
          }
        }
      });
    }
  });
  
  // Download selected upload files
  document.getElementById('btn-download-upload-selected').addEventListener('click', function() {
    if (window.checkedUploadFiles.length === 0) {
      alert('Please select files to download.');
      return;
    }
    
    console.log('Downloading upload files:', window.checkedUploadFiles);
    
    // Download từng file một
    window.checkedUploadFiles.forEach((fileId, index) => {
      const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
      if (fileRow) {
        const fileInfo = JSON.parse(fileRow.getAttribute('data-file-info') || '{}');
        const fileIdNum = fileInfo.id;
        
        if (fileIdNum) {
          // Tạo link download
          const downloadUrl = `/api/dataserver/download-upload-file?id=${fileIdNum}`;
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = fileInfo.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          // Delay giữa các download để tránh browser block
          setTimeout(() => {
            if (index === window.checkedUploadFiles.length - 1) {
              showToast(`Downloaded ${window.checkedUploadFiles.length} file(s)!`, 'success');
            }
          }, index * 100);
        }
      }
    });
  });
  
  // View selected download file
  document.getElementById('btn-view-download-selected').addEventListener('click', function() {
    if (window.checkedDownloadFiles.length === 0) {
      alert('Please select a file to view.');
      return;
    }
    
    if (window.checkedDownloadFiles.length > 1) {
      alert('Please select only one file to view.');
      return;
    }
    
    viewFileContent(window.checkedDownloadFiles[0]);
  });
  
  // Delete selected download files
  document.getElementById('btn-delete-download-selected').addEventListener('click', function() {
    if (window.checkedDownloadFiles.length === 0) {
      alert('Please select files to delete.');
      return;
    }
    
    if (confirm(`Are you sure you want to delete ${window.checkedDownloadFiles.length} selected file(s)?`)) {
      console.log('Deleting download files:', window.checkedDownloadFiles);
      // Implement bulk delete logic
      alert('Bulk delete functionality will be implemented!');
    }
  });
  
  // Save selected download files to client
  document.getElementById('btn-save-download-selected').addEventListener('click', function() {
    if (window.checkedDownloadFiles.length === 0) {
      alert('Please select files to save.');
      return;
    }
    
    console.log('Saving download files to client:', window.checkedDownloadFiles);
    // Implement bulk save to client logic
    alert('Bulk save to client functionality will be implemented!');
  });

  // Search functionality
  document.getElementById('search-upload-files').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    
    if (searchTerm.trim() === '') {
      // Nếu search trống, refresh lại toàn bộ danh sách
      refreshUploadFilesList();
      return;
    }
    
    // Search real-time trên dữ liệu hiện tại
    const rows = document.querySelectorAll('#upload-files-tbody tr');
    
    rows.forEach(row => {
      const fileInfo = JSON.parse(row.getAttribute('data-file-info') || '{}');
      const fileName = (fileInfo.name || '').toLowerCase();
      const fileHash = (fileInfo.hash || '').toLowerCase();
      
      if (fileName.includes(searchTerm) || fileHash.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });

  document.getElementById('search-download-files').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#download-files-tbody tr');
    
    rows.forEach(row => {
      const fileName = row.querySelector('h6').textContent.toLowerCase();
      if (fileName.includes(searchTerm)) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
});
</script>
