<!-- Weevely Module Terminal JavaScript -->
<script>
// Global variables
window.currentWeevelyConnection = {
    id: '',
    url: '',
    password: '',
    timeout: 60
};

// Utility functions
async function fetchJsonSafe(input, init) {
    const res = await fetch(input, init);
    const contentType = res.headers.get('content-type') || '';
    const text = await res.text();
    let json = null;
    if (contentType.includes('application/json')) {
        try { json = JSON.parse(text); } catch (e) { /* leave json null */ }
    }
    return { ok: res.ok, status: res.status, headers: res.headers, json, text };
}

function showLoading(message = 'Executing command...') {
    document.getElementById('loading_message').textContent = message;
    document.getElementById('loading_overlay').classList.remove('d-none');
    document.getElementById('execution_status').textContent = 'Running';
    document.getElementById('execution_status').className = 'badge bg-warning';
}

// Toggle data display
function toggleDataDisplay() {
    const dataDisplay = document.getElementById('weevely-data-display');
    const button = event.target.closest('button');
    const icon = button.querySelector('i');
    
    // Check if data display element exists
    if (!dataDisplay) {
        // Create a placeholder data display div if it doesn't exist
        const terminalCard = document.querySelector('#terminal_output').closest('.card');
        const newDataDisplay = document.createElement('div');
        newDataDisplay.id = 'weevely-data-display';
        newDataDisplay.className = 'mt-3 p-3 bg-light rounded';
        newDataDisplay.style.display = 'none';
        newDataDisplay.innerHTML = `
            <h6><i class="fas fa-chart-bar text-primary"></i> Data Visualization</h6>
            <p class="text-muted mb-0">Enhanced data display will appear here when available.</p>
            <small class="text-info">This feature shows structured output in tables, charts, and formatted views.</small>
        `;
        terminalCard.appendChild(newDataDisplay);
        
        appendToTerminal('Data display panel created', 'info');
        return;
    }
    
    if (dataDisplay.style.display === 'none') {
        dataDisplay.style.display = 'block';
        icon.className = 'fas fa-eye-slash';
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Data View';
        appendToTerminal('Data display panel shown', 'info');
    } else {
        dataDisplay.style.display = 'none';
        icon.className = 'fas fa-chart-bar';
        button.innerHTML = '<i class="fas fa-chart-bar"></i> Show Data View';
        appendToTerminal('Data display panel hidden', 'info');
    }
}

function hideLoading() {
    document.getElementById('loading_overlay').classList.add('d-none');
}

function updateStatus(status, type = 'success') {
    const statusElement = document.getElementById('execution_status');
    statusElement.textContent = status;
    
    const statusClasses = {
        'success': 'badge bg-success',
        'error': 'badge bg-danger', 
        'warning': 'badge bg-warning',
        'info': 'badge bg-info',
        'ready': 'badge bg-secondary'
    };
    
    statusElement.className = statusClasses[type] || 'badge bg-secondary';
}

function appendToTerminal(content, type = 'output') {
    const terminal = document.getElementById('terminal_output');
    const timestamp = new Date().toLocaleTimeString();
    
    let formattedContent = '';
    
    switch (type) {
        case 'command':
            formattedContent = `\n[${timestamp}] $ ${content}\n`;
            break;
        case 'success':
            formattedContent = `\n[${timestamp}] ✓ ${content}\n`;
            break;
        case 'error':
            formattedContent = `\n[${timestamp}] ✗ ERROR: ${content}\n`;
            break;
        case 'info':
            formattedContent = `\n[${timestamp}] ℹ ${content}\n`;
            break;
        default:
            formattedContent = content + '\n';
    }
    
    terminal.innerHTML += formattedContent;
    terminal.scrollTop = terminal.scrollHeight;
}

function clearTerminalOutput() {
    document.getElementById('terminal_output').innerHTML = 'Terminal cleared...\n';
    updateStatus('Ready', 'ready');
}

function copyTerminalOutput() {
    const content = document.getElementById('terminal_output').textContent;
    navigator.clipboard.writeText(content).then(() => {
        appendToTerminal('Terminal output copied to clipboard', 'info');
    });
}

// Connection management
function getConnectionDetails() {
    return {
        url: document.getElementById('weevely_url').value.trim(),
        password: document.getElementById('weevely_password').value.trim(),
        timeout: parseInt(document.getElementById('command_timeout').value) || 60
    };
}

// Enhanced module execution with beautiful data display
function executeModuleWithDisplay(moduleCommand) {
    if (!validateConnection()) {
        return;
    }
    
    const conn = getConnectionDetails();
    showLoading('Executing module...');
    
    // Call backend API
    fetchJsonSafe('/api/weevely/execute-module', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: window.currentWeevelyConnection.id,
            url: window.currentWeevelyConnection.url,
            password: window.currentWeevelyConnection.password,
            module_command: moduleCommand,
            timeout: conn.timeout
        })
    })
    .then(({ ok, json, text, status }) => {
        hideLoading();
        const result = json;
        if (!ok || !result) {
            updateStatus('Failed', 'error');
            appendToTerminal(`HTTP ${status}: ${text.substring(0, 400)}`, 'error');
            return;
        }
        if (result.success) {
            updateStatus('Success', 'success');
            // Display data in beautiful format
            if (typeof displayWeevelyData === 'function') {
                displayWeevelyData(result, moduleCommand);
            }
            // Also show in terminal
            appendToTerminal(`Module executed successfully: ${moduleCommand}`, 'success');
            const stderrText = result.clean_stderr || result.error_output || '';
            const stdoutText = result.clean_stdout || result.raw_output || '';
            const content = stderrText || stdoutText || '';
            appendToTerminal('=== STDERR OUTPUT ===');
            appendToTerminal(content || 'No output', content ? 'output' : 'info');
            if (result.saved_to) {
                appendToTerminal(`Saved to: ${result.saved_to}`, 'info');
            }
            if (result.data_file_id) {
                appendToTerminal(`DataFile ID: ${result.data_file_id}`, 'info');
            }
        } else {
            updateStatus('Failed', 'error');
            appendToTerminal(`Module execution failed: ${result.error}`, 'error');
            // Still try to display any parsed data
            if (typeof displayWeevelyData === 'function') {
                displayWeevelyData(result, moduleCommand);
            }
        }
    })
    .catch(error => {
        hideLoading();
        updateStatus('Error', 'error');
        appendToTerminal(`Network error: ${error.message}`, 'error');
    });
}

function validateConnection() {
    const conn = getConnectionDetails();
    
    if (!conn.url || !conn.url.startsWith('http')) {
        appendToTerminal('Please enter a valid weevely URL', 'error');
        return false;
    }
    
    if (!conn.password) {
        appendToTerminal('Please enter weevely password', 'error');
        return false;
    }
    
    // Preserve existing id and other fields; only update url/password/timeout
    if (!window.currentWeevelyConnection) {
        window.currentWeevelyConnection = { id: '', url: '', password: '', timeout: 60 };
    }
    window.currentWeevelyConnection.url = conn.url;
    window.currentWeevelyConnection.password = conn.password;
    window.currentWeevelyConnection.timeout = conn.timeout;

    // Keep the non-window alias in sync
    currentWeevelyConnection = window.currentWeevelyConnection;
    return true;
}

// API calls to backend
async function executeWeevelyModule(moduleCommand, params = {}) {
    if (!validateConnection()) return;
    
    showLoading(`Executing: ${moduleCommand}`);
    appendToTerminal(moduleCommand, 'command');
    
    try {
        const { ok, json, text, status } = await fetchJsonSafe('/api/weevely/execute-module', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: window.currentWeevelyConnection.id,
                url: window.currentWeevelyConnection.url,
                password: window.currentWeevelyConnection.password,
                module_command: moduleCommand,
                timeout: currentWeevelyConnection.timeout
            })
        });
        
        if (!ok || !json) {
            appendToTerminal(`HTTP ${status}: ${text.substring(0, 400)}`, 'error');
            updateStatus('Failed', 'error');
            return;
        }
        const result = json;
        
        if (result.success) {
            appendToTerminal('Command executed successfully', 'success');
            
            const stderrText = result.clean_stderr || result.error_output || '';
            const stdoutText = result.clean_stdout || result.raw_output || '';
            const content = stderrText || stdoutText || '';
            appendToTerminal('=== STDERR OUTPUT ===');
            appendToTerminal(content || 'No output', content ? 'output' : 'info');
            if (result.saved_to) {
                appendToTerminal(`Saved to: ${result.saved_to}`, 'info');
            }
            if (result.data_file_id) {
                appendToTerminal(`DataFile ID: ${result.data_file_id}`, 'info');
            }
            
            // Display execution info
            appendToTerminal(`Execution time: ${result.execution_time}s`, 'info');
            updateStatus('Success', 'success');
            
        } else {
            appendToTerminal(`Command failed: ${result.error}`, 'error');
            if (result.error_output) {
                appendToTerminal('=== ERROR OUTPUT ===');
                appendToTerminal(result.error_output);
            }
            updateStatus('Failed', 'error');
        }
        
    } catch (error) {
        appendToTerminal(`Network error: ${error.message}`, 'error');
        updateStatus('Error', 'error');
    } finally {
        hideLoading();
    }
}

// Test connection
async function testWeevelyConnection() {
    if (!validateConnection()) return;
    
    showLoading('Testing connection...');
    appendToTerminal('Testing weevely connection...', 'command');
    
    try {
        const { ok, json, text, status } = await fetchJsonSafe('/api/weevely/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: window.currentWeevelyConnection.id,
                url: window.currentWeevelyConnection.url,
                password: window.currentWeevelyConnection.password,
                timeout: currentWeevelyConnection.timeout
            })
        });
        if (!ok || !json) {
            appendToTerminal(`HTTP ${status}: ${text.substring(0, 400)}`, 'error');
            updateStatus('Disconnected', 'error');
            return;
        }
        const result = json;
        
        if (result.success) {
            appendToTerminal('Connection test successful!', 'success');
            appendToTerminal(`Response time: ${result.response_time}s`, 'info');
            updateStatus('Connected', 'success');
        } else {
            appendToTerminal(`Connection failed: ${result.message}`, 'error');
            updateStatus('Disconnected', 'error');
        }
        
    } catch (error) {
        appendToTerminal(`Connection test error: ${error.message}`, 'error');
        updateStatus('Error', 'error');
    } finally {
        hideLoading();
    }
}

// Get session info
async function getSessionInfo() {
    if (!validateConnection()) return;
    
    showLoading('Getting session information...');
    appendToTerminal('Retrieving session information...', 'command');
    
    try {
        const { ok, json, text, status } = await fetchJsonSafe('/api/weevely/session-info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: window.currentWeevelyConnection.url,
                password: window.currentWeevelyConnection.password
            })
        });
        if (!ok || !json) {
            appendToTerminal(`HTTP ${status}: ${text.substring(0, 400)}`, 'error');
            updateStatus('Failed', 'error');
            return;
        }
        const result = json;
        
        if (result.success) {
            appendToTerminal('Session information retrieved', 'success');
            appendToTerminal('=== SESSION INFO ===');
            appendToTerminal(JSON.stringify(result.session_info, null, 2));
            updateStatus('Info Retrieved', 'info');
        } else {
            appendToTerminal(`Failed to get session info: ${result.error}`, 'error');
            updateStatus('Failed', 'error');
        }
        
    } catch (error) {
        appendToTerminal(`Session info error: ${error.message}`, 'error');
        updateStatus('Error', 'error');
    } finally {
        hideLoading();
    }
}

// File operations
function listDirectory() {
    const path = document.getElementById('current_path').value || '/';
    executeModuleWithDisplay(`:file_ls ${path}`);
}

function changeDirectory(path) {
    document.getElementById('current_path').value = path;
    listDirectory();
}

// Shell operations
function executeShellCommand() {
    const command = document.getElementById('shell_command').value.trim();
    if (!command) {
        appendToTerminal('Please enter a shell command', 'error');
        return;
    }
    
    executeWeevelyModule(':shell_sh "'+ command +'"');
    document.getElementById('shell_command').value = '';
}

function setShellCommand(command) {
    document.getElementById('shell_command').value = command;
}

function executePHPCode() {
    const code = document.getElementById('php_code').value.trim();
    if (!code) {
        appendToTerminal('Please enter PHP code', 'error');
        return;
    }
    
    executeWeevelyModule(`:shell_php ${code}`);
    document.getElementById('php_code').value = '';
}

// Network operations
function executeScan() {
    const target = document.getElementById('scan_target').value.trim();
    if (!target) {
        appendToTerminal('Please enter a target to scan', 'error');
        return;
    }
    
    executeWeevelyModule(`:net_scan ${target}`);
}


function executeWebDownload() {
    const url = document.getElementById('download_url').value.trim();
    const path = document.getElementById('save_path').value.trim();
    
    if (!url || !path) {
        appendToTerminal('Please enter both URL and save path', 'error');
        return;
    }
    
    executeWeevelyModule(`:file_webdownload ${url} ${path}`);
}

// Custom commands
function executeCustomCommand() {
    const command = document.getElementById('custom_command').value.trim();
    if (!command) {
        appendToTerminal('Please enter a weevely command', 'error');
        return;
    }
    
    const fullCommand = command.startsWith(':') ? command : `:${command}`;
    executeWeevelyModule(fullCommand);
    document.getElementById('custom_command').value = '';
}

function setCustomCommand(command) {
    document.getElementById('custom_command').value = command;
}

// Batch execution
async function executeBatchCommands() {
    const batchCommands = [
        ':system_info',
        ':procs_list',
        ':file_ls /',
        ':audit_phpconf'
    ];
    
    if (!validateConnection()) return;
    
    showLoading('Executing batch commands...');
    appendToTerminal('Starting batch execution...', 'command');
    
    try {
        const { ok, json, text, status } = await fetchJsonSafe('/api/weevely/batch-execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                url: currentWeevelyConnection.url,
                password: currentWeevelyConnection.password,
                commands: batchCommands,
                delay: 0.5
            })
        });
        if (!ok || !json) {
            appendToTerminal(`HTTP ${status}: ${text.substring(0, 400)}`, 'error');
            updateStatus('Batch Failed', 'error');
            return;
        }
        const result = json;
        
        if (result.success) {
            appendToTerminal(`Batch execution completed`, 'success');
            appendToTerminal(`Total: ${result.total_commands}, Success: ${result.successful_commands}, Failed: ${result.failed_commands}`, 'info');
            appendToTerminal(`Total time: ${result.total_execution_time}s`, 'info');
            
            // Display individual results
            appendToTerminal('=== BATCH RESULTS ===');
            result.results.forEach(r => {
                const status = r.result.success ? '✓' : '✗';
                appendToTerminal(`${status} ${r.command}`);
                if (r.result.raw_output) {
                    appendToTerminal(r.result.raw_output);
                }
                appendToTerminal('---');
            });
            
            updateStatus('Batch Complete', 'success');
        } else {
            appendToTerminal(`Batch execution failed: ${result.error}`, 'error');
            updateStatus('Batch Failed', 'error');
        }
        
    } catch (error) {
        appendToTerminal(`Batch execution error: ${error.message}`, 'error');
        updateStatus('Error', 'error');
    } finally {
        hideLoading();
    }
}

// Modal functions (placeholders for future implementation)
function showFileSearchModal() {
    // TODO: Implement file search modal
    const path = prompt('Enter search path:', '/');
    const pattern = prompt('Enter file pattern (e.g., *.php):', '*.php');
    
    if (path && pattern) {
        executeWeevelyModule(`:file_find -vector sh_find -ftype f ${path} ${pattern}`);
    }
}

function showFileReadModal() {
    // TODO: Implement file read modal
    const filepath = prompt('Enter file path to read:', '/etc/passwd');
    
    if (filepath) {
        executeWeevelyModule(`:file_read -vector file_get_contents ${filepath}`);
    }
}

// showFileOperationsModal is now defined in weevely-modals.html

function showBatchModal() {
    // Check if modal exists and show it
    const modalElement = document.getElementById('batchCommandsModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        appendToTerminal('Batch Commands modal opened', 'info');
    } else {
        appendToTerminal('Batch Commands modal not found. Please ensure enhanced-modals.html is included.', 'error');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set default values if available
    // TODO: Load from weevely connection data if available
    
    appendToTerminal('Weevely Module Terminal initialized', 'info');
    appendToTerminal('Configure connection details and select modules to begin', 'info');
    
    // Initialize data display
    console.log('Weevely Data Display initialized');
    
    // Include the data display template
    if (typeof displayWeevelyData === 'undefined') {
        console.log('Loading Weevely Data Display scripts...');
        // The template should be included via [include] in the main template
    }
    
    // Note: Data display panel will be created dynamically when toggle button is clicked
    console.log('Weevely Module Terminal scripts loaded successfully');
});

// Auto-save connection details
document.getElementById('weevely_url').addEventListener('change', function() {
    localStorage.setItem('weevely_last_url', this.value);
});

document.getElementById('weevely_password').addEventListener('change', function() {
    // Note: Consider security implications of storing passwords
    // localStorage.setItem('weevely_last_password', this.value);
});

// Load saved connection details
window.addEventListener('load', function() {
    const savedUrl = localStorage.getItem('weevely_last_url');
    if (savedUrl) {
        document.getElementById('weevely_url').value = savedUrl;
    }
});
</script>

<!-- Additional CSS for better terminal styling -->
<style>
#terminal_output {
    background-color: #1a1a1a !important;
    color: #00ff00;
    font-family: 'Courier New', Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    padding: 15px;
    border-radius: 5px;
    border: 1px solid #333;
    overflow-x: auto;
}

#terminal_output::-webkit-scrollbar {
    width: 8px;
}

#terminal_output::-webkit-scrollbar-track {
    background: #2a2a2a;
}

#terminal_output::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
}

#terminal_output::-webkit-scrollbar-thumb:hover {
    background: #777;
}

.nav-pills .nav-link.active {
    background-color: #f97316 !important;
}

.card.border {
    border: 1px solid #e2e8f0 !important;
}

.btn-group-vertical .btn {
    text-align: left;
}

#loading_overlay {
    backdrop-filter: blur(3px);
}

.font-monospace {
    font-family: 'Courier New', Consolas, monospace !important;
}

/* Custom scrollbar for better terminal appearance */
.card-body {
    scrollbar-width: thin;
    scrollbar-color: #555 #2a2a2a;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .btn-group-vertical {
        display: flex;
        flex-direction: column;
    }
    
    .d-flex.gap-2.flex-wrap {
        gap: 0.5rem !important;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>
